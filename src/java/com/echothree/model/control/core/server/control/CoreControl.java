// --------------------------------------------------------------------------------
// Copyright 2002-2025 Echo Three, LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// --------------------------------------------------------------------------------

package com.echothree.model.control.core.server.control;

import com.echothree.model.control.accounting.server.control.AccountingControl;
import com.echothree.model.control.associate.server.control.AssociateControl;
import com.echothree.model.control.batch.server.control.BatchControl;
import com.echothree.model.control.chain.server.control.ChainControl;
import com.echothree.model.control.comment.server.control.CommentControl;
import com.echothree.model.control.core.common.ComponentVendors;
import com.echothree.model.control.core.common.EntityAttributeTypes;
import com.echothree.model.control.core.common.EntityTypes;
import com.echothree.model.control.core.common.EventTypes;
import com.echothree.model.control.core.common.choice.AppearanceChoicesBean;
import com.echothree.model.control.core.common.choice.ApplicationChoicesBean;
import com.echothree.model.control.core.common.choice.ApplicationEditorChoicesBean;
import com.echothree.model.control.core.common.choice.ApplicationEditorUseChoicesBean;
import com.echothree.model.control.core.common.choice.BaseEncryptionKeyStatusChoicesBean;
import com.echothree.model.control.core.common.choice.ColorChoicesBean;
import com.echothree.model.control.core.common.choice.CommandMessageTypeChoicesBean;
import com.echothree.model.control.core.common.choice.EditorChoicesBean;
import com.echothree.model.control.core.common.choice.EntityAliasTypeChoicesBean;
import com.echothree.model.control.core.common.choice.EntityAttributeGroupChoicesBean;
import com.echothree.model.control.core.common.choice.EntityAttributeTypeChoicesBean;
import com.echothree.model.control.core.common.choice.EntityIntegerRangeChoicesBean;
import com.echothree.model.control.core.common.choice.EntityListItemChoicesBean;
import com.echothree.model.control.core.common.choice.EntityLongRangeChoicesBean;
import com.echothree.model.control.core.common.choice.EventGroupStatusChoicesBean;
import com.echothree.model.control.core.common.choice.FontStyleChoicesBean;
import com.echothree.model.control.core.common.choice.FontWeightChoicesBean;
import com.echothree.model.control.core.common.choice.MimeTypeChoicesBean;
import com.echothree.model.control.core.common.choice.MimeTypeUsageTypeChoicesBean;
import com.echothree.model.control.core.common.choice.ProtocolChoicesBean;
import com.echothree.model.control.core.common.choice.ServerChoicesBean;
import com.echothree.model.control.core.common.choice.ServiceChoicesBean;
import com.echothree.model.control.core.common.choice.TextDecorationChoicesBean;
import com.echothree.model.control.core.common.choice.TextTransformationChoicesBean;
import com.echothree.model.control.core.common.transfer.AppearanceDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.AppearanceTextDecorationTransfer;
import com.echothree.model.control.core.common.transfer.AppearanceTextTransformationTransfer;
import com.echothree.model.control.core.common.transfer.AppearanceTransfer;
import com.echothree.model.control.core.common.transfer.ApplicationDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.ApplicationEditorTransfer;
import com.echothree.model.control.core.common.transfer.ApplicationEditorUseDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.ApplicationEditorUseTransfer;
import com.echothree.model.control.core.common.transfer.ApplicationTransfer;
import com.echothree.model.control.core.common.transfer.BaseEncryptionKeyTransfer;
import com.echothree.model.control.core.common.transfer.CacheEntryDependencyTransfer;
import com.echothree.model.control.core.common.transfer.CacheEntryTransfer;
import com.echothree.model.control.core.common.transfer.ColorDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.ColorTransfer;
import com.echothree.model.control.core.common.transfer.CommandDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.CommandMessageTransfer;
import com.echothree.model.control.core.common.transfer.CommandMessageTranslationTransfer;
import com.echothree.model.control.core.common.transfer.CommandMessageTypeDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.CommandMessageTypeTransfer;
import com.echothree.model.control.core.common.transfer.CommandTransfer;
import com.echothree.model.control.core.common.transfer.ComponentVendorTransfer;
import com.echothree.model.control.core.common.transfer.EditorDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.EditorTransfer;
import com.echothree.model.control.core.common.transfer.EntityAliasTransfer;
import com.echothree.model.control.core.common.transfer.EntityAliasTypeDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.EntityAliasTypeTransfer;
import com.echothree.model.control.core.common.transfer.EntityAppearanceTransfer;
import com.echothree.model.control.core.common.transfer.EntityAttributeDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.EntityAttributeEntityAttributeGroupTransfer;
import com.echothree.model.control.core.common.transfer.EntityAttributeEntityTypeTransfer;
import com.echothree.model.control.core.common.transfer.EntityAttributeGroupDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.EntityAttributeGroupTransfer;
import com.echothree.model.control.core.common.transfer.EntityAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityAttributeTypeTransfer;
import com.echothree.model.control.core.common.transfer.EntityBlobAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityBooleanAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityBooleanDefaultTransfer;
import com.echothree.model.control.core.common.transfer.EntityClobAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityCollectionAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityDateAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityEntityAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityGeoPointAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityInstanceTransfer;
import com.echothree.model.control.core.common.transfer.EntityIntegerAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityIntegerDefaultTransfer;
import com.echothree.model.control.core.common.transfer.EntityIntegerRangeDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.EntityIntegerRangeTransfer;
import com.echothree.model.control.core.common.transfer.EntityListItemAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityListItemDefaultTransfer;
import com.echothree.model.control.core.common.transfer.EntityListItemDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.EntityListItemTransfer;
import com.echothree.model.control.core.common.transfer.EntityLongAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityLongDefaultTransfer;
import com.echothree.model.control.core.common.transfer.EntityLongRangeDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.EntityLongRangeTransfer;
import com.echothree.model.control.core.common.transfer.EntityMultipleListItemAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityNameAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityStringAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityStringDefaultTransfer;
import com.echothree.model.control.core.common.transfer.EntityTimeAttributeTransfer;
import com.echothree.model.control.core.common.transfer.EntityTimeTransfer;
import com.echothree.model.control.core.common.transfer.EntityTypeDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.EntityTypeTransfer;
import com.echothree.model.control.core.common.transfer.EntityVisitTransfer;
import com.echothree.model.control.core.common.transfer.EventGroupTransfer;
import com.echothree.model.control.core.common.transfer.EventTransfer;
import com.echothree.model.control.core.common.transfer.EventTypeTransfer;
import com.echothree.model.control.core.common.transfer.FontStyleDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.FontStyleTransfer;
import com.echothree.model.control.core.common.transfer.FontWeightDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.FontWeightTransfer;
import com.echothree.model.control.core.common.transfer.MimeTypeDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.MimeTypeFileExtensionTransfer;
import com.echothree.model.control.core.common.transfer.MimeTypeTransfer;
import com.echothree.model.control.core.common.transfer.MimeTypeUsageTransfer;
import com.echothree.model.control.core.common.transfer.MimeTypeUsageTypeTransfer;
import com.echothree.model.control.core.common.transfer.PartyApplicationEditorUseTransfer;
import com.echothree.model.control.core.common.transfer.PartyEntityTypeTransfer;
import com.echothree.model.control.core.common.transfer.ProtocolDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.ProtocolTransfer;
import com.echothree.model.control.core.common.transfer.ServerDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.ServerServiceTransfer;
import com.echothree.model.control.core.common.transfer.ServerTransfer;
import com.echothree.model.control.core.common.transfer.ServiceDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.ServiceTransfer;
import com.echothree.model.control.core.common.transfer.TextDecorationDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.TextDecorationTransfer;
import com.echothree.model.control.core.common.transfer.TextTransformationDescriptionTransfer;
import com.echothree.model.control.core.common.transfer.TextTransformationTransfer;
import static com.echothree.model.control.core.common.workflow.BaseEncryptionKeyStatusConstants.WorkflowDestination_BASE_ENCRYPTION_KEY_STATUS_ACTIVE_TO_INACTIVE;
import static com.echothree.model.control.core.common.workflow.BaseEncryptionKeyStatusConstants.WorkflowStep_BASE_ENCRYPTION_KEY_STATUS_ACTIVE;
import static com.echothree.model.control.core.common.workflow.BaseEncryptionKeyStatusConstants.Workflow_BASE_ENCRYPTION_KEY_STATUS;
import static com.echothree.model.control.core.common.workflow.EventGroupStatusConstants.WorkflowStep_EVENT_GROUP_STATUS_ACTIVE;
import static com.echothree.model.control.core.common.workflow.EventGroupStatusConstants.Workflow_EVENT_GROUP_STATUS;
import com.echothree.model.control.core.server.CoreDebugFlags;
import com.echothree.model.control.core.server.database.EntityInstancePKsByEntityTypeWithNullDeletedTimeQuery;
import com.echothree.model.control.core.server.eventbus.SentEvent;
import com.echothree.model.control.core.server.eventbus.SentEventEventBus;
import com.echothree.model.control.index.server.control.IndexControl;
import com.echothree.model.control.message.server.control.MessageControl;
import com.echothree.model.control.queue.common.QueueTypes;
import com.echothree.model.control.queue.common.exception.UnknownQueueTypeNameException;
import com.echothree.model.control.queue.server.logic.QueuedEntityLogic;
import com.echothree.model.control.rating.server.control.RatingControl;
import com.echothree.model.control.scale.server.control.ScaleControl;
import com.echothree.model.control.search.server.control.SearchControl;
import com.echothree.model.control.security.server.control.SecurityControl;
import com.echothree.model.control.sequence.common.SequenceTypes;
import com.echothree.model.control.sequence.server.control.SequenceControl;
import com.echothree.model.control.sequence.server.logic.SequenceGeneratorLogic;
import com.echothree.model.control.tag.server.control.TagControl;
import com.echothree.model.control.workeffort.server.control.WorkEffortControl;
import com.echothree.model.control.workflow.server.control.WorkflowControl;
import com.echothree.model.data.chain.server.entity.ChainInstance;
import com.echothree.model.data.core.common.pk.AppearancePK;
import com.echothree.model.data.core.common.pk.ApplicationPK;
import com.echothree.model.data.core.common.pk.CacheEntryPK;
import com.echothree.model.data.core.common.pk.ColorPK;
import com.echothree.model.data.core.common.pk.ComponentVendorPK;
import com.echothree.model.data.core.common.pk.EntityAliasTypePK;
import com.echothree.model.data.core.common.pk.EntityAttributeGroupPK;
import com.echothree.model.data.core.common.pk.EntityAttributePK;
import com.echothree.model.data.core.common.pk.EntityAttributeTypePK;
import com.echothree.model.data.core.common.pk.EntityInstancePK;
import com.echothree.model.data.core.common.pk.EntityIntegerRangePK;
import com.echothree.model.data.core.common.pk.EntityListItemPK;
import com.echothree.model.data.core.common.pk.EntityLongRangePK;
import com.echothree.model.data.core.common.pk.EntityTypePK;
import com.echothree.model.data.core.common.pk.FontStylePK;
import com.echothree.model.data.core.common.pk.FontWeightPK;
import com.echothree.model.data.core.common.pk.MimeTypePK;
import com.echothree.model.data.core.common.pk.TextDecorationPK;
import com.echothree.model.data.core.common.pk.TextTransformationPK;
import com.echothree.model.data.core.server.entity.Appearance;
import com.echothree.model.data.core.server.entity.AppearanceDescription;
import com.echothree.model.data.core.server.entity.AppearanceTextDecoration;
import com.echothree.model.data.core.server.entity.AppearanceTextTransformation;
import com.echothree.model.data.core.server.entity.Application;
import com.echothree.model.data.core.server.entity.ApplicationDescription;
import com.echothree.model.data.core.server.entity.ApplicationEditor;
import com.echothree.model.data.core.server.entity.ApplicationEditorUse;
import com.echothree.model.data.core.server.entity.ApplicationEditorUseDescription;
import com.echothree.model.data.core.server.entity.BaseEncryptionKey;
import com.echothree.model.data.core.server.entity.CacheBlobEntry;
import com.echothree.model.data.core.server.entity.CacheClobEntry;
import com.echothree.model.data.core.server.entity.CacheEntry;
import com.echothree.model.data.core.server.entity.CacheEntryDependency;
import com.echothree.model.data.core.server.entity.Color;
import com.echothree.model.data.core.server.entity.ColorDescription;
import com.echothree.model.data.core.server.entity.Command;
import com.echothree.model.data.core.server.entity.CommandDescription;
import com.echothree.model.data.core.server.entity.CommandMessage;
import com.echothree.model.data.core.server.entity.CommandMessageTranslation;
import com.echothree.model.data.core.server.entity.CommandMessageType;
import com.echothree.model.data.core.server.entity.CommandMessageTypeDescription;
import com.echothree.model.data.core.server.entity.Component;
import com.echothree.model.data.core.server.entity.ComponentStage;
import com.echothree.model.data.core.server.entity.ComponentVendor;
import com.echothree.model.data.core.server.entity.ComponentVersion;
import com.echothree.model.data.core.server.entity.Editor;
import com.echothree.model.data.core.server.entity.EditorDescription;
import com.echothree.model.data.core.server.entity.EntityAlias;
import com.echothree.model.data.core.server.entity.EntityAliasType;
import com.echothree.model.data.core.server.entity.EntityAliasTypeDescription;
import com.echothree.model.data.core.server.entity.EntityAppearance;
import com.echothree.model.data.core.server.entity.EntityAttribute;
import com.echothree.model.data.core.server.entity.EntityAttributeBlob;
import com.echothree.model.data.core.server.entity.EntityAttributeDescription;
import com.echothree.model.data.core.server.entity.EntityAttributeEntityAttributeGroup;
import com.echothree.model.data.core.server.entity.EntityAttributeEntityType;
import com.echothree.model.data.core.server.entity.EntityAttributeGroup;
import com.echothree.model.data.core.server.entity.EntityAttributeGroupDescription;
import com.echothree.model.data.core.server.entity.EntityAttributeInteger;
import com.echothree.model.data.core.server.entity.EntityAttributeListItem;
import com.echothree.model.data.core.server.entity.EntityAttributeLong;
import com.echothree.model.data.core.server.entity.EntityAttributeNumeric;
import com.echothree.model.data.core.server.entity.EntityAttributeString;
import com.echothree.model.data.core.server.entity.EntityAttributeType;
import com.echothree.model.data.core.server.entity.EntityAttributeTypeDescription;
import com.echothree.model.data.core.server.entity.EntityAttributeWorkflow;
import com.echothree.model.data.core.server.entity.EntityBlobAttribute;
import com.echothree.model.data.core.server.entity.EntityBooleanAttribute;
import com.echothree.model.data.core.server.entity.EntityBooleanDefault;
import com.echothree.model.data.core.server.entity.EntityClobAttribute;
import com.echothree.model.data.core.server.entity.EntityCollectionAttribute;
import com.echothree.model.data.core.server.entity.EntityDateAttribute;
import com.echothree.model.data.core.server.entity.EntityEncryptionKey;
import com.echothree.model.data.core.server.entity.EntityEntityAttribute;
import com.echothree.model.data.core.server.entity.EntityGeoPointAttribute;
import com.echothree.model.data.core.server.entity.EntityInstance;
import com.echothree.model.data.core.server.entity.EntityIntegerAttribute;
import com.echothree.model.data.core.server.entity.EntityIntegerDefault;
import com.echothree.model.data.core.server.entity.EntityIntegerRange;
import com.echothree.model.data.core.server.entity.EntityIntegerRangeDescription;
import com.echothree.model.data.core.server.entity.EntityListItem;
import com.echothree.model.data.core.server.entity.EntityListItemAttribute;
import com.echothree.model.data.core.server.entity.EntityListItemDefault;
import com.echothree.model.data.core.server.entity.EntityListItemDescription;
import com.echothree.model.data.core.server.entity.EntityLongAttribute;
import com.echothree.model.data.core.server.entity.EntityLongDefault;
import com.echothree.model.data.core.server.entity.EntityLongRange;
import com.echothree.model.data.core.server.entity.EntityLongRangeDescription;
import com.echothree.model.data.core.server.entity.EntityMultipleListItemAttribute;
import com.echothree.model.data.core.server.entity.EntityNameAttribute;
import com.echothree.model.data.core.server.entity.EntityStringAttribute;
import com.echothree.model.data.core.server.entity.EntityStringDefault;
import com.echothree.model.data.core.server.entity.EntityTime;
import com.echothree.model.data.core.server.entity.EntityTimeAttribute;
import com.echothree.model.data.core.server.entity.EntityType;
import com.echothree.model.data.core.server.entity.EntityTypeDescription;
import com.echothree.model.data.core.server.entity.EntityVisit;
import com.echothree.model.data.core.server.entity.Event;
import com.echothree.model.data.core.server.entity.EventGroup;
import com.echothree.model.data.core.server.entity.EventSubscriber;
import com.echothree.model.data.core.server.entity.EventSubscriberEntityInstance;
import com.echothree.model.data.core.server.entity.EventSubscriberEntityType;
import com.echothree.model.data.core.server.entity.EventSubscriberEventType;
import com.echothree.model.data.core.server.entity.EventType;
import com.echothree.model.data.core.server.entity.EventTypeDescription;
import com.echothree.model.data.core.server.entity.FontStyle;
import com.echothree.model.data.core.server.entity.FontStyleDescription;
import com.echothree.model.data.core.server.entity.FontWeight;
import com.echothree.model.data.core.server.entity.FontWeightDescription;
import com.echothree.model.data.core.server.entity.MimeType;
import com.echothree.model.data.core.server.entity.MimeTypeDescription;
import com.echothree.model.data.core.server.entity.MimeTypeFileExtension;
import com.echothree.model.data.core.server.entity.MimeTypeUsage;
import com.echothree.model.data.core.server.entity.MimeTypeUsageType;
import com.echothree.model.data.core.server.entity.MimeTypeUsageTypeDescription;
import com.echothree.model.data.core.server.entity.PartyApplicationEditorUse;
import com.echothree.model.data.core.server.entity.PartyEntityType;
import com.echothree.model.data.core.server.entity.Protocol;
import com.echothree.model.data.core.server.entity.ProtocolDescription;
import com.echothree.model.data.core.server.entity.QueuedEvent;
import com.echothree.model.data.core.server.entity.QueuedSubscriberEvent;
import com.echothree.model.data.core.server.entity.Server;
import com.echothree.model.data.core.server.entity.ServerDescription;
import com.echothree.model.data.core.server.entity.ServerService;
import com.echothree.model.data.core.server.entity.Service;
import com.echothree.model.data.core.server.entity.ServiceDescription;
import com.echothree.model.data.core.server.entity.TextDecoration;
import com.echothree.model.data.core.server.entity.TextDecorationDescription;
import com.echothree.model.data.core.server.entity.TextTransformation;
import com.echothree.model.data.core.server.entity.TextTransformationDescription;
import com.echothree.model.data.core.server.factory.AppearanceDescriptionFactory;
import com.echothree.model.data.core.server.factory.AppearanceDetailFactory;
import com.echothree.model.data.core.server.factory.AppearanceFactory;
import com.echothree.model.data.core.server.factory.AppearanceTextDecorationFactory;
import com.echothree.model.data.core.server.factory.AppearanceTextTransformationFactory;
import com.echothree.model.data.core.server.factory.ApplicationDescriptionFactory;
import com.echothree.model.data.core.server.factory.ApplicationDetailFactory;
import com.echothree.model.data.core.server.factory.ApplicationEditorDetailFactory;
import com.echothree.model.data.core.server.factory.ApplicationEditorFactory;
import com.echothree.model.data.core.server.factory.ApplicationEditorUseDescriptionFactory;
import com.echothree.model.data.core.server.factory.ApplicationEditorUseDetailFactory;
import com.echothree.model.data.core.server.factory.ApplicationEditorUseFactory;
import com.echothree.model.data.core.server.factory.ApplicationFactory;
import com.echothree.model.data.core.server.factory.BaseEncryptionKeyFactory;
import com.echothree.model.data.core.server.factory.CacheBlobEntryFactory;
import com.echothree.model.data.core.server.factory.CacheClobEntryFactory;
import com.echothree.model.data.core.server.factory.CacheEntryDependencyFactory;
import com.echothree.model.data.core.server.factory.CacheEntryFactory;
import com.echothree.model.data.core.server.factory.ColorDescriptionFactory;
import com.echothree.model.data.core.server.factory.ColorDetailFactory;
import com.echothree.model.data.core.server.factory.ColorFactory;
import com.echothree.model.data.core.server.factory.CommandDescriptionFactory;
import com.echothree.model.data.core.server.factory.CommandDetailFactory;
import com.echothree.model.data.core.server.factory.CommandFactory;
import com.echothree.model.data.core.server.factory.CommandMessageDetailFactory;
import com.echothree.model.data.core.server.factory.CommandMessageFactory;
import com.echothree.model.data.core.server.factory.CommandMessageTranslationFactory;
import com.echothree.model.data.core.server.factory.CommandMessageTypeDescriptionFactory;
import com.echothree.model.data.core.server.factory.CommandMessageTypeDetailFactory;
import com.echothree.model.data.core.server.factory.CommandMessageTypeFactory;
import com.echothree.model.data.core.server.factory.ComponentDetailFactory;
import com.echothree.model.data.core.server.factory.ComponentFactory;
import com.echothree.model.data.core.server.factory.ComponentStageFactory;
import com.echothree.model.data.core.server.factory.ComponentVendorDetailFactory;
import com.echothree.model.data.core.server.factory.ComponentVendorFactory;
import com.echothree.model.data.core.server.factory.ComponentVersionFactory;
import com.echothree.model.data.core.server.factory.EditorDescriptionFactory;
import com.echothree.model.data.core.server.factory.EditorDetailFactory;
import com.echothree.model.data.core.server.factory.EditorFactory;
import com.echothree.model.data.core.server.factory.EntityAliasFactory;
import com.echothree.model.data.core.server.factory.EntityAliasTypeDescriptionFactory;
import com.echothree.model.data.core.server.factory.EntityAliasTypeDetailFactory;
import com.echothree.model.data.core.server.factory.EntityAliasTypeFactory;
import com.echothree.model.data.core.server.factory.EntityAppearanceFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeBlobFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeDescriptionFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeDetailFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeEntityAttributeGroupFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeEntityTypeFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeGroupDescriptionFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeGroupDetailFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeGroupFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeIntegerFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeListItemFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeLongFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeNumericFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeStringFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeTypeDescriptionFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeTypeFactory;
import com.echothree.model.data.core.server.factory.EntityAttributeWorkflowFactory;
import com.echothree.model.data.core.server.factory.EntityBlobAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityBooleanAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityBooleanDefaultFactory;
import com.echothree.model.data.core.server.factory.EntityClobAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityCollectionAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityDateAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityEncryptionKeyFactory;
import com.echothree.model.data.core.server.factory.EntityEntityAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityGeoPointAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityInstanceFactory;
import com.echothree.model.data.core.server.factory.EntityIntegerAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityIntegerDefaultFactory;
import com.echothree.model.data.core.server.factory.EntityIntegerRangeDescriptionFactory;
import com.echothree.model.data.core.server.factory.EntityIntegerRangeDetailFactory;
import com.echothree.model.data.core.server.factory.EntityIntegerRangeFactory;
import com.echothree.model.data.core.server.factory.EntityListItemAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityListItemDefaultFactory;
import com.echothree.model.data.core.server.factory.EntityListItemDescriptionFactory;
import com.echothree.model.data.core.server.factory.EntityListItemDetailFactory;
import com.echothree.model.data.core.server.factory.EntityListItemFactory;
import com.echothree.model.data.core.server.factory.EntityLongAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityLongDefaultFactory;
import com.echothree.model.data.core.server.factory.EntityLongRangeDescriptionFactory;
import com.echothree.model.data.core.server.factory.EntityLongRangeDetailFactory;
import com.echothree.model.data.core.server.factory.EntityLongRangeFactory;
import com.echothree.model.data.core.server.factory.EntityMultipleListItemAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityNameAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityStringAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityStringDefaultFactory;
import com.echothree.model.data.core.server.factory.EntityTimeAttributeFactory;
import com.echothree.model.data.core.server.factory.EntityTimeFactory;
import com.echothree.model.data.core.server.factory.EntityTypeDescriptionFactory;
import com.echothree.model.data.core.server.factory.EntityTypeDetailFactory;
import com.echothree.model.data.core.server.factory.EntityTypeFactory;
import com.echothree.model.data.core.server.factory.EntityVisitFactory;
import com.echothree.model.data.core.server.factory.EventFactory;
import com.echothree.model.data.core.server.factory.EventGroupDetailFactory;
import com.echothree.model.data.core.server.factory.EventGroupFactory;
import com.echothree.model.data.core.server.factory.EventSubscriberDetailFactory;
import com.echothree.model.data.core.server.factory.EventSubscriberEntityInstanceFactory;
import com.echothree.model.data.core.server.factory.EventSubscriberEntityTypeFactory;
import com.echothree.model.data.core.server.factory.EventSubscriberEventTypeFactory;
import com.echothree.model.data.core.server.factory.EventSubscriberFactory;
import com.echothree.model.data.core.server.factory.EventTypeDescriptionFactory;
import com.echothree.model.data.core.server.factory.EventTypeFactory;
import com.echothree.model.data.core.server.factory.FontStyleDescriptionFactory;
import com.echothree.model.data.core.server.factory.FontStyleDetailFactory;
import com.echothree.model.data.core.server.factory.FontStyleFactory;
import com.echothree.model.data.core.server.factory.FontWeightDescriptionFactory;
import com.echothree.model.data.core.server.factory.FontWeightDetailFactory;
import com.echothree.model.data.core.server.factory.FontWeightFactory;
import com.echothree.model.data.core.server.factory.MimeTypeDescriptionFactory;
import com.echothree.model.data.core.server.factory.MimeTypeDetailFactory;
import com.echothree.model.data.core.server.factory.MimeTypeFactory;
import com.echothree.model.data.core.server.factory.MimeTypeFileExtensionFactory;
import com.echothree.model.data.core.server.factory.MimeTypeUsageFactory;
import com.echothree.model.data.core.server.factory.MimeTypeUsageTypeDescriptionFactory;
import com.echothree.model.data.core.server.factory.MimeTypeUsageTypeFactory;
import com.echothree.model.data.core.server.factory.PartyApplicationEditorUseDetailFactory;
import com.echothree.model.data.core.server.factory.PartyApplicationEditorUseFactory;
import com.echothree.model.data.core.server.factory.PartyEntityTypeFactory;
import com.echothree.model.data.core.server.factory.ProtocolDescriptionFactory;
import com.echothree.model.data.core.server.factory.ProtocolDetailFactory;
import com.echothree.model.data.core.server.factory.ProtocolFactory;
import com.echothree.model.data.core.server.factory.QueuedEventFactory;
import com.echothree.model.data.core.server.factory.QueuedSubscriberEventFactory;
import com.echothree.model.data.core.server.factory.ServerDescriptionFactory;
import com.echothree.model.data.core.server.factory.ServerDetailFactory;
import com.echothree.model.data.core.server.factory.ServerFactory;
import com.echothree.model.data.core.server.factory.ServerServiceFactory;
import com.echothree.model.data.core.server.factory.ServiceDescriptionFactory;
import com.echothree.model.data.core.server.factory.ServiceDetailFactory;
import com.echothree.model.data.core.server.factory.ServiceFactory;
import com.echothree.model.data.core.server.factory.TextDecorationDescriptionFactory;
import com.echothree.model.data.core.server.factory.TextDecorationDetailFactory;
import com.echothree.model.data.core.server.factory.TextDecorationFactory;
import com.echothree.model.data.core.server.factory.TextTransformationDescriptionFactory;
import com.echothree.model.data.core.server.factory.TextTransformationDetailFactory;
import com.echothree.model.data.core.server.factory.TextTransformationFactory;
import com.echothree.model.data.core.server.value.AppearanceDescriptionValue;
import com.echothree.model.data.core.server.value.AppearanceDetailValue;
import com.echothree.model.data.core.server.value.AppearanceTextDecorationValue;
import com.echothree.model.data.core.server.value.AppearanceTextTransformationValue;
import com.echothree.model.data.core.server.value.ApplicationDescriptionValue;
import com.echothree.model.data.core.server.value.ApplicationDetailValue;
import com.echothree.model.data.core.server.value.ApplicationEditorDetailValue;
import com.echothree.model.data.core.server.value.ApplicationEditorUseDescriptionValue;
import com.echothree.model.data.core.server.value.ApplicationEditorUseDetailValue;
import com.echothree.model.data.core.server.value.CacheEntryDependencyValue;
import com.echothree.model.data.core.server.value.ColorDescriptionValue;
import com.echothree.model.data.core.server.value.ColorDetailValue;
import com.echothree.model.data.core.server.value.CommandDescriptionValue;
import com.echothree.model.data.core.server.value.CommandDetailValue;
import com.echothree.model.data.core.server.value.CommandMessageDetailValue;
import com.echothree.model.data.core.server.value.CommandMessageTranslationValue;
import com.echothree.model.data.core.server.value.CommandMessageTypeDescriptionValue;
import com.echothree.model.data.core.server.value.CommandMessageTypeDetailValue;
import com.echothree.model.data.core.server.value.ComponentVendorDetailValue;
import com.echothree.model.data.core.server.value.EditorDescriptionValue;
import com.echothree.model.data.core.server.value.EditorDetailValue;
import com.echothree.model.data.core.server.value.EntityAliasTypeDescriptionValue;
import com.echothree.model.data.core.server.value.EntityAliasTypeDetailValue;
import com.echothree.model.data.core.server.value.EntityAliasValue;
import com.echothree.model.data.core.server.value.EntityAppearanceValue;
import com.echothree.model.data.core.server.value.EntityAttributeBlobValue;
import com.echothree.model.data.core.server.value.EntityAttributeDescriptionValue;
import com.echothree.model.data.core.server.value.EntityAttributeDetailValue;
import com.echothree.model.data.core.server.value.EntityAttributeEntityAttributeGroupValue;
import com.echothree.model.data.core.server.value.EntityAttributeGroupDescriptionValue;
import com.echothree.model.data.core.server.value.EntityAttributeGroupDetailValue;
import com.echothree.model.data.core.server.value.EntityAttributeIntegerValue;
import com.echothree.model.data.core.server.value.EntityAttributeListItemValue;
import com.echothree.model.data.core.server.value.EntityAttributeLongValue;
import com.echothree.model.data.core.server.value.EntityAttributeNumericValue;
import com.echothree.model.data.core.server.value.EntityAttributeStringValue;
import com.echothree.model.data.core.server.value.EntityAttributeWorkflowValue;
import com.echothree.model.data.core.server.value.EntityBlobAttributeValue;
import com.echothree.model.data.core.server.value.EntityBooleanAttributeValue;
import com.echothree.model.data.core.server.value.EntityBooleanDefaultValue;
import com.echothree.model.data.core.server.value.EntityClobAttributeValue;
import com.echothree.model.data.core.server.value.EntityDateAttributeValue;
import com.echothree.model.data.core.server.value.EntityEntityAttributeValue;
import com.echothree.model.data.core.server.value.EntityGeoPointAttributeValue;
import com.echothree.model.data.core.server.value.EntityIntegerAttributeValue;
import com.echothree.model.data.core.server.value.EntityIntegerDefaultValue;
import com.echothree.model.data.core.server.value.EntityIntegerRangeDescriptionValue;
import com.echothree.model.data.core.server.value.EntityIntegerRangeDetailValue;
import com.echothree.model.data.core.server.value.EntityListItemAttributeValue;
import com.echothree.model.data.core.server.value.EntityListItemDefaultValue;
import com.echothree.model.data.core.server.value.EntityListItemDescriptionValue;
import com.echothree.model.data.core.server.value.EntityListItemDetailValue;
import com.echothree.model.data.core.server.value.EntityLongAttributeValue;
import com.echothree.model.data.core.server.value.EntityLongDefaultValue;
import com.echothree.model.data.core.server.value.EntityLongRangeDescriptionValue;
import com.echothree.model.data.core.server.value.EntityLongRangeDetailValue;
import com.echothree.model.data.core.server.value.EntityNameAttributeValue;
import com.echothree.model.data.core.server.value.EntityStringAttributeValue;
import com.echothree.model.data.core.server.value.EntityStringDefaultValue;
import com.echothree.model.data.core.server.value.EntityTimeAttributeValue;
import com.echothree.model.data.core.server.value.EntityTypeDescriptionValue;
import com.echothree.model.data.core.server.value.EntityTypeDetailValue;
import com.echothree.model.data.core.server.value.EventGroupDetailValue;
import com.echothree.model.data.core.server.value.FontStyleDescriptionValue;
import com.echothree.model.data.core.server.value.FontStyleDetailValue;
import com.echothree.model.data.core.server.value.FontWeightDescriptionValue;
import com.echothree.model.data.core.server.value.FontWeightDetailValue;
import com.echothree.model.data.core.server.value.MimeTypeDescriptionValue;
import com.echothree.model.data.core.server.value.MimeTypeDetailValue;
import com.echothree.model.data.core.server.value.PartyApplicationEditorUseDetailValue;
import com.echothree.model.data.core.server.value.PartyEntityTypeValue;
import com.echothree.model.data.core.server.value.ProtocolDescriptionValue;
import com.echothree.model.data.core.server.value.ProtocolDetailValue;
import com.echothree.model.data.core.server.value.ServerDescriptionValue;
import com.echothree.model.data.core.server.value.ServerDetailValue;
import com.echothree.model.data.core.server.value.ServerServiceValue;
import com.echothree.model.data.core.server.value.ServiceDescriptionValue;
import com.echothree.model.data.core.server.value.ServiceDetailValue;
import com.echothree.model.data.core.server.value.TextDecorationDescriptionValue;
import com.echothree.model.data.core.server.value.TextDecorationDetailValue;
import com.echothree.model.data.core.server.value.TextTransformationDescriptionValue;
import com.echothree.model.data.core.server.value.TextTransformationDetailValue;
import com.echothree.model.data.party.common.pk.PartyPK;
import com.echothree.model.data.party.server.entity.Language;
import com.echothree.model.data.party.server.entity.Party;
import com.echothree.model.data.sequence.server.entity.Sequence;
import com.echothree.model.data.uom.server.entity.UnitOfMeasureType;
import com.echothree.model.data.user.server.entity.UserVisit;
import com.echothree.model.data.workflow.server.entity.Workflow;
import com.echothree.util.common.exception.PersistenceDatabaseException;
import com.echothree.util.common.message.ExecutionErrors;
import com.echothree.util.common.persistence.BaseKey;
import com.echothree.util.common.persistence.BasePK;
import com.echothree.util.common.persistence.type.ByteArray;
import com.echothree.util.server.kafka.EventTopic;
import com.echothree.util.server.message.ExecutionErrorAccumulator;
import com.echothree.util.server.persistence.BaseEntity;
import com.echothree.util.server.persistence.EntityPermission;
import com.echothree.util.server.persistence.Session;
import com.echothree.util.server.persistence.Sha1Utils;
import com.echothree.util.server.string.EntityInstanceUtils;
import com.echothree.util.server.string.UuidUtils;
import com.google.common.base.Splitter;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;

public class CoreControl
        extends BaseCoreControl {
    
    /** Creates a new instance of CoreControl */
    public CoreControl() {
        super();
    }
    
    // --------------------------------------------------------------------------------
    //   Component Vendors
    // --------------------------------------------------------------------------------
    
    public ComponentVendor createComponentVendor(String componentVendorName, String description, BasePK createdBy) {
        var componentVendor = ComponentVendorFactory.getInstance().create();
        var componentVendorDetail = ComponentVendorDetailFactory.getInstance().create(componentVendor,
                componentVendorName, description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        // Convert to R/W
        componentVendor = ComponentVendorFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                componentVendor.getPrimaryKey());
        componentVendor.setActiveDetail(componentVendorDetail);
        componentVendor.setLastDetail(componentVendorDetail);
        componentVendor.store();
        
        sendEvent(componentVendor.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return componentVendor;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.ComponentVendor */
    public ComponentVendor getComponentVendorByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new ComponentVendorPK(entityInstance.getEntityUniqueId());

        return ComponentVendorFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public ComponentVendor getComponentVendorByEntityInstance(EntityInstance entityInstance) {
        return getComponentVendorByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public ComponentVendor getComponentVendorByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getComponentVendorByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public long countComponentVendors() {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM componentvendors, componentvendordetails " +
                "WHERE cvnd_activedetailid = cvndd_componentvendordetailid");
    }

    public ComponentVendor getComponentVendorByName(String componentVendorName, EntityPermission entityPermission) {
        ComponentVendor componentVendor;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM componentvendors, componentvendordetails " +
                        "WHERE cvnd_activedetailid = cvndd_componentvendordetailid AND cvndd_componentvendorname = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM componentvendors, componentvendordetails " +
                        "WHERE cvnd_activedetailid = cvndd_componentvendordetailid AND cvndd_componentvendorname = ? " +
                        "FOR UPDATE";
            }

            var ps = ComponentVendorFactory.getInstance().prepareStatement(query);
            
            ps.setString(1, componentVendorName);
            
            componentVendor = ComponentVendorFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return componentVendor;
    }
    
    public ComponentVendor getComponentVendorByName(String componentVendorName) {
        return getComponentVendorByName(componentVendorName, EntityPermission.READ_ONLY);
    }
    
    public ComponentVendor getComponentVendorByNameForUpdate(String componentVendorName) {
        return getComponentVendorByName(componentVendorName, EntityPermission.READ_WRITE);
    }

    public ComponentVendorDetailValue getComponentVendorDetailValueForUpdate(ComponentVendor componentVendor) {
        return componentVendor == null? null: componentVendor.getLastDetailForUpdate().getComponentVendorDetailValue().clone();
    }
    
    public ComponentVendorDetailValue getComponentVendorDetailValueByNameForUpdate(String componentVendorName) {
        return getComponentVendorDetailValueForUpdate(getComponentVendorByNameForUpdate(componentVendorName));
    }
    
    private final Map<String, ComponentVendor> componentVendorCache = new HashMap<>();
    
    public ComponentVendor getComponentVendorByNameFromCache(String componentVendorName) {
        var componentVendor = componentVendorCache.get(componentVendorName);
        
        if(componentVendor == null) {
            componentVendor = getComponentVendorByName(componentVendorName);
            
            if(componentVendor != null) {
                componentVendorCache.put(componentVendorName, componentVendor);
            }
        }
        
        return componentVendor;
    }
    
    public List<ComponentVendor> getComponentVendors() {
        var ps = ComponentVendorFactory.getInstance().prepareStatement(
                "SELECT _ALL_ " +
                "FROM componentvendors, componentvendordetails " +
                "WHERE cvnd_activedetailid = cvndd_componentvendordetailid " +
                "ORDER BY cvndd_componentvendorname " +
                "_LIMIT_");
        
        return ComponentVendorFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
    }
    
    public ComponentVendorTransfer getComponentVendorTransfer(UserVisit userVisit, ComponentVendor componentVendor) {
        return getCoreTransferCaches(userVisit).getComponentVendorTransferCache().getComponentVendorTransfer(componentVendor);
    }

    public List<ComponentVendorTransfer> getComponentVendorTransfers(UserVisit userVisit, Collection<ComponentVendor> componentVendors) {
        var componentVendorTransfers = new ArrayList<ComponentVendorTransfer>(componentVendors.size());
        var componentVendorTransferCache = getCoreTransferCaches(userVisit).getComponentVendorTransferCache();

        componentVendors.forEach((componentVendor) ->
                componentVendorTransfers.add(componentVendorTransferCache.getComponentVendorTransfer(componentVendor))
        );

        return componentVendorTransfers;
    }

    public List<ComponentVendorTransfer> getComponentVendorTransfers(UserVisit userVisit) {
        return getComponentVendorTransfers(userVisit, getComponentVendors());
    }

    public void updateComponentVendorFromValue(ComponentVendorDetailValue componentVendorDetailValue, BasePK updatedBy) {
        if(componentVendorDetailValue.hasBeenModified()) {
            var componentVendor = ComponentVendorFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     componentVendorDetailValue.getComponentVendorPK());
            var componentVendorDetail = componentVendor.getActiveDetailForUpdate();
            
            componentVendorDetail.setThruTime(session.START_TIME_LONG);
            componentVendorDetail.store();

            var componentVendorPK = componentVendorDetail.getComponentVendorPK();
            var componentVendorName = componentVendorDetailValue.getComponentVendorName();
            var description = componentVendorDetailValue.getDescription();
            
            componentVendorDetail = ComponentVendorDetailFactory.getInstance().create(componentVendorPK,
                    componentVendorName, description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            componentVendor.setActiveDetail(componentVendorDetail);
            componentVendor.setLastDetail(componentVendorDetail);
            
            sendEvent(componentVendorPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public ComponentVendor getComponentVendorByPK(ComponentVendorPK pk) {
        return ComponentVendorFactory.getInstance().getEntityFromPK(EntityPermission.READ_ONLY, pk);
    }

    public void deleteComponentVendor(ComponentVendor componentVendor, BasePK deletedBy) {
        deleteEntityTypesByComponentVendor(componentVendor, deletedBy);
        
        var componentVendorDetail = componentVendor.getLastDetailForUpdate();
        componentVendorDetail.setThruTime(session.START_TIME_LONG);
        componentVendor.setActiveDetail(null);
        componentVendor.store();
        
        sendEvent(componentVendor.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Types
    // --------------------------------------------------------------------------------
    
    public EntityType createEntityType(ComponentVendor componentVendor, String entityTypeName, Boolean keepAllHistory,
            Long lockTimeout, Boolean isExtensible, Integer sortOrder, BasePK createdBy) {
        var entityType = EntityTypeFactory.getInstance().create();
        var entityTypeDetail = EntityTypeDetailFactory.getInstance().create(entityType, componentVendor,
                entityTypeName, keepAllHistory, lockTimeout, isExtensible, sortOrder, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);
        
        // Convert to R/W
        entityType = EntityTypeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, entityType.getPrimaryKey());
        entityType.setActiveDetail(entityTypeDetail);
        entityType.setLastDetail(entityTypeDetail);
        entityType.store();
        
        sendEvent(entityType.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return entityType;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.EntityType */
    public EntityType getEntityTypeByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new EntityTypePK(entityInstance.getEntityUniqueId());

        return EntityTypeFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public EntityType getEntityTypeByEntityInstance(EntityInstance entityInstance) {
        return getEntityTypeByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public EntityType getEntityTypeByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getEntityTypeByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }
    
    public long countEntityTypes() {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entitytypes, entitytypedetails " +
                "WHERE ent_activedetailid = entdt_entitytypedetailid");
    }

    public long countEntityTypesByComponentVendor(ComponentVendor componentVendor) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entitytypes, entitytypedetails " +
                "WHERE ent_activedetailid = entdt_entitytypedetailid AND entdt_cvnd_componentvendorid = ?",
                componentVendor);
    }

    public EntityType getEntityTypeByName(ComponentVendor componentVendor, String entityTypeName, EntityPermission entityPermission) {
        EntityType entityType;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitytypes, entitytypedetails " +
                        "WHERE ent_activedetailid = entdt_entitytypedetailid " +
                        "AND entdt_cvnd_componentvendorid = ? AND entdt_entitytypename = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitytypes, entitytypedetails " +
                        "WHERE ent_activedetailid = entdt_entitytypedetailid " +
                        "AND entdt_cvnd_componentvendorid = ? AND entdt_entitytypename = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityTypeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, componentVendor.getPrimaryKey().getEntityId());
            ps.setString(2, entityTypeName);
            
            entityType = EntityTypeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityType;
    }
    
    public EntityType getEntityTypeByName(ComponentVendor componentVendor, String entityTypeName) {
        return getEntityTypeByName(componentVendor, entityTypeName, EntityPermission.READ_ONLY);
    }
    
    public EntityType getEntityTypeByNameForUpdate(ComponentVendor componentVendor, String entityTypeName) {
        return getEntityTypeByName(componentVendor, entityTypeName, EntityPermission.READ_WRITE);
    }
    
    public EntityTypeDetailValue getEntityTypeDetailValueForUpdate(EntityType entityType) {
        return entityType == null? null: entityType.getLastDetailForUpdate().getEntityTypeDetailValue().clone();
    }
    
    public EntityTypeDetailValue getEntityTypeDetailValueByNameForUpdate(ComponentVendor componentVendor, String entityTypeName) {
        return getEntityTypeDetailValueForUpdate(getEntityTypeByNameForUpdate(componentVendor, entityTypeName));
    }
    
    private final Map<ComponentVendor, Map<String, EntityType>> entityTypeCache = new HashMap<>();
    
    public EntityType getEntityTypeByNameFromCache(ComponentVendor componentVendor, String entityTypeName) {
        var cacheByComponentVendor = entityTypeCache.computeIfAbsent(componentVendor, k -> new HashMap<>());

        var entityType = cacheByComponentVendor.get(entityTypeName);
        
        if(entityType == null) {
            entityType = getEntityTypeByName(componentVendor, entityTypeName);
            
            if(entityType != null) {
                cacheByComponentVendor.put(entityTypeName, entityType);
            }
        }
        
        return entityType;
    }

    private List<EntityType> getEntityTypesByComponentVendor(ComponentVendor componentVendor, EntityPermission entityPermission) {
        List<EntityType> entityTypes;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ "
                        + "FROM entitytypes, entitytypedetails "
                        + "WHERE ent_activedetailid = entdt_entitytypedetailid "
                        + "AND entdt_cvnd_componentvendorid = ? "
                        + "ORDER BY entdt_sortorder, entdt_entitytypename "
                        + "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ "
                        + "FROM entitytypes, entitytypedetails "
                        + "WHERE ent_activedetailid = entdt_entitytypedetailid "
                        + "AND entdt_cvnd_componentvendorid = ? "
                        + "FOR UPDATE";
            }

            var ps = EntityTypeFactory.getInstance().prepareStatement(query);

            ps.setLong(1, componentVendor.getPrimaryKey().getEntityId());

            entityTypes = EntityTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityTypes;
    }

    public List<EntityType> getEntityTypesByComponentVendor(ComponentVendor componentVendor) {
        return getEntityTypesByComponentVendor(componentVendor, EntityPermission.READ_ONLY);
    }

    public List<EntityType> getEntityTypesByComponentVendorForUpdate(ComponentVendor componentVendor) {
        return getEntityTypesByComponentVendor(componentVendor, EntityPermission.READ_WRITE);
    }

    private List<EntityType> getEntityTypesByName(String entityTypeName, EntityPermission entityPermission) {
        List<EntityType> entityTypes;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ "
                        + "FROM entitytypes, entitytypedetails "
                        + "WHERE ent_activedetailid = entdt_entitytypedetailid "
                        + "AND entdt_entitytypename = ? "
                        + "ORDER BY entdt_sortorder, entdt_entitytypename "
                        + "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ "
                        + "FROM entitytypes, entitytypedetails "
                        + "WHERE ent_activedetailid = entdt_entitytypedetailid "
                        + "AND entdt_entitytypename = ? "
                        + "FOR UPDATE";
            }

            var ps = EntityTypeFactory.getInstance().prepareStatement(query);

            ps.setString(1, entityTypeName);

            entityTypes = EntityTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityTypes;
    }

    public List<EntityType> getEntityTypesByName(String entityTypeName) {
        return getEntityTypesByName(entityTypeName, EntityPermission.READ_ONLY);
    }

    public List<EntityType> getEntityTypesByNameForUpdate(String entityTypeName) {
        return getEntityTypesByName(entityTypeName, EntityPermission.READ_WRITE);
    }

    public List<EntityType> getEntityTypes() {
        var ps = EntityTypeFactory.getInstance().prepareStatement(
                "SELECT _ALL_ "
                + "FROM entitytypes, entitytypedetails "
                + "WHERE ent_activedetailid = entdt_entitytypedetailid "
                + "ORDER BY entdt_sortorder, entdt_entitytypename "
                + "_LIMIT_");

        return EntityTypeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
    }
    
    public EntityTypeTransfer getEntityTypeTransfer(UserVisit userVisit, EntityType entityType) {
        return getCoreTransferCaches(userVisit).getEntityTypeTransferCache().getEntityTypeTransfer(entityType);
    }
    
    public List<EntityTypeTransfer> getEntityTypeTransfers(UserVisit userVisit, Collection<EntityType> entityTypes) {
        List<EntityTypeTransfer> entityTypeTransfers = new ArrayList<>(entityTypes.size());
        var entityTypeTransferCache = getCoreTransferCaches(userVisit).getEntityTypeTransferCache();
        
        entityTypes.forEach((entityType) ->
                entityTypeTransfers.add(entityTypeTransferCache.getEntityTypeTransfer(entityType))
        );
        
        return entityTypeTransfers;
    }
    
    public List<EntityTypeTransfer> getEntityTypeTransfers(UserVisit userVisit) {
        return getEntityTypeTransfers(userVisit, getEntityTypes());
    }
    
    public List<EntityTypeTransfer> getEntityTypeTransfersByComponentVendor(UserVisit userVisit, ComponentVendor componentVendor) {
        return getEntityTypeTransfers(userVisit, getEntityTypesByComponentVendor(componentVendor));
    }
    
    public void updateEntityTypeFromValue(EntityTypeDetailValue entityTypeDetailValue, BasePK updatedBy) {
        if(entityTypeDetailValue.hasBeenModified()) {
            var entityType = EntityTypeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityTypeDetailValue.getEntityTypePK());
            var entityTypeDetail = entityType.getActiveDetailForUpdate();
            
            entityTypeDetail.setThruTime(session.START_TIME_LONG);
            entityTypeDetail.store();

            var entityTypePK = entityTypeDetail.getEntityTypePK();
            var componentVendorPK = entityTypeDetail.getComponentVendorPK(); // Not updated
            var entityTypeName = entityTypeDetailValue.getEntityTypeName();
            var keepAllHistory = entityTypeDetailValue.getKeepAllHistory();
            var lockTimeout = entityTypeDetailValue.getLockTimeout();
            var isExtensible = entityTypeDetailValue.getIsExtensible();
            var sortOrder = entityTypeDetailValue.getSortOrder();
            
            entityTypeDetail = EntityTypeDetailFactory.getInstance().create(entityTypePK, componentVendorPK, entityTypeName,
                    keepAllHistory, lockTimeout, isExtensible, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            entityType.setActiveDetail(entityTypeDetail);
            entityType.setLastDetail(entityTypeDetail);
            
            sendEvent(entityTypePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public EntityType getEntityTypeByPK(EntityTypePK entityTypePK) {
        return EntityTypeFactory.getInstance().getEntityFromPK(EntityPermission.READ_ONLY, entityTypePK);
    }

    public void deleteEntityType(EntityType entityType, BasePK deletedBy) {
        var accountingControl = Session.getModelController(AccountingControl.class);
        var batchControl = Session.getModelController(BatchControl.class);
        var commentControl = Session.getModelController(CommentControl.class);
        var indexControl = Session.getModelController(IndexControl.class);
        var messageControl = Session.getModelController(MessageControl.class);
        var ratingControl = Session.getModelController(RatingControl.class);
        var tagControl = Session.getModelController(TagControl.class);
        var workflowControl = Session.getModelController(WorkflowControl.class);

        deleteEntityInstancesByEntityTypeWithNullDeletedTime(entityType, deletedBy);
        deleteEntityTypeDescriptionsByEntityType(entityType, deletedBy);
        deleteEntityAliasTypesByEntityType(entityType, deletedBy);
        deleteEntityAttributesByEntityType(entityType, deletedBy);
        deleteEntityAttributeEntityTypesByAllowedEntityType(entityType, deletedBy);
        accountingControl.deleteTransactionEntityRoleTypesByEntityType(entityType, deletedBy);
        batchControl.deleteBatchTypeEntityTypesByEntityType(entityType, deletedBy);
        commentControl.deleteCommentTypesByEntityType(entityType, deletedBy);
        indexControl.deleteIndexTypesByEntityType(entityType, deletedBy);
        messageControl.deleteMessageTypesByEntityType(entityType, deletedBy);
        ratingControl.deleteRatingTypesByEntityType(entityType, deletedBy);
        tagControl.deleteTagScopeEntityTypesByEntityType(entityType, deletedBy);
        workflowControl.deleteWorkflowEntityTypesByEntityType(entityType, deletedBy);

        var entityTypeDetail = entityType.getLastDetailForUpdate();
        entityTypeDetail.setThruTime(session.START_TIME_LONG);
        entityType.setActiveDetail(null);
        entityType.store();
        
        sendEvent(entityType.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }
    
    public void deleteEntityTypesByComponentVendor(ComponentVendor componentVendor, BasePK deletedBy) {
        var entityTypes = getEntityTypesByComponentVendorForUpdate(componentVendor);
        
        entityTypes.forEach((entityType) -> 
                deleteEntityType(entityType, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Type Descriptions
    // --------------------------------------------------------------------------------
    
    public EntityTypeDescription createEntityTypeDescription(EntityType entityType, Language language, String description,
            BasePK createdBy) {
        var entityTypeDescription = EntityTypeDescriptionFactory.getInstance().create(entityType,
                language, description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityType.getPrimaryKey(), EventTypes.MODIFY, entityTypeDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityTypeDescription;
    }
    
    private EntityTypeDescription getEntityTypeDescription(EntityType entityType, Language language,
            EntityPermission entityPermission) {
        EntityTypeDescription entityTypeDescription;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitytypedescriptions " +
                        "WHERE entd_ent_entitytypeid = ? AND entd_lang_languageid = ? AND entd_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitytypedescriptions " +
                        "WHERE entd_ent_entitytypeid = ? AND entd_lang_languageid = ? AND entd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityTypeDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityTypeDescription = EntityTypeDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityTypeDescription;
    }
    
    public EntityTypeDescription getEntityTypeDescription(EntityType entityType, Language language) {
        return getEntityTypeDescription(entityType, language, EntityPermission.READ_ONLY);
    }
    
    public EntityTypeDescription getEntityTypeDescriptionForUpdate(EntityType entityType, Language language) {
        return getEntityTypeDescription(entityType, language, EntityPermission.READ_WRITE);
    }
    
    public EntityTypeDescriptionValue getEntityTypeDescriptionValue(EntityTypeDescription entityTypeDescription) {
        return entityTypeDescription == null? null: entityTypeDescription.getEntityTypeDescriptionValue().clone();
    }
    
    public EntityTypeDescriptionValue getEntityTypeDescriptionValueForUpdate(EntityType entityType, Language language) {
        return getEntityTypeDescriptionValue(getEntityTypeDescriptionForUpdate(entityType, language));
    }
    
    private List<EntityTypeDescription> getEntityTypeDescriptionsByEntityType(EntityType entityType,
            EntityPermission entityPermission) {
        List<EntityTypeDescription> entityTypeDescriptions;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitytypedescriptions, languages " +
                        "WHERE entd_ent_entitytypeid = ? AND entd_thrutime = ? AND entd_lang_languageid = lang_languageid " +
                        "ORDER BY lang_sortorder, lang_languageisoname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitytypedescriptions " +
                        "WHERE entd_ent_entitytypeid = ? AND entd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityTypeDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityTypeDescriptions = EntityTypeDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityTypeDescriptions;
    }
    
    public List<EntityTypeDescription> getEntityTypeDescriptionsByEntityType(EntityType entityType) {
        return getEntityTypeDescriptionsByEntityType(entityType, EntityPermission.READ_ONLY);
    }
    
    public List<EntityTypeDescription> getEntityTypeDescriptionsByEntityTypeForUpdate(EntityType entityType) {
        return getEntityTypeDescriptionsByEntityType(entityType, EntityPermission.READ_WRITE);
    }
    
    public String getBestEntityTypeDescription(EntityType entityType, Language language) {
        String description;
        var entityTypeDescription = getEntityTypeDescription(entityType, language);
        
        if(entityTypeDescription == null && !language.getIsDefault()) {
            entityTypeDescription = getEntityTypeDescription(entityType, getPartyControl().getDefaultLanguage());
        }
        
        if(entityTypeDescription == null) {
            description = entityType.getLastDetail().getEntityTypeName();
        } else {
            description = entityTypeDescription.getDescription();
        }
        
        return description;
    }
    
    public EntityTypeDescriptionTransfer getEntityTypeDescriptionTransfer(UserVisit userVisit, EntityTypeDescription entityTypeDescription) {
        return getCoreTransferCaches(userVisit).getEntityTypeDescriptionTransferCache().getEntityTypeDescriptionTransfer(entityTypeDescription);
    }
    
    public List<EntityTypeDescriptionTransfer> getEntityTypeDescriptionTransfersByEntityType(UserVisit userVisit,
            EntityType entityType) {
        var entityTypeDescriptions = getEntityTypeDescriptionsByEntityType(entityType);
        List<EntityTypeDescriptionTransfer> entityTypeDescriptionTransfers = new ArrayList<>(entityTypeDescriptions.size());
        var entityTypeDescriptionTransferCache = getCoreTransferCaches(userVisit).getEntityTypeDescriptionTransferCache();
        
        entityTypeDescriptions.forEach((entityTypeDescription) ->
                entityTypeDescriptionTransfers.add(entityTypeDescriptionTransferCache.getEntityTypeDescriptionTransfer(entityTypeDescription))
        );
        
        return entityTypeDescriptionTransfers;
    }
    
    public void updateEntityTypeDescriptionFromValue(EntityTypeDescriptionValue entityTypeDescriptionValue, BasePK updatedBy) {
        if(entityTypeDescriptionValue.hasBeenModified()) {
            var entityTypeDescription = EntityTypeDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityTypeDescriptionValue.getPrimaryKey());
            
            entityTypeDescription.setThruTime(session.START_TIME_LONG);
            entityTypeDescription.store();

            var entityType = entityTypeDescription.getEntityType();
            var language = entityTypeDescription.getLanguage();
            var description = entityTypeDescriptionValue.getDescription();
            
            entityTypeDescription = EntityTypeDescriptionFactory.getInstance().create(entityType, language,
                    description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityType.getPrimaryKey(), EventTypes.MODIFY, entityTypeDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityTypeDescription(EntityTypeDescription entityTypeDescription, BasePK deletedBy) {
        entityTypeDescription.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityTypeDescription.getEntityTypePK(), EventTypes.MODIFY, entityTypeDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityTypeDescriptionsByEntityType(EntityType entityType, BasePK deletedBy) {
        var entityTypeDescriptions = getEntityTypeDescriptionsByEntityTypeForUpdate(entityType);
        
        entityTypeDescriptions.forEach((entityTypeDescription) -> 
                deleteEntityTypeDescription(entityTypeDescription, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Commands
    // --------------------------------------------------------------------------------
    
    public Command createCommand(ComponentVendor componentVendor, String commandName, Integer sortOrder, BasePK createdBy) {
        var command = CommandFactory.getInstance().create();
        var commandDetail = CommandDetailFactory.getInstance().create(command, componentVendor,
                commandName, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        // Convert to R/W
        command = CommandFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, command.getPrimaryKey());
        command.setActiveDetail(commandDetail);
        command.setLastDetail(commandDetail);
        command.store();
        
        sendEvent(command.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return command;
    }
    
    private Command getCommandByName(ComponentVendor componentVendor, String commandName, EntityPermission entityPermission) {
        Command command;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM commands, commanddetails " +
                        "WHERE cmd_activedetailid = cmddt_commanddetailid " +
                        "AND cmddt_cvnd_componentvendorid = ? AND cmddt_commandname = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM commands, commanddetails " +
                        "WHERE cmd_activedetailid = cmddt_commanddetailid " +
                        "AND cmddt_cvnd_componentvendorid = ? AND cmddt_commandname = ? " +
                        "FOR UPDATE";
            }

            var ps = CommandFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, componentVendor.getPrimaryKey().getEntityId());
            ps.setString(2, commandName);
            
            command = CommandFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return command;
    }
    
    public Command getCommandByName(ComponentVendor componentVendor, String commandName) {
        return getCommandByName(componentVendor, commandName, EntityPermission.READ_ONLY);
    }
    
    public Command getCommandByNameForUpdate(ComponentVendor componentVendor, String commandName) {
        return getCommandByName(componentVendor, commandName, EntityPermission.READ_WRITE);
    }
    
    public CommandDetailValue getCommandDetailValueForUpdate(Command command) {
        return command == null? null: command.getLastDetailForUpdate().getCommandDetailValue().clone();
    }
    
    public CommandDetailValue getCommandDetailValueByNameForUpdate(ComponentVendor componentVendor, String commandName) {
        return getCommandDetailValueForUpdate(getCommandByNameForUpdate(componentVendor, commandName));
    }
    
    private List<Command> getCommandsByComponentVendor(ComponentVendor componentVendor, EntityPermission entityPermission) {
        List<Command> commands;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM commands, commanddetails " +
                        "WHERE cmd_activedetailid = cmddt_commanddetailid " +
                        "AND cmddt_cvnd_componentvendorid = ? " +
                        "ORDER BY cmddt_sortorder, cmddt_commandname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM commands, commanddetails " +
                        "WHERE cmd_activedetailid = cmddt_commanddetailid " +
                        "AND cmddt_cvnd_componentvendorid = ? " +
                        "FOR UPDATE";
            }

            var ps = CommandFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, componentVendor.getPrimaryKey().getEntityId());
            
            commands = CommandFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return commands;
    }
    
    public List<Command> getCommandsByComponentVendor(ComponentVendor componentVendor) {
        return getCommandsByComponentVendor(componentVendor, EntityPermission.READ_ONLY);
    }
    
    public List<Command> getCommandsByComponentVendorForUpdate(ComponentVendor componentVendor) {
        return getCommandsByComponentVendor(componentVendor, EntityPermission.READ_WRITE);
    }
    
    public List<Command> getCommands() {
        var ps = CommandFactory.getInstance().prepareStatement(
                "SELECT _ALL_ " +
                "FROM commands, commanddetails " +
                "WHERE cmd_activedetailid = cmddt_commanddetailid " +
                "ORDER BY cmddt_sortorder, cmddt_commandname");
        
        return CommandFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
    }
    
    public CommandTransfer getCommandTransfer(UserVisit userVisit, Command command) {
        return getCoreTransferCaches(userVisit).getCommandTransferCache().getCommandTransfer(command);
    }
    
    private List<CommandTransfer> getCommandTransfers(UserVisit userVisit, Collection<Command> commands) {
        List<CommandTransfer> commandTransfers = new ArrayList<>(commands.size());
        var commandTransferCache = getCoreTransferCaches(userVisit).getCommandTransferCache();
        
        commands.forEach((command) ->
                commandTransfers.add(commandTransferCache.getCommandTransfer(command))
        );
        
        return commandTransfers;
    }
    
    public List<CommandTransfer> getCommandTransfers(UserVisit userVisit) {
        return getCommandTransfers(userVisit, getCommands());
    }
    
    public List<CommandTransfer> getCommandTransfersByComponentVendor(UserVisit userVisit, ComponentVendor componentVendor) {
        return getCommandTransfers(userVisit, getCommandsByComponentVendor(componentVendor));
    }
    
    public void updateCommandFromValue(CommandDetailValue commandDetailValue, BasePK updatedBy) {
        if(commandDetailValue.hasBeenModified()) {
            var command = CommandFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     commandDetailValue.getCommandPK());
            var commandDetail = command.getActiveDetailForUpdate();
            
            commandDetail.setThruTime(session.START_TIME_LONG);
            commandDetail.store();

            var commandPK = commandDetail.getCommandPK();
            var componentVendorPK = commandDetail.getComponentVendorPK(); // Not updated
            var commandName = commandDetailValue.getCommandName();
            var sortOrder = commandDetailValue.getSortOrder();
            
            commandDetail = CommandDetailFactory.getInstance().create(commandPK, componentVendorPK, commandName,
                    sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            command.setActiveDetail(commandDetail);
            command.setLastDetail(commandDetail);
            
            sendEvent(commandPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }
    
    public void deleteCommand(Command command, BasePK deletedBy) {
        deleteCommandDescriptionsByCommand(command, deletedBy);

        var commandDetail = command.getLastDetailForUpdate();
        commandDetail.setThruTime(session.START_TIME_LONG);
        command.setActiveDetail(null);
        command.store();
        
        sendEvent(command.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }
    
    public void deleteCommandsByComponentVendor(ComponentVendor componentVendor, BasePK deletedBy) {
        var commands = getCommandsByComponentVendorForUpdate(componentVendor);
        
        commands.forEach((command) -> 
                deleteCommand(command, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Command Descriptions
    // --------------------------------------------------------------------------------
    
    public CommandDescription createCommandDescription(Command command, Language language, String description,
            BasePK createdBy) {
        var commandDescription = CommandDescriptionFactory.getInstance().create(command,
                language, description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(command.getPrimaryKey(), EventTypes.MODIFY, commandDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return commandDescription;
    }
    
    private CommandDescription getCommandDescription(Command command, Language language,
            EntityPermission entityPermission) {
        CommandDescription commandDescription;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM commanddescriptions " +
                        "WHERE cmdd_cmd_commandid = ? AND cmdd_lang_languageid = ? AND cmdd_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM commanddescriptions " +
                        "WHERE cmdd_cmd_commandid = ? AND cmdd_lang_languageid = ? AND cmdd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = CommandDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, command.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            commandDescription = CommandDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return commandDescription;
    }
    
    public CommandDescription getCommandDescription(Command command, Language language) {
        return getCommandDescription(command, language, EntityPermission.READ_ONLY);
    }
    
    public CommandDescription getCommandDescriptionForUpdate(Command command, Language language) {
        return getCommandDescription(command, language, EntityPermission.READ_WRITE);
    }
    
    public CommandDescriptionValue getCommandDescriptionValue(CommandDescription commandDescription) {
        return commandDescription == null? null: commandDescription.getCommandDescriptionValue().clone();
    }
    
    public CommandDescriptionValue getCommandDescriptionValueForUpdate(Command command, Language language) {
        return getCommandDescriptionValue(getCommandDescriptionForUpdate(command, language));
    }
    
    private List<CommandDescription> getCommandDescriptionsByCommand(Command command,
            EntityPermission entityPermission) {
        List<CommandDescription> commandDescriptions;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM commanddescriptions, languages " +
                        "WHERE cmdd_cmd_commandid = ? AND cmdd_thrutime = ? AND cmdd_lang_languageid = lang_languageid " +
                        "ORDER BY lang_sortorder, lang_languageisoname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM commanddescriptions " +
                        "WHERE cmdd_cmd_commandid = ? AND cmdd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = CommandDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, command.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            commandDescriptions = CommandDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return commandDescriptions;
    }
    
    public List<CommandDescription> getCommandDescriptionsByCommand(Command command) {
        return getCommandDescriptionsByCommand(command, EntityPermission.READ_ONLY);
    }
    
    public List<CommandDescription> getCommandDescriptionsByCommandForUpdate(Command command) {
        return getCommandDescriptionsByCommand(command, EntityPermission.READ_WRITE);
    }
    
    public String getBestCommandDescription(Command command, Language language) {
        String description;
        var commandDescription = getCommandDescription(command, language);
        
        if(commandDescription == null && !language.getIsDefault()) {
            commandDescription = getCommandDescription(command, getPartyControl().getDefaultLanguage());
        }
        
        if(commandDescription == null) {
            description = command.getLastDetail().getCommandName();
        } else {
            description = commandDescription.getDescription();
        }
        
        return description;
    }
    
    public CommandDescriptionTransfer getCommandDescriptionTransfer(UserVisit userVisit, CommandDescription commandDescription) {
        return getCoreTransferCaches(userVisit).getCommandDescriptionTransferCache().getCommandDescriptionTransfer(commandDescription);
    }
    
    public List<CommandDescriptionTransfer> getCommandDescriptionTransfersByCommand(UserVisit userVisit,
            Command command) {
        var commandDescriptions = getCommandDescriptionsByCommand(command);
        List<CommandDescriptionTransfer> commandDescriptionTransfers = new ArrayList<>(commandDescriptions.size());
        var commandDescriptionTransferCache = getCoreTransferCaches(userVisit).getCommandDescriptionTransferCache();
        
        commandDescriptions.forEach((commandDescription) ->
                commandDescriptionTransfers.add(commandDescriptionTransferCache.getCommandDescriptionTransfer(commandDescription))
        );
        
        return commandDescriptionTransfers;
    }
    
    public void updateCommandDescriptionFromValue(CommandDescriptionValue commandDescriptionValue, BasePK updatedBy) {
        if(commandDescriptionValue.hasBeenModified()) {
            var commandDescription = CommandDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     commandDescriptionValue.getPrimaryKey());
            
            commandDescription.setThruTime(session.START_TIME_LONG);
            commandDescription.store();

            var command = commandDescription.getCommand();
            var language = commandDescription.getLanguage();
            var description = commandDescriptionValue.getDescription();
            
            commandDescription = CommandDescriptionFactory.getInstance().create(command, language,
                    description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(command.getPrimaryKey(), EventTypes.MODIFY, commandDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteCommandDescription(CommandDescription commandDescription, BasePK deletedBy) {
        commandDescription.setThruTime(session.START_TIME_LONG);
        
        sendEvent(commandDescription.getCommandPK(), EventTypes.MODIFY, commandDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteCommandDescriptionsByCommand(Command command, BasePK deletedBy) {
        var commandDescriptions = getCommandDescriptionsByCommandForUpdate(command);
        
        commandDescriptions.forEach((commandDescription) -> 
                deleteCommandDescription(commandDescription, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Command Message Types
    // --------------------------------------------------------------------------------
    
    public CommandMessageType createCommandMessageType(String commandMessageTypeName, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultCommandMessageType = getDefaultCommandMessageType();
        var defaultFound = defaultCommandMessageType != null;
        
        if(defaultFound && isDefault) {
            var defaultCommandMessageTypeDetailValue = getDefaultCommandMessageTypeDetailValueForUpdate();
            
            defaultCommandMessageTypeDetailValue.setIsDefault(Boolean.FALSE);
            updateCommandMessageTypeFromValue(defaultCommandMessageTypeDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var commandMessageType = CommandMessageTypeFactory.getInstance().create();
        var commandMessageTypeDetail = CommandMessageTypeDetailFactory.getInstance().create(commandMessageType,
                commandMessageTypeName, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        // Convert to R/W
        commandMessageType = CommandMessageTypeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                commandMessageType.getPrimaryKey());
        commandMessageType.setActiveDetail(commandMessageTypeDetail);
        commandMessageType.setLastDetail(commandMessageTypeDetail);
        commandMessageType.store();
        
        sendEvent(commandMessageType.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return commandMessageType;
    }
    
    private List<CommandMessageType> getCommandMessageTypes(EntityPermission entityPermission) {
        String query = null;
        
        if(entityPermission.equals(EntityPermission.READ_ONLY)) {
            query = "SELECT _ALL_ " +
                    "FROM commandmessagetypes, commandmessagetypedetails " +
                    "WHERE cmdmssgty_activedetailid = cmdmssgtydt_commandmessagetypedetailid " +
                    "ORDER BY cmdmssgtydt_sortorder, cmdmssgtydt_commandmessagetypename";
        } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
            query = "SELECT _ALL_ " +
                    "FROM commandmessagetypes, commandmessagetypedetails " +
                    "WHERE cmdmssgty_activedetailid = cmdmssgtydt_commandmessagetypedetailid " +
                    "FOR UPDATE";
        }

        var ps = CommandMessageTypeFactory.getInstance().prepareStatement(query);
        
        return CommandMessageTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
    }
    
    public List<CommandMessageType> getCommandMessageTypes() {
        return getCommandMessageTypes(EntityPermission.READ_ONLY);
    }
    
    public List<CommandMessageType> getCommandMessageTypesForUpdate() {
        return getCommandMessageTypes(EntityPermission.READ_WRITE);
    }
    
    private CommandMessageType getDefaultCommandMessageType(EntityPermission entityPermission) {
        String query = null;
        
        if(entityPermission.equals(EntityPermission.READ_ONLY)) {
            query = "SELECT _ALL_ " +
                    "FROM commandmessagetypes, commandmessagetypedetails " +
                    "WHERE cmdmssgty_activedetailid = cmdmssgtydt_commandmessagetypedetailid AND cmdmssgtydt_isdefault = 1";
        } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
            query = "SELECT _ALL_ " +
                    "FROM commandmessagetypes, commandmessagetypedetails " +
                    "WHERE cmdmssgty_activedetailid = cmdmssgtydt_commandmessagetypedetailid AND cmdmssgtydt_isdefault = 1 " +
                    "FOR UPDATE";
        }

        var ps = CommandMessageTypeFactory.getInstance().prepareStatement(query);
        
        return CommandMessageTypeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
    }
    
    public CommandMessageType getDefaultCommandMessageType() {
        return getDefaultCommandMessageType(EntityPermission.READ_ONLY);
    }
    
    public CommandMessageType getDefaultCommandMessageTypeForUpdate() {
        return getDefaultCommandMessageType(EntityPermission.READ_WRITE);
    }
    
    public CommandMessageTypeDetailValue getDefaultCommandMessageTypeDetailValueForUpdate() {
        return getDefaultCommandMessageTypeForUpdate().getLastDetailForUpdate().getCommandMessageTypeDetailValue().clone();
    }
    
    private CommandMessageType getCommandMessageTypeByName(String commandMessageTypeName, EntityPermission entityPermission) {
        CommandMessageType commandMessageType;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessagetypes, commandmessagetypedetails " +
                        "WHERE cmdmssgty_activedetailid = cmdmssgtydt_commandmessagetypedetailid AND cmdmssgtydt_commandmessagetypename = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessagetypes, commandmessagetypedetails " +
                        "WHERE cmdmssgty_activedetailid = cmdmssgtydt_commandmessagetypedetailid AND cmdmssgtydt_commandmessagetypename = ? " +
                        "FOR UPDATE";
            }

            var ps = CommandMessageTypeFactory.getInstance().prepareStatement(query);
            
            ps.setString(1, commandMessageTypeName);
            
            commandMessageType = CommandMessageTypeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return commandMessageType;
    }
    
    public CommandMessageType getCommandMessageTypeByName(String commandMessageTypeName) {
        return getCommandMessageTypeByName(commandMessageTypeName, EntityPermission.READ_ONLY);
    }
    
    public CommandMessageType getCommandMessageTypeByNameForUpdate(String commandMessageTypeName) {
        return getCommandMessageTypeByName(commandMessageTypeName, EntityPermission.READ_WRITE);
    }
    
    public CommandMessageTypeDetailValue getCommandMessageTypeDetailValueForUpdate(CommandMessageType commandMessageType) {
        return commandMessageType == null? null: commandMessageType.getLastDetailForUpdate().getCommandMessageTypeDetailValue().clone();
    }
    
    public CommandMessageTypeDetailValue getCommandMessageTypeDetailValueByNameForUpdate(String commandMessageTypeName) {
        return getCommandMessageTypeDetailValueForUpdate(getCommandMessageTypeByNameForUpdate(commandMessageTypeName));
    }
    
    public CommandMessageTypeChoicesBean getCommandMessageTypeChoices(String defaultCommandMessageTypeChoice, Language language,
            boolean allowNullChoice) {
        var commandMessageTypes = getCommandMessageTypes();
        var size = commandMessageTypes.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;
        
        if(allowNullChoice) {
            labels.add("");
            values.add("");
            
            if(defaultCommandMessageTypeChoice == null) {
                defaultValue = "";
            }
        }
        
        for(var commandMessageType : commandMessageTypes) {
            var commandMessageTypeDetail = commandMessageType.getLastDetail();
            var label = getBestCommandMessageTypeDescription(commandMessageType, language);
            var value = commandMessageTypeDetail.getCommandMessageTypeName();
            
            labels.add(label == null? value: label);
            values.add(value);
            
            var usingDefaultChoice = defaultCommandMessageTypeChoice != null && defaultCommandMessageTypeChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && commandMessageTypeDetail.getIsDefault())) {
                defaultValue = value;
            }
        }
        
        return new CommandMessageTypeChoicesBean(labels, values, defaultValue);
    }
    
    public CommandMessageTypeTransfer getCommandMessageTypeTransfer(UserVisit userVisit, CommandMessageType commandMessageType) {
        return getCoreTransferCaches(userVisit).getCommandMessageTypeTransferCache().getCommandMessageTypeTransfer(commandMessageType);
    }
    
    public List<CommandMessageTypeTransfer> getCommandMessageTypeTransfers(UserVisit userVisit) {
        var commandMessageTypes = getCommandMessageTypes();
        List<CommandMessageTypeTransfer> commandMessageTypeTransfers = new ArrayList<>(commandMessageTypes.size());
        var commandMessageTypeTransferCache = getCoreTransferCaches(userVisit).getCommandMessageTypeTransferCache();
        
        commandMessageTypes.forEach((commandMessageType) ->
                commandMessageTypeTransfers.add(commandMessageTypeTransferCache.getCommandMessageTypeTransfer(commandMessageType))
        );
        
        return commandMessageTypeTransfers;
    }
    
    private void updateCommandMessageTypeFromValue(CommandMessageTypeDetailValue commandMessageTypeDetailValue, boolean checkDefault,
            BasePK updatedBy) {
        if(commandMessageTypeDetailValue.hasBeenModified()) {
            var commandMessageType = CommandMessageTypeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     commandMessageTypeDetailValue.getCommandMessageTypePK());
            var commandMessageTypeDetail = commandMessageType.getActiveDetailForUpdate();
            
            commandMessageTypeDetail.setThruTime(session.START_TIME_LONG);
            commandMessageTypeDetail.store();

            var commandMessageTypePK = commandMessageTypeDetail.getCommandMessageTypePK();
            var commandMessageTypeName = commandMessageTypeDetailValue.getCommandMessageTypeName();
            var isDefault = commandMessageTypeDetailValue.getIsDefault();
            var sortOrder = commandMessageTypeDetailValue.getSortOrder();
            
            if(checkDefault) {
                var defaultCommandMessageType = getDefaultCommandMessageType();
                var defaultFound = defaultCommandMessageType != null && !defaultCommandMessageType.equals(commandMessageType);
                
                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultCommandMessageTypeDetailValue = getDefaultCommandMessageTypeDetailValueForUpdate();
                    
                    defaultCommandMessageTypeDetailValue.setIsDefault(Boolean.FALSE);
                    updateCommandMessageTypeFromValue(defaultCommandMessageTypeDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }
            
            commandMessageTypeDetail = CommandMessageTypeDetailFactory.getInstance().create(commandMessageTypePK, commandMessageTypeName, isDefault,
                    sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            commandMessageType.setActiveDetail(commandMessageTypeDetail);
            commandMessageType.setLastDetail(commandMessageTypeDetail);
            
            sendEvent(commandMessageTypePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }
    
    public void updateCommandMessageTypeFromValue(CommandMessageTypeDetailValue commandMessageTypeDetailValue, BasePK updatedBy) {
        updateCommandMessageTypeFromValue(commandMessageTypeDetailValue, true, updatedBy);
    }
    
    public void deleteCommandMessageType(CommandMessageType commandMessageType, BasePK deletedBy) {
        deleteCommandMessagesByCommandMessageType(commandMessageType, deletedBy);
        deleteCommandMessageTypeDescriptionsByCommandMessageType(commandMessageType, deletedBy);

        var commandMessageTypeDetail = commandMessageType.getLastDetailForUpdate();
        commandMessageTypeDetail.setThruTime(session.START_TIME_LONG);
        commandMessageType.setActiveDetail(null);
        commandMessageType.store();
        
        // Check for default, and pick one if necessary
        var defaultCommandMessageType = getDefaultCommandMessageType();
        if(defaultCommandMessageType == null) {
            var commandMessageTypes = getCommandMessageTypesForUpdate();
            
            if(!commandMessageTypes.isEmpty()) {
                var iter = commandMessageTypes.iterator();
                if(iter.hasNext()) {
                    defaultCommandMessageType = iter.next();
                }
                var commandMessageTypeDetailValue = Objects.requireNonNull(defaultCommandMessageType).getLastDetailForUpdate().getCommandMessageTypeDetailValue().clone();
                
                commandMessageTypeDetailValue.setIsDefault(Boolean.TRUE);
                updateCommandMessageTypeFromValue(commandMessageTypeDetailValue, false, deletedBy);
            }
        }
        
        sendEvent(commandMessageType.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Command Message Type Descriptions
    // --------------------------------------------------------------------------------
    
    public CommandMessageTypeDescription createCommandMessageTypeDescription(CommandMessageType commandMessageType,
            Language language, String description, BasePK createdBy) {
        var commandMessageTypeDescription = CommandMessageTypeDescriptionFactory.getInstance().create(commandMessageType,
                language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(commandMessageType.getPrimaryKey(), EventTypes.MODIFY, commandMessageTypeDescription.getPrimaryKey(),
                null, createdBy);
        
        return commandMessageTypeDescription;
    }
    
    private CommandMessageTypeDescription getCommandMessageTypeDescription(CommandMessageType commandMessageType, Language language,
            EntityPermission entityPermission) {
        CommandMessageTypeDescription commandMessageTypeDescription;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessagetypedescriptions " +
                        "WHERE cmdmssgtyd_cmdmssgty_commandmessagetypeid = ? AND cmdmssgtyd_lang_languageid = ? AND cmdmssgtyd_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessagetypedescriptions " +
                        "WHERE cmdmssgtyd_cmdmssgty_commandmessagetypeid = ? AND cmdmssgtyd_lang_languageid = ? AND cmdmssgtyd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = CommandMessageTypeDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, commandMessageType.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            commandMessageTypeDescription = CommandMessageTypeDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return commandMessageTypeDescription;
    }
    
    public CommandMessageTypeDescription getCommandMessageTypeDescription(CommandMessageType commandMessageType, Language language) {
        return getCommandMessageTypeDescription(commandMessageType, language, EntityPermission.READ_ONLY);
    }
    
    public CommandMessageTypeDescription getCommandMessageTypeDescriptionForUpdate(CommandMessageType commandMessageType, Language language) {
        return getCommandMessageTypeDescription(commandMessageType, language, EntityPermission.READ_WRITE);
    }
    
    public CommandMessageTypeDescriptionValue getCommandMessageTypeDescriptionValue(CommandMessageTypeDescription commandMessageTypeDescription) {
        return commandMessageTypeDescription == null? null: commandMessageTypeDescription.getCommandMessageTypeDescriptionValue().clone();
    }
    
    public CommandMessageTypeDescriptionValue getCommandMessageTypeDescriptionValueForUpdate(CommandMessageType commandMessageType, Language language) {
        return getCommandMessageTypeDescriptionValue(getCommandMessageTypeDescriptionForUpdate(commandMessageType, language));
    }
    
    private List<CommandMessageTypeDescription> getCommandMessageTypeDescriptionsByCommandMessageType(CommandMessageType commandMessageType,
            EntityPermission entityPermission) {
        List<CommandMessageTypeDescription> commandMessageTypeDescriptions;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessagetypedescriptions, languages " +
                        "WHERE cmdmssgtyd_cmdmssgty_commandmessagetypeid = ? AND cmdmssgtyd_thrutime = ? AND cmdmssgtyd_lang_languageid = lang_languageid " +
                        "ORDER BY lang_sortorder, lang_languageisoname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessagetypedescriptions " +
                        "WHERE cmdmssgtyd_cmdmssgty_commandmessagetypeid = ? AND cmdmssgtyd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = CommandMessageTypeDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, commandMessageType.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            commandMessageTypeDescriptions = CommandMessageTypeDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return commandMessageTypeDescriptions;
    }
    
    public List<CommandMessageTypeDescription> getCommandMessageTypeDescriptionsByCommandMessageType(CommandMessageType commandMessageType) {
        return getCommandMessageTypeDescriptionsByCommandMessageType(commandMessageType, EntityPermission.READ_ONLY);
    }
    
    public List<CommandMessageTypeDescription> getCommandMessageTypeDescriptionsByCommandMessageTypeForUpdate(CommandMessageType commandMessageType) {
        return getCommandMessageTypeDescriptionsByCommandMessageType(commandMessageType, EntityPermission.READ_WRITE);
    }
    
    public String getBestCommandMessageTypeDescription(CommandMessageType commandMessageType, Language language) {
        String description;
        var commandMessageTypeDescription = getCommandMessageTypeDescription(commandMessageType, language);
        
        if(commandMessageTypeDescription == null && !language.getIsDefault()) {
            commandMessageTypeDescription = getCommandMessageTypeDescription(commandMessageType, getPartyControl().getDefaultLanguage());
        }
        
        if(commandMessageTypeDescription == null) {
            description = commandMessageType.getLastDetail().getCommandMessageTypeName();
        } else {
            description = commandMessageTypeDescription.getDescription();
        }
        
        return description;
    }
    
    public CommandMessageTypeDescriptionTransfer getCommandMessageTypeDescriptionTransfer(UserVisit userVisit, CommandMessageTypeDescription commandMessageTypeDescription) {
        return getCoreTransferCaches(userVisit).getCommandMessageTypeDescriptionTransferCache().getCommandMessageTypeDescriptionTransfer(commandMessageTypeDescription);
    }
    
    public List<CommandMessageTypeDescriptionTransfer> getCommandMessageTypeDescriptionTransfers(UserVisit userVisit, CommandMessageType commandMessageType) {
        var commandMessageTypeDescriptions = getCommandMessageTypeDescriptionsByCommandMessageType(commandMessageType);
        List<CommandMessageTypeDescriptionTransfer> commandMessageTypeDescriptionTransfers = new ArrayList<>(commandMessageTypeDescriptions.size());
        var commandMessageTypeDescriptionTransferCache = getCoreTransferCaches(userVisit).getCommandMessageTypeDescriptionTransferCache();
    
        commandMessageTypeDescriptions.forEach((commandMessageTypeDescription) ->
                commandMessageTypeDescriptionTransfers.add(commandMessageTypeDescriptionTransferCache.getCommandMessageTypeDescriptionTransfer(commandMessageTypeDescription))
        );
        
        return commandMessageTypeDescriptionTransfers;
    }
    
    public void updateCommandMessageTypeDescriptionFromValue(CommandMessageTypeDescriptionValue commandMessageTypeDescriptionValue, BasePK updatedBy) {
        if(commandMessageTypeDescriptionValue.hasBeenModified()) {
            var commandMessageTypeDescription = CommandMessageTypeDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     commandMessageTypeDescriptionValue.getPrimaryKey());
            
            commandMessageTypeDescription.setThruTime(session.START_TIME_LONG);
            commandMessageTypeDescription.store();

            var commandMessageType = commandMessageTypeDescription.getCommandMessageType();
            var language = commandMessageTypeDescription.getLanguage();
            var description = commandMessageTypeDescriptionValue.getDescription();
            
            commandMessageTypeDescription = CommandMessageTypeDescriptionFactory.getInstance().create(commandMessageType, language,
                    description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(commandMessageType.getPrimaryKey(), EventTypes.MODIFY, commandMessageTypeDescription.getPrimaryKey(),
                    null, updatedBy);
        }
    }
    
    public void deleteCommandMessageTypeDescription(CommandMessageTypeDescription commandMessageTypeDescription, BasePK deletedBy) {
        commandMessageTypeDescription.setThruTime(session.START_TIME_LONG);
        
        sendEvent(commandMessageTypeDescription.getCommandMessageTypePK(), EventTypes.MODIFY,
                commandMessageTypeDescription.getPrimaryKey(), null, deletedBy);
    }
    
    public void deleteCommandMessageTypeDescriptionsByCommandMessageType(CommandMessageType commandMessageType, BasePK deletedBy) {
        var commandMessageTypeDescriptions = getCommandMessageTypeDescriptionsByCommandMessageTypeForUpdate(commandMessageType);
        
        commandMessageTypeDescriptions.forEach((commandMessageTypeDescription) -> 
                deleteCommandMessageTypeDescription(commandMessageTypeDescription, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Command Messages
    // --------------------------------------------------------------------------------
    
    public CommandMessage createCommandMessage(CommandMessageType commandMessageType, String commandMessageKey, BasePK createdBy) {
        var commandMessage = CommandMessageFactory.getInstance().create();
        var commandMessageDetail = CommandMessageDetailFactory.getInstance().create(commandMessage,
                commandMessageType, commandMessageKey, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        // Convert to R/W
        commandMessage = CommandMessageFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                commandMessage.getPrimaryKey());
        commandMessage.setActiveDetail(commandMessageDetail);
        commandMessage.setLastDetail(commandMessageDetail);
        commandMessage.store();
        
        sendEvent(commandMessage.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return commandMessage;
    }
    
    private CommandMessage getCommandMessageByKey(CommandMessageType commandMessageType, String commandMessageKey, EntityPermission entityPermission) {
        CommandMessage commandMessage;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessages, commandmessagedetails " +
                        "WHERE cmdmssg_activedetailid = cmdmssgdt_commandmessagedetailid " +
                        "AND cmdmssgdt_cmdmssgty_commandmessagetypeid = ? AND cmdmssgdt_commandmessagekey = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessages, commandmessagedetails " +
                        "WHERE cmdmssg_activedetailid = cmdmssgdt_commandmessagedetailid " +
                        "AND cmdmssgdt_cmdmssgty_commandmessagetypeid = ? AND cmdmssgdt_commandmessagekey = ? " +
                        "FOR UPDATE";
            }

            var ps = CommandMessageFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, commandMessageType.getPrimaryKey().getEntityId());
            ps.setString(2, commandMessageKey);
            
            commandMessage = CommandMessageFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return commandMessage;
    }
    
    public CommandMessage getCommandMessageByKey(CommandMessageType commandMessageType, String commandMessageKey) {
        return getCommandMessageByKey(commandMessageType, commandMessageKey, EntityPermission.READ_ONLY);
    }
    
    public CommandMessage getCommandMessageByKeyForUpdate(CommandMessageType commandMessageType, String commandMessageKey) {
        return getCommandMessageByKey(commandMessageType, commandMessageKey, EntityPermission.READ_WRITE);
    }
    
    public CommandMessageDetailValue getCommandMessageDetailValueForUpdate(CommandMessage commandMessage) {
        return commandMessage == null? null: commandMessage.getLastDetailForUpdate().getCommandMessageDetailValue().clone();
    }
    
    public CommandMessageDetailValue getCommandMessageDetailValueByKeyForUpdate(CommandMessageType commandMessageType, String commandMessageKey) {
        return getCommandMessageDetailValueForUpdate(getCommandMessageByKeyForUpdate(commandMessageType, commandMessageKey));
    }
    
    private List<CommandMessage> getCommandMessagesByCommandMessageType(CommandMessageType commandMessageType, EntityPermission entityPermission) {
        List<CommandMessage> commandMessages;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessages, commandmessagedetails " +
                        "WHERE cmdmssg_activedetailid = cmdmssgdt_commandmessagedetailid " +
                        "AND cmdmssgdt_cmdmssgty_commandmessagetypeid = ? " +
                        "ORDER BY cmdmssgdt_commandmessagekey";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessages, commandmessagedetails " +
                        "WHERE cmdmssg_activedetailid = cmdmssgdt_commandmessagedetailid " +
                        "AND cmdmssgdt_cmdmssgty_commandmessagetypeid = ? " +
                        "FOR UPDATE";
            }

            var ps = CommandMessageFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, commandMessageType.getPrimaryKey().getEntityId());
            
            commandMessages = CommandMessageFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return commandMessages;
    }
    
    public List<CommandMessage> getCommandMessagesByCommandMessageType(CommandMessageType commandMessageType) {
        return getCommandMessagesByCommandMessageType(commandMessageType, EntityPermission.READ_ONLY);
    }
    
    public List<CommandMessage> getCommandMessagesByCommandMessageTypeForUpdate(CommandMessageType commandMessageType) {
        return getCommandMessagesByCommandMessageType(commandMessageType, EntityPermission.READ_WRITE);
    }
    
    public CommandMessageTransfer getCommandMessageTransfer(UserVisit userVisit, CommandMessage commandMessage) {
        return getCoreTransferCaches(userVisit).getCommandMessageTransferCache().getCommandMessageTransfer(commandMessage);
    }
    
    private List<CommandMessageTransfer> getCommandMessageTransfers(UserVisit userVisit, Collection<CommandMessage> commandMessages) {
        List<CommandMessageTransfer> commandMessageTransfers = new ArrayList<>(commandMessages.size());
        var commandMessageTransferCache = getCoreTransferCaches(userVisit).getCommandMessageTransferCache();
        
        commandMessages.forEach((commandMessage) ->
                commandMessageTransfers.add(commandMessageTransferCache.getCommandMessageTransfer(commandMessage))
        );
        
        return commandMessageTransfers;
    }
    
    public List<CommandMessageTransfer> getCommandMessageTransfers(UserVisit userVisit, CommandMessageType commandMessageType) {
        return getCommandMessageTransfers(userVisit, getCommandMessagesByCommandMessageType(commandMessageType));
    }
    
    public void updateCommandMessageFromValue(CommandMessageDetailValue commandMessageDetailValue, BasePK updatedBy) {
        if(commandMessageDetailValue.hasBeenModified()) {
            var commandMessage = CommandMessageFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     commandMessageDetailValue.getCommandMessagePK());
            var commandMessageDetail = commandMessage.getActiveDetailForUpdate();
            
            commandMessageDetail.setThruTime(session.START_TIME_LONG);
            commandMessageDetail.store();

            var commandMessagePK = commandMessageDetail.getCommandMessagePK();
            var commandMessageTypePK = commandMessageDetail.getCommandMessageTypePK(); // Not updated
            var commandMessageKey = commandMessageDetailValue.getCommandMessageKey();
            
            commandMessageDetail = CommandMessageDetailFactory.getInstance().create(commandMessagePK, commandMessageTypePK, commandMessageKey,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            commandMessage.setActiveDetail(commandMessageDetail);
            commandMessage.setLastDetail(commandMessageDetail);
            
            sendEvent(commandMessagePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }
    
    public void deleteCommandMessage(CommandMessage commandMessage, BasePK deletedBy) {
        deleteCommandMessageTranslationsByCommandMessage(commandMessage, deletedBy);

        var commandMessageDetail = commandMessage.getLastDetailForUpdate();
        commandMessageDetail.setThruTime(session.START_TIME_LONG);
        commandMessage.setActiveDetail(null);
        commandMessage.store();
        
        sendEvent(commandMessage.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }
    
    public void deleteCommandMessages(List<CommandMessage> commandMessages, BasePK deletedBy) {
        commandMessages.forEach((commandMessage) -> 
                deleteCommandMessage(commandMessage, deletedBy)
        );
    }
    
    public void deleteCommandMessagesByCommandMessageType(CommandMessageType commandMessageType, BasePK deletedBy) {
        deleteCommandMessages(getCommandMessagesByCommandMessageTypeForUpdate(commandMessageType), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Command Message Strings
    // --------------------------------------------------------------------------------
    
    public CommandMessageTranslation createCommandMessageTranslation(CommandMessage commandMessage, Language language, String translation, BasePK createdBy) {
        var commandMessageTranslation = CommandMessageTranslationFactory.getInstance().create(commandMessage, language, translation,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(commandMessageTranslation.getCommandMessagePK(), EventTypes.MODIFY, commandMessageTranslation.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return commandMessageTranslation;
    }
    
    private List<CommandMessageTranslation> getCommandMessageTranslationsByCommandMessage(CommandMessage commandMessage, EntityPermission entityPermission) {
        List<CommandMessageTranslation> commandMessageTranslations;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessagetranslations, languages " +
                        "WHERE cmdmssgtr_cmdmssg_commandMessageid = ? AND cmdmssgtr_thrutime = ? " +
                        "AND cmdmssgtr_lang_languageid = lang_languageid " +
                        "ORDER BY lang_sortorder, lang_languageisoname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessagetranslations " +
                        "WHERE cmdmssgtr_cmdmssg_commandMessageid = ? AND cmdmssgtr_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = CommandMessageTranslationFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, commandMessage.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            commandMessageTranslations = CommandMessageTranslationFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return commandMessageTranslations;
    }
    
    public List<CommandMessageTranslation> getCommandMessageTranslationsByCommandMessage(CommandMessage commandMessage) {
        return getCommandMessageTranslationsByCommandMessage(commandMessage, EntityPermission.READ_ONLY);
    }
    
    public List<CommandMessageTranslation> getCommandMessageTranslationsByCommandMessageForUpdate(CommandMessage commandMessage) {
        return getCommandMessageTranslationsByCommandMessage(commandMessage, EntityPermission.READ_WRITE);
    }
    
    public CommandMessageTranslation getBestCommandMessageTranslation(CommandMessage commandMessage, Language language) {
        var commandMessageTranslation = getCommandMessageTranslation(commandMessage, language);
        
        if(commandMessageTranslation == null && !language.getIsDefault()) {
            commandMessageTranslation = getCommandMessageTranslation(commandMessage, getPartyControl().getDefaultLanguage());
        }
        
        return commandMessageTranslation;
    }
    
    private CommandMessageTranslation getCommandMessageTranslation(CommandMessage commandMessage, Language language, EntityPermission entityPermission) {
        CommandMessageTranslation commandMessageTranslation;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessagetranslations " +
                        "WHERE cmdmssgtr_cmdmssg_commandmessageid = ? AND cmdmssgtr_lang_languageid = ? AND cmdmssgtr_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM commandmessagetranslations " +
                        "WHERE cmdmssgtr_cmdmssg_commandmessageid = ? AND cmdmssgtr_lang_languageid = ? AND cmdmssgtr_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = CommandMessageTranslationFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, commandMessage.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            commandMessageTranslation = CommandMessageTranslationFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return commandMessageTranslation;
    }
    
    public CommandMessageTranslation getCommandMessageTranslation(CommandMessage commandMessage, Language language) {
        return getCommandMessageTranslation(commandMessage, language, EntityPermission.READ_ONLY);
    }
    
    public CommandMessageTranslation getCommandMessageTranslationForUpdate(CommandMessage commandMessage, Language language) {
        return getCommandMessageTranslation(commandMessage, language, EntityPermission.READ_WRITE);
    }
    
    public CommandMessageTranslationValue getCommandMessageTranslationValue(CommandMessageTranslation commandMessageTranslation) {
        return commandMessageTranslation == null? null: commandMessageTranslation.getCommandMessageTranslationValue().clone();
    }
    
    public CommandMessageTranslationValue getCommandMessageTranslationValueForUpdate(CommandMessage commandMessage, Language language) {
        var commandMessageTranslation = getCommandMessageTranslationForUpdate(commandMessage, language);
        
        return commandMessageTranslation == null? null: getCommandMessageTranslationValue(commandMessageTranslation);
    }
    
    public List<CommandMessageTranslationTransfer> getCommandMessageTranslationTransfers(UserVisit userVisit, Collection<CommandMessageTranslation> commandMessageTranslations) {
        List<CommandMessageTranslationTransfer> commandMessageTranslationTransfers = new ArrayList<>(commandMessageTranslations.size());
        var commandMessageTranslationTransferCache = getCoreTransferCaches(userVisit).getCommandMessageTranslationTransferCache();
        
        commandMessageTranslations.forEach((commandMessageTranslation) ->
                commandMessageTranslationTransfers.add(commandMessageTranslationTransferCache.getCommandMessageTranslationTransfer(commandMessageTranslation))
        );
        
        return commandMessageTranslationTransfers;
    }
    
    public List<CommandMessageTranslationTransfer> getCommandMessageTranslationTransfersByCommandMessage(UserVisit userVisit, CommandMessage commandMessage) {
        return getCommandMessageTranslationTransfers(userVisit, getCommandMessageTranslationsByCommandMessage(commandMessage));
    }

    public CommandMessageTranslationTransfer getCommandMessageTranslationTransfer(UserVisit userVisit, CommandMessageTranslation commandMessageTranslation) {
        return getCoreTransferCaches(userVisit).getCommandMessageTranslationTransferCache().getCommandMessageTranslationTransfer(commandMessageTranslation);
    }

    public void updateCommandMessageTranslationFromValue(CommandMessageTranslationValue commandMessageTranslationValue, BasePK updatedBy) {
        if(commandMessageTranslationValue.hasBeenModified()) {
            var commandMessageTranslation = CommandMessageTranslationFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    commandMessageTranslationValue.getPrimaryKey());
            
            commandMessageTranslation.setThruTime(session.START_TIME_LONG);
            commandMessageTranslation.store();

            var commandMessagePK = commandMessageTranslation.getCommandMessagePK(); // Not updated
            var languagePK = commandMessageTranslation.getLanguagePK(); // Not updated
            var translation = commandMessageTranslationValue.getTranslation();
            
            commandMessageTranslation = CommandMessageTranslationFactory.getInstance().create(commandMessagePK, languagePK, translation, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);
            
            sendEvent(commandMessagePK, EventTypes.MODIFY, commandMessageTranslation.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteCommandMessageTranslation(CommandMessageTranslation commandMessageTranslation, BasePK deletedBy) {
        commandMessageTranslation.setThruTime(session.START_TIME_LONG);
        
        sendEvent(commandMessageTranslation.getCommandMessagePK(), EventTypes.MODIFY, commandMessageTranslation.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteCommandMessageTranslations(List<CommandMessageTranslation> commandMessageTranslations, BasePK deletedBy) {
        commandMessageTranslations.forEach((commandMessageTranslation) -> 
                deleteCommandMessageTranslation(commandMessageTranslation, deletedBy)
        );
    }
    
    public void deleteCommandMessageTranslationsByCommandMessage(CommandMessage commandMessage, BasePK deletedBy) {
        deleteCommandMessageTranslations(getCommandMessageTranslationsByCommandMessageForUpdate(commandMessage), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Entity Instances
    // --------------------------------------------------------------------------------

    public EntityInstance createEntityInstance(EntityType entityType, Long entityUniqueId) {
        return EntityInstanceFactory.getInstance().create(entityType, entityUniqueId, null);
    }

    public EntityInstance createEntityAttributeDefaults(EntityInstance entityInstance, BasePK createdBy) {
        var entityAttributes = getEntityAttributesByEntityType(entityInstance.getEntityType());

        entityAttributes.forEach(entityAttribute -> {
            var entityAttributeTypeName = entityAttribute.getLastDetail().getEntityAttributeType().getEntityAttributeTypeName();
            var entityAttributeType = EntityAttributeTypes.valueOf(entityAttributeTypeName);

            switch(entityAttributeType) {
                case BOOLEAN -> {
                    var entityBooleanDefault = getEntityBooleanDefault(entityAttribute);

                    if(entityBooleanDefault != null) {
                        createEntityBooleanAttribute(entityAttribute, entityInstance, entityBooleanDefault.getBooleanAttribute(), createdBy);
                    }
                }
                case INTEGER -> {
                    var entityIntegerDefault = getEntityIntegerDefault(entityAttribute);

                    if(entityIntegerDefault != null) {
                        createEntityIntegerAttribute(entityAttribute, entityInstance, entityIntegerDefault.getIntegerAttribute(), createdBy);
                    }
                }
                case LONG -> {
                    var entityLongDefault = getEntityLongDefault(entityAttribute);

                    if(entityLongDefault != null) {
                        createEntityLongAttribute(entityAttribute, entityInstance, entityLongDefault.getLongAttribute(), createdBy);
                    }
                }
                case LISTITEM -> {
                    var entityListItemDefault = getEntityListItemDefault(entityAttribute);

                    if(entityListItemDefault != null) {
                        createEntityListItemAttribute(entityAttribute, entityInstance, entityListItemDefault.getEntityListItem(), createdBy);
                    }
                }
                case STRING -> {
                    var entityStringDefaults = getEntityStringDefaultsByEntityAttribute(entityAttribute);

                    entityStringDefaults.forEach(entityStringDefault ->
                            createEntityStringAttribute(entityAttribute, entityInstance, entityStringDefault.getLanguage(),
                                    entityStringDefault.getStringAttribute(), createdBy));
                }
                default -> {}
            }
        });

        return entityInstance;
    }

    public boolean verifyEntityInstance(final EntityInstance entityInstance, final String componentVendorName, final String entityTypeName) {
        var result = true;
        var entityTypeDetail = entityInstance.getEntityType().getLastDetail();
        
        if(entityTypeDetail.getEntityTypeName().equals(entityTypeName)) {
            if(!entityTypeDetail.getComponentVendor().getLastDetail().getComponentVendorName().equals(componentVendorName)) {
                result = false;
            }
        } else {
            result = false;
        }
        
        return result;
    }

    public long countEntityInstances() {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityinstances");
    }

    public long countEntityInstancesByEntityType(EntityType entityType) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityinstances " +
                "WHERE eni_ent_entitytypeid = ?",
                entityType);
    }

    public List<EntityInstance> getEntityInstancesByEntityType(EntityType entityType) {
        List<EntityInstance> entityInstances;
        
        try {
            var ps = EntityInstanceFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityinstances " +
                    "WHERE eni_ent_entitytypeid = ? " +
                    "ORDER BY eni_entityuniqueid " +
                    "_LIMIT_");
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            
            entityInstances = EntityInstanceFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityInstances;
    }
    
    private EntityInstance getEntityInstance(EntityType entityType, Long entityUniqueId, EntityPermission entityPermission) {
        EntityInstance entityInstance;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityinstances " +
                        "WHERE eni_ent_entitytypeid = ? AND eni_entityuniqueid = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityinstances " +
                        "WHERE eni_ent_entitytypeid = ? AND eni_entityuniqueid = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityInstanceFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            ps.setLong(2, entityUniqueId);
            
            entityInstance = EntityInstanceFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityInstance;
    }
    
    public EntityInstance getEntityInstance(EntityType entityType, Long entityUniqueId) {
        return getEntityInstance(entityType, entityUniqueId, EntityPermission.READ_ONLY);
    }
    
    public EntityInstance getEntityInstanceForUpdate(EntityType entityType, Long entityUniqueId) {
        return getEntityInstance(entityType, entityUniqueId, EntityPermission.READ_WRITE);
    }

    private EntityInstance getEntityInstanceByUuid(String uuid, EntityPermission entityPermission) {
        EntityInstance entityInstance;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityinstances " +
                        "WHERE eni_uuid = UUID_TO_BIN(?)";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityinstances " +
                        "WHERE eni_uuid = UUID_TO_BIN(?) " +
                        "FOR UPDATE";
            }

            var ps = EntityInstanceFactory.getInstance().prepareStatement(query);
            
            ps.setString(1, uuid);
            
            entityInstance = EntityInstanceFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityInstance;
    }
    
    public EntityInstance getEntityInstanceByUuid(String uuid) {
        return getEntityInstanceByUuid(uuid, EntityPermission.READ_ONLY);
    }
    
    public EntityInstance getEntityInstanceByUuidForUpdate(String uuid) {
        return getEntityInstanceByUuid(uuid, EntityPermission.READ_WRITE);
    }
    
    public EntityInstance ensureUuidForEntityInstance(EntityInstance entityInstance, boolean forceRegeneration) {
        var uuid = entityInstance.getUuid();
        
        if(uuid == null || forceRegeneration) {
            // Convert to READ_WRITE if necessary...
            if(entityInstance.getEntityPermission().equals(EntityPermission.READ_ONLY)) {
                entityInstance = EntityInstanceFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, entityInstance.getPrimaryKey());
            }
            
            // Keep generating UUIDs until a unique one is found...
            EntityInstance duplicateEntityInstance;
            do {
                uuid = UuidUtils.getInstance().generateUuid(entityInstance);
                duplicateEntityInstance = getEntityInstanceByUuid(uuid);
            } while(duplicateEntityInstance != null);
            
            // Store it immediately in order to decrease the odds of another thread choosing the same UUID...
            entityInstance.setUuid(uuid);
            entityInstance.store();
        }
        
        return entityInstance;
    }
    
    public EntityInstanceTransfer getEntityInstanceTransfer(UserVisit userVisit, EntityInstance entityInstance, boolean includeEntityAppearance,
            boolean includeEntityVisit, boolean includeNames, boolean includeUuid) {
        return getCoreTransferCaches(userVisit).getEntityInstanceTransferCache().getEntityInstanceTransfer(entityInstance, includeEntityAppearance,
                includeEntityVisit, includeNames, includeUuid);
    }
    
    public EntityInstanceTransfer getEntityInstanceTransfer(UserVisit userVisit, BaseEntity baseEntity, boolean includeEntityAppearance,
            boolean includeEntityVisit, boolean includeNames, boolean includeUuid) {
        return getEntityInstanceTransfer(userVisit, getEntityInstanceByBasePK(baseEntity.getPrimaryKey()), includeEntityAppearance,
                includeEntityVisit, includeNames, includeUuid);
    }

    public List<EntityInstanceTransfer> getEntityInstanceTransfers(UserVisit userVisit, Collection<EntityInstance> entityInstances,
            boolean includeEntityAppearance, boolean includeEntityVisit, boolean includeNames, boolean includeUuid) {
        var entityInstanceTransfers = new ArrayList<EntityInstanceTransfer>(entityInstances.size());
        var entityInstanceTransferCache = getCoreTransferCaches(userVisit).getEntityInstanceTransferCache();

        entityInstances.forEach((entityInstance) ->
                entityInstanceTransfers.add(entityInstanceTransferCache.getEntityInstanceTransfer(entityInstance,
                        includeEntityAppearance, includeEntityVisit, includeNames, includeUuid))
        );

        return entityInstanceTransfers;
    }

    public List<EntityInstanceTransfer> getEntityInstanceTransfersByEntityType(UserVisit userVisit, EntityType entityType,
            boolean includeEntityAppearance, boolean includeEntityVisit, boolean includeNames, boolean includeUuid) {
        return getEntityInstanceTransfers(userVisit, getEntityInstancesByEntityType(entityType), includeEntityAppearance,
                includeEntityVisit, includeNames, includeUuid);
    }

    /** Gets an EntityInstance for BasePK, creating it if necessary. Overrides function from BaseModelControl.
     * Some errors from this function are normal during the initial load of data into the database.
     */
    private EntityInstance getEntityInstanceByBasePK(BasePK pk, EntityPermission entityPermission) {
        EntityInstance entityInstance = null;
        
        if(CoreDebugFlags.LogEntityInstanceResolution) {
            getLog().info(">>> getEntityInstanceByBasePK(pk=" + pk + ")");
        }
        
        if(pk != null) {
            var componentVendorName = pk.getComponentVendorName();
            var componentVendor = getComponentVendorByNameFromCache(componentVendorName);
            
            if(CoreDebugFlags.LogEntityInstanceResolution) {
                getLog().info("--- componentVendor = " + componentVendor);
            }
            
            if(componentVendor != null) {
                var entityTypeName = pk.getEntityTypeName();
                var entityType = getEntityTypeByNameFromCache(componentVendor, entityTypeName);
                
                if(CoreDebugFlags.LogEntityInstanceResolution) {
                    getLog().info("--- entityType = " + entityType);
                }
                
                if(entityType != null) {
                    var entityUniqueId = pk.getEntityId();
                    
                    if(CoreDebugFlags.LogEntityInstanceResolution) {
                        getLog().info("--- entityUniqueId = " + entityUniqueId);
                    }
                    
                    entityInstance = getEntityInstance(entityType, entityUniqueId, entityPermission);
                    if(entityInstance == null) {
                        entityInstance = createEntityInstance(entityType, entityUniqueId);
                        
                        if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                            // Convert to R/W
                            entityInstance = EntityInstanceFactory.getInstance().getEntityFromPK(session,
                                    EntityPermission.READ_WRITE, entityInstance.getPrimaryKey());
                        }
                    }
                    
                    if(CoreDebugFlags.LogEntityInstanceResolution) {
                        getLog().info("--- entityInstance = " + entityInstance);
                    }
                } else if(CoreDebugFlags.LogUnresolvedEntityInstances) {
                    getLog().error("getEntityInstanceByBasePK: unknown entityTypeName \"" + componentVendorName + "." + entityTypeName + "\"");
                }
            } else if(CoreDebugFlags.LogUnresolvedEntityInstances) {
                getLog().error("getEntityInstanceByBasePK: unknown componentVendorName \"" + componentVendorName + "\"");
            }
        } else if(CoreDebugFlags.LogUnresolvedEntityInstances) {
            getLog().error("getEntityInstanceByBasePK: PK was null");
        }
        
        if(CoreDebugFlags.LogEntityInstanceResolution) {
            getLog().info("<<< entityInstance=" + entityInstance);
        }
        
        return entityInstance;
    }
    
    @Override
    public EntityInstance getEntityInstanceByBasePK(BasePK pk) {
        return getEntityInstanceByBasePK(pk, EntityPermission.READ_ONLY);
    }
    
    public EntityInstance getEntityInstanceByBasePKForUpdate(BasePK pk) {
        return getEntityInstanceByBasePK(pk, EntityPermission.READ_WRITE);
    }
    
    /** This function handles data passed back from a client. Because of this, missing entity instances
     * are not automatically created if they do not exist. Do not trust what the user is telling us.
     */
    private EntityInstance getEntityInstanceByEntityRef(String entityRef, EntityPermission entityPermission) {
        EntityInstance entityInstance = null;
        
        if(entityRef != null) {
            var entityRefParts = Splitter.on('.').trimResults().omitEmptyStrings().splitToList(entityRef).toArray(new String[0]);
            
            if(entityRefParts.length == 3) {
                var componentVendorName = entityRefParts[0];
                var componentVendor = getComponentVendorByNameFromCache(componentVendorName);
                
                if(componentVendor != null) {
                    var entityTypeName = entityRefParts[1];
                    var entityType = getEntityTypeByNameFromCache(componentVendor, entityTypeName);
                    
                    if(entityType != null) {
                        var entityUniqueId = Long.valueOf(entityRefParts[2]);
                        
                        entityInstance = getEntityInstance(entityType, entityUniqueId, entityPermission);
                        
                        if(CoreDebugFlags.LogUnresolvedEntityInstances && entityInstance == null) {
                            getLog().error("getEntityInstanceByEntityRef: unknown entityUniqueId \"" + componentVendorName + "." + entityTypeName + "." + entityUniqueId + "\"");
                        }
                    } else if(CoreDebugFlags.LogUnresolvedEntityInstances) {
                        getLog().error("getEntityInstanceByEntityRef: unknown entityTypeName \"" + componentVendorName + "." + entityTypeName + "\"");
                    }
                } else if(CoreDebugFlags.LogUnresolvedEntityInstances) {
                    getLog().error("getEntityInstanceByEntityRef: unknown componentVendorName \"" + componentVendorName + "\"");
                }
            } else if(CoreDebugFlags.LogUnresolvedEntityInstances) {
                getLog().error("getEntityInstanceByEntityRef: entityRef not valid");
            }
        } else if(CoreDebugFlags.LogUnresolvedEntityInstances) {
            getLog().error("getEntityInstanceByEntityRef: entityRef was null");
        }
        
        return entityInstance;
    }
    
    public EntityInstance getEntityInstanceByEntityRef(String entityRef) {
        return getEntityInstanceByEntityRef(entityRef, EntityPermission.READ_ONLY);
    }
    
    public EntityInstance getEntityInstanceByEntityRefForUpdate(String entityRef) {
        return getEntityInstanceByEntityRef(entityRef, EntityPermission.READ_WRITE);
    }

    public EntityInstance getEntityInstanceByPK(EntityInstancePK entityInstancePK) {
        return EntityInstanceFactory.getInstance().getEntityFromPK(EntityPermission.READ_ONLY, entityInstancePK);
    }

    /** This function is a little odd. It doesn't actually delete the Entity Instance, rather, it cleans up all the
     * entities scattered through several components that depend on them.
     */
    public void deleteEntityInstanceDependencies(EntityInstance entityInstance, BasePK deletedBy) {
        var chainControl = Session.getModelController(ChainControl.class);
        var searchControl = Session.getModelController(SearchControl.class);
        var securityControl = Session.getModelController(SecurityControl.class);

        Session.getModelController(AccountingControl.class).deleteTransactionEntityRolesByEntityInstance(entityInstance, deletedBy);
        Session.getModelController(AssociateControl.class).deleteAssociateReferralsByTargetEntityInstance(entityInstance, deletedBy);
        Session.getModelController(BatchControl.class).deleteBatchEntitiesByEntityInstance(entityInstance, deletedBy);
        Session.getModelController(CommentControl.class).deleteCommentsByEntityInstance(entityInstance, deletedBy);
        Session.getModelController(MessageControl.class).deleteEntityMessagesByEntityInstance(entityInstance, deletedBy);
        Session.getModelController(RatingControl.class).deleteRatingsByEntityInstance(entityInstance, deletedBy);
        searchControl.removeSearchResultsByEntityInstance(entityInstance);
        searchControl.removeCachedExecutedSearchResultsByEntityInstance(entityInstance);
        searchControl.deleteSearchResultActionsByEntityInstance(entityInstance, deletedBy);
        securityControl.deletePartyEntitySecurityRolesByEntityInstance(entityInstance, deletedBy);
        Session.getModelController(TagControl.class).deleteEntityTagsByEntityInstance(entityInstance, deletedBy);
        getWorkflowControl().deleteWorkflowEntityStatusesByEntityInstance(entityInstance, deletedBy);
        Session.getModelController(WorkEffortControl.class).deleteWorkEffortsByOwningEntityInstance(entityInstance, deletedBy);

        // If an EntityInstance is in a role for a ChainInstance, then that ChainInstance should be deleted. Because an individual
        // EntityInstance may be in more than one role, the list of ChainInstances needs to be deduplicated.
        Set<ChainInstance> chainInstances = new HashSet<>();
        chainControl.getChainInstanceEntityRolesByEntityInstanceForUpdate(entityInstance).forEach((chainInstanceEntityRole) ->
                chainInstances.add(chainInstanceEntityRole.getChainInstanceForUpdate())
        );
        chainControl.deleteChainInstances(chainInstances, deletedBy);

        deleteEntityAliasesByEntityInstance(entityInstance, deletedBy);
        deleteEntityAttributesByEntityInstance(entityInstance, deletedBy);
        deleteEntityAppearancesByEntityInstance(entityInstance, deletedBy);
    }

    public void deleteEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        // sendEvent(...) handles calling back to deleteEntityInstanceDependencies(...)
        sendEvent(entityInstance, EventTypes.DELETE, (EntityInstance)null, null, deletedBy);
    }

    public void deleteEntityInstancesByEntityTypeWithNullDeletedTime(final EntityType entityType, final BasePK deletedBy) {
        for(var entityInstanceResult : new EntityInstancePKsByEntityTypeWithNullDeletedTimeQuery().execute(entityType)) {
            deleteEntityInstance(EntityInstanceFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    entityInstanceResult.getEntityInstancePK()), deletedBy);
        }
    }

    public void removeEntityInstance(EntityInstance entityInstance) {
        entityInstance.remove();
    }
    
    public void removeEntityInstanceByBasePK(BasePK pk) {
        removeEntityInstance(getEntityInstanceByBasePKForUpdate(pk));
    }
    
    public void removeEntityInstanceByEntityRef(String entityRef) {
        removeEntityInstance(getEntityInstanceByEntityRefForUpdate(entityRef));
    }
    
    // --------------------------------------------------------------------------------
    //   Event Types
    // --------------------------------------------------------------------------------
    
    public EventType createEventType(String eventTypeName) {
        var eventType = EventTypeFactory.getInstance().create(eventTypeName);
        
        return eventType;
    }
    
    public EventType getEventTypeByName(String eventTypeName) {
        EventType eventType;
        
        try {
            var ps = EventTypeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM eventtypes " +
                    "WHERE evty_eventtypename = ?");
            
            ps.setString(1, eventTypeName);
            
            eventType = EventTypeFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return eventType;
    }

    private final Map<EventTypes, EventType> eventTypeCache = new HashMap<>();

    public EventType getEventTypeByEventTypesFromCache(EventTypes eventTypeEnum) {
        var eventType = eventTypeCache.get(eventTypeEnum);

        if(eventType == null) {
            eventType = getEventTypeByName(eventTypeEnum.name());

            if(eventType != null) {
                eventTypeCache.put(eventTypeEnum, eventType);
            }
        }

        return eventType;
    }

    public List<EventType> getEventTypes() {
        var ps = EventTypeFactory.getInstance().prepareStatement(
                "SELECT _ALL_ " +
                "FROM eventtypes " +
                "ORDER BY evty_eventtypename");
        
        return EventTypeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
    }
    
    public EventTypeTransfer getEventTypeTransfer(UserVisit userVisit, EventType eventType) {
        return getCoreTransferCaches(userVisit).getEventTypeTransferCache().getEventTypeTransfer(eventType);
    }
    
    // --------------------------------------------------------------------------------
    //   Event Type Descriptions
    // --------------------------------------------------------------------------------
    
    public EventTypeDescription createEventTypeDescription(EventType eventType, Language language, String description) {
        var eventTypeDescription = EventTypeDescriptionFactory.getInstance().create(eventType, language, description);
        
        return eventTypeDescription;
    }
    
    public EventTypeDescription getEventTypeDescription(EventType eventType, Language language) {
        EventTypeDescription eventTypeDescription;
        
        try {
            var ps = EventTypeDescriptionFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM eventtypedescriptions " +
                    "WHERE evtyd_evty_eventtypeid = ? AND evtyd_lang_languageid = ?");
            
            ps.setLong(1, eventType.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            
            eventTypeDescription = EventTypeDescriptionFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return eventTypeDescription;
    }
    
    public String getBestEventTypeDescription(EventType eventType, Language language) {
        String description;
        var eventTypeDescription = getEventTypeDescription(eventType, language);
        
        if(eventTypeDescription == null && !language.getIsDefault()) {
            eventTypeDescription = getEventTypeDescription(eventType, getPartyControl().getDefaultLanguage());
        }
        
        if(eventTypeDescription == null) {
            description = eventType.getEventTypeName();
        } else {
            description = eventTypeDescription.getDescription();
        }
        
        return description;
    }
    
    // --------------------------------------------------------------------------------
    //   Component Stages
    // --------------------------------------------------------------------------------
    
    public ComponentStage createComponentStage(String componentStageName, String description, Integer relativeAge) {
        var componentStage = ComponentStageFactory.getInstance().create(componentStageName, description, relativeAge);
        
        return componentStage;
    }
    
    public ComponentStage getComponentStageByName(String componentStageName) {
        ComponentStage componentStage;
        
        try {
            var ps = ComponentStageFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM componentstages " +
                    "WHERE cstg_componentstagename = ?");
            
            ps.setString(1, componentStageName);
            
            componentStage = ComponentStageFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return componentStage;
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attribute Types
    // --------------------------------------------------------------------------------
    
    public EntityAttributeType createEntityAttributeType(String entityAttributeTypeName) {
        var entityAttributeType = EntityAttributeTypeFactory.getInstance().create(entityAttributeTypeName);
        
        return entityAttributeType;
    }
    
    /** Assume that the entityInstance passed to this function is a ECHO_THREE.EntityAttributeType */
    public EntityAttributeType getEntityAttributeTypeByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new EntityAttributeTypePK(entityInstance.getEntityUniqueId());

        return EntityAttributeTypeFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public EntityAttributeType getEntityAttributeTypeByEntityInstance(EntityInstance entityInstance) {
        return getEntityAttributeTypeByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public EntityAttributeType getEntityAttributeTypeByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getEntityAttributeTypeByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public long countEntityAttributeTypes() {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityattributetypes ");
    }

    public EntityAttributeType getEntityAttributeTypeByName(String entityAttributeTypeName) {
        EntityAttributeType entityAttributeType;
        
        try {
            var ps = EntityAttributeTypeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityattributetypes " +
                    "WHERE enat_entityattributetypename = ?");
            
            ps.setString(1, entityAttributeTypeName);
            
            entityAttributeType = EntityAttributeTypeFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributeType;
    }
    
    public List<EntityAttributeType> getEntityAttributeTypes() {
        var ps = EntityAttributeTypeFactory.getInstance().prepareStatement(
                "SELECT _ALL_ " +
                "FROM entityattributetypes " +
                "ORDER BY enat_entityattributetypename " +
                "_LIMIT_");
        
        return EntityAttributeTypeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
    }
    
    public EntityAttributeTypeTransfer getEntityAttributeTypeTransfer(UserVisit userVisit, EntityAttributeType entityAttributeType) {
        return getCoreTransferCaches(userVisit).getEntityAttributeTypeTransferCache().getEntityAttributeTypeTransfer(entityAttributeType);
    }
    
    public List<EntityAttributeTypeTransfer> getEntityAttributeTypeTransfers(UserVisit userVisit, Collection<EntityAttributeType> entityAttributeTypes) {
        List<EntityAttributeTypeTransfer> entityAttributeTypeTransfers = null;
        
        if(entityAttributeTypes != null) {
            entityAttributeTypeTransfers = new ArrayList<>(entityAttributeTypes.size());
            
            for(var entityAttributeType : entityAttributeTypes) {
                entityAttributeTypeTransfers.add(getCoreTransferCaches(userVisit).getEntityAttributeTypeTransferCache().getEntityAttributeTypeTransfer(entityAttributeType));
            }
        }
        
        return entityAttributeTypeTransfers;
    }
    
    public List<EntityAttributeTypeTransfer> getEntityAttributeTypeTransfers(UserVisit userVisit) {
        return getEntityAttributeTypeTransfers(userVisit, getEntityAttributeTypes());
    }
    
    public EntityAttributeTypeChoicesBean getEntityAttributeTypeChoices(String defaultEntityAttributeTypeChoice, Language language) {
        var entityAttributeTypes = getEntityAttributeTypes();
        var size = entityAttributeTypes.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;
        
        for(var entityAttributeType : entityAttributeTypes) {
            var label = getBestEntityAttributeTypeDescription(entityAttributeType, language);
            var value = entityAttributeType.getEntityAttributeTypeName();
            
            labels.add(label == null? value: label);
            values.add(value);
            
            var usingDefaultChoice = defaultEntityAttributeTypeChoice != null && defaultEntityAttributeTypeChoice.equals(value);
            if(usingDefaultChoice || defaultValue == null) {
                defaultValue = value;
            }
        }
        
        return new EntityAttributeTypeChoicesBean(labels, values, defaultValue);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attribute Type Descriptions
    // --------------------------------------------------------------------------------
    
    public EntityAttributeTypeDescription createEntityAttributeTypeDescription(EntityAttributeType entityAttributeType, Language language, String description) {
        var entityAttributeTypeDescription = EntityAttributeTypeDescriptionFactory.getInstance().create(entityAttributeType, language, description);
        
        return entityAttributeTypeDescription;
    }
    
    public EntityAttributeTypeDescription getEntityAttributeTypeDescription(EntityAttributeType entityAttributeType, Language language) {
        EntityAttributeTypeDescription entityAttributeTypeDescription;
        
        try {
            var ps = EntityAttributeTypeDescriptionFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityattributetypedescriptions " +
                    "WHERE enatd_enat_entityattributetypeid = ? AND enatd_lang_languageid = ?");
            
            ps.setLong(1, entityAttributeType.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            
            entityAttributeTypeDescription = EntityAttributeTypeDescriptionFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributeTypeDescription;
    }
    
    public String getBestEntityAttributeTypeDescription(EntityAttributeType entityAttributeType, Language language) {
        String description;
        var entityAttributeTypeDescription = getEntityAttributeTypeDescription(entityAttributeType, language);
        
        if(entityAttributeTypeDescription == null && !language.getIsDefault()) {
            entityAttributeTypeDescription = getEntityAttributeTypeDescription(entityAttributeType, getPartyControl().getDefaultLanguage());
        }
        
        if(entityAttributeTypeDescription == null) {
            description = entityAttributeType.getEntityAttributeTypeName();
        } else {
            description = entityAttributeTypeDescription.getDescription();
        }
        
        return description;
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Times
    // --------------------------------------------------------------------------------
    
    public EntityTime createEntityTime(EntityInstance entityInstance, Long createdTime, Long modifiedTime, Long deletedTime) {
        return EntityTimeFactory.getInstance().create(entityInstance, createdTime, modifiedTime, deletedTime);
        
    }
    
    public EntityTime getEntityTime(EntityInstance entityInstance) {
        EntityTime entityTime;
        
        try {
            var ps = EntityTimeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitytimes " +
                    "WHERE etim_eni_entityinstanceid = ?");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            
            entityTime = EntityTimeFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityTime;
    }
    
    public EntityTime getEntityTimeForUpdate(EntityInstance entityInstance) {
        EntityTime entityTime;
        
        try {
            var ps = EntityTimeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitytimes " +
                    "WHERE etim_eni_entityinstanceid = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            
            entityTime = EntityTimeFactory.getInstance().getEntityFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityTime;
    }
    
    public static final Integer negativeOne = -1;
    
    public static final String selectEntityTimesByEntityType = "SELECT _ALL_ " +
            "FROM entitytimes, entityinstances, entitytypes " +
            "WHERE ent_entitytypeid = ? AND ent_entitytypeid = eni_ent_entitytypeid AND eni_entityinstanceid = etim_eni_entityinstanceid " +
            "ORDER BY etim_createdtime";
    
    public static final String selectEntityTimesByEntityTypeWithLimit = "SELECT _ALL_ " +
            "FROM entitytimes, entityinstances, entitytypes " +
            "WHERE ent_entitytypeid = ? AND ent_entitytypeid = eni_ent_entitytypeid AND eni_entityinstanceid = etim_eni_entityinstanceid " +
            "ORDER BY etim_createdtime " +
            "LIMIT ?";
    
    public List<EntityTime> getEntityTimesByEntityType(EntityType entityType) {
        return getEntityTimesByEntityTypeWithLimit(entityType, negativeOne);
    }
    
    public List<EntityTime> getEntityTimesByEntityTypeWithLimit(EntityType entityType, Integer limit) {
        List<EntityTime> entityTimes;
        
        try {
            int intLimit = limit;
            var ps = EntityTimeFactory.getInstance().prepareStatement(
                    intLimit == -1? selectEntityTimesByEntityType: selectEntityTimesByEntityTypeWithLimit);
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            if(intLimit != -1) {
                ps.setInt(2, intLimit);
            }
            
            entityTimes = EntityTimeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityTimes;
    }
    
    public static final String selectEntityTimesByEntityTypeCreatedAfter = "SELECT _ALL_ " +
            "FROM entitytimes, entityinstances, entitytypes " +
            "WHERE ent_entitytypeid = ? AND ent_entitytypeid = eni_ent_entitytypeid AND eni_entityinstanceid = etim_eni_entityinstanceid " +
            "AND etim_createdtime IS NOT NULL AND etim_createdtime > ? " +
            "ORDER BY etim_createdtime";
    public static final String selectEntityTimesByEntityTypeCreatedAfterWithLimit = "SELECT _ALL_ " +
            "FROM entitytimes, entityinstances, entitytypes " +
            "WHERE ent_entitytypeid = ? AND ent_entitytypeid = eni_ent_entitytypeid AND eni_entityinstanceid = etim_eni_entityinstanceid " +
            "AND etim_createdtime IS NOT NULL AND etim_createdtime > ? " +
            "ORDER BY etim_createdtime " +
            "LIMIT ?";
    
    public List<EntityTime> getEntityTimesByEntityTypeCreatedAfter(EntityType entityType, Long createdTime) {
        return getEntityTimesByEntityTypeCreatedAfterWithLimit(entityType, createdTime, negativeOne);
    }
    
    public List<EntityTime> getEntityTimesByEntityTypeCreatedAfterWithLimit(EntityType entityType, Long createdTime, Integer limit) {
        List<EntityTime> entityTimes;
        
        try {
            int intLimit = limit;
            var ps = EntityTimeFactory.getInstance().prepareStatement(
                    intLimit == -1? selectEntityTimesByEntityTypeCreatedAfter: selectEntityTimesByEntityTypeCreatedAfterWithLimit);
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            ps.setLong(2, createdTime);
            if(intLimit != -1) {
                ps.setInt(3, intLimit);
            }
            
            entityTimes = EntityTimeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityTimes;
    }
    
    public static final String selectEntityTimesByEntityTypeModifiedAfter = "SELECT _ALL_ " +
            "FROM entitytimes, entityinstances, entitytypes " +
            "WHERE ent_entitytypeid = ? AND ent_entitytypeid = eni_ent_entitytypeid AND eni_entityinstanceid = etim_eni_entityinstanceid " +
            "AND etim_modifiedtime IS NOT NULL AND etim_modifiedtime > ? " +
            "ORDER BY etim_modifiedtime";
    public static final String selectEntityTimesByEntityTypeModifiedAfterWithLimit = "SELECT _ALL_ " +
            "FROM entitytimes, entityinstances, entitytypes " +
            "WHERE ent_entitytypeid = ? AND ent_entitytypeid = eni_ent_entitytypeid AND eni_entityinstanceid = etim_eni_entityinstanceid " +
            "AND etim_modifiedtime IS NOT NULL AND etim_modifiedtime > ? " +
            "ORDER BY etim_modifiedtime " +
            "LIMIT ?";
    
    public List<EntityTime> getEntityTimesByEntityTypeModifiedAfter(EntityType entityType, Long modifiedTime) {
        return getEntityTimesByEntityTypeModifiedAfterWithLimit(entityType, modifiedTime, negativeOne);
    }
    
    public List<EntityTime> getEntityTimesByEntityTypeModifiedAfterWithLimit(EntityType entityType, Long modifiedTime, Integer limit) {
        List<EntityTime> entityTimes;
        
        try {
            int intLimit = limit;
            var ps = EntityTimeFactory.getInstance().prepareStatement(
                    intLimit == -1? selectEntityTimesByEntityTypeModifiedAfter: selectEntityTimesByEntityTypeModifiedAfterWithLimit);
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            ps.setLong(2, modifiedTime);
            if(intLimit != -1) {
                ps.setInt(3, intLimit);
            }
            
            entityTimes = EntityTimeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityTimes;
    }
    
    public static final String selectEntityTimesByEntityTypeDeletedAfter = "SELECT _ALL_ " +
            "FROM entitytimes, entityinstances, entitytypes " +
            "WHERE ent_entitytypeid = ? AND ent_entitytypeid = eni_ent_entitytypeid AND eni_entityinstanceid = etim_eni_entityinstanceid " +
            "AND etim_deletedtime IS NOT NULL AND etim_deletedtime > ? " +
            "ORDER BY etim_deletedtime";
    public static final String selectEntityTimesByEntityTypeDeletedAfterWithLimit = "SELECT _ALL_ " +
            "FROM entitytimes, entityinstances, entitytypes " +
            "WHERE ent_entitytypeid = ? AND ent_entitytypeid = eni_ent_entitytypeid AND eni_entityinstanceid = etim_eni_entityinstanceid " +
            "AND etim_deletedtime IS NOT NULL AND etim_deletedtime > ? " +
            "ORDER BY etim_deletedtime " +
            "LIMIT ?";
    
    public List<EntityTime> getEntityTimesByEntityTypeDeletedAfter(EntityType entityType, Long deletedTime) {
        return getEntityTimesByEntityTypeDeletedAfterWithLimit(entityType, deletedTime, negativeOne);
    }
    
    public List<EntityTime> getEntityTimesByEntityTypeDeletedAfterWithLimit(EntityType entityType, Long deletedTime, Integer limit) {
        List<EntityTime> entityTimes;
        
        try {
            int intLimit = limit;
            var ps = EntityTimeFactory.getInstance().prepareStatement(
                    intLimit == -1? selectEntityTimesByEntityTypeDeletedAfter: selectEntityTimesByEntityTypeDeletedAfterWithLimit);
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            ps.setLong(2, deletedTime);
            if(intLimit != -1) {
                ps.setInt(3, intLimit);
            }
            
            entityTimes = EntityTimeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityTimes;
    }
    
    public EntityTimeTransfer getEntityTimeTransfer(UserVisit userVisit, EntityTime entityTime) {
        return getCoreTransferCaches(userVisit).getEntityTimeTransferCache().getEntityTimeTransfer(entityTime);
    }
    
    // --------------------------------------------------------------------------------
    //   Event Groups
    // --------------------------------------------------------------------------------
    
    boolean alreadyCreatingEventGroup = false;
    
    public EventGroup getActiveEventGroup(BasePK createdBy) {
        EventGroup eventGroup = null;
        
        if(!alreadyCreatingEventGroup) {
            var workflowStep = getWorkflowControl().getWorkflowStepUsingNames(Workflow_EVENT_GROUP_STATUS,
                    WorkflowStep_EVENT_GROUP_STATUS_ACTIVE);

            if(workflowStep != null) {
                List<EventGroup> eventGroups;

                try {
                    var ps = EventGroupFactory.getInstance().prepareStatement(
                            "SELECT _ALL_ " +
                            "FROM componentvendors, componentvendordetails, entitytypes, entitytypedetails, entityinstances, " +
                            "eventgroups, eventgroupdetails, workflowentitystatuses, entitytimes " +
                            "WHERE evgrp_activedetailid = evgrpdt_eventgroupdetailid " +
                            "AND cvnd_activedetailid = cvndd_componentvendordetailid AND cvndd_componentvendorname = ? " +
                            "AND ent_activedetailid = entdt_entitytypedetailid " +
                            "AND cvnd_componentvendorid = entdt_cvnd_componentvendorid " +
                            "AND entdt_entitytypename = ? " +
                            "AND ent_entitytypeid = eni_ent_entitytypeid AND evgrp_eventgroupid = eni_entityuniqueid " +
                            "AND eni_entityinstanceid = wkfles_eni_entityinstanceid AND wkfles_wkfls_workflowstepid = ? AND wkfles_thrutime = ? " +
                            "AND eni_entityinstanceid = etim_eni_entityinstanceid " +
                            "ORDER BY etim_createdtime DESC");

                    ps.setString(1, ComponentVendors.ECHO_THREE.name());
                    ps.setString(2, EntityTypes.EventGroup.name());
                    ps.setLong(3, workflowStep.getPrimaryKey().getEntityId());
                    ps.setLong(4, Session.MAX_TIME);

                    eventGroups = EventGroupFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
                } catch (SQLException se) {
                    throw new PersistenceDatabaseException(se);
                }

                if(eventGroups != null && !eventGroups.isEmpty()) {
                    eventGroup = eventGroups.iterator().next();
                } else {
                    alreadyCreatingEventGroup = true;
                    eventGroup = createEventGroup(createdBy);
                    alreadyCreatingEventGroup = false;
                }
            }
        }
        
        return eventGroup;
    }
    
    public EventGroup createEventGroup(BasePK createdBy) {
        var sequenceControl = Session.getModelController(SequenceControl.class);
        var workflowControl = getWorkflowControl();
        EventGroup eventGroup = null;
        var workflow = workflowControl.getWorkflowByName(Workflow_EVENT_GROUP_STATUS);
        
        if(workflow != null) {
            var workflowEntrance = workflowControl.getDefaultWorkflowEntrance(workflow);
            
            if(workflowEntrance != null && (workflowControl.countWorkflowEntranceStepsByWorkflowEntrance(workflowEntrance) > 0)) {
                var sequence = sequenceControl.getDefaultSequenceUsingNames(SequenceTypes.EVENT_GROUP.name());
                var eventGroupName = SequenceGeneratorLogic.getInstance().getNextSequenceValue(sequence);
                
                eventGroup = createEventGroup(eventGroupName, createdBy);

                var entityInstance = getEntityInstanceByBaseEntity(eventGroup);
                getWorkflowControl().addEntityToWorkflow(workflowEntrance, entityInstance, null, null, createdBy);
            }
        }
        
        return eventGroup;
    }
    
    public EventGroup createEventGroup(String eventGroupName, BasePK createdBy) {
        var eventGroup = EventGroupFactory.getInstance().create();
        var eventGroupDetail = EventGroupDetailFactory.getInstance().create(eventGroup, eventGroupName,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        // Convert to R/W
        eventGroup = EventGroupFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                eventGroup.getPrimaryKey());
        eventGroup.setActiveDetail(eventGroupDetail);
        eventGroup.setLastDetail(eventGroupDetail);
        eventGroup.store();
        
        sendEvent(eventGroup.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return eventGroup;
    }
    
    public EventGroupDetailValue getEventGroupDetailValueForUpdate(EventGroup eventGroup) {
        return eventGroup.getLastDetailForUpdate().getEventGroupDetailValue().clone();
    }
    
    private EventGroup getEventGroupByName(String eventGroupName, EntityPermission entityPermission) {
        EventGroup eventGroup;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM eventgroups, eventgroupdetails " +
                        "WHERE evgrp_activedetailid = evgrpdt_eventgroupdetailid AND evgrpdt_eventgroupname = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM eventgroups, eventgroupdetails " +
                        "WHERE evgrp_activedetailid = evgrpdt_eventgroupdetailid AND evgrpdt_eventgroupname = ? " +
                        "FOR UPDATE";
            }

            var ps = EventGroupFactory.getInstance().prepareStatement(query);
            
            ps.setString(1, eventGroupName);
            
            eventGroup = EventGroupFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return eventGroup;
    }
    
    public EventGroup getEventGroupByName(String eventGroupName) {
        return getEventGroupByName(eventGroupName, EntityPermission.READ_ONLY);
    }
    
    public EventGroup getEventGroupByNameForUpdate(String eventGroupName) {
        return getEventGroupByName(eventGroupName, EntityPermission.READ_WRITE);
    }
    
    public EventGroupDetailValue getEventGroupDetailValueByNameForUpdate(String eventGroupName) {
        return getEventGroupDetailValueForUpdate(getEventGroupByNameForUpdate(eventGroupName));
    }
    
    private List<EventGroup> getEventGroups(EntityPermission entityPermission) {
        String query = null;
        
        if(entityPermission.equals(EntityPermission.READ_ONLY)) {
            query = "SELECT _ALL_ " +
                    "FROM eventgroups, eventgroupdetails " +
                    "WHERE evgrp_activedetailid = evgrpdt_eventgroupdetailid " +
                    "ORDER BY evgrpdt_eventgroupname";
        } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
            query = "SELECT _ALL_ " +
                    "FROM eventgroups, eventgroupdetails " +
                    "WHERE evgrp_activedetailid = evgrpdt_eventgroupdetailid " +
                    "FOR UPDATE";
        }

        var ps = EventGroupFactory.getInstance().prepareStatement(query);
        
        return EventGroupFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
    }
    
    public List<EventGroup> getEventGroups() {
        return getEventGroups(EntityPermission.READ_ONLY);
    }
    
    public List<EventGroup> getEventGroupsForUpdate() {
        return getEventGroups(EntityPermission.READ_WRITE);
    }
    
    public EventGroupTransfer getEventGroupTransfer(UserVisit userVisit, EventGroup eventGroup) {
        return getCoreTransferCaches(userVisit).getEventGroupTransferCache().getEventGroupTransfer(eventGroup);
    }
    
    public List<EventGroupTransfer> getEventGroupTransfers(UserVisit userVisit, Collection<EventGroup> eventGroups) {
        List<EventGroupTransfer> eventGroupTransfers = new ArrayList<>(eventGroups.size());
        var eventGroupTransferCache = getCoreTransferCaches(userVisit).getEventGroupTransferCache();
        
        eventGroups.forEach((eventGroup) ->
                eventGroupTransfers.add(eventGroupTransferCache.getEventGroupTransfer(eventGroup))
        );
        
        return eventGroupTransfers;
    }
    
    public List<EventGroupTransfer> getEventGroupTransfers(UserVisit userVisit) {
        return getEventGroupTransfers(userVisit, getEventGroups());
    }
    
    public EventGroupStatusChoicesBean getEventGroupStatusChoices(String defaultEventGroupStatusChoice, Language language, boolean allowNullChoice,
            EventGroup eventGroup, PartyPK partyPK) {
        var workflowControl = getWorkflowControl();
        var eventGroupStatusChoicesBean = new EventGroupStatusChoicesBean();
        
        if(eventGroup == null) {
            workflowControl.getWorkflowEntranceChoices(eventGroupStatusChoicesBean, defaultEventGroupStatusChoice, language, allowNullChoice,
                    workflowControl.getWorkflowByName(Workflow_EVENT_GROUP_STATUS), partyPK);
        } else {
            var entityInstance = getCoreControl().getEntityInstanceByBasePK(eventGroup.getPrimaryKey());
            var workflowEntityStatus = workflowControl.getWorkflowEntityStatusByEntityInstanceUsingNames(Workflow_EVENT_GROUP_STATUS,
                    entityInstance);
            
            workflowControl.getWorkflowDestinationChoices(eventGroupStatusChoicesBean, defaultEventGroupStatusChoice, language, allowNullChoice,
                    workflowEntityStatus.getWorkflowStep(), partyPK);
        }
        
        return eventGroupStatusChoicesBean;
    }
    
    public void setEventGroupStatus(ExecutionErrorAccumulator eea, EventGroup eventGroup, String eventGroupStatusChoice, PartyPK modifiedBy) {
        var workflowControl = getWorkflowControl();
        var entityInstance = getEntityInstanceByBaseEntity(eventGroup);
        var workflowEntityStatus = workflowControl.getWorkflowEntityStatusByEntityInstanceForUpdateUsingNames(Workflow_EVENT_GROUP_STATUS,
                entityInstance);
        var workflowDestination = eventGroupStatusChoice == null? null:
            workflowControl.getWorkflowDestinationByName(workflowEntityStatus.getWorkflowStep(), eventGroupStatusChoice);
        
        if(workflowDestination != null || eventGroupStatusChoice == null) {
            workflowControl.transitionEntityInWorkflow(eea, workflowEntityStatus, workflowDestination, null, modifiedBy);
        } else {
            eea.addExecutionError(ExecutionErrors.UnknownEventGroupStatusChoice.name(), eventGroupStatusChoice);
        }
    }
    
    // --------------------------------------------------------------------------------
    //   Events
    // --------------------------------------------------------------------------------
    
    public Event createEvent(EventGroup eventGroup, Long eventTime, EntityInstance entityInstance, EventType eventType,
            EntityInstance relatedEntityInstance, EventType relatedEventType, EntityInstance createdBy) {
        var eventTimeSequence = session.getNextEventTimeSequence(entityInstance.getPrimaryKey());

        return EventFactory.getInstance().create(eventGroup, eventTime, eventTimeSequence, entityInstance, eventType, relatedEntityInstance, relatedEventType,
                createdBy);
    }
    
    public long countEventsByEventGroup(EventGroup eventGroup) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM events " +
                "WHERE ev_evgrp_eventgroupid = ?",
                eventGroup);
    }

    public long countEventsByEntityInstance(EntityInstance entityInstance) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM events " +
                "WHERE ev_eni_entityinstanceid = ?",
                entityInstance);
    }

    public long countEventsByEventType(EventType eventType) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM events " +
                "WHERE ev_evty_eventtypeid = ?",
                eventType);
    }

    public long countEventsByCreatedBy(EntityInstance createdBy) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM events " +
                "WHERE ev_createdbyid = ?",
                createdBy);
    }

    private static final Map<EntityPermission, String> getEventsByEventGroupQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM events "
                + "WHERE ev_evgrp_eventgroupid = ? "
                + "ORDER BY ev_eventtime, ev_eventtimesequence "
                + "_LIMIT_");
        getEventsByEventGroupQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<Event> getEventsByEventGroup(EventGroup eventGroup) {
        return EventFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEventsByEventGroupQueries,
                eventGroup);
    }
    
    private static final Map<EntityPermission, String> getEventsByEntityInstanceQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM events "
                + "WHERE ev_eni_entityinstanceid = ? "
                + "ORDER BY ev_eventtime, ev_eventtimesequence "
                + "_LIMIT_");
        getEventsByEntityInstanceQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<Event> getEventsByEntityInstance(EntityInstance entityInstance) {
        return EventFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEventsByEntityInstanceQueries,
                entityInstance);
    }
    
    private static final Map<EntityPermission, String> getEventsByEventTypeQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM events "
                + "WHERE ev_eni_entityinstanceid = ? "
                + "ORDER BY ev_eventtime, ev_eventtimesequence "
                + "_LIMIT_");
        getEventsByEventTypeQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<Event> getEventsByEventType(EventType eventType) {
        return EventFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEventsByEventTypeQueries,
                eventType);
    }
    
    private static final Map<EntityPermission, String> getEventsByCreatedByQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM events "
                + "WHERE ev_createdbyid = ? "
                + "ORDER BY ev_eventtime, ev_eventtimesequence "
                + "_LIMIT_");
        getEventsByCreatedByQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<Event> getEventsByCreatedBy(EntityInstance createdBy) {
        return EventFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEventsByCreatedByQueries,
                createdBy);
    }
    
    private static final Map<EntityPermission, String> getEventsByEntityInstanceAndEventTypeQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM events "
                + "WHERE ev_eni_entityinstanceid = ? AND ev_evty_eventtypeid = ? "
                + "ORDER BY ev_eventtime "
                + "FOR UPDATE");
        getEventsByEntityInstanceAndEventTypeQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<Event> getEventsByEntityInstanceAndEventTypeForUpdate(EntityInstance entityInstance, EventType eventType) {
        return EventFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, getEventsByEntityInstanceAndEventTypeQueries,
                entityInstance, eventType);
    }
    
    public List<EventTransfer> getEventTransfers(UserVisit userVisit, Collection<Event> events) {
        List<EventTransfer> eventTransfers = new ArrayList<>(events.size());
        var eventTransferCache = getCoreTransferCaches(userVisit).getEventTransferCache();
        
        events.forEach((event) ->
                eventTransfers.add(eventTransferCache.getEventTransfer(event))
        );
        
        return eventTransfers;
    }
    
    public List<EventTransfer> getEventTransfersByEntityInstance(UserVisit userVisit, EventGroup eventGroup) {
        return getEventTransfers(userVisit, getEventsByEventGroup(eventGroup));
    }
    
    public List<EventTransfer> getEventTransfersByEntityInstance(UserVisit userVisit, EntityInstance entityInstance) {
        return getEventTransfers(userVisit, getEventsByEntityInstance(entityInstance));
    }
    
    public List<EventTransfer> getEventTransfersByEntityInstance(UserVisit userVisit, EventType eventType) {
        return getEventTransfers(userVisit, getEventsByEventType(eventType));
    }
    
    public List<EventTransfer> getEventTransfersByCreatedBy(UserVisit userVisit, EntityInstance createdBy) {
        return getEventTransfers(userVisit, getEventsByCreatedBy(createdBy));
    }
    
    public void removeEvent(Event event) {
        event.remove();
    }
    
    // --------------------------------------------------------------------------------
    //   Queued Events
    // --------------------------------------------------------------------------------
    
    public QueuedEvent createQueuedEvent(Event event) {
        return QueuedEventFactory.getInstance().create(event);
    }
    
    public List<QueuedEvent> getQueuedEventsForUpdate() {
        var ps = QueuedEventFactory.getInstance().prepareStatement(
                "SELECT _ALL_ " +
                "FROM queuedevents " +
                "FOR UPDATE");

        return QueuedEventFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
    }
    
    public void removeQueuedEvent(QueuedEvent queuedEvent) {
        queuedEvent.remove();
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Visits
    // --------------------------------------------------------------------------------
    
    public EntityVisit createEntityVisit(final EntityInstance entityInstance, final EntityInstance visitedEntityInstance) {
        return EntityVisitFactory.getInstance().create(entityInstance, visitedEntityInstance, session.START_TIME_LONG);
    }

    private static final Map<EntityPermission, String> getEntityVisitQueries;

    static {
        getEntityVisitQueries = Map.of(
                EntityPermission.READ_ONLY, """
                        SELECT _ALL_
                        FROM entityvisits
                        WHERE evis_eni_entityinstanceid = ? AND evis_visitedentityinstanceid = ?
                        """,
                EntityPermission.READ_WRITE, """
                        SELECT _ALL_
                        FROM entityvisits
                        WHERE evis_eni_entityinstanceid = ? AND evis_visitedentityinstanceid = ?
                        FOR UPDATE
                        """);
    }

    private EntityVisit getEntityVisit(final EntityInstance entityInstance, final EntityInstance visitedEntityInstance,
            final EntityPermission entityPermission) {
        return EntityVisitFactory.getInstance().getEntityFromQuery(entityPermission, getEntityVisitQueries, entityInstance, visitedEntityInstance);
    }

    public EntityVisit getEntityVisit(final EntityInstance entityInstance, final EntityInstance visitedEntityInstance) {
        return getEntityVisit(entityInstance, visitedEntityInstance, EntityPermission.READ_ONLY);
    }

    public EntityVisit getEntityVisitForUpdate(final EntityInstance entityInstance, final EntityInstance visitedEntityInstance) {
        return getEntityVisit(entityInstance, visitedEntityInstance, EntityPermission.READ_WRITE);
    }

    public EntityVisitTransfer getEntityVisitTransfer(UserVisit userVisit, EntityVisit entityVisit) {
        return getCoreTransferCaches(userVisit).getEntityVisitTransferCache().getEntityVisitTransfer(entityVisit);
    }
    
    // --------------------------------------------------------------------------------
    //   Cache Entries
    // --------------------------------------------------------------------------------

    public CacheEntry createCacheEntry(String cacheEntryKey, MimeType mimeType, Long createdTime, Long validUntilTime, String clob, ByteArray blob,
            Set<String> entityRefs) {
        var cacheEntry = createCacheEntry(cacheEntryKey, mimeType, createdTime, validUntilTime);
        var entityAttributeTypeName = mimeType.getLastDetail().getEntityAttributeType().getEntityAttributeTypeName();

        if(entityAttributeTypeName.equals(EntityAttributeTypes.CLOB.name())) {
            createCacheClobEntry(cacheEntry, clob);
        } else if(entityAttributeTypeName.equals(EntityAttributeTypes.BLOB.name())) {
            createCacheBlobEntry(cacheEntry, blob);
        }

        if(entityRefs != null) {
            createCacheEntryDependencies(cacheEntry, entityRefs);
        }

        return cacheEntry;
    }

    public CacheEntry createCacheEntry(String cacheEntryKey, MimeType mimeType, Long createdTime, Long validUntilTime) {
        return CacheEntryFactory.getInstance().create(cacheEntryKey, mimeType, createdTime, validUntilTime);
    }

    public long countCacheEntries() {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM cacheentries");
    }

    private static final Map<EntityPermission, String> getCacheEntryByCacheEntryKeyQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM cacheentries " +
                "WHERE cent_cacheentrykey = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM cacheentries " +
                "WHERE cent_cacheentrykey = ? " +
                "FOR UPDATE");
        getCacheEntryByCacheEntryKeyQueries = Collections.unmodifiableMap(queryMap);
    }

    private CacheEntry getCacheEntryByCacheEntryKey(String cacheEntryKey, EntityPermission entityPermission) {
        return CacheEntryFactory.getInstance().getEntityFromQuery(entityPermission, getCacheEntryByCacheEntryKeyQueries,
                cacheEntryKey);
    }

    public CacheEntry getCacheEntryByCacheEntryKey(String cacheEntryKey) {
        return getCacheEntryByCacheEntryKey(cacheEntryKey, EntityPermission.READ_ONLY);
    }

    public CacheEntry getCacheEntryByCacheEntryKeyForUpdate(String cacheEntryKey) {
        return getCacheEntryByCacheEntryKey(cacheEntryKey, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getCacheEntriesByCacheEntryKeyQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM cacheentries " +
                "ORDER BY cent_cacheentrykey " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM cacheentries " +
                "FOR UPDATE");
        getCacheEntriesByCacheEntryKeyQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<CacheEntry> getCacheEntries(EntityPermission entityPermission) {
        return CacheEntryFactory.getInstance().getEntitiesFromQuery(entityPermission, getCacheEntriesByCacheEntryKeyQueries);
    }

    public List<CacheEntry> getCacheEntries() {
        return getCacheEntries(EntityPermission.READ_ONLY);
    }

    public List<CacheEntry> getCacheEntriesForUpdate() {
        return getCacheEntries(EntityPermission.READ_WRITE);
    }

    public CacheEntryTransfer getCacheEntryTransfer(UserVisit userVisit, CacheEntry cacheEntry) {
        return getCoreTransferCaches(userVisit).getCacheEntryTransferCache().getCacheEntryTransfer(cacheEntry);
    }

    public CacheEntryTransfer getCacheEntryTransferByCacheEntryKey(UserVisit userVisit, String cacheEntryKey) {
        var cacheEntry = getCacheEntryByCacheEntryKey(cacheEntryKey);
        CacheEntryTransfer cacheEntryTransfer = null;

        if(cacheEntry != null) {
            var validUntilTime = cacheEntry.getValidUntilTime();
            
            if(validUntilTime != null && validUntilTime < session.START_TIME) {
                removeCacheEntry(cacheEntry);
            } else {
                cacheEntryTransfer = getCacheEntryTransfer(userVisit, cacheEntry);
            }
        }

        return cacheEntryTransfer;
    }

    public List<CacheEntryTransfer> getCacheEntryTransfers(UserVisit userVisit, Collection<CacheEntry> cacheEntries) {
        List<CacheEntryTransfer> cacheEntryTransfers = new ArrayList<>(cacheEntries.size());
        var cacheEntryTransferCache = getCoreTransferCaches(userVisit).getCacheEntryTransferCache();

        cacheEntries.forEach((cacheEntry) ->
                cacheEntryTransfers.add(cacheEntryTransferCache.getCacheEntryTransfer(cacheEntry))
        );

        return cacheEntryTransfers;
    }

    public List<CacheEntryTransfer> getCacheEntryTransfers(UserVisit userVisit) {
        return getCacheEntryTransfers(userVisit, getCacheEntries());
    }

    public void removeCacheEntry(CacheEntry cacheEntry) {
        cacheEntry.remove();
    }
    
    public void removeCacheEntries(List<CacheEntry> cacheEntries) {
        cacheEntries.forEach(this::removeCacheEntry);
    }
    
    public void removeCacheEntries() {
        removeCacheEntries(getCacheEntriesForUpdate());
    }

    private List<CacheEntryPK> getCacheEntryPKsByEntityInstance(final EntityInstance entityInstance) {
        final var instance = CacheEntryFactory.getInstance();
        
        return instance.getPKsFromQueryAsList(
                instance.prepareStatement(
                        "SELECT _PK_ "
                        + "FROM cacheentrydependencies, cacheentries "
                        + "WHERE centd_eni_entityinstanceid = ? "
                        + "AND centd_cent_cacheentryid = cent_cacheentryid"),
                entityInstance);
    }

    public void removeCacheEntriesByEntityInstance(final EntityInstance entityInstance) {
        CacheEntryFactory.getInstance().remove(getCacheEntryPKsByEntityInstance(entityInstance));
    }

    // --------------------------------------------------------------------------------
    //   Cache Clob Entries
    // --------------------------------------------------------------------------------

    public CacheClobEntry createCacheClobEntry(CacheEntry cacheEntry, String clob) {
        return CacheClobEntryFactory.getInstance().create(cacheEntry, clob);
    }

    private static final Map<EntityPermission, String> getCacheClobEntryByCacheEntryQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM cacheclobentries " +
                "WHERE ccent_cent_cacheentryid = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM cacheclobentries " +
                "WHERE ccent_cent_cacheentryid = ? " +
                "FOR UPDATE");
        getCacheClobEntryByCacheEntryQueries = Collections.unmodifiableMap(queryMap);
    }

    private CacheClobEntry getCacheClobEntryByCacheEntry(CacheEntry cacheEntry, EntityPermission entityPermission) {
        return CacheClobEntryFactory.getInstance().getEntityFromQuery(entityPermission, getCacheClobEntryByCacheEntryQueries,
                cacheEntry);
    }

    public CacheClobEntry getCacheClobEntryByCacheEntry(CacheEntry cacheEntry) {
        return getCacheClobEntryByCacheEntry(cacheEntry, EntityPermission.READ_ONLY);
    }

    public CacheClobEntry getCacheClobEntryByCacheEntryForUpdate(CacheEntry cacheEntry) {
        return getCacheClobEntryByCacheEntry(cacheEntry, EntityPermission.READ_WRITE);
    }

    // --------------------------------------------------------------------------------
    //   Cache Blob Entries
    // --------------------------------------------------------------------------------

    public CacheBlobEntry createCacheBlobEntry(CacheEntry cacheEntry, ByteArray blob) {
        return CacheBlobEntryFactory.getInstance().create(cacheEntry, blob);
    }

    private static final Map<EntityPermission, String> getCacheBlobEntryByCacheEntryQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM cacheblobentries " +
                "WHERE ccent_cent_cacheentryid = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM cacheblobentries " +
                "WHERE ccent_cent_cacheentryid = ? " +
                "FOR UPDATE");
        getCacheBlobEntryByCacheEntryQueries = Collections.unmodifiableMap(queryMap);
    }

    private CacheBlobEntry getCacheBlobEntryByCacheEntry(CacheEntry cacheEntry, EntityPermission entityPermission) {
        return CacheBlobEntryFactory.getInstance().getEntityFromQuery(entityPermission, getCacheBlobEntryByCacheEntryQueries,
                cacheEntry);
    }

    public CacheBlobEntry getCacheBlobEntryByCacheEntry(CacheEntry cacheEntry) {
        return getCacheBlobEntryByCacheEntry(cacheEntry, EntityPermission.READ_ONLY);
    }

    public CacheBlobEntry getCacheBlobEntryByCacheEntryForUpdate(CacheEntry cacheEntry) {
        return getCacheBlobEntryByCacheEntry(cacheEntry, EntityPermission.READ_WRITE);
    }

    // --------------------------------------------------------------------------------
    //   Cache Entry Dependencies
    // --------------------------------------------------------------------------------
    
    public void createCacheEntryDependencies(CacheEntry cacheEntry, Set<String> entityRefs) {
        List<CacheEntryDependencyValue> cacheEntryDependencyValues = new ArrayList<>(entityRefs.size());

        for(var entityRef : entityRefs) {
            var entityInstance = getEntityInstanceByEntityRef(entityRef);

            if(entityInstance != null) {
                cacheEntryDependencyValues.add(new CacheEntryDependencyValue(cacheEntry.getPrimaryKey(), entityInstance.getPrimaryKey()));
            }
        }
        
        CacheEntryDependencyFactory.getInstance().create(cacheEntryDependencyValues);
    }

    public CacheEntryDependency createCacheEntryDependency(CacheEntry cacheEntry, EntityInstance entityInstance) {
        return CacheEntryDependencyFactory.getInstance().create(cacheEntry, entityInstance);
    }

    private static final Map<EntityPermission, String> getCacheEntryDependenciesByEntityInstanceQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM cacheentrydependencies, cacheentries "
                + "WHERE centd_eni_entityinstanceid = ? "
                + "AND centd_cent_cacheentryid = cent_cacheentryid "
                + "ORDER BY cent_cacheentrykey");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM cacheentrydependencies "
                + "WHERE centd_eni_entityinstanceid = ? "
                + "FOR UPDATE");
        getCacheEntryDependenciesByEntityInstanceQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<CacheEntryDependency> getCacheEntryDependenciesByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        return CacheEntryDependencyFactory.getInstance().getEntitiesFromQuery(entityPermission, getCacheEntryDependenciesByEntityInstanceQueries,
                entityInstance);
    }

    public List<CacheEntryDependency> getCacheEntryDependenciesByEntityInstance(EntityInstance entityInstance) {
        return getCacheEntryDependenciesByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public List<CacheEntryDependency> getCacheEntryDependenciesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getCacheEntryDependenciesByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getCacheEntryDependenciesByCacheEntryQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM cacheentrydependencies, entityinstances, entitytypes, entitytypedetails, componentvendors, componentvendordetails "
                + "WHERE centd_cent_cacheentryid = ? "
                + "AND centd_eni_entityinstanceid = eni_entityinstanceid "
                + "AND eni_ent_entitytypeid = ent_entitytypeid AND ent_lastdetailid = entdt_entitytypedetailid "
                + "AND entdt_cvnd_componentvendorid = cvnd_componentvendorid AND cvnd_lastdetailid = cvndd_componentvendordetailid "
                + "ORDER BY cvndd_componentvendorname, entdt_sortorder, entdt_entitytypename, eni_entityuniqueid");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM cacheentrydependencies "
                + "WHERE centd_cent_cacheentryid = ? "
                + "FOR UPDATE");
        getCacheEntryDependenciesByCacheEntryQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<CacheEntryDependency> getCacheEntryDependenciesByCacheEntry(CacheEntry cacheEntry, EntityPermission entityPermission) {
        return CacheEntryDependencyFactory.getInstance().getEntitiesFromQuery(entityPermission, getCacheEntryDependenciesByCacheEntryQueries,
                cacheEntry);
    }

    public List<CacheEntryDependency> getCacheEntryDependenciesByCacheEntry(CacheEntry cacheEntry) {
        return getCacheEntryDependenciesByCacheEntry(cacheEntry, EntityPermission.READ_ONLY);
    }

    public List<CacheEntryDependency> getCacheEntryDependenciesByCacheEntryForUpdate(CacheEntry cacheEntry) {
        return getCacheEntryDependenciesByCacheEntry(cacheEntry, EntityPermission.READ_WRITE);
    }

    public CacheEntryDependencyTransfer getCacheEntryDependencyTransfer(UserVisit userVisit, CacheEntryDependency cacheEntryDependency) {
        return getCoreTransferCaches(userVisit).getCacheEntryDependencyTransferCache().getCacheEntryDependencyTransfer(cacheEntryDependency);
    }

    public List<CacheEntryDependencyTransfer> getCacheEntryDependencyTransfers(UserVisit userVisit, Collection<CacheEntryDependency> cacheEntries) {
        List<CacheEntryDependencyTransfer> cacheEntryDependencyTransfers = new ArrayList<>(cacheEntries.size());
        var cacheEntryDependencyTransferCache = getCoreTransferCaches(userVisit).getCacheEntryDependencyTransferCache();

        cacheEntries.forEach((cacheEntryDependency) ->
                cacheEntryDependencyTransfers.add(cacheEntryDependencyTransferCache.getCacheEntryDependencyTransfer(cacheEntryDependency))
        );

        return cacheEntryDependencyTransfers;
    }

    public List<CacheEntryDependencyTransfer> getCacheEntryDependencyTransfersByCacheEntry(UserVisit userVisit, CacheEntry cacheEntry) {
        return getCacheEntryDependencyTransfers(userVisit, getCacheEntryDependenciesByCacheEntry(cacheEntry));
    }

    // --------------------------------------------------------------------------------
    //   Entity Alias Types
    // --------------------------------------------------------------------------------

    public EntityAliasType createEntityAliasType(EntityType entityType, String entityAliasTypeName,
            String validationPattern, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultEntityAliasType = getDefaultEntityAliasType(entityType);
        var defaultFound = defaultEntityAliasType != null;

        if(defaultFound && isDefault) {
            var defaultEntityAliasTypeDetailValue = getDefaultEntityAliasTypeDetailValueForUpdate(entityType);

            defaultEntityAliasTypeDetailValue.setIsDefault(Boolean.FALSE);
            updateEntityAliasTypeFromValue(defaultEntityAliasTypeDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var entityAliasType = EntityAliasTypeFactory.getInstance().create();
        var entityAliasTypeDetail = EntityAliasTypeDetailFactory.getInstance().create(entityAliasType, entityType,
                entityAliasTypeName, validationPattern, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        // Convert to R/W
        entityAliasType = EntityAliasTypeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                entityAliasType.getPrimaryKey());
        entityAliasType.setActiveDetail(entityAliasTypeDetail);
        entityAliasType.setLastDetail(entityAliasTypeDetail);
        entityAliasType.store();

        sendEvent(entityAliasType.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return entityAliasType;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.EntityAliasType */
    public EntityAliasType getEntityAliasTypeByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new EntityAliasTypePK(entityInstance.getEntityUniqueId());

        return EntityAliasTypeFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public EntityAliasType getEntityAliasTypeByEntityInstance(EntityInstance entityInstance) {
        return getEntityAliasTypeByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public EntityAliasType getEntityAliasTypeByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getEntityAliasTypeByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public EntityAliasType getEntityAliasTypeByPK(EntityAliasTypePK pk) {
        return EntityAliasTypeFactory.getInstance().getEntityFromPK(EntityPermission.READ_ONLY, pk);
    }

    public long countEntityAliasTypesByEntityType(EntityType entityType) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                        "FROM entityaliastypes, entityaliastypedetails " +
                        "WHERE eniat_activedetailid = eniatdt_entityaliastypedetailid AND eniatdt_ent_entitytypeid = ?",
                entityType);
    }

    public EntityAliasType getEntityAliasTypeByName(EntityType entityType, String entityAliasTypeName, EntityPermission entityPermission) {
        EntityAliasType entityAliasType;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliastypes, entityaliastypedetails " +
                        "WHERE eniat_activedetailid = eniatdt_entityaliastypedetailid " +
                        "AND eniatdt_ent_entitytypeid = ? AND eniatdt_entityaliastypename = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliastypes, entityaliastypedetails " +
                        "WHERE eniat_activedetailid = eniatdt_entityaliastypedetailid " +
                        "AND eniatdt_ent_entitytypeid = ? AND eniatdt_entityaliastypename = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAliasTypeFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            ps.setString(2, entityAliasTypeName);

            entityAliasType = EntityAliasTypeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityAliasType;
    }

    public EntityAliasType getEntityAliasTypeByName(EntityType entityType, String entityAliasTypeName) {
        return getEntityAliasTypeByName(entityType, entityAliasTypeName, EntityPermission.READ_ONLY);
    }

    public EntityAliasType getEntityAliasTypeByNameForUpdate(EntityType entityType, String entityAliasTypeName) {
        return getEntityAliasTypeByName(entityType, entityAliasTypeName, EntityPermission.READ_WRITE);
    }

    public EntityAliasTypeDetailValue getEntityAliasTypeDetailValueForUpdate(EntityAliasType entityAliasType) {
        return entityAliasType == null? null: entityAliasType.getLastDetailForUpdate().getEntityAliasTypeDetailValue().clone();
    }

    public EntityAliasTypeDetailValue getEntityAliasTypeDetailValueByNameForUpdate(EntityType entityType, String entityAliasTypeName) {
        return getEntityAliasTypeDetailValueForUpdate(getEntityAliasTypeByNameForUpdate(entityType, entityAliasTypeName));
    }

    private static final Map<EntityPermission, String> getDefaultEntityAliasTypeQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                        "FROM entityaliastypes, entityaliastypedetails " +
                        "WHERE eniat_activedetailid = eniatdt_entityaliastypedetailid " +
                        "AND eniatdt_ent_entitytypeid = ? " +
                        "AND eniatdt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                        "FROM entityaliastypes, entityaliastypedetails " +
                        "WHERE eniat_activedetailid = eniatdt_entityaliastypedetailid " +
                        "AND eniatdt_ent_entitytypeid = ? " +
                        "AND eniatdt_isdefault = 1 " +
                        "FOR UPDATE");
        getDefaultEntityAliasTypeQueries = Collections.unmodifiableMap(queryMap);
    }

    private EntityAliasType getDefaultEntityAliasType(EntityPermission entityPermission, EntityType entityType) {
        return EntityAliasTypeFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultEntityAliasTypeQueries,
                entityType);
    }

    public EntityAliasType getDefaultEntityAliasType(EntityType entityType) {
        return getDefaultEntityAliasType(EntityPermission.READ_ONLY, entityType);
    }

    public EntityAliasType getDefaultEntityAliasTypeForUpdate(EntityType entityType) {
        return getDefaultEntityAliasType(EntityPermission.READ_WRITE, entityType);
    }

    public EntityAliasTypeDetailValue getDefaultEntityAliasTypeDetailValueForUpdate(EntityType entityType) {
        return getDefaultEntityAliasTypeForUpdate(entityType).getLastDetailForUpdate().getEntityAliasTypeDetailValue().clone();
    }

    private List<EntityAliasType> getEntityAliasTypesByEntityType(EntityType entityType, EntityPermission entityPermission) {
        List<EntityAliasType> entityAliasTypes;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliastypes, entityaliastypedetails " +
                        "WHERE eniat_activedetailid = eniatdt_entityaliastypedetailid " +
                        "AND eniatdt_ent_entitytypeid = ? " +
                        "ORDER BY eniatdt_sortorder, eniatdt_entityaliastypename " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliastypes, entityaliastypedetails " +
                        "WHERE eniat_activedetailid = eniatdt_entityaliastypedetailid " +
                        "AND eniatdt_ent_entitytypeid = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAliasTypeFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityType.getPrimaryKey().getEntityId());

            entityAliasTypes = EntityAliasTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityAliasTypes;
    }

    public List<EntityAliasType> getEntityAliasTypesByEntityType(EntityType entityType) {
        return getEntityAliasTypesByEntityType(entityType, EntityPermission.READ_ONLY);
    }

    public List<EntityAliasType> getEntityAliasTypesByEntityTypeForUpdate(EntityType entityType) {
        return getEntityAliasTypesByEntityType(entityType, EntityPermission.READ_WRITE);
    }

    public EntityAliasTypeTransfer getEntityAliasTypeTransfer(UserVisit userVisit, EntityAliasType entityAliasType, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityAliasTypeTransferCache().getEntityAliasTypeTransfer(entityAliasType, entityInstance);
    }

    public List<EntityAliasTypeTransfer> getEntityAliasTypeTransfers(UserVisit userVisit, Collection<EntityAliasType> entityAliasTypes, EntityInstance entityInstance) {
        List<EntityAliasTypeTransfer> entityAliasTypeTransfers = new ArrayList<>(entityAliasTypes.size());
        var entityAliasTypeTransferCache = getCoreTransferCaches(userVisit).getEntityAliasTypeTransferCache();

        entityAliasTypes.forEach((entityAliasType) ->
                entityAliasTypeTransfers.add(entityAliasTypeTransferCache.getEntityAliasTypeTransfer(entityAliasType, entityInstance))
        );

        return entityAliasTypeTransfers;
    }

    public List<EntityAliasTypeTransfer> getEntityAliasTypeTransfersByEntityType(UserVisit userVisit, EntityType entityType, EntityInstance entityInstance) {
        return getEntityAliasTypeTransfers(userVisit, getEntityAliasTypesByEntityType(entityType), entityInstance);
    }

    private void updateEntityAliasTypeFromValue(EntityAliasTypeDetailValue entityAliasTypeDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(entityAliasTypeDetailValue.hasBeenModified()) {
            var entityAliasType = EntityAliasTypeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    entityAliasTypeDetailValue.getEntityAliasTypePK());
            var entityAliasTypeDetail = entityAliasType.getActiveDetailForUpdate();

            entityAliasTypeDetail.setThruTime(session.START_TIME_LONG);
            entityAliasTypeDetail.store();

            var entityTypePK = entityAliasTypeDetail.getEntityTypePK();
            var entityAliasTypePK = entityAliasTypeDetail.getEntityAliasTypePK(); // Not updated
            var entityAliasTypeName = entityAliasTypeDetailValue.getEntityAliasTypeName();
            var validationPattern = entityAliasTypeDetailValue.getValidationPattern();
            var isDefault = entityAliasTypeDetailValue.getIsDefault();
            var sortOrder = entityAliasTypeDetailValue.getSortOrder();

            if(checkDefault) {
                var entityType = entityAliasTypeDetail.getEntityType();
                var defaultEntityAliasType = getDefaultEntityAliasType(entityType);
                var defaultFound = defaultEntityAliasType != null && !defaultEntityAliasType.equals(entityAliasType);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultEntityAliasTypeDetailValue = getDefaultEntityAliasTypeDetailValueForUpdate(entityType);

                    defaultEntityAliasTypeDetailValue.setIsDefault(Boolean.FALSE);
                    updateEntityAliasTypeFromValue(defaultEntityAliasTypeDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            entityAliasTypeDetail = EntityAliasTypeDetailFactory.getInstance().create(entityAliasTypePK, entityTypePK,
                    entityAliasTypeName, validationPattern, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);

            entityAliasType.setActiveDetail(entityAliasTypeDetail);
            entityAliasType.setLastDetail(entityAliasTypeDetail);

            sendEvent(entityAliasTypePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateEntityAliasTypeFromValue(EntityAliasTypeDetailValue entityAliasTypeDetailValue, BasePK updatedBy) {
        updateEntityAliasTypeFromValue(entityAliasTypeDetailValue, true, updatedBy);
    }

    public EntityAliasTypeChoicesBean getEntityAliasTypeChoices(String defaultEntityAliasTypeChoice, Language language,
            boolean allowNullChoice, EntityType entityType) {
        var entityAliasTypes = getEntityAliasTypesByEntityType(entityType);
        var size = entityAliasTypes.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultEntityAliasTypeChoice == null) {
                defaultValue = "";
            }
        }

        for(var entityAliasType : entityAliasTypes) {
            var entityAliasTypeDetail = entityAliasType.getLastDetail();
            var label = getBestEntityAliasTypeDescription(entityAliasType, language);
            var value = entityAliasTypeDetail.getEntityAliasTypeName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultEntityAliasTypeChoice != null && defaultEntityAliasTypeChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && entityAliasTypeDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new EntityAliasTypeChoicesBean(labels, values, defaultValue);
    }

    private void deleteEntityAliasType(EntityAliasType entityAliasType, boolean checkDefault, BasePK deletedBy) {
        var entityAliasTypeDetail = entityAliasType.getLastDetailForUpdate();

        deleteEntityAliasesByEntityAliasType(entityAliasType, deletedBy);
        deleteEntityAliasTypeDescriptionsByEntityAliasType(entityAliasType, deletedBy);

        entityAliasTypeDetail.setThruTime(session.START_TIME_LONG);
        entityAliasType.setActiveDetail(null);
        entityAliasType.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultEntityAliasType = getDefaultEntityAliasType(entityAliasTypeDetail.getEntityType());

            if(defaultEntityAliasType == null) {
                var entityType = entityAliasTypeDetail.getEntityType();
                var entityAliasTypes = getEntityAliasTypesByEntityTypeForUpdate(entityType);

                if(!entityAliasTypes.isEmpty()) {
                    var iter = entityAliasTypes.iterator();
                    if(iter.hasNext()) {
                        defaultEntityAliasType = iter.next();
                    }
                    var entityAliasTypeDetailValue = Objects.requireNonNull(defaultEntityAliasType).getLastDetailForUpdate().getEntityAliasTypeDetailValue().clone();

                    entityAliasTypeDetailValue.setIsDefault(Boolean.TRUE);
                    updateEntityAliasTypeFromValue(entityAliasTypeDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(entityAliasType.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteEntityAliasType(EntityAliasType entityAliasType, BasePK deletedBy) {
        deleteEntityAliasType(entityAliasType, true, deletedBy);
    }

    private void deleteEntityAliasTypes(List<EntityAliasType> entityAliasTypes, boolean checkDefault, BasePK deletedBy) {
        entityAliasTypes.forEach((entityAliasType) -> deleteEntityAliasType(entityAliasType, checkDefault, deletedBy));
    }

    public void deleteEntityAliasTypesByEntityType(EntityType entityType, BasePK deletedBy) {
        deleteEntityAliasTypes(getEntityAliasTypesByEntityTypeForUpdate(entityType), false, deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Entity Alias Type Descriptions
    // --------------------------------------------------------------------------------

    public EntityAliasTypeDescription createEntityAliasTypeDescription(EntityAliasType entityAliasType, Language language,
            String description, BasePK createdBy) {
        var entityAliasTypeDescription = EntityAliasTypeDescriptionFactory.getInstance().create(session,
                entityAliasType, language, description, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityAliasType.getPrimaryKey(), EventTypes.MODIFY, entityAliasTypeDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return entityAliasTypeDescription;
    }

    private EntityAliasTypeDescription getEntityAliasTypeDescription(EntityAliasType entityAliasType, Language language,
            EntityPermission entityPermission) {
        EntityAliasTypeDescription entityAliasTypeDescription;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliastypedescriptions " +
                        "WHERE eniatd_eniat_entityaliastypeid = ? AND eniatd_lang_languageid = ? AND eniatd_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliastypedescriptions " +
                        "WHERE eniatd_eniat_entityaliastypeid = ? AND eniatd_lang_languageid = ? AND eniatd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAliasTypeDescriptionFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityAliasType.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);

            entityAliasTypeDescription = EntityAliasTypeDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityAliasTypeDescription;
    }

    public EntityAliasTypeDescription getEntityAliasTypeDescription(EntityAliasType entityAliasType, Language language) {
        return getEntityAliasTypeDescription(entityAliasType, language, EntityPermission.READ_ONLY);
    }

    public EntityAliasTypeDescription getEntityAliasTypeDescriptionForUpdate(EntityAliasType entityAliasType, Language language) {
        return getEntityAliasTypeDescription(entityAliasType, language, EntityPermission.READ_WRITE);
    }

    public EntityAliasTypeDescriptionValue getEntityAliasTypeDescriptionValue(EntityAliasTypeDescription entityAliasTypeDescription) {
        return entityAliasTypeDescription == null? null: entityAliasTypeDescription.getEntityAliasTypeDescriptionValue().clone();
    }

    public EntityAliasTypeDescriptionValue getEntityAliasTypeDescriptionValueForUpdate(EntityAliasType entityAliasType, Language language) {
        return getEntityAliasTypeDescriptionValue(getEntityAliasTypeDescriptionForUpdate(entityAliasType, language));
    }

    private List<EntityAliasTypeDescription> getEntityAliasTypeDescriptionsByEntityAliasType(EntityAliasType entityAliasType,
            EntityPermission entityPermission) {
        List<EntityAliasTypeDescription> entityAliasTypeDescriptions;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliastypedescriptions, languages " +
                        "WHERE eniatd_eniat_entityaliastypeid = ? AND eniatd_thrutime = ? AND eniatd_lang_languageid = lang_languageid " +
                        "ORDER BY lang_sortorder, lang_languageisoname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliastypedescriptions " +
                        "WHERE eniatd_eniat_entityaliastypeid = ? AND eniatd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAliasTypeDescriptionFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityAliasType.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);

            entityAliasTypeDescriptions = EntityAliasTypeDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityAliasTypeDescriptions;
    }

    public List<EntityAliasTypeDescription> getEntityAliasTypeDescriptionsByEntityAliasType(EntityAliasType entityAliasType) {
        return getEntityAliasTypeDescriptionsByEntityAliasType(entityAliasType, EntityPermission.READ_ONLY);
    }

    public List<EntityAliasTypeDescription> getEntityAliasTypeDescriptionsByEntityAliasTypeForUpdate(EntityAliasType entityAliasType) {
        return getEntityAliasTypeDescriptionsByEntityAliasType(entityAliasType, EntityPermission.READ_WRITE);
    }

    public String getBestEntityAliasTypeDescription(EntityAliasType entityAliasType, Language language) {
        String description;
        var entityAliasTypeDescription = getEntityAliasTypeDescription(entityAliasType, language);

        if(entityAliasTypeDescription == null && !language.getIsDefault()) {
            entityAliasTypeDescription = getEntityAliasTypeDescription(entityAliasType, getPartyControl().getDefaultLanguage());
        }

        if(entityAliasTypeDescription == null) {
            description = entityAliasType.getLastDetail().getEntityAliasTypeName();
        } else {
            description = entityAliasTypeDescription.getDescription();
        }

        return description;
    }

    public EntityAliasTypeDescriptionTransfer getEntityAliasTypeDescriptionTransfer(UserVisit userVisit, EntityAliasTypeDescription entityAliasTypeDescription, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityAliasTypeDescriptionTransferCache().getEntityAliasTypeDescriptionTransfer(entityAliasTypeDescription, entityInstance);
    }

    public List<EntityAliasTypeDescriptionTransfer> getEntityAliasTypeDescriptionTransfersByEntityAliasType(UserVisit userVisit,
            EntityAliasType entityAliasType, EntityInstance entityInstance) {
        var entityAliasTypeDescriptions = getEntityAliasTypeDescriptionsByEntityAliasType(entityAliasType);
        List<EntityAliasTypeDescriptionTransfer> entityAliasTypeDescriptionTransfers = new ArrayList<>(entityAliasTypeDescriptions.size());
        var entityAliasTypeDescriptionTransferCache = getCoreTransferCaches(userVisit).getEntityAliasTypeDescriptionTransferCache();

        entityAliasTypeDescriptions.forEach((entityAliasTypeDescription) ->
                entityAliasTypeDescriptionTransfers.add(entityAliasTypeDescriptionTransferCache.getEntityAliasTypeDescriptionTransfer(entityAliasTypeDescription, entityInstance))
        );

        return entityAliasTypeDescriptionTransfers;
    }

    public void updateEntityAliasTypeDescriptionFromValue(EntityAliasTypeDescriptionValue entityAliasTypeDescriptionValue, BasePK updatedBy) {
        if(entityAliasTypeDescriptionValue.hasBeenModified()) {
            var entityAliasTypeDescription = EntityAliasTypeDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    entityAliasTypeDescriptionValue.getPrimaryKey());

            entityAliasTypeDescription.setThruTime(session.START_TIME_LONG);
            entityAliasTypeDescription.store();

            var entityAliasType = entityAliasTypeDescription.getEntityAliasType();
            var language = entityAliasTypeDescription.getLanguage();
            var description = entityAliasTypeDescriptionValue.getDescription();

            entityAliasTypeDescription = EntityAliasTypeDescriptionFactory.getInstance().create(entityAliasType, language,
                    description, session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(entityAliasType.getPrimaryKey(), EventTypes.MODIFY, entityAliasTypeDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteEntityAliasTypeDescription(EntityAliasTypeDescription entityAliasTypeDescription, BasePK deletedBy) {
        entityAliasTypeDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(entityAliasTypeDescription.getEntityAliasTypePK(), EventTypes.MODIFY, entityAliasTypeDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deleteEntityAliasTypeDescriptionsByEntityAliasType(EntityAliasType entityAliasType, BasePK deletedBy) {
        var entityAliasTypeDescriptions = getEntityAliasTypeDescriptionsByEntityAliasTypeForUpdate(entityAliasType);

        entityAliasTypeDescriptions.forEach((entityAliasTypeDescription) ->
                deleteEntityAliasTypeDescription(entityAliasTypeDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Entity Aliases
    // --------------------------------------------------------------------------------

    public EntityAlias createEntityAlias(EntityInstance entityInstance, EntityAliasType entityAliasType, String alias,
            BasePK createdBy) {
        var entityAlias = EntityAliasFactory.getInstance().create(entityInstance, entityAliasType,
                alias, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityInstance, EventTypes.MODIFY, entityAliasType.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return entityAlias;
    }

    public long countEntityAliasesByEntityInstance(EntityInstance entityInstance) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityaliases " +
                "WHERE enial_eni_entityinstanceid = ? AND enial_thrutime = ?",
                entityInstance, Session.MAX_TIME);
    }

    public long countEntityAliasesByEntityAliasType(EntityAliasType entityAliasType) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityaliases " +
                "WHERE enial_eniat_entityaliastypeid = ? AND enial_thrutime = ?",
                entityAliasType, Session.MAX_TIME);
    }

    public long countEntityAliasHistory(EntityInstance entityInstance, EntityAliasType entityAliasType) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entityaliases
                    WHERE enial_eni_entityinstanceid = ? AND enial_eniat_entityaliastypeid = ?
                    """, entityInstance, entityAliasType);
    }

    private static final Map<EntityPermission, String> getEntityAliasHistoryQueries;

    static {
        var queryMap = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entityaliases
                WHERE enial_eni_entityinstanceid = ? AND enial_eniat_entityaliastypeid = ?
                ORDER BY enial_thrutime
                _LIMIT_
                """);
        getEntityAliasHistoryQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<EntityAlias> getEntityAliasHistory(EntityInstance entityInstance, EntityAliasType entityAliasType) {
        return EntityAliasFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityAliasHistoryQueries,
                entityInstance, entityAliasType);
    }
    
    private EntityAlias getEntityAlias(EntityInstance entityInstance, EntityAliasType entityAliasType,
            EntityPermission entityPermission) {
        EntityAlias entityAlias;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliases " +
                        "WHERE enial_eni_entityinstanceid = ? AND enial_eniat_entityaliastypeid = ? AND enial_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliases " +
                        "WHERE enial_eni_entityinstanceid = ? AND enial_eniat_entityaliastypeid = ? AND enial_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAliasFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, entityAliasType.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);

            entityAlias = EntityAliasFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityAlias;
    }

    public EntityAlias getEntityAlias(EntityInstance entityInstance, EntityAliasType entityAliasType) {
        return getEntityAlias(entityInstance, entityAliasType, EntityPermission.READ_ONLY);
    }

    public EntityAlias getEntityAliasForUpdate(EntityInstance entityInstance, EntityAliasType entityAliasType) {
        return getEntityAlias(entityInstance, entityAliasType, EntityPermission.READ_WRITE);
    }

    public EntityAliasValue getEntityAliasValueForUpdate(EntityAlias entityAlias) {
        return entityAlias == null ? null : entityAlias.getEntityAliasValue().clone();
    }

    public EntityAliasValue getEntityAliasValueForUpdate(EntityInstance entityInstance, EntityAliasType entityAliasType) {
        return getEntityAliasValueForUpdate(getEntityAliasForUpdate(entityInstance, entityAliasType));
    }

    private List<EntityAlias> getEntityAliasesByEntityAliasType(EntityAliasType entityAliasType, EntityPermission entityPermission) {
        List<EntityAlias> entityAliases;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliases " +
                        "WHERE enial_eniat_entityaliastypeid = ? AND enial_thrutime = ? " +
                        "ORDER BY enial_alias " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliases " +
                        "WHERE enial_eniat_entityaliastypeid = ? AND enial_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAliasFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityAliasType.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);

            entityAliases = EntityAliasFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityAliases;
    }

    public List<EntityAlias> getEntityAliasesByEntityAliasType(EntityAliasType entityAliasType) {
        return getEntityAliasesByEntityAliasType(entityAliasType, EntityPermission.READ_ONLY);
    }

    public List<EntityAlias> getEntityAliasesByEntityAliasTypeForUpdate(EntityAliasType entityAliasType) {
        return getEntityAliasesByEntityAliasType(entityAliasType, EntityPermission.READ_WRITE);
    }

    private List<EntityAlias> getEntityAliasesByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        List<EntityAlias> entityAliases;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliases " +
                        "WHERE enial_eni_entityinstanceid = ? AND enial_thrutime = ? " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityaliases " +
                        "WHERE enial_eni_entityinstanceid = ? AND enial_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAliasFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);

            entityAliases = EntityAliasFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityAliases;
    }
    public List<EntityAlias> getEntityAliasesByEntityInstance(EntityInstance entityInstance) {
        return getEntityAliasesByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public List<EntityAlias> getEntityAliasesByEntityInstanceForUpdate(EntityInstance entityInstance){
        return getEntityAliasesByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public EntityAliasTransfer getEntityAliasTransfer(UserVisit userVisit, EntityAlias entityAlias) {
        return getCoreTransferCaches(userVisit).getEntityAliasTransferCache().getEntityAliasTransfer(entityAlias);
    }

    public List<EntityAliasTransfer> getEntityAliasTransfers(UserVisit userVisit, Collection<EntityAlias> entityAliases) {
        var entityAliasTransfers = new ArrayList<EntityAliasTransfer>(entityAliases.size());
        var entityAliasTransferCache = getCoreTransferCaches(userVisit).getEntityAliasTransferCache();

        entityAliases.forEach((entityAlias) ->
                entityAliasTransfers.add(entityAliasTransferCache.getEntityAliasTransfer(entityAlias))
        );

        return entityAliasTransfers;
    }

    public void updateEntityAliasFromValue(EntityAliasValue entityAliasValue, BasePK updatedBy) {
        if(entityAliasValue.hasBeenModified()) {
            var entityAlias = EntityAliasFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityAliasValue);
            var entityAliasType = entityAlias.getEntityAliasType();
            var entityInstance = entityAlias.getEntityInstance();

            entityAlias.setThruTime(session.START_TIME_LONG);
            entityAlias.store();

            EntityAliasFactory.getInstance().create(entityInstance, entityAliasType, entityAliasValue.getAlias(), session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            sendEvent(entityInstance, EventTypes.MODIFY, entityAliasType.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteEntityAlias(EntityAlias entityAlias, BasePK deletedBy) {
        var entityAliasType = entityAlias.getEntityAliasType();
        var entityInstance = entityAlias.getEntityInstance();

        entityAlias.setThruTime(session.START_TIME_LONG);

        sendEvent(entityInstance, EventTypes.MODIFY, entityAliasType.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deleteEntityAliases(List<EntityAlias> entityAliases, BasePK deletedBy) {
        entityAliases.forEach((entityAlias) ->
                deleteEntityAlias(entityAlias, deletedBy)
        );
    }

    public void deleteEntityAliasesByEntityAliasType(EntityAliasType entityAliasType, BasePK deletedBy) {
        deleteEntityAliases(getEntityAliasesByEntityAliasTypeForUpdate(entityAliasType), deletedBy);
    }

    public void deleteEntityAliasesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityAliases(getEntityAliasesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }

    public EntityAlias getEntityAliasByEntityAliasTypeAndAlias(EntityAliasType entityAliasType, String alias) {
        EntityAlias entityAlias;

        try {
            var ps = EntityAliasFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityaliases " +
                    "WHERE enial_eniat_entityaliastypeid = ? AND enial_alias = ? AND enial_thrutime = ?");

            ps.setLong(1, entityAliasType.getPrimaryKey().getEntityId());
            ps.setString(2, alias);
            ps.setLong(3, Session.MAX_TIME);

            entityAlias = EntityAliasFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityAlias;
    }

    // --------------------------------------------------------------------------------
    //   Entity Attribute Groups
    // --------------------------------------------------------------------------------
    
    public EntityAttributeGroup createEntityAttributeGroup(String entityAttributeGroupName, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultEntityAttributeGroup = getDefaultEntityAttributeGroup();
        var defaultFound = defaultEntityAttributeGroup != null;
        
        if(defaultFound && isDefault) {
            var defaultEntityAttributeGroupDetailValue = getDefaultEntityAttributeGroupDetailValueForUpdate();
            
            defaultEntityAttributeGroupDetailValue.setIsDefault(Boolean.FALSE);
            updateEntityAttributeGroupFromValue(defaultEntityAttributeGroupDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var entityAttributeGroup = EntityAttributeGroupFactory.getInstance().create();
        var entityAttributeGroupDetail = EntityAttributeGroupDetailFactory.getInstance().create(entityAttributeGroup,
                entityAttributeGroupName, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        // Convert to R/W
        entityAttributeGroup = EntityAttributeGroupFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                entityAttributeGroup.getPrimaryKey());
        entityAttributeGroup.setActiveDetail(entityAttributeGroupDetail);
        entityAttributeGroup.setLastDetail(entityAttributeGroupDetail);
        entityAttributeGroup.store();
        
        sendEvent(entityAttributeGroup.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return entityAttributeGroup;
    }
    
    /** Assume that the entityInstance passed to this function is a ECHO_THREE.EntityAttributeGroup */
    public EntityAttributeGroup getEntityAttributeGroupByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new EntityAttributeGroupPK(entityInstance.getEntityUniqueId());

        return EntityAttributeGroupFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public EntityAttributeGroup getEntityAttributeGroupByEntityInstance(EntityInstance entityInstance) {
        return getEntityAttributeGroupByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public EntityAttributeGroup getEntityAttributeGroupByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getEntityAttributeGroupByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public long countEntityAttributeGroups() {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityattributegroups, entityattributegroupdetails " +
                "WHERE enagp_activedetailid = enagpdt_entityattributegroupdetailid");
    }

    public long countEntityAttributeGroupsByEntityType(EntityType entityType) {
        var count = session.queryForLong("""
                                SELECT COUNT(*)
                                FROM (
                                    SELECT COUNT(*)
                                    FROM entityattributegroups
                                    JOIN entityattributegroupdetails ON enagp_lastdetailid = enagpdt_entityattributegroupdetailid
                                    JOIN entityattributeentityattributegroups ON enagp_entityattributegroupid = enaenagp_enagp_entityattributegroupid AND enaenagp_thrutime = ?
                                    JOIN entityattributes ON enaenagp_ena_entityattributeid = ena_entityattributeid
                                    JOIN entityattributedetails ON ena_lastdetailid = enadt_entityattributedetailid
                                    WHERE enadt_ent_entitytypeid = ?
                                    GROUP BY enagp_entityattributegroupid
                                ) AS entityattributegroups
                                """, Session.MAX_TIME, entityType);

        return count == null ? 0L : count;
    }

    private List<EntityAttributeGroup> getEntityAttributeGroups(EntityPermission entityPermission) {
        String query = null;
        
        if(entityPermission.equals(EntityPermission.READ_ONLY)) {
            query = "SELECT _ALL_ " +
                    "FROM entityattributegroups, entityattributegroupdetails " +
                    "WHERE enagp_activedetailid = enagpdt_entityattributegroupdetailid " +
                    "ORDER BY enagpdt_sortorder, enagpdt_entityattributegroupname " +
                    "_LIMIT_";
        } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
            query = "SELECT _ALL_ " +
                    "FROM entityattributegroups, entityattributegroupdetails " +
                    "WHERE enagp_activedetailid = enagpdt_entityattributegroupdetailid " +
                    "FOR UPDATE";
        }

        var ps = EntityAttributeGroupFactory.getInstance().prepareStatement(query);
        
        return EntityAttributeGroupFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
    }
    
    public List<EntityAttributeGroup> getEntityAttributeGroups() {
        return getEntityAttributeGroups(EntityPermission.READ_ONLY);
    }
    
    public List<EntityAttributeGroup> getEntityAttributeGroupsForUpdate() {
        return getEntityAttributeGroups(EntityPermission.READ_WRITE);
    }
    
    private List<EntityAttributeGroup> getEntityAttributeGroupsByEntityType(EntityType entityType, EntityPermission entityPermission) {
        List<EntityAttributeGroup> entityAttributeGroups;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ "
                        + "FROM entityattributegroups, entityattributegroupdetails, entityattributeentityattributegroups, entityattributes, entityattributedetails "
                        + "WHERE enagp_lastdetailid = enagpdt_entityattributegroupdetailid "
                        + "AND enagp_entityattributegroupid = enaenagp_enagp_entityattributegroupid AND enaenagp_ena_entityattributeid = ena_entityattributeid AND enaenagp_thrutime = ? "
                        + "AND ena_lastdetailid = enadt_entityattributedetailid AND enadt_ent_entitytypeid = ? "
                        + "GROUP BY enagp_entityattributegroupid "
                        + "ORDER BY enagpdt_sortorder, enagpdt_entityattributegroupname " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ "
                        + "FROM entityattributegroups, entityattributegroupdetails, entityattributeentityattributegroups, entityattributes, entityattributedetails "
                        + "WHERE enagp_lastdetailid = enagpdt_entityattributegroupdetailid "
                        + "AND enagp_entityattributegroupid = enaenagp_enagp_entityattributegroupid AND enaenagp_ena_entityattributeid = ena_entityattributeid AND enaenagp_thrutime = ? "
                        + "AND ena_lastdetailid = enadt_entityattributedetailid AND enadt_ent_entitytypeid = ? "
                        + "GROUP BY enagp_entityattributegroupid "
                        + "FOR UPDATE";
            }

            var ps = EntityAttributeGroupFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, Session.MAX_TIME);
            ps.setLong(2, entityType.getPrimaryKey().getEntityId());
            
            entityAttributeGroups = EntityAttributeGroupFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributeGroups;
    }
    
    public List<EntityAttributeGroup> getEntityAttributeGroupsByEntityType(EntityType entityType) {
        return getEntityAttributeGroupsByEntityType(entityType, EntityPermission.READ_ONLY);
    }
    
    public List<EntityAttributeGroup> getEntityAttributeGroupsByEntityTypeForUpdate(EntityType entityType) {
        return getEntityAttributeGroupsByEntityType(entityType, EntityPermission.READ_WRITE);
    }
    
    private EntityAttributeGroup getDefaultEntityAttributeGroup(EntityPermission entityPermission) {
        String query = null;
        
        if(entityPermission.equals(EntityPermission.READ_ONLY)) {
            query = "SELECT _ALL_ " +
                    "FROM entityattributegroups, entityattributegroupdetails " +
                    "WHERE enagp_activedetailid = enagpdt_entityattributegroupdetailid AND enagpdt_isdefault = 1";
        } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
            query = "SELECT _ALL_ " +
                    "FROM entityattributegroups, entityattributegroupdetails " +
                    "WHERE enagp_activedetailid = enagpdt_entityattributegroupdetailid AND enagpdt_isdefault = 1 " +
                    "FOR UPDATE";
        }

        var ps = EntityAttributeGroupFactory.getInstance().prepareStatement(query);
        
        return EntityAttributeGroupFactory.getInstance().getEntityFromQuery(entityPermission, ps);
    }
    
    public EntityAttributeGroup getDefaultEntityAttributeGroup() {
        return getDefaultEntityAttributeGroup(EntityPermission.READ_ONLY);
    }
    
    public EntityAttributeGroup getDefaultEntityAttributeGroupForUpdate() {
        return getDefaultEntityAttributeGroup(EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeGroupDetailValue getDefaultEntityAttributeGroupDetailValueForUpdate() {
        return getDefaultEntityAttributeGroupForUpdate().getLastDetailForUpdate().getEntityAttributeGroupDetailValue().clone();
    }
    
    public EntityAttributeGroup getEntityAttributeGroupByName(String entityAttributeGroupName, EntityPermission entityPermission) {
        EntityAttributeGroup entityAttributeGroup;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributegroups, entityattributegroupdetails " +
                        "WHERE enagp_activedetailid = enagpdt_entityattributegroupdetailid AND enagpdt_entityattributegroupname = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributegroups, entityattributegroupdetails " +
                        "WHERE enagp_activedetailid = enagpdt_entityattributegroupdetailid AND enagpdt_entityattributegroupname = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAttributeGroupFactory.getInstance().prepareStatement(query);
            
            ps.setString(1, entityAttributeGroupName);
            
            entityAttributeGroup = EntityAttributeGroupFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributeGroup;
    }
    
    public EntityAttributeGroup getEntityAttributeGroupByName(String entityAttributeGroupName) {
        return getEntityAttributeGroupByName(entityAttributeGroupName, EntityPermission.READ_ONLY);
    }
    
    public EntityAttributeGroup getEntityAttributeGroupByNameForUpdate(String entityAttributeGroupName) {
        return getEntityAttributeGroupByName(entityAttributeGroupName, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeGroupDetailValue getEntityAttributeGroupDetailValueForUpdate(EntityAttributeGroup entityAttributeGroup) {
        return entityAttributeGroup == null? null: entityAttributeGroup.getLastDetailForUpdate().getEntityAttributeGroupDetailValue().clone();
    }
    
    public EntityAttributeGroupDetailValue getEntityAttributeGroupDetailValueByNameForUpdate(String entityAttributeGroupName) {
        return getEntityAttributeGroupDetailValueForUpdate(getEntityAttributeGroupByNameForUpdate(entityAttributeGroupName));
    }
    
    public EntityAttributeGroupChoicesBean getEntityAttributeGroupChoices(String defaultEntityAttributeGroupChoice, Language language,
            boolean allowNullChoice) {
        var entityAttributeGroups = getEntityAttributeGroups();
        var size = entityAttributeGroups.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;
        
        if(allowNullChoice) {
            labels.add("");
            values.add("");
            
            if(defaultEntityAttributeGroupChoice == null) {
                defaultValue = "";
            }
        }
        
        for(var entityAttributeGroup : entityAttributeGroups) {
            var entityAttributeGroupDetail = entityAttributeGroup.getLastDetail();
            var label = getBestEntityAttributeGroupDescription(entityAttributeGroup, language);
            var value = entityAttributeGroupDetail.getEntityAttributeGroupName();
            
            labels.add(label == null? value: label);
            values.add(value);
            
            var usingDefaultChoice = defaultEntityAttributeGroupChoice != null && defaultEntityAttributeGroupChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && entityAttributeGroupDetail.getIsDefault())) {
                defaultValue = value;
            }
        }
        
        return new EntityAttributeGroupChoicesBean(labels, values, defaultValue);
    }
    
    public EntityAttributeGroupTransfer getEntityAttributeGroupTransfer(UserVisit userVisit, EntityAttributeGroup entityAttributeGroup, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityAttributeGroupTransferCache().getEntityAttributeGroupTransfer(entityAttributeGroup, entityInstance);
    }
    
    public List<EntityAttributeGroupTransfer> getEntityAttributeGroupTransfers(UserVisit userVisit, Collection<EntityAttributeGroup> entityAttributeGroups, EntityInstance entityInstance) {
        List<EntityAttributeGroupTransfer> entityAttributeGroupTransfers = new ArrayList<>(entityAttributeGroups.size());
        var entityAttributeGroupTransferCache = getCoreTransferCaches(userVisit).getEntityAttributeGroupTransferCache();
        
        entityAttributeGroups.forEach((entityAttributeGroup) ->
                entityAttributeGroupTransfers.add(entityAttributeGroupTransferCache.getEntityAttributeGroupTransfer(entityAttributeGroup, entityInstance))
        );
        
        return entityAttributeGroupTransfers;
    }
    
    public List<EntityAttributeGroupTransfer> getEntityAttributeGroupTransfers(UserVisit userVisit, EntityInstance entityInstance) {
        return getEntityAttributeGroupTransfers(userVisit, getEntityAttributeGroups(), entityInstance);
    }
    
    public List<EntityAttributeGroupTransfer> getEntityAttributeGroupTransfersByEntityType(UserVisit userVisit, EntityType entityType, EntityInstance entityInstance) {
        return getEntityAttributeGroupTransfers(userVisit, getEntityAttributeGroupsByEntityType(entityType), entityInstance);
    }
    
    private void updateEntityAttributeGroupFromValue(EntityAttributeGroupDetailValue entityAttributeGroupDetailValue, boolean checkDefault,
            BasePK updatedBy) {
        if(entityAttributeGroupDetailValue.hasBeenModified()) {
            var entityAttributeGroup = EntityAttributeGroupFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityAttributeGroupDetailValue.getEntityAttributeGroupPK());
            var entityAttributeGroupDetail = entityAttributeGroup.getActiveDetailForUpdate();
            
            entityAttributeGroupDetail.setThruTime(session.START_TIME_LONG);
            entityAttributeGroupDetail.store();

            var entityAttributeGroupPK = entityAttributeGroupDetail.getEntityAttributeGroupPK();
            var entityAttributeGroupName = entityAttributeGroupDetailValue.getEntityAttributeGroupName();
            var isDefault = entityAttributeGroupDetailValue.getIsDefault();
            var sortOrder = entityAttributeGroupDetailValue.getSortOrder();
            
            if(checkDefault) {
                var defaultEntityAttributeGroup = getDefaultEntityAttributeGroup();
                var defaultFound = defaultEntityAttributeGroup != null && !defaultEntityAttributeGroup.equals(entityAttributeGroup);
                
                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultEntityAttributeGroupDetailValue = getDefaultEntityAttributeGroupDetailValueForUpdate();
                    
                    defaultEntityAttributeGroupDetailValue.setIsDefault(Boolean.FALSE);
                    updateEntityAttributeGroupFromValue(defaultEntityAttributeGroupDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }
            
            entityAttributeGroupDetail = EntityAttributeGroupDetailFactory.getInstance().create(entityAttributeGroupPK, entityAttributeGroupName,
                    isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            entityAttributeGroup.setActiveDetail(entityAttributeGroupDetail);
            entityAttributeGroup.setLastDetail(entityAttributeGroupDetail);
            
            sendEvent(entityAttributeGroupPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }
    
    public void updateEntityAttributeGroupFromValue(EntityAttributeGroupDetailValue entityAttributeGroupDetailValue, BasePK updatedBy) {
        updateEntityAttributeGroupFromValue(entityAttributeGroupDetailValue, true, updatedBy);
    }

    public EntityAttributeGroup getEntityAttributeGroupByPK(EntityAttributeGroupPK pk) {
        return EntityAttributeGroupFactory.getInstance().getEntityFromPK(EntityPermission.READ_ONLY, pk);
    }

    public void deleteEntityAttributeGroup(EntityAttributeGroup entityAttributeGroup, BasePK deletedBy) {
        deleteEntityAttributeEntityAttributeGroupsByEntityAttributeGroup(entityAttributeGroup, deletedBy);
        deleteEntityAttributeGroupDescriptionsByEntityAttributeGroup(entityAttributeGroup, deletedBy);

        var entityAttributeGroupDetail = entityAttributeGroup.getLastDetailForUpdate();
        entityAttributeGroupDetail.setThruTime(session.START_TIME_LONG);
        entityAttributeGroup.setActiveDetail(null);
        entityAttributeGroup.store();
        
        // Check for default, and pick one if necessary
        var defaultEntityAttributeGroup = getDefaultEntityAttributeGroup();
        if(defaultEntityAttributeGroup == null) {
            var entityAttributeGroups = getEntityAttributeGroupsForUpdate();
            
            if(!entityAttributeGroups.isEmpty()) {
                var iter = entityAttributeGroups.iterator();
                if(iter.hasNext()) {
                    defaultEntityAttributeGroup = iter.next();
                }
                var entityAttributeGroupDetailValue = Objects.requireNonNull(defaultEntityAttributeGroup).getLastDetailForUpdate().getEntityAttributeGroupDetailValue().clone();
                
                entityAttributeGroupDetailValue.setIsDefault(Boolean.TRUE);
                updateEntityAttributeGroupFromValue(entityAttributeGroupDetailValue, false, deletedBy);
            }
        }
        
        sendEvent(entityAttributeGroup.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attribute Group Descriptions
    // --------------------------------------------------------------------------------
    
    public EntityAttributeGroupDescription createEntityAttributeGroupDescription(EntityAttributeGroup entityAttributeGroup, Language language, String description,
            BasePK createdBy) {
        var entityAttributeGroupDescription = EntityAttributeGroupDescriptionFactory.getInstance().create(entityAttributeGroup,
                language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityAttributeGroup.getPrimaryKey(), EventTypes.MODIFY, entityAttributeGroupDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityAttributeGroupDescription;
    }
    
    private EntityAttributeGroupDescription getEntityAttributeGroupDescription(EntityAttributeGroup entityAttributeGroup, Language language, EntityPermission entityPermission) {
        EntityAttributeGroupDescription entityAttributeGroupDescription;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributegroupdescriptions " +
                        "WHERE enagpd_enagp_entityattributegroupid = ? AND enagpd_lang_languageid = ? AND enagpd_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributegroupdescriptions " +
                        "WHERE enagpd_enagp_entityattributegroupid = ? AND enagpd_lang_languageid = ? AND enagpd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAttributeGroupDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttributeGroup.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityAttributeGroupDescription = EntityAttributeGroupDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributeGroupDescription;
    }
    
    public EntityAttributeGroupDescription getEntityAttributeGroupDescription(EntityAttributeGroup entityAttributeGroup, Language language) {
        return getEntityAttributeGroupDescription(entityAttributeGroup, language, EntityPermission.READ_ONLY);
    }
    
    public EntityAttributeGroupDescription getEntityAttributeGroupDescriptionForUpdate(EntityAttributeGroup entityAttributeGroup, Language language) {
        return getEntityAttributeGroupDescription(entityAttributeGroup, language, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeGroupDescriptionValue getEntityAttributeGroupDescriptionValue(EntityAttributeGroupDescription entityAttributeGroupDescription) {
        return entityAttributeGroupDescription == null? null: entityAttributeGroupDescription.getEntityAttributeGroupDescriptionValue().clone();
    }
    
    public EntityAttributeGroupDescriptionValue getEntityAttributeGroupDescriptionValueForUpdate(EntityAttributeGroup entityAttributeGroup, Language language) {
        return getEntityAttributeGroupDescriptionValue(getEntityAttributeGroupDescriptionForUpdate(entityAttributeGroup, language));
    }
    
    private List<EntityAttributeGroupDescription> getEntityAttributeGroupDescriptionsByEntityAttributeGroup(EntityAttributeGroup entityAttributeGroup, EntityPermission entityPermission) {
        List<EntityAttributeGroupDescription> entityAttributeGroupDescriptions;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributegroupdescriptions, languages " +
                        "WHERE enagpd_enagp_entityattributegroupid = ? AND enagpd_thrutime = ? " +
                        "AND enagpd_lang_languageid = lang_languageid " +
                        "ORDER BY lang_sortorder, lang_languageisoname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributegroupdescriptions " +
                        "WHERE enagpd_enagp_entityattributegroupid = ? AND enagpd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAttributeGroupDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttributeGroup.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityAttributeGroupDescriptions = EntityAttributeGroupDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributeGroupDescriptions;
    }
    
    public List<EntityAttributeGroupDescription> getEntityAttributeGroupDescriptionsByEntityAttributeGroup(EntityAttributeGroup entityAttributeGroup) {
        return getEntityAttributeGroupDescriptionsByEntityAttributeGroup(entityAttributeGroup, EntityPermission.READ_ONLY);
    }
    
    public List<EntityAttributeGroupDescription> getEntityAttributeGroupDescriptionsByEntityAttributeGroupForUpdate(EntityAttributeGroup entityAttributeGroup) {
        return getEntityAttributeGroupDescriptionsByEntityAttributeGroup(entityAttributeGroup, EntityPermission.READ_WRITE);
    }
    
    public String getBestEntityAttributeGroupDescription(EntityAttributeGroup entityAttributeGroup, Language language) {
        String description;
        var entityAttributeGroupDescription = getEntityAttributeGroupDescription(entityAttributeGroup, language);
        
        if(entityAttributeGroupDescription == null && !language.getIsDefault()) {
            entityAttributeGroupDescription = getEntityAttributeGroupDescription(entityAttributeGroup, getPartyControl().getDefaultLanguage());
        }
        
        if(entityAttributeGroupDescription == null) {
            description = entityAttributeGroup.getLastDetail().getEntityAttributeGroupName();
        } else {
            description = entityAttributeGroupDescription.getDescription();
        }
        
        return description;
    }
    
    public EntityAttributeGroupDescriptionTransfer getEntityAttributeGroupDescriptionTransfer(UserVisit userVisit, EntityAttributeGroupDescription entityAttributeGroupDescription, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityAttributeGroupDescriptionTransferCache().getEntityAttributeGroupDescriptionTransfer(entityAttributeGroupDescription, entityInstance);
    }
    
    public List<EntityAttributeGroupDescriptionTransfer> getEntityAttributeGroupDescriptionTransfers(UserVisit userVisit, EntityAttributeGroup entityAttributeGroup, EntityInstance entityInstance) {
        var entityAttributeGroupDescriptions = getEntityAttributeGroupDescriptionsByEntityAttributeGroup(entityAttributeGroup);
        List<EntityAttributeGroupDescriptionTransfer> entityAttributeGroupDescriptionTransfers = new ArrayList<>(entityAttributeGroupDescriptions.size());
        var entityAttributeGroupDescriptionTransferCache = getCoreTransferCaches(userVisit).getEntityAttributeGroupDescriptionTransferCache();
        
        entityAttributeGroupDescriptions.forEach((entityAttributeGroupDescription) ->
                entityAttributeGroupDescriptionTransfers.add(entityAttributeGroupDescriptionTransferCache.getEntityAttributeGroupDescriptionTransfer(entityAttributeGroupDescription, entityInstance))
        );
        
        return entityAttributeGroupDescriptionTransfers;
    }
    
    public void updateEntityAttributeGroupDescriptionFromValue(EntityAttributeGroupDescriptionValue entityAttributeGroupDescriptionValue, BasePK updatedBy) {
        if(entityAttributeGroupDescriptionValue.hasBeenModified()) {
            var entityAttributeGroupDescription = EntityAttributeGroupDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityAttributeGroupDescriptionValue.getPrimaryKey());
            
            entityAttributeGroupDescription.setThruTime(session.START_TIME_LONG);
            entityAttributeGroupDescription.store();

            var entityAttributeGroup = entityAttributeGroupDescription.getEntityAttributeGroup();
            var language = entityAttributeGroupDescription.getLanguage();
            var description = entityAttributeGroupDescriptionValue.getDescription();
            
            entityAttributeGroupDescription = EntityAttributeGroupDescriptionFactory.getInstance().create(entityAttributeGroup, language,
                    description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityAttributeGroup.getPrimaryKey(), EventTypes.MODIFY, entityAttributeGroupDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityAttributeGroupDescription(EntityAttributeGroupDescription entityAttributeGroupDescription, BasePK deletedBy) {
        entityAttributeGroupDescription.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityAttributeGroupDescription.getEntityAttributeGroupPK(), EventTypes.MODIFY, entityAttributeGroupDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityAttributeGroupDescriptionsByEntityAttributeGroup(EntityAttributeGroup entityAttributeGroup, BasePK deletedBy) {
        var entityAttributeGroupDescriptions = getEntityAttributeGroupDescriptionsByEntityAttributeGroupForUpdate(entityAttributeGroup);
        
        entityAttributeGroupDescriptions.forEach((entityAttributeGroupDescription) -> 
                deleteEntityAttributeGroupDescription(entityAttributeGroupDescription, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attributes
    // --------------------------------------------------------------------------------
    
    public EntityAttribute createEntityAttribute(EntityType entityType, String entityAttributeName,
            EntityAttributeType entityAttributeType, Boolean trackRevisions, Integer sortOrder, BasePK createdBy) {
        var entityAttribute = EntityAttributeFactory.getInstance().create();
        var entityAttributeDetail = EntityAttributeDetailFactory.getInstance().create(entityAttribute, entityType,
                entityAttributeName, entityAttributeType, trackRevisions, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        // Convert to R/W
        entityAttribute = EntityAttributeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                entityAttribute.getPrimaryKey());
        entityAttribute.setActiveDetail(entityAttributeDetail);
        entityAttribute.setLastDetail(entityAttributeDetail);
        entityAttribute.store();
        
        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return entityAttribute;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.EntityAttribute */
    public EntityAttribute getEntityAttributeByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new EntityAttributePK(entityInstance.getEntityUniqueId());

        return EntityAttributeFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public EntityAttribute getEntityAttributeByEntityInstance(EntityInstance entityInstance) {
        return getEntityAttributeByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public EntityAttribute getEntityAttributeByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getEntityAttributeByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }
    
    public EntityAttribute getEntityAttributeByPK(EntityAttributePK pk) {
        return EntityAttributeFactory.getInstance().getEntityFromPK(EntityPermission.READ_ONLY, pk);
    }

    public long countEntityAttributesByEntityType(EntityType entityType) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityattributes, entityattributedetails " +
                "WHERE ena_activedetailid = enadt_entityattributedetailid AND enadt_ent_entitytypeid = ?",
                entityType);
    }

    public long countEntityAttributesByEntityTypeAndEntityAttributeType(EntityType entityType, EntityAttributeType entityAttributeType) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityattributes, entityattributedetails " +
                "WHERE ena_activedetailid = enadt_entityattributedetailid " +
                "AND enadt_ent_entitytypeid = ? AND enadt_enat_entityattributetypeid = ?",
                entityType, entityAttributeType);
    }

    public long countEntityAttributesByEntityAttributeGroupAndEntityType(EntityAttributeGroup entityAttributeGroup, EntityType entityType) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                        "FROM entityattributeentityattributegroups, entityattributes, entityattributedetails " +
                        "WHERE enaenagp_enagp_entityattributegroupid = ? AND enaenagp_thrutime = ? " +
                        "AND enaenagp_ena_entityattributeid = ena_entityattributeid " +
                        "AND ena_lastdetailid = enadt_entityattributedetailid AND enadt_ent_entitytypeid = ?",
                entityAttributeGroup, Session.MAX_TIME, entityType);
    }

    public long countEntityAttributesByEntityTypeAndWorkflow(final EntityType entityType, final Workflow workflow) {
        return session.queryForLong("""
                        SELECT COUNT(*)
                        FROM entityattributes
                        JOIN entityattributedetails ON ena_activedetailid = enadt_entityattributedetailid
                        JOIN entityattributetypes ON enadt_enat_entityattributetypeid = enat_entityattributetypeid
                        JOIN entityattributeworkflows ON ena_entityattributeid = enawkfl_ena_entityattributeid AND enawkfl_thrutime = ?
                        WHERE enadt_ent_entitytypeid = ? AND enat_entityattributetypename = ? AND enawkfl_wkfl_workflowid = ?
                        """, Session.MAX_TIME, entityType, EntityAttributeTypes.WORKFLOW.name(), workflow);
    }

    public EntityAttribute getEntityAttributeByName(EntityType entityType, String entityAttributeName, EntityPermission entityPermission) {
        EntityAttribute entityAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributes, entityattributedetails " +
                        "WHERE ena_activedetailid = enadt_entityattributedetailid " +
                        "AND enadt_ent_entitytypeid = ? AND enadt_entityattributename = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributes, entityattributedetails " +
                        "WHERE ena_activedetailid = enadt_entityattributedetailid " +
                        "AND enadt_ent_entitytypeid = ? AND enadt_entityattributename = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            ps.setString(2, entityAttributeName);
            
            entityAttribute = EntityAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttribute;
    }
    
    public EntityAttribute getEntityAttributeByName(EntityType entityType, String entityAttributeName) {
        return getEntityAttributeByName(entityType, entityAttributeName, EntityPermission.READ_ONLY);
    }
    
    public EntityAttribute getEntityAttributeByNameForUpdate(EntityType entityType, String entityAttributeName) {
        return getEntityAttributeByName(entityType, entityAttributeName, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeDetailValue getEntityAttributeDetailValueForUpdate(EntityAttribute entityAttribute) {
        return entityAttribute == null? null: entityAttribute.getLastDetailForUpdate().getEntityAttributeDetailValue().clone();
    }
    
    public EntityAttributeDetailValue getEntityAttributeDetailValueByNameForUpdate(EntityType entityType, String entityAttributeName) {
        return getEntityAttributeDetailValueForUpdate(getEntityAttributeByNameForUpdate(entityType, entityAttributeName));
    }
    
    private List<EntityAttribute> getEntityAttributesByEntityType(EntityType entityType, EntityPermission entityPermission) {
        List<EntityAttribute> entityAttributes;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributes, entityattributedetails " +
                        "WHERE ena_activedetailid = enadt_entityattributedetailid " +
                        "AND enadt_ent_entitytypeid = ? " +
                        "ORDER BY enadt_sortorder, enadt_entityattributename " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributes, entityattributedetails " +
                        "WHERE ena_activedetailid = enadt_entityattributedetailid " +
                        "AND enadt_ent_entitytypeid = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            
            entityAttributes = EntityAttributeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributes;
    }
    
    public List<EntityAttribute> getEntityAttributesByEntityType(EntityType entityType) {
        return getEntityAttributesByEntityType(entityType, EntityPermission.READ_ONLY);
    }
    
    public List<EntityAttribute> getEntityAttributesByEntityTypeForUpdate(EntityType entityType) {
        return getEntityAttributesByEntityType(entityType, EntityPermission.READ_WRITE);
    }
    
    private List<EntityAttribute> getEntityAttributesByEntityTypeAndEntityAttributeType(EntityType entityType,
            EntityAttributeType entityAttributeType, EntityPermission entityPermission) {
        List<EntityAttribute> entityAttributes;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributes, entityattributedetails " +
                        "WHERE ena_activedetailid = enadt_entityattributedetailid " +
                        "AND enadt_ent_entitytypeid = ? AND enadt_enat_entityattributetypeid = ? " +
                        "ORDER BY enadt_sortorder, enadt_entityattributename " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributes, entityattributedetails " +
                        "WHERE ena_activedetailid = enadt_entityattributedetailid " +
                        "AND enadt_ent_entitytypeid = ? AND enadt_enat_entityattributetypeid = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            ps.setLong(2, entityAttributeType.getPrimaryKey().getEntityId());
            
            entityAttributes = EntityAttributeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributes;
    }
    
    public List<EntityAttribute> getEntityAttributesByEntityTypeAndEntityAttributeType(EntityType entityType,
            EntityAttributeType entityAttributeType) {
        return getEntityAttributesByEntityTypeAndEntityAttributeType(entityType, entityAttributeType, EntityPermission.READ_ONLY);
    }
    
    public List<EntityAttribute> getEntityAttributesByEntityTypeAndEntityAttributeTypeForUpdate(EntityType entityType,
            EntityAttributeType entityAttributeType) {
        return getEntityAttributesByEntityTypeAndEntityAttributeType(entityType, entityAttributeType, EntityPermission.READ_WRITE);
    }
    
    private List<EntityAttribute> getEntityAttributesByEntityAttributeGroupAndEntityType(EntityAttributeGroup entityAttributeGroup, EntityType entityType,
            EntityPermission entityPermission) {
        List<EntityAttribute> entityAttributes;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ "
                        + "FROM entityattributeentityattributegroups, entityattributes, entityattributedetails "
                        + "WHERE enaenagp_enagp_entityattributegroupid = ? AND enaenagp_thrutime = ? "
                        + "AND enaenagp_ena_entityattributeid = ena_entityattributeid "
                        + "AND ena_lastdetailid = enadt_entityattributedetailid AND enadt_ent_entitytypeid = ? "
                        + "ORDER BY enaenagp_sortorder, enadt_sortorder, enadt_entityattributename " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ "
                        + "FROM entityattributeentityattributegroups, entityattributes, entityattributedetails "
                        + "WHERE enaenagp_enagp_entityattributegroupid = ? AND enaenagp_thrutime = ? "
                        + "AND enaenagp_ena_entityattributeid = ena_entityattributeid "
                        + "AND ena_lastdetailid = enadt_entityattributedetailid AND enadt_ent_entitytypeid = ? "
                        + "FOR UPDATE";
            }

            var ps = EntityAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttributeGroup.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            ps.setLong(3, entityType.getPrimaryKey().getEntityId());
            
            entityAttributes = EntityAttributeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributes;
    }
    
    public List<EntityAttribute> getEntityAttributesByEntityAttributeGroupAndEntityType(EntityAttributeGroup entityAttributeGroup, EntityType entityType) {
        return getEntityAttributesByEntityAttributeGroupAndEntityType(entityAttributeGroup, entityType, EntityPermission.READ_ONLY);
    }
    
    public List<EntityAttribute> getEntityAttributesByEntityAttributeGroupAndEntityTypeForUpdate(EntityAttributeGroup entityAttributeGroup, EntityType entityType) {
        return getEntityAttributesByEntityAttributeGroupAndEntityType(entityAttributeGroup, entityType, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeTransfer getEntityAttributeTransfer(UserVisit userVisit, EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityAttributeTransferCache().getEntityAttributeTransfer(entityAttribute, entityInstance);
    }
    
    public List<EntityAttributeTransfer> getEntityAttributeTransfers(UserVisit userVisit, Collection<EntityAttribute> entityAttributes, EntityInstance entityInstance) {
        List<EntityAttributeTransfer> entityAttributeTransfers = new ArrayList<>(entityAttributes.size());
        var entityAttributeTransferCache = getCoreTransferCaches(userVisit).getEntityAttributeTransferCache();
        
        entityAttributes.forEach((entityAttribute) ->
                entityAttributeTransfers.add(entityAttributeTransferCache.getEntityAttributeTransfer(entityAttribute, entityInstance))
        );
        
        return entityAttributeTransfers;
    }
    
    public List<EntityAttributeTransfer> getEntityAttributeTransfersByEntityType(UserVisit userVisit, EntityType entityType, EntityInstance entityInstance) {
        return getEntityAttributeTransfers(userVisit, getEntityAttributesByEntityType(entityType), entityInstance);
    }
    
    public List<EntityAttributeTransfer> getEntityAttributeTransfersByEntityTypeAndEntityAttributeType(UserVisit userVisit, EntityType entityType,
            EntityAttributeType entityAttributeType, EntityInstance entityInstance) {
        return getEntityAttributeTransfers(userVisit, getEntityAttributesByEntityTypeAndEntityAttributeType(entityType, entityAttributeType), entityInstance);
    }
    
    public List<EntityAttributeTransfer> getEntityAttributeTransfersByEntityAttributeGroupAndEntityType(UserVisit userVisit,
            EntityAttributeGroup entityAttributeGroup, EntityType entityType, EntityInstance entityInstance) {
        return getEntityAttributeTransfers(userVisit, getEntityAttributesByEntityAttributeGroupAndEntityType(entityAttributeGroup, entityType),
                entityInstance);
    }
    
    public void updateEntityAttributeFromValue(final EntityAttributeDetailValue entityAttributeDetailValue, final BasePK updatedBy) {
        if(entityAttributeDetailValue.hasBeenModified()) {
            final var entityAttribute = EntityAttributeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityAttributeDetailValue.getEntityAttributePK());
            var entityAttributeDetail = entityAttribute.getActiveDetailForUpdate();
            
            entityAttributeDetail.setThruTime(session.START_TIME_LONG);
            entityAttributeDetail.store();

            final var entityAttributePK = entityAttributeDetail.getEntityAttributePK(); // Not updated
            final var entityTypePK = entityAttributeDetail.getEntityTypePK(); // Not updated
            final var entityAttributeName = entityAttributeDetailValue.getEntityAttributeName();
            final var entityAttributeTypePK = entityAttributeDetail.getEntityAttributeTypePK(); // Not updated
            final var trackRevisions = entityAttributeDetailValue.getTrackRevisions();
            final var sortOrder = entityAttributeDetailValue.getSortOrder();
            
            entityAttributeDetail = EntityAttributeDetailFactory.getInstance().create(entityAttributePK, entityTypePK,
                    entityAttributeName, entityAttributeTypePK, trackRevisions, sortOrder, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);
            
            entityAttribute.setActiveDetail(entityAttributeDetail);
            entityAttribute.setLastDetail(entityAttributeDetail);
            
            sendEvent(entityAttributePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }
    
    public void deleteEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityAttributeDetail = entityAttribute.getLastDetailForUpdate();
        var entityAttributeTypeName = entityAttributeDetail.getEntityAttributeType().getEntityAttributeTypeName();
        var entityAttributeType = EntityAttributeTypes.valueOf(entityAttributeTypeName);

        switch(entityAttributeType) {
            case BOOLEAN -> {
                deleteEntityBooleanDefaultByEntityAttribute(entityAttribute, deletedBy);
                deleteEntityBooleanAttributesByEntityAttribute(entityAttribute, deletedBy);
            }
            case NAME -> deleteEntityNameAttributesByEntityAttribute(entityAttribute, deletedBy);
            case INTEGER, LONG -> {
                deleteEntityAttributeNumericByEntityAttribute(entityAttribute, deletedBy);

                switch(entityAttributeType) {
                    case INTEGER:
                        deleteEntityAttributeIntegerByEntityAttribute(entityAttribute, deletedBy);
                        deleteEntityIntegerRangesByEntityAttribute(entityAttribute, deletedBy);
                        deleteEntityIntegerDefaultByEntityAttribute(entityAttribute, deletedBy);
                        deleteEntityIntegerAttributesByEntityAttribute(entityAttribute, deletedBy);
                        break;
                    case LONG:
                        deleteEntityAttributeLongByEntityAttribute(entityAttribute, deletedBy);
                        deleteEntityLongRangesByEntityAttribute(entityAttribute, deletedBy);
                        deleteEntityLongDefaultByEntityAttribute(entityAttribute, deletedBy);
                        deleteEntityLongAttributesByEntityAttribute(entityAttribute, deletedBy);
                        break;
                    default:
                        break;
                }
            }
            case STRING -> {
                deleteEntityAttributeStringByEntityAttribute(entityAttribute, deletedBy);
                deleteEntityStringDefaultByEntityAttribute(entityAttribute, deletedBy);
                deleteEntityStringAttributesByEntityAttribute(entityAttribute, deletedBy);
            }
            case GEOPOINT -> deleteEntityGeoPointAttributesByEntityAttribute(entityAttribute, deletedBy);
            case BLOB -> {
                deleteEntityAttributeBlobByEntityAttribute(entityAttribute, deletedBy);
                deleteEntityBlobAttributesByEntityAttribute(entityAttribute, deletedBy);
            }
            case CLOB -> deleteEntityClobAttributesByEntityAttribute(entityAttribute, deletedBy);
            case DATE -> deleteEntityDateAttributesByEntityAttribute(entityAttribute, deletedBy);
            case TIME -> deleteEntityTimeAttributesByEntityAttribute(entityAttribute, deletedBy);
            case LISTITEM, MULTIPLELISTITEM -> {
                deleteEntityAttributeListItemByEntityAttribute(entityAttribute, deletedBy);
                deleteEntityListItemsByEntityAttribute(entityAttribute, deletedBy);
            }
            case ENTITY, COLLECTION -> {
                deleteEntityAttributeEntityTypesByEntityAttribute(entityAttribute, deletedBy);

                switch(entityAttributeType) {
                    case ENTITY:
                        deleteEntityEntityAttributesByEntityAttribute(entityAttribute, deletedBy);
                        break;
                    case COLLECTION:
                        deleteEntityCollectionAttributesByEntityAttribute(entityAttribute, deletedBy);
                        break;
                    default:
                        break;
                }
            }
            case WORKFLOW -> {
                var workflowControl = Session.getModelController(WorkflowControl.class);
                var entityAttributeWorkflow = getEntityAttributeWorkflow(entityAttribute);

                workflowControl.deleteWorkflowEntityStatusesByWorkflowAndEntityType(entityAttributeWorkflow.getWorkflow(),
                        entityAttributeDetail.getEntityType(), deletedBy);
                deleteEntityAttributeWorkflowByEntityAttribute(entityAttribute, deletedBy);
            }
        }
        
        deleteEntityAttributeEntityAttributeGroupsByEntityAttribute(entityAttribute, deletedBy);
        deleteEntityAttributeDescriptionsByEntityAttribute(entityAttribute, deletedBy);
        
        if(entityAttribute.getEntityPermission().equals(EntityPermission.READ_ONLY)) {
            // Convert to R/W
            entityAttribute = EntityAttributeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, entityAttribute.getPrimaryKey());
        }
        
        entityAttributeDetail.setThruTime(session.START_TIME_LONG);
        entityAttribute.setActiveDetail(null);
        entityAttribute.store();
        
        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }
    
    public void deleteEntityAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        var entityAttributes = getEntityAttributesByEntityType(entityInstance.getEntityType());
        
        entityAttributes.stream().map((entityAttribute) -> entityAttribute.getLastDetailForUpdate().getEntityAttributeType().getEntityAttributeTypeName()).forEach((entityAttributeTypeName) -> {
            if(entityAttributeTypeName.equals(EntityAttributeTypes.BOOLEAN.name())) {
                deleteEntityBooleanAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.NAME.name())) {
                deleteEntityNameAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.INTEGER.name())) {
                deleteEntityIntegerAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.LONG.name())) {
                deleteEntityLongAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.STRING.name())) {
                deleteEntityStringAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.GEOPOINT.name())) {
                deleteEntityGeoPointAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.BLOB.name())) {
                deleteEntityBlobAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.CLOB.name())) {
                deleteEntityClobAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.ENTITY.name())) {
                deleteEntityEntityAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.COLLECTION.name())) {
                deleteEntityCollectionAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.DATE.name())) {
                deleteEntityDateAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.TIME.name())) {
                deleteEntityTimeAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.LISTITEM.name())) {
                deleteEntityListItemAttributesByEntityInstance(entityInstance, deletedBy);
            } else if(entityAttributeTypeName.equals(EntityAttributeTypes.MULTIPLELISTITEM.name())) {
                deleteEntityMultipleListItemAttributesByEntityInstance(entityInstance, deletedBy);
            }
        });
    }
    
    public void deleteEntityAttributes(List<EntityAttribute> entityAttributes, BasePK deletedBy) {
        entityAttributes.forEach((entityAttribute) -> 
                deleteEntityAttribute(entityAttribute, deletedBy)
        );
    }
    
    public void deleteEntityAttributesByEntityType(EntityType entityType, BasePK deletedBy) {
        deleteEntityAttributes(getEntityAttributesByEntityTypeForUpdate(entityType), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attribute Descriptions
    // --------------------------------------------------------------------------------
    
    public EntityAttributeDescription createEntityAttributeDescription(EntityAttribute entityAttribute, Language language,
            String description, BasePK createdBy) {
        var entityAttributeDescription = EntityAttributeDescriptionFactory.getInstance().create(session,
                entityAttribute, language, description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityAttributeDescription;
    }
    
    private EntityAttributeDescription getEntityAttributeDescription(EntityAttribute entityAttribute, Language language,
            EntityPermission entityPermission) {
        EntityAttributeDescription entityAttributeDescription;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributedescriptions " +
                        "WHERE enad_ena_entityattributeid = ? AND enad_lang_languageid = ? AND enad_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributedescriptions " +
                        "WHERE enad_ena_entityattributeid = ? AND enad_lang_languageid = ? AND enad_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAttributeDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityAttributeDescription = EntityAttributeDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributeDescription;
    }
    
    public EntityAttributeDescription getEntityAttributeDescription(EntityAttribute entityAttribute, Language language) {
        return getEntityAttributeDescription(entityAttribute, language, EntityPermission.READ_ONLY);
    }
    
    public EntityAttributeDescription getEntityAttributeDescriptionForUpdate(EntityAttribute entityAttribute, Language language) {
        return getEntityAttributeDescription(entityAttribute, language, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeDescriptionValue getEntityAttributeDescriptionValue(EntityAttributeDescription entityAttributeDescription) {
        return entityAttributeDescription == null? null: entityAttributeDescription.getEntityAttributeDescriptionValue().clone();
    }
    
    public EntityAttributeDescriptionValue getEntityAttributeDescriptionValueForUpdate(EntityAttribute entityAttribute, Language language) {
        return getEntityAttributeDescriptionValue(getEntityAttributeDescriptionForUpdate(entityAttribute, language));
    }
    
    private List<EntityAttributeDescription> getEntityAttributeDescriptionsByEntityAttribute(EntityAttribute entityAttribute,
            EntityPermission entityPermission) {
        List<EntityAttributeDescription> entityAttributeDescriptions;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributedescriptions, languages " +
                        "WHERE enad_ena_entityattributeid = ? AND enad_thrutime = ? AND enad_lang_languageid = lang_languageid " +
                        "ORDER BY lang_sortorder, lang_languageisoname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributedescriptions " +
                        "WHERE enad_ena_entityattributeid = ? AND enad_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAttributeDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityAttributeDescriptions = EntityAttributeDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributeDescriptions;
    }
    
    public List<EntityAttributeDescription> getEntityAttributeDescriptionsByEntityAttribute(EntityAttribute entityAttribute) {
        return getEntityAttributeDescriptionsByEntityAttribute(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public List<EntityAttributeDescription> getEntityAttributeDescriptionsByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeDescriptionsByEntityAttribute(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    public String getBestEntityAttributeDescription(EntityAttribute entityAttribute, Language language) {
        String description;
        var entityAttributeDescription = getEntityAttributeDescription(entityAttribute, language);
        
        if(entityAttributeDescription == null && !language.getIsDefault()) {
            entityAttributeDescription = getEntityAttributeDescription(entityAttribute, getPartyControl().getDefaultLanguage());
        }
        
        if(entityAttributeDescription == null) {
            description = entityAttribute.getLastDetail().getEntityAttributeName();
        } else {
            description = entityAttributeDescription.getDescription();
        }
        
        return description;
    }
    
    public EntityAttributeDescriptionTransfer getEntityAttributeDescriptionTransfer(UserVisit userVisit, EntityAttributeDescription entityAttributeDescription, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityAttributeDescriptionTransferCache().getEntityAttributeDescriptionTransfer(entityAttributeDescription, entityInstance);
    }
    
    public List<EntityAttributeDescriptionTransfer> getEntityAttributeDescriptionTransfersByEntityAttribute(UserVisit userVisit,
            EntityAttribute entityAttribute, EntityInstance entityInstance) {
        var entityAttributeDescriptions = getEntityAttributeDescriptionsByEntityAttribute(entityAttribute);
        List<EntityAttributeDescriptionTransfer> entityAttributeDescriptionTransfers = new ArrayList<>(entityAttributeDescriptions.size());
        var entityAttributeDescriptionTransferCache = getCoreTransferCaches(userVisit).getEntityAttributeDescriptionTransferCache();
        
        entityAttributeDescriptions.forEach((entityAttributeDescription) ->
                entityAttributeDescriptionTransfers.add(entityAttributeDescriptionTransferCache.getEntityAttributeDescriptionTransfer(entityAttributeDescription, entityInstance))
        );
        
        return entityAttributeDescriptionTransfers;
    }
    
    public void updateEntityAttributeDescriptionFromValue(EntityAttributeDescriptionValue entityAttributeDescriptionValue, BasePK updatedBy) {
        if(entityAttributeDescriptionValue.hasBeenModified()) {
            var entityAttributeDescription = EntityAttributeDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityAttributeDescriptionValue.getPrimaryKey());
            
            entityAttributeDescription.setThruTime(session.START_TIME_LONG);
            entityAttributeDescription.store();

            var entityAttribute = entityAttributeDescription.getEntityAttribute();
            var language = entityAttributeDescription.getLanguage();
            var description = entityAttributeDescriptionValue.getDescription();
            
            entityAttributeDescription = EntityAttributeDescriptionFactory.getInstance().create(entityAttribute, language,
                    description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityAttributeDescription(EntityAttributeDescription entityAttributeDescription, BasePK deletedBy) {
        entityAttributeDescription.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityAttributeDescription.getEntityAttributePK(), EventTypes.MODIFY, entityAttributeDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityAttributeDescriptionsByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityAttributeDescriptions = getEntityAttributeDescriptionsByEntityAttributeForUpdate(entityAttribute);
        
        entityAttributeDescriptions.forEach((entityAttributeDescription) -> 
                deleteEntityAttributeDescription(entityAttributeDescription, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attribute Blobs
    // --------------------------------------------------------------------------------
    
    public EntityAttributeBlob createEntityAttributeBlob(EntityAttribute entityAttribute, Boolean checkContentWebAddress,
            BasePK createdBy) {
        var entityAttributeBlob = EntityAttributeBlobFactory.getInstance().create(session,
                entityAttribute, checkContentWebAddress, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeBlob.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityAttributeBlob;
    }
    
    private static final Map<EntityPermission, String> getEntityAttributeBlobQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM entityattributeblobs "
                + "WHERE enab_ena_entityattributeid = ? AND enab_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM entityattributeblobs "
                + "WHERE enab_ena_entityattributeid = ? AND enab_thrutime = ? "
                + "FOR UPDATE");
        getEntityAttributeBlobQueries = Collections.unmodifiableMap(queryMap);
    }

    private EntityAttributeBlob getEntityAttributeBlob(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        return EntityAttributeBlobFactory.getInstance().getEntityFromQuery(entityPermission, getEntityAttributeBlobQueries,
                entityAttribute, Session.MAX_TIME_LONG);
    }
    
    public EntityAttributeBlob getEntityAttributeBlob(EntityAttribute entityAttribute) {
        return getEntityAttributeBlob(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public EntityAttributeBlob getEntityAttributeBlobForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeBlob(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeBlobValue getEntityAttributeBlobValue(EntityAttributeBlob entityAttributeBlob) {
        return entityAttributeBlob == null? null: entityAttributeBlob.getEntityAttributeBlobValue().clone();
    }
    
    public EntityAttributeBlobValue getEntityAttributeBlobValueForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeBlobValue(getEntityAttributeBlobForUpdate(entityAttribute));
    }
    
    public void updateEntityAttributeBlobFromValue(EntityAttributeBlobValue entityAttributeBlobValue, BasePK updatedBy) {
        if(entityAttributeBlobValue.hasBeenModified()) {
            var entityAttributeBlob = EntityAttributeBlobFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityAttributeBlobValue.getPrimaryKey());
            
            entityAttributeBlob.setThruTime(session.START_TIME_LONG);
            entityAttributeBlob.store();

            var entityAttribute = entityAttributeBlob.getEntityAttribute();
            var checkContentWebAddress = entityAttributeBlobValue.getCheckContentWebAddress();
            
            entityAttributeBlob = EntityAttributeBlobFactory.getInstance().create(entityAttribute, checkContentWebAddress,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeBlob.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityAttributeBlob(EntityAttributeBlob entityAttributeBlob, BasePK deletedBy) {
        entityAttributeBlob.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityAttributeBlob.getEntityAttributePK(), EventTypes.MODIFY, entityAttributeBlob.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityAttributeBlobByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityAttributeBlob = getEntityAttributeBlobForUpdate(entityAttribute);
        
        if(entityAttributeBlob != null) {
            deleteEntityAttributeBlob(entityAttributeBlob, deletedBy);
        }
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attribute Strings
    // --------------------------------------------------------------------------------
    
    public EntityAttributeString createEntityAttributeString(EntityAttribute entityAttribute, String validationPattern,
            BasePK createdBy) {
        var entityAttributeString = EntityAttributeStringFactory.getInstance().create(session,
                entityAttribute, validationPattern, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeString.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityAttributeString;
    }
    
    private static final Map<EntityPermission, String> getEntityAttributeStringQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM entityattributestrings "
                + "WHERE enas_ena_entityattributeid = ? AND enas_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM entityattributestrings "
                + "WHERE enas_ena_entityattributeid = ? AND enas_thrutime = ? "
                + "FOR UPDATE");
        getEntityAttributeStringQueries = Collections.unmodifiableMap(queryMap);
    }

    private EntityAttributeString getEntityAttributeString(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        return EntityAttributeStringFactory.getInstance().getEntityFromQuery(entityPermission, getEntityAttributeStringQueries,
                entityAttribute, Session.MAX_TIME_LONG);
    }
    
    public EntityAttributeString getEntityAttributeString(EntityAttribute entityAttribute) {
        return getEntityAttributeString(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public EntityAttributeString getEntityAttributeStringForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeString(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeStringValue getEntityAttributeStringValue(EntityAttributeString entityAttributeString) {
        return entityAttributeString == null? null: entityAttributeString.getEntityAttributeStringValue().clone();
    }
    
    public EntityAttributeStringValue getEntityAttributeStringValueForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeStringValue(getEntityAttributeStringForUpdate(entityAttribute));
    }
    
    public void updateEntityAttributeStringFromValue(EntityAttributeStringValue entityAttributeStringValue, BasePK updatedBy) {
        if(entityAttributeStringValue.hasBeenModified()) {
            var entityAttributeString = EntityAttributeStringFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityAttributeStringValue.getPrimaryKey());
            
            entityAttributeString.setThruTime(session.START_TIME_LONG);
            entityAttributeString.store();

            var entityAttribute = entityAttributeString.getEntityAttribute();
            var validationPattern = entityAttributeStringValue.getValidationPattern();
            
            entityAttributeString = EntityAttributeStringFactory.getInstance().create(entityAttribute, validationPattern,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeString.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityAttributeString(EntityAttributeString entityAttributeString, BasePK deletedBy) {
        entityAttributeString.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityAttributeString.getEntityAttributePK(), EventTypes.MODIFY, entityAttributeString.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityAttributeStringByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityAttributeString = getEntityAttributeStringForUpdate(entityAttribute);
        
        if(entityAttributeString != null) {
            deleteEntityAttributeString(entityAttributeString, deletedBy);
        }
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attribute Integers
    // --------------------------------------------------------------------------------
    
    public EntityAttributeInteger createEntityAttributeInteger(EntityAttribute entityAttribute, Integer upperRangeIntegerValue,
            Integer upperLimitIntegerValue, Integer lowerLimitIntegerValue, Integer lowerRangeIntegerValue, BasePK createdBy) {
        var entityAttributeInteger = EntityAttributeIntegerFactory.getInstance().create(session,
                entityAttribute, upperRangeIntegerValue, upperLimitIntegerValue, lowerLimitIntegerValue, lowerRangeIntegerValue,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeInteger.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityAttributeInteger;
    }
    
    private static final Map<EntityPermission, String> getEntityAttributeIntegerQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM entityattributeintegers "
                + "WHERE enai_ena_entityattributeid = ? AND enai_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM entityattributeintegers "
                + "WHERE enai_ena_entityattributeid = ? AND enai_thrutime = ? "
                + "FOR UPDATE");
        getEntityAttributeIntegerQueries = Collections.unmodifiableMap(queryMap);
    }

    private EntityAttributeInteger getEntityAttributeInteger(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        return EntityAttributeIntegerFactory.getInstance().getEntityFromQuery(entityPermission, getEntityAttributeIntegerQueries,
                entityAttribute, Session.MAX_TIME_LONG);
    }
    
    public EntityAttributeInteger getEntityAttributeInteger(EntityAttribute entityAttribute) {
        return getEntityAttributeInteger(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public EntityAttributeInteger getEntityAttributeIntegerForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeInteger(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeIntegerValue getEntityAttributeIntegerValue(EntityAttributeInteger entityAttributeInteger) {
        return entityAttributeInteger == null? null: entityAttributeInteger.getEntityAttributeIntegerValue().clone();
    }
    
    public EntityAttributeIntegerValue getEntityAttributeIntegerValueForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeIntegerValue(getEntityAttributeIntegerForUpdate(entityAttribute));
    }
    
    public void updateEntityAttributeIntegerFromValue(EntityAttributeIntegerValue entityAttributeIntegerValue, BasePK updatedBy) {
        if(entityAttributeIntegerValue.hasBeenModified()) {
            var entityAttributeInteger = EntityAttributeIntegerFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityAttributeIntegerValue.getPrimaryKey());
            
            entityAttributeInteger.setThruTime(session.START_TIME_LONG);
            entityAttributeInteger.store();

            var entityAttribute = entityAttributeInteger.getEntityAttribute();
            var upperRangeIntegerValue = entityAttributeIntegerValue.getUpperRangeIntegerValue();
            var upperLimitIntegerValue = entityAttributeIntegerValue.getUpperLimitIntegerValue();
            var lowerLimitIntegerValue = entityAttributeIntegerValue.getLowerLimitIntegerValue();
            var lowerRangeIntegerValue = entityAttributeIntegerValue.getLowerRangeIntegerValue();
            
            entityAttributeInteger = EntityAttributeIntegerFactory.getInstance().create(entityAttribute, upperRangeIntegerValue,
                    upperLimitIntegerValue, lowerLimitIntegerValue, lowerRangeIntegerValue, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);
            
            sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeInteger.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityAttributeInteger(EntityAttributeInteger entityAttributeInteger, BasePK deletedBy) {
        entityAttributeInteger.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityAttributeInteger.getEntityAttributePK(), EventTypes.MODIFY, entityAttributeInteger.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityAttributeIntegerByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityAttributeInteger = getEntityAttributeIntegerForUpdate(entityAttribute);
        
        if(entityAttributeInteger != null) {
            deleteEntityAttributeInteger(entityAttributeInteger, deletedBy);
        }
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attribute Longs
    // --------------------------------------------------------------------------------
    
    public EntityAttributeLong createEntityAttributeLong(EntityAttribute entityAttribute, Long upperRangeLongValue,
            Long upperLimitLongValue, Long lowerLimitLongValue, Long lowerRangeLongValue, BasePK createdBy) {
        var entityAttributeLong = EntityAttributeLongFactory.getInstance().create(session,
                entityAttribute, upperRangeLongValue, upperLimitLongValue, lowerLimitLongValue, lowerRangeLongValue,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeLong.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityAttributeLong;
    }
    
    private static final Map<EntityPermission, String> getEntityAttributeLongQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM entityattributelongs "
                + "WHERE enal_ena_entityattributeid = ? AND enal_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM entityattributelongs "
                + "WHERE enal_ena_entityattributeid = ? AND enal_thrutime = ? "
                + "FOR UPDATE");
        getEntityAttributeLongQueries = Collections.unmodifiableMap(queryMap);
    }

    private EntityAttributeLong getEntityAttributeLong(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        return EntityAttributeLongFactory.getInstance().getEntityFromQuery(entityPermission, getEntityAttributeLongQueries,
                entityAttribute, Session.MAX_TIME_LONG);
    }
    
    public EntityAttributeLong getEntityAttributeLong(EntityAttribute entityAttribute) {
        return getEntityAttributeLong(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public EntityAttributeLong getEntityAttributeLongForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeLong(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeLongValue getEntityAttributeLongValue(EntityAttributeLong entityAttributeLong) {
        return entityAttributeLong == null? null: entityAttributeLong.getEntityAttributeLongValue().clone();
    }
    
    public EntityAttributeLongValue getEntityAttributeLongValueForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeLongValue(getEntityAttributeLongForUpdate(entityAttribute));
    }
    
    public void updateEntityAttributeLongFromValue(EntityAttributeLongValue entityAttributeLongValue, BasePK updatedBy) {
        if(entityAttributeLongValue.hasBeenModified()) {
            var entityAttributeLong = EntityAttributeLongFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityAttributeLongValue.getPrimaryKey());
            
            entityAttributeLong.setThruTime(session.START_TIME_LONG);
            entityAttributeLong.store();

            var entityAttribute = entityAttributeLong.getEntityAttribute();
            var upperRangeLongValue = entityAttributeLongValue.getUpperRangeLongValue();
            var upperLimitLongValue = entityAttributeLongValue.getUpperLimitLongValue();
            var lowerLimitLongValue = entityAttributeLongValue.getLowerLimitLongValue();
            var lowerRangeLongValue = entityAttributeLongValue.getLowerRangeLongValue();
            
            entityAttributeLong = EntityAttributeLongFactory.getInstance().create(entityAttribute, upperRangeLongValue,
                    upperLimitLongValue, lowerLimitLongValue, lowerRangeLongValue, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeLong.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityAttributeLong(EntityAttributeLong entityAttributeLong, BasePK deletedBy) {
        entityAttributeLong.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityAttributeLong.getEntityAttributePK(), EventTypes.MODIFY, entityAttributeLong.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityAttributeLongByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityAttributeLong = getEntityAttributeLongForUpdate(entityAttribute);
        
        if(entityAttributeLong != null) {
            deleteEntityAttributeLong(entityAttributeLong, deletedBy);
        }
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attribute Numerics
    // --------------------------------------------------------------------------------
    
    public EntityAttributeNumeric createEntityAttributeNumeric(EntityAttribute entityAttribute, UnitOfMeasureType unitOfMeasureType,
            BasePK createdBy) {
        var entityAttributeNumeric = EntityAttributeNumericFactory.getInstance().create(session,
                entityAttribute, unitOfMeasureType, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeNumeric.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityAttributeNumeric;
    }
    
    public long countEntityAttributeNumericsByUnitOfMeasureType(UnitOfMeasureType unitOfMeasureType) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityattributenumerics " +
                "WHERE enan_uomt_unitofmeasuretypeid = ? AND enan_thrutime = ?",
                unitOfMeasureType, Session.MAX_TIME_LONG);
    }

    private static final Map<EntityPermission, String> getEntityAttributeNumericQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM entityattributenumerics "
                + "WHERE enan_ena_entityattributeid = ? AND enan_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM entityattributenumerics "
                + "WHERE enan_ena_entityattributeid = ? AND enan_thrutime = ? "
                + "FOR UPDATE");
        getEntityAttributeNumericQueries = Collections.unmodifiableMap(queryMap);
    }

    private EntityAttributeNumeric getEntityAttributeNumeric(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        return EntityAttributeNumericFactory.getInstance().getEntityFromQuery(entityPermission, getEntityAttributeNumericQueries,
                entityAttribute, Session.MAX_TIME_LONG);
    }
    
    public EntityAttributeNumeric getEntityAttributeNumeric(EntityAttribute entityAttribute) {
        return getEntityAttributeNumeric(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public EntityAttributeNumeric getEntityAttributeNumericForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeNumeric(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeNumericValue getEntityAttributeNumericValue(EntityAttributeNumeric entityAttributeNumeric) {
        return entityAttributeNumeric == null? null: entityAttributeNumeric.getEntityAttributeNumericValue().clone();
    }
    
    public EntityAttributeNumericValue getEntityAttributeNumericValueForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeNumericValue(getEntityAttributeNumericForUpdate(entityAttribute));
    }
    
    public void updateEntityAttributeNumericFromValue(EntityAttributeNumericValue entityAttributeNumericValue, BasePK updatedBy) {
        if(entityAttributeNumericValue.hasBeenModified()) {
            var entityAttributeNumeric = EntityAttributeNumericFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityAttributeNumericValue.getPrimaryKey());
            
            entityAttributeNumeric.setThruTime(session.START_TIME_LONG);
            entityAttributeNumeric.store();

            var entityAttributePK = entityAttributeNumeric.getEntityAttributePK();
            var unitOfMeasureTypePK = entityAttributeNumericValue.getUnitOfMeasureTypePK();
            
            entityAttributeNumeric = EntityAttributeNumericFactory.getInstance().create(entityAttributePK, unitOfMeasureTypePK,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityAttributePK, EventTypes.MODIFY, entityAttributeNumeric.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityAttributeNumeric(EntityAttributeNumeric entityAttributeNumeric, BasePK deletedBy) {
        entityAttributeNumeric.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityAttributeNumeric.getEntityAttributePK(), EventTypes.MODIFY, entityAttributeNumeric.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityAttributeNumericByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityAttributeNumeric = getEntityAttributeNumericForUpdate(entityAttribute);
        
        if(entityAttributeNumeric != null) {
            deleteEntityAttributeNumeric(entityAttributeNumeric, deletedBy);
        }
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attribute List Items
    // --------------------------------------------------------------------------------
    
    public EntityAttributeListItem createEntityAttributeListItem(EntityAttribute entityAttribute, Sequence entityListItemSequence,
            BasePK createdBy) {
        var entityAttributeListItem = EntityAttributeListItemFactory.getInstance().create(session,
                entityAttribute, entityListItemSequence, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeListItem.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityAttributeListItem;
    }
    
    public long countEntityAttributeListItemsByEntityListItemSequence(Sequence entityListItemSequence) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityattributelistitems " +
                "WHERE enali_entitylistitemsequenceid = ? AND enali_thrutime = ?",
                entityListItemSequence, Session.MAX_TIME_LONG);
    }

    private static final Map<EntityPermission, String> getEntityAttributeListItemQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM entityattributelistitems "
                + "WHERE enali_entitylistitemsequenceid = ? AND enali_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM entityattributelistitems "
                + "WHERE enali_entitylistitemsequenceid = ? AND enali_thrutime = ? "
                + "FOR UPDATE");
        getEntityAttributeListItemQueries = Collections.unmodifiableMap(queryMap);
    }

    private EntityAttributeListItem getEntityAttributeListItem(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        return EntityAttributeListItemFactory.getInstance().getEntityFromQuery(entityPermission, getEntityAttributeListItemQueries,
                entityAttribute, Session.MAX_TIME_LONG);
    }
    
    public EntityAttributeListItem getEntityAttributeListItem(EntityAttribute entityAttribute) {
        return getEntityAttributeListItem(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public EntityAttributeListItem getEntityAttributeListItemForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeListItem(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeListItemValue getEntityAttributeListItemValue(EntityAttributeListItem entityAttributeListItem) {
        return entityAttributeListItem == null? null: entityAttributeListItem.getEntityAttributeListItemValue().clone();
    }
    
    public EntityAttributeListItemValue getEntityAttributeListItemValueForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeListItemValue(getEntityAttributeListItemForUpdate(entityAttribute));
    }
    
    public void updateEntityAttributeListItemFromValue(EntityAttributeListItemValue entityAttributeListItemValue, BasePK updatedBy) {
        if(entityAttributeListItemValue.hasBeenModified()) {
            var entityAttributeListItem = EntityAttributeListItemFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityAttributeListItemValue.getPrimaryKey());
            
            entityAttributeListItem.setThruTime(session.START_TIME_LONG);
            entityAttributeListItem.store();

            var entityAttributePK = entityAttributeListItem.getEntityAttributePK();
            var entityListItemSequencePK = entityAttributeListItemValue.getEntityListItemSequencePK();
            
            entityAttributeListItem = EntityAttributeListItemFactory.getInstance().create(entityAttributePK, entityListItemSequencePK,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityAttributePK, EventTypes.MODIFY, entityAttributeListItem.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityAttributeListItem(EntityAttributeListItem entityAttributeListItem, BasePK deletedBy) {
        entityAttributeListItem.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityAttributeListItem.getEntityAttributePK(), EventTypes.MODIFY, entityAttributeListItem.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityAttributeListItemByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityAttributeListItem = getEntityAttributeListItemForUpdate(entityAttribute);
        
        if(entityAttributeListItem != null) {
            deleteEntityAttributeListItem(entityAttributeListItem, deletedBy);
        }
    }

    // --------------------------------------------------------------------------------
    //   Entity Attribute Workflows
    // --------------------------------------------------------------------------------

    public EntityAttributeWorkflow createEntityAttributeWorkflow(EntityAttribute entityAttribute, Workflow workflow,
            BasePK createdBy) {
        var entityAttributeWorkflow = EntityAttributeWorkflowFactory.getInstance().create(session,
                entityAttribute, workflow, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeWorkflow.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return entityAttributeWorkflow;
    }

    public long countEntityAttributeWorkflowsByWorkflow(Workflow workflow) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                        "FROM entityattributeworkflows " +
                        "WHERE enawkfl_wkfl_workflowid = ? AND enawkfl_thrutime = ?",
                workflow, Session.MAX_TIME_LONG);
    }

    private static final Map<EntityPermission, String> getEntityAttributeWorkflowQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(1);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                        + "FROM entityattributeworkflows "
                        + "WHERE enawkfl_ena_entityattributeid = ? AND enawkfl_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                        + "FROM entityattributeworkflows "
                        + "WHERE enawkfl_ena_entityattributeid = ? AND enawkfl_thrutime = ? "
                        + "FOR UPDATE");
        getEntityAttributeWorkflowQueries = Collections.unmodifiableMap(queryMap);
    }

    private EntityAttributeWorkflow getEntityAttributeWorkflow(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        return EntityAttributeWorkflowFactory.getInstance().getEntityFromQuery(entityPermission, getEntityAttributeWorkflowQueries,
                entityAttribute, Session.MAX_TIME_LONG);
    }

    public EntityAttributeWorkflow getEntityAttributeWorkflow(EntityAttribute entityAttribute) {
        return getEntityAttributeWorkflow(entityAttribute, EntityPermission.READ_ONLY);
    }

    public EntityAttributeWorkflow getEntityAttributeWorkflowForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeWorkflow(entityAttribute, EntityPermission.READ_WRITE);
    }

    public EntityAttributeWorkflowValue getEntityAttributeWorkflowValue(EntityAttributeWorkflow entityAttributeWorkflow) {
        return entityAttributeWorkflow == null? null: entityAttributeWorkflow.getEntityAttributeWorkflowValue().clone();
    }

    public EntityAttributeWorkflowValue getEntityAttributeWorkflowValueForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeWorkflowValue(getEntityAttributeWorkflowForUpdate(entityAttribute));
    }

    public void updateEntityAttributeWorkflowFromValue(EntityAttributeWorkflowValue entityAttributeWorkflowValue, BasePK updatedBy) {
        if(entityAttributeWorkflowValue.hasBeenModified()) {
            var entityAttributeWorkflow = EntityAttributeWorkflowFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    entityAttributeWorkflowValue.getPrimaryKey());

            entityAttributeWorkflow.setThruTime(session.START_TIME_LONG);
            entityAttributeWorkflow.store();

            var entityAttributePK = entityAttributeWorkflow.getEntityAttributePK();
            var workflowPK = entityAttributeWorkflowValue.getWorkflowPK();

            entityAttributeWorkflow = EntityAttributeWorkflowFactory.getInstance().create(entityAttributePK, workflowPK,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(entityAttributePK, EventTypes.MODIFY, entityAttributeWorkflow.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteEntityAttributeWorkflow(EntityAttributeWorkflow entityAttributeWorkflow, BasePK deletedBy) {
        entityAttributeWorkflow.setThruTime(session.START_TIME_LONG);

        sendEvent(entityAttributeWorkflow.getEntityAttributePK(), EventTypes.MODIFY, entityAttributeWorkflow.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deleteEntityAttributeWorkflowByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityAttributeWorkflow = getEntityAttributeWorkflowForUpdate(entityAttribute);

        if(entityAttributeWorkflow != null) {
            deleteEntityAttributeWorkflow(entityAttributeWorkflow, deletedBy);
        }
    }

    // --------------------------------------------------------------------------------
    //   Entity Attribute Entity Attribute Groups
    // --------------------------------------------------------------------------------
    
    public EntityAttributeEntityAttributeGroup createEntityAttributeEntityAttributeGroup(EntityAttribute entityAttribute,
            EntityAttributeGroup entityAttributeGroup, Integer sortOrder, BasePK createdBy) {
        var entityAttributeEntityAttributeGroup = EntityAttributeEntityAttributeGroupFactory.getInstance().create(session,
                entityAttribute, entityAttributeGroup, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeEntityAttributeGroup.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityAttributeEntityAttributeGroup;
    }

    public long countEntityAttributeEntityAttributeGroupsByEntityAttribute(EntityAttribute entityAttribute) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityattributeentityattributegroups " +
                "WHERE enaenagp_ena_entityattributeid = ? AND enaenagp_thrutime = ?",
                entityAttribute, Session.MAX_TIME_LONG);
    }

    public long countEntityAttributeEntityAttributeGroupsByEntityAttributeGroup(EntityAttributeGroup entityAttributeGroup) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityattributeentityattributegroups " +
                "WHERE enaenagp_enagp_entityattributegroupid = ? AND enaenagp_thrutime = ?",
                entityAttributeGroup, Session.MAX_TIME_LONG);
    }

    private EntityAttributeEntityAttributeGroup getEntityAttributeEntityAttributeGroup(EntityAttribute entityAttribute,
            EntityAttributeGroup entityAttributeGroup, EntityPermission entityPermission) {
        EntityAttributeEntityAttributeGroup entityAttributeEntityAttributeGroup;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributeentityattributegroups " +
                        "WHERE enaenagp_ena_entityattributeid = ? AND enaenagp_enagp_entityattributegroupid = ? AND enaenagp_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityattributeentityattributegroups " +
                        "WHERE enaenagp_ena_entityattributeid = ? AND enaenagp_enagp_entityattributegroupid = ? AND enaenagp_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityAttributeEntityAttributeGroupFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityAttributeGroup.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityAttributeEntityAttributeGroup = EntityAttributeEntityAttributeGroupFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributeEntityAttributeGroup;
    }
    
    public EntityAttributeEntityAttributeGroup getEntityAttributeEntityAttributeGroup(EntityAttribute entityAttribute, EntityAttributeGroup entityAttributeGroup) {
        return getEntityAttributeEntityAttributeGroup(entityAttribute, entityAttributeGroup, EntityPermission.READ_ONLY);
    }
    
    public EntityAttributeEntityAttributeGroup getEntityAttributeEntityAttributeGroupForUpdate(EntityAttribute entityAttribute, EntityAttributeGroup entityAttributeGroup) {
        return getEntityAttributeEntityAttributeGroup(entityAttribute, entityAttributeGroup, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeEntityAttributeGroupValue getEntityAttributeEntityAttributeGroupValue(EntityAttributeEntityAttributeGroup entityAttributeEntityAttributeGroup) {
        return entityAttributeEntityAttributeGroup == null? null: entityAttributeEntityAttributeGroup.getEntityAttributeEntityAttributeGroupValue().clone();
    }
    
    public EntityAttributeEntityAttributeGroupValue getEntityAttributeEntityAttributeGroupValueForUpdate(EntityAttribute entityAttribute, EntityAttributeGroup entityAttributeGroup) {
        return getEntityAttributeEntityAttributeGroupValue(getEntityAttributeEntityAttributeGroupForUpdate(entityAttribute, entityAttributeGroup));
    }
    
    public List<EntityAttributeEntityAttributeGroup> getEntityAttributeEntityAttributeGroupsByEntityAttribute(EntityAttribute entityAttribute,
            EntityPermission entityPermission) {
        List<EntityAttributeEntityAttributeGroup> entityAttributeEntityAttributeGroups;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ "
                        + "FROM entityattributeentityattributegroups, entityattributegroups, entityattributegroupdetails "
                        + "WHERE enaenagp_ena_entityattributeid = ? AND enaenagp_thrutime = ? "
                        + "AND enaenagp_enagp_entityattributegroupid = enagp_entityattributegroupid AND enagp_lastdetailid = enagpdt_entityattributegroupdetailid "
                        + "ORDER BY enaenagp_sortorder, enagpdt_sortorder, enagpdt_entityattributegroupname " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ "
                        + "FROM entityattributeentityattributegroups "
                        + "WHERE enaenagp_ena_entityattributeid = ? AND enaenagp_thrutime = ? "
                        + "FOR UPDATE";
            }

            var ps = EntityAttributeEntityAttributeGroupFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityAttributeEntityAttributeGroups = EntityAttributeEntityAttributeGroupFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributeEntityAttributeGroups;
    }
    
    public List<EntityAttributeEntityAttributeGroup> getEntityAttributeEntityAttributeGroupsByEntityAttribute(EntityAttribute entityAttribute) {
        return getEntityAttributeEntityAttributeGroupsByEntityAttribute(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public List<EntityAttributeEntityAttributeGroup> getEntityAttributeEntityAttributeGroupsByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeEntityAttributeGroupsByEntityAttribute(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    public List<EntityAttributeEntityAttributeGroup> getEntityAttributeEntityAttributeGroupsByEntityAttributeGroup(EntityAttributeGroup entityAttributeGroup,
            EntityPermission entityPermission) {
        List<EntityAttributeEntityAttributeGroup> entityAttributeEntityAttributeGroups;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ "
                        + "FROM entityattributeentityattributegroups, entityattributegroups, entityattributegroupdetails "
                        + "WHERE enaenagp_enagp_entityattributegroupid = ? AND enaenagp_thrutime = ? "
                        + "AND enaenagp_enagp_entityattributegroupid = enagp_entityattributegroupid AND enagp_lastdetailid = enagpdt_entityattributegroupdetailid "
                        + "ORDER BY enaenagp_sortorder, enagpdt_sortorder, enagpdt_entityattributegroupname " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ "
                        + "FROM entityattributeentityattributegroups "
                        + "WHERE enaenagp_enagp_entityattributegroupid = ? AND enaenagp_thrutime = ? "
                        + "FOR UPDATE";
            }

            var ps = EntityAttributeEntityAttributeGroupFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttributeGroup.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityAttributeEntityAttributeGroups = EntityAttributeEntityAttributeGroupFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityAttributeEntityAttributeGroups;
    }
    
    public List<EntityAttributeEntityAttributeGroup> getEntityAttributeEntityAttributeGroupsByEntityAttributeGroup(EntityAttributeGroup entityAttributeGroup) {
        return getEntityAttributeEntityAttributeGroupsByEntityAttributeGroup(entityAttributeGroup, EntityPermission.READ_ONLY);
    }
    
    public List<EntityAttributeEntityAttributeGroup> getEntityAttributeEntityAttributeGroupsByEntityAttributeGroupForUpdate(EntityAttributeGroup entityAttributeGroup) {
        return getEntityAttributeEntityAttributeGroupsByEntityAttributeGroup(entityAttributeGroup, EntityPermission.READ_WRITE);
    }
    
    public EntityAttributeEntityAttributeGroupTransfer getEntityAttributeEntityAttributeGroupTransfer(UserVisit userVisit, EntityAttributeEntityAttributeGroup entityAttributeEntityAttributeGroup, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityAttributeEntityAttributeGroupTransferCache().getEntityAttributeEntityAttributeGroupTransfer(entityAttributeEntityAttributeGroup, entityInstance);
    }
    
    public List<EntityAttributeEntityAttributeGroupTransfer> getEntityAttributeEntityAttributeGroupTransfers(UserVisit userVisit,
            Collection<EntityAttributeEntityAttributeGroup> entityAttributeEntityAttributeGroups, EntityInstance entityInstance) {
        List<EntityAttributeEntityAttributeGroupTransfer> entityAttributeEntityAttributeGroupTransfers = new ArrayList<>(entityAttributeEntityAttributeGroups.size());
        var entityAttributeEntityAttributeGroupTransferCache = getCoreTransferCaches(userVisit).getEntityAttributeEntityAttributeGroupTransferCache();
        
        entityAttributeEntityAttributeGroups.forEach((entityAttributeEntityAttributeGroup) ->
                entityAttributeEntityAttributeGroupTransfers.add(entityAttributeEntityAttributeGroupTransferCache.getEntityAttributeEntityAttributeGroupTransfer(entityAttributeEntityAttributeGroup, entityInstance))
        );
        
        return entityAttributeEntityAttributeGroupTransfers;
    }
    
    public List<EntityAttributeEntityAttributeGroupTransfer> getEntityAttributeEntityAttributeGroupTransfersByEntityAttribute(UserVisit userVisit,
            EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityAttributeEntityAttributeGroupTransfers(userVisit, getEntityAttributeEntityAttributeGroupsByEntityAttribute(entityAttribute), entityInstance);
    }
    
    public List<EntityAttributeEntityAttributeGroupTransfer> getEntityAttributeEntityAttributeGroupTransfersByEntityAttributeGroup(UserVisit userVisit,
            EntityAttributeGroup entityAttributeGroup, EntityInstance entityInstance) {
        return getEntityAttributeEntityAttributeGroupTransfers(userVisit, getEntityAttributeEntityAttributeGroupsByEntityAttributeGroup(entityAttributeGroup), entityInstance);
    }
    
    public void updateEntityAttributeEntityAttributeGroupFromValue(EntityAttributeEntityAttributeGroupValue entityAttributeEntityAttributeGroupValue, BasePK updatedBy) {
        if(entityAttributeEntityAttributeGroupValue.hasBeenModified()) {
            var entityAttributeEntityAttributeGroup = EntityAttributeEntityAttributeGroupFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityAttributeEntityAttributeGroupValue.getPrimaryKey());
            
            entityAttributeEntityAttributeGroup.setThruTime(session.START_TIME_LONG);
            entityAttributeEntityAttributeGroup.store();

            var entityAttribute = entityAttributeEntityAttributeGroup.getEntityAttribute();
            var entityAttributeGroup = entityAttributeEntityAttributeGroup.getEntityAttributeGroup();
            var sortOrder = entityAttributeEntityAttributeGroupValue.getSortOrder();
            
            entityAttributeEntityAttributeGroup = EntityAttributeEntityAttributeGroupFactory.getInstance().create(entityAttribute, entityAttributeGroup,
                    sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeEntityAttributeGroup.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityAttributeEntityAttributeGroup(EntityAttributeEntityAttributeGroup entityAttributeEntityAttributeGroup, BasePK deletedBy) {
        entityAttributeEntityAttributeGroup.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityAttributeEntityAttributeGroup.getEntityAttributePK(), EventTypes.MODIFY, entityAttributeEntityAttributeGroup.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityAttributeEntityAttributeGroupsByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityAttributeEntityAttributeGroups = getEntityAttributeEntityAttributeGroupsByEntityAttributeForUpdate(entityAttribute);
        
        entityAttributeEntityAttributeGroups.forEach((entityAttributeEntityAttributeGroup) -> 
                deleteEntityAttributeEntityAttributeGroup(entityAttributeEntityAttributeGroup, deletedBy)
        );
    }
    
    public void deleteEntityAttributeEntityAttributeGroupsByEntityAttributeGroup(EntityAttributeGroup entityAttributeGroup, BasePK deletedBy) {
        var entityAttributeEntityAttributeGroups = getEntityAttributeEntityAttributeGroupsByEntityAttributeGroupForUpdate(entityAttributeGroup);
        
        entityAttributeEntityAttributeGroups.forEach((entityAttributeEntityAttributeGroup) -> 
                deleteEntityAttributeEntityAttributeGroup(entityAttributeEntityAttributeGroup, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Entity List Items
    // --------------------------------------------------------------------------------
    
    public EntityListItem createEntityListItem(EntityAttribute entityAttribute, String entityListItemName, Boolean isDefault, Integer sortOrder,
            BasePK createdBy) {
        var defaultEntityListItem = getDefaultEntityListItem(entityAttribute);
        var defaultFound = defaultEntityListItem != null;
        
        if(defaultFound && isDefault) {
            var defaultEntityListItemDetailValue = getDefaultEntityListItemDetailValueForUpdate(entityAttribute);
            
            defaultEntityListItemDetailValue.setIsDefault(Boolean.FALSE);
            updateEntityListItemFromValue(defaultEntityListItemDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var entityListItem = EntityListItemFactory.getInstance().create();
        var entityListItemDetail = EntityListItemDetailFactory.getInstance().create(entityListItem,
                entityAttribute, entityListItemName, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        // Convert to R/W
        entityListItem = EntityListItemFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, entityListItem.getPrimaryKey());
        entityListItem.setActiveDetail(entityListItemDetail);
        entityListItem.setLastDetail(entityListItemDetail);
        entityListItem.store();
        
        sendEvent(entityListItem.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return entityListItem;
    }
    
    /** Assume that the entityInstance passed to this function is a ECHO_THREE.EntityListItem */
    public EntityListItem getEntityListItemByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new EntityListItemPK(entityInstance.getEntityUniqueId());

        return EntityListItemFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public EntityListItem getEntityListItemByEntityInstance(EntityInstance entityInstance) {
        return getEntityListItemByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public EntityListItem getEntityListItemByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getEntityListItemByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }
    
    public EntityListItem getEntityListItemByPK(EntityListItemPK pk) {
        return EntityListItemFactory.getInstance().getEntityFromPK(EntityPermission.READ_ONLY, pk);
    }
    
    public long countEntityListItems() {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entitylistitems, entitylistitemdetails " +
                "WHERE eli_activedetailid = elidt_entitylistitemdetailid");
    }

    private EntityListItem getDefaultEntityListItem(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        EntityListItem entityListItem;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitems, entitylistitemdetails " +
                        "WHERE eli_activedetailid = elidt_entitylistitemdetailid " +
                        "AND elidt_ena_entityattributeid = ? AND elidt_isdefault = 1";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitems, entitylistitemdetails " +
                        "WHERE eli_activedetailid = elidt_entitylistitemdetailid " +
                        "AND elidt_ena_entityattributeid = ? AND elidt_isdefault = 1 " +
                        "FOR UPDATE";
            }

            var ps = EntityListItemFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            
            entityListItem = EntityListItemFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityListItem;
    }
    
    public EntityListItem getDefaultEntityListItem(EntityAttribute entityAttribute) {
        return getDefaultEntityListItem(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public EntityListItem getDefaultEntityListItemForUpdate(EntityAttribute entityAttribute) {
        return getDefaultEntityListItem(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    public EntityListItemDetailValue getDefaultEntityListItemDetailValueForUpdate(EntityAttribute entityAttribute) {
        return getDefaultEntityListItemForUpdate(entityAttribute).getLastDetailForUpdate().getEntityListItemDetailValue().clone();
    }
    
    public EntityListItem getEntityListItemByName(EntityAttribute entityAttribute, String entityListItemName, EntityPermission entityPermission) {
        EntityListItem entityListItem;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitems, entitylistitemdetails " +
                        "WHERE eli_activedetailid = elidt_entitylistitemdetailid " +
                        "AND elidt_ena_entityattributeid = ? AND elidt_entitylistitemname = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitems, entitylistitemdetails " +
                        "WHERE eli_activedetailid = elidt_entitylistitemdetailid " +
                        "AND elidt_ena_entityattributeid = ? AND elidt_entitylistitemname = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityListItemFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setString(2, entityListItemName);
            
            entityListItem = EntityListItemFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityListItem;
    }
    
    public EntityListItem getEntityListItemByName(EntityAttribute entityAttribute, String entityListItemName) {
        return getEntityListItemByName(entityAttribute, entityListItemName, EntityPermission.READ_ONLY);
    }
    
    public EntityListItem getEntityListItemByNameForUpdate(EntityAttribute entityAttribute, String entityListItemName) {
        return getEntityListItemByName(entityAttribute, entityListItemName, EntityPermission.READ_WRITE);
    }
    
    public EntityListItemDetailValue getEntityListItemDetailValueForUpdate(EntityListItem entityListItem) {
        return entityListItem == null? null: entityListItem.getLastDetailForUpdate().getEntityListItemDetailValue().clone();
    }
    
    public EntityListItemDetailValue getEntityListItemDetailValueByNameForUpdate(EntityAttribute entityAttribute, String entityListItemName) {
        return getEntityListItemDetailValueForUpdate(getEntityListItemByNameForUpdate(entityAttribute, entityListItemName));
    }
    
    private List<EntityListItem> getEntityListItems(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        List<EntityListItem> entityListItems;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitems, entitylistitemdetails " +
                        "WHERE eli_activedetailid = elidt_entitylistitemdetailid AND elidt_ena_entityattributeid = ? " +
                        "ORDER BY elidt_sortorder, elidt_entitylistitemname " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitems, entitylistitemdetails " +
                        "WHERE eli_activedetailid = elidt_entitylistitemdetailid AND elidt_ena_entityattributeid = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityListItemFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            
            entityListItems = EntityListItemFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityListItems;
    }
    
    public List<EntityListItem> getEntityListItems(EntityAttribute entityAttribute) {
        return getEntityListItems(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public List<EntityListItem> getEntityListItemsForUpdate(EntityAttribute entityAttribute) {
        return getEntityListItems(entityAttribute, EntityPermission.READ_WRITE);
    }

    public long countEntityListItems(EntityAttribute entityAttribute) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entitylistitems, entitylistitemdetails " +
                "WHERE eli_activedetailid = elidt_entitylistitemdetailid AND elidt_ena_entityattributeid = ?",
                entityAttribute);
    }

    public EntityListItemTransfer getEntityListItemTransfer(UserVisit userVisit, EntityListItem entityListItem, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityListItemTransferCache().getEntityListItemTransfer(entityListItem, entityInstance);
    }
    
    public List<EntityListItemTransfer> getEntityListItemTransfers(UserVisit userVisit, Collection<EntityListItem> entityListItems, EntityInstance entityInstance) {
        List<EntityListItemTransfer> entityListItemTransfers = new ArrayList<>(entityListItems.size());
        var entityListItemTransferCache = getCoreTransferCaches(userVisit).getEntityListItemTransferCache();

        entityListItems.forEach((entityListItem) ->
                entityListItemTransfers.add(entityListItemTransferCache.getEntityListItemTransfer(entityListItem, entityInstance))
        );

        return entityListItemTransfers;
    }

    public List<EntityListItemTransfer> getEntityListItemTransfersByEntityAttribute(UserVisit userVisit, EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityListItemTransfers(userVisit, getEntityListItems(entityAttribute), entityInstance);
    }

    private void updateEntityListItemFromValue(EntityListItemDetailValue entityListItemDetailValue, boolean checkDefault,
            BasePK updatedBy) {
        if(entityListItemDetailValue.hasBeenModified()) {
            var entityListItem = EntityListItemFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityListItemDetailValue.getEntityListItemPK());
            var entityListItemDetail = entityListItem.getActiveDetailForUpdate();
            
            entityListItemDetail.setThruTime(session.START_TIME_LONG);
            entityListItemDetail.store();

            var entityListItemPK = entityListItemDetail.getEntityListItemPK(); // Not updated
            var entityAttribute = entityListItemDetail.getEntityAttribute(); // Not updated
            var entityListItemName = entityListItemDetailValue.getEntityListItemName();
            var isDefault = entityListItemDetailValue.getIsDefault();
            var sortOrder = entityListItemDetailValue.getSortOrder();
            
            if(checkDefault) {
                var defaultEntityListItem = getDefaultEntityListItem(entityAttribute);
                var defaultFound = defaultEntityListItem != null && !defaultEntityListItem.equals(entityListItem);
                
                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultEntityListItemDetailValue = getDefaultEntityListItemDetailValueForUpdate(entityAttribute);
                    
                    defaultEntityListItemDetailValue.setIsDefault(Boolean.FALSE);
                    updateEntityListItemFromValue(defaultEntityListItemDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }
            
            entityListItemDetail = EntityListItemDetailFactory.getInstance().create(entityListItemPK,
                    entityAttribute.getPrimaryKey(), entityListItemName, isDefault, sortOrder, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);
            
            entityListItem.setActiveDetail(entityListItemDetail);
            entityListItem.setLastDetail(entityListItemDetail);
            
            sendEvent(entityListItemPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }
    
    public void updateEntityListItemFromValue(EntityListItemDetailValue entityListItemDetailValue, BasePK updatedBy) {
        updateEntityListItemFromValue(entityListItemDetailValue, true, updatedBy);
    }
    
    public EntityListItemChoicesBean getEntityListItemChoices(String defaultEntityListItemChoice, Language language,
            boolean allowNullChoice, EntityAttribute entityAttribute) {
        var entityListItems = getEntityListItems(entityAttribute);
        var size = entityListItems.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;
        
        if(allowNullChoice) {
            labels.add("");
            values.add("");
            
            if(defaultEntityListItemChoice == null) {
                defaultValue = "";
            }
        }
        
        for(var entityListItem : entityListItems) {
            var entityListItemDetail = entityListItem.getLastDetail();
            var label = getBestEntityListItemDescription(entityListItem, language);
            var value = entityListItemDetail.getEntityListItemName();
            
            labels.add(label == null? value: label);
            values.add(value);
            
            var usingDefaultChoice = defaultEntityListItemChoice != null && defaultEntityListItemChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && entityListItemDetail.getIsDefault())) {
                defaultValue = value;
            }
        }
        
        return new EntityListItemChoicesBean(labels, values, defaultValue);
    }
    
    private void deleteEntityListItem(EntityListItem entityListItem, boolean checkDefault, BasePK deletedBy) {
        var entityListItemDetail = entityListItem.getLastDetailForUpdate();
        var entityAttributeTypeName = entityListItemDetail.getEntityAttribute().getLastDetail().getEntityAttributeType().getEntityAttributeTypeName();
        
        if(entityAttributeTypeName.equals(EntityAttributeTypes.LISTITEM.name())) {
            deleteEntityListItemDefaultByEntityListItem(entityListItem, deletedBy);
            deleteEntityListItemAttributesByEntityListItem(entityListItem, deletedBy);
        } else if(entityAttributeTypeName.equals(EntityAttributeTypes.MULTIPLELISTITEM.name())) {
            deleteEntityMultipleListItemAttributesByEntityListItem(entityListItem, deletedBy);
        }
        
        deleteEntityListItemDescriptionsByEntityListItem(entityListItem, deletedBy);
        
        entityListItemDetail.setThruTime(session.START_TIME_LONG);
        entityListItem.setActiveDetail(null);
        entityListItem.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var entityAttribute = entityListItemDetail.getEntityAttribute();
            var defaultEntityListItem = getDefaultEntityListItem(entityAttribute);
            if(defaultEntityListItem == null) {
                var entityListItems = getEntityListItemsForUpdate(entityAttribute);

                if(!entityListItems.isEmpty()) {
                    var iter = entityListItems.iterator();
                    if(iter.hasNext()) {
                        defaultEntityListItem = iter.next();
                    }
                    var entityListItemDetailValue = Objects.requireNonNull(defaultEntityListItem).getLastDetailForUpdate().getEntityListItemDetailValue().clone();

                    entityListItemDetailValue.setIsDefault(Boolean.TRUE);
                    updateEntityListItemFromValue(entityListItemDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(entityListItem.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }
    
    public void deleteEntityListItem(EntityListItem entityListItem, BasePK deletedBy) {
        deleteEntityListItem(entityListItem, true, deletedBy);
    }

    public void deleteEntityListItemsByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityListItems = getEntityListItemsForUpdate(entityAttribute);
        
        entityListItems.forEach((entityListItem) ->
                deleteEntityListItem(entityListItem, false, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Entity List Item Descriptions
    // --------------------------------------------------------------------------------
    
    public EntityListItemDescription createEntityListItemDescription(EntityListItem entityListItem, Language language, String description, BasePK createdBy) {
        var entityListItemDescription = EntityListItemDescriptionFactory.getInstance().create(entityListItem, language, description, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);
        
        sendEvent(entityListItem.getPrimaryKey(), EventTypes.MODIFY, entityListItemDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityListItemDescription;
    }
    
    private EntityListItemDescription getEntityListItemDescription(EntityListItem entityListItem, Language language, EntityPermission entityPermission) {
        EntityListItemDescription entityListItemDescription;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitemdescriptions " +
                        "WHERE elid_eli_entitylistitemid = ? AND elid_lang_languageid = ? AND elid_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitemdescriptions " +
                        "WHERE elid_eli_entitylistitemid = ? AND elid_lang_languageid = ? AND elid_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityListItemDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityListItem.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityListItemDescription = EntityListItemDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityListItemDescription;
    }
    
    public EntityListItemDescription getEntityListItemDescription(EntityListItem entityListItem, Language language) {
        return getEntityListItemDescription(entityListItem, language, EntityPermission.READ_ONLY);
    }
    
    public EntityListItemDescription getEntityListItemDescriptionForUpdate(EntityListItem entityListItem, Language language) {
        return getEntityListItemDescription(entityListItem, language, EntityPermission.READ_WRITE);
    }
    
    public EntityListItemDescriptionValue getEntityListItemDescriptionValue(EntityListItemDescription entityListItemDescription) {
        return entityListItemDescription == null? null: entityListItemDescription.getEntityListItemDescriptionValue().clone();
    }
    
    public EntityListItemDescriptionValue getEntityListItemDescriptionValueForUpdate(EntityListItem entityListItem, Language language) {
        return getEntityListItemDescriptionValue(getEntityListItemDescriptionForUpdate(entityListItem, language));
    }
    
    private List<EntityListItemDescription> getEntityListItemDescriptionsByEntityListItem(EntityListItem entityListItem, EntityPermission entityPermission) {
        List<EntityListItemDescription> entityListItemDescriptions;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitemdescriptions, languages " +
                        "WHERE elid_eli_entitylistitemid = ? AND elid_thrutime = ? AND elid_lang_languageid = lang_languageid " +
                        "ORDER BY lang_sortorder, lang_languageisoname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitemdescriptions " +
                        "WHERE elid_eli_entitylistitemid = ? AND elid_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityListItemDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityListItem.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityListItemDescriptions = EntityListItemDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityListItemDescriptions;
    }
    
    public List<EntityListItemDescription> getEntityListItemDescriptionsByEntityListItem(EntityListItem entityListItem) {
        return getEntityListItemDescriptionsByEntityListItem(entityListItem, EntityPermission.READ_ONLY);
    }
    
    public List<EntityListItemDescription> getEntityListItemDescriptionsByEntityListItemForUpdate(EntityListItem entityListItem) {
        return getEntityListItemDescriptionsByEntityListItem(entityListItem, EntityPermission.READ_WRITE);
    }
    
    public String getBestEntityListItemDescription(EntityListItem entityListItem, Language language) {
        String description;
        var entityListItemDescription = getEntityListItemDescription(entityListItem, language);
        
        if(entityListItemDescription == null && !language.getIsDefault()) {
            entityListItemDescription = getEntityListItemDescription(entityListItem, getPartyControl().getDefaultLanguage());
        }
        
        if(entityListItemDescription == null) {
            description = entityListItem.getLastDetail().getEntityListItemName();
        } else {
            description = entityListItemDescription.getDescription();
        }
        
        return description;
    }
    
    public EntityListItemDescriptionTransfer getEntityListItemDescriptionTransfer(UserVisit userVisit, EntityListItemDescription entityListItemDescription, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityListItemDescriptionTransferCache().getEntityListItemDescriptionTransfer(entityListItemDescription, entityInstance);
    }
    
    public List<EntityListItemDescriptionTransfer> getEntityListItemDescriptionTransfersByEntityListItem(UserVisit userVisit, EntityListItem entityListItem, EntityInstance entityInstance) {
        var entityListItemDescriptions = getEntityListItemDescriptionsByEntityListItem(entityListItem);
        List<EntityListItemDescriptionTransfer> entityListItemDescriptionTransfers = new ArrayList<>(entityListItemDescriptions.size());
        var entityListItemDescriptionTransferCache = getCoreTransferCaches(userVisit).getEntityListItemDescriptionTransferCache();
        
        entityListItemDescriptions.forEach((entityListItemDescription) ->
                entityListItemDescriptionTransfers.add(entityListItemDescriptionTransferCache.getEntityListItemDescriptionTransfer(entityListItemDescription, entityInstance))
        );
        
        return entityListItemDescriptionTransfers;
    }
    
    public void updateEntityListItemDescriptionFromValue(EntityListItemDescriptionValue entityListItemDescriptionValue, BasePK updatedBy) {
        if(entityListItemDescriptionValue.hasBeenModified()) {
            var entityListItemDescription = EntityListItemDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, entityListItemDescriptionValue.getPrimaryKey());
            
            entityListItemDescription.setThruTime(session.START_TIME_LONG);
            entityListItemDescription.store();

            var entityListItem = entityListItemDescription.getEntityListItem();
            var language = entityListItemDescription.getLanguage();
            var description = entityListItemDescriptionValue.getDescription();
            
            entityListItemDescription = EntityListItemDescriptionFactory.getInstance().create(entityListItem, language,
                    description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityListItem.getPrimaryKey(), EventTypes.MODIFY, entityListItemDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityListItemDescription(EntityListItemDescription entityListItemDescription, BasePK deletedBy) {
        entityListItemDescription.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityListItemDescription.getEntityListItemPK(), EventTypes.MODIFY, entityListItemDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityListItemDescriptionsByEntityListItem(EntityListItem entityListItem, BasePK deletedBy) {
        var entityListItemDescriptions = getEntityListItemDescriptionsByEntityListItemForUpdate(entityListItem);
        
        entityListItemDescriptions.forEach((entityListItemDescription) -> 
                deleteEntityListItemDescription(entityListItemDescription, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Integer Ranges
    // --------------------------------------------------------------------------------
    
    public EntityIntegerRange createEntityIntegerRange(EntityAttribute entityAttribute, String entityIntegerRangeName, Integer minimumIntegerValue,
            Integer maximumIntegerValue, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultEntityIntegerRange = getDefaultEntityIntegerRange(entityAttribute);
        var defaultFound = defaultEntityIntegerRange != null;
        
        if(defaultFound && isDefault) {
            var defaultEntityIntegerRangeDetailValue = getDefaultEntityIntegerRangeDetailValueForUpdate(entityAttribute);
            
            defaultEntityIntegerRangeDetailValue.setIsDefault(Boolean.FALSE);
            updateEntityIntegerRangeFromValue(defaultEntityIntegerRangeDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var entityIntegerRange = EntityIntegerRangeFactory.getInstance().create();
        var entityIntegerRangeDetail = EntityIntegerRangeDetailFactory.getInstance().create(entityIntegerRange, entityAttribute,
                entityIntegerRangeName, minimumIntegerValue, maximumIntegerValue, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        // Convert to R/W
        entityIntegerRange = EntityIntegerRangeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, entityIntegerRange.getPrimaryKey());
        entityIntegerRange.setActiveDetail(entityIntegerRangeDetail);
        entityIntegerRange.setLastDetail(entityIntegerRangeDetail);
        entityIntegerRange.store();
        
        sendEvent(entityIntegerRange.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return entityIntegerRange;
    }
    
    /** Assume that the entityInstance passed to this function is a ECHO_THREE.EntityIntegerRange */
    public EntityIntegerRange getEntityIntegerRangeByEntityInstance(EntityInstance entityInstance) {
        var pk = new EntityIntegerRangePK(entityInstance.getEntityUniqueId());
        var entityIntegerRange = EntityIntegerRangeFactory.getInstance().getEntityFromPK(EntityPermission.READ_ONLY, pk);
        
        return entityIntegerRange;
    }
    
    private EntityIntegerRange getDefaultEntityIntegerRange(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        EntityIntegerRange entityIntegerRange;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerranges, entityintegerrangedetails " +
                        "WHERE enir_activedetailid = enirdt_entityintegerrangedetailid " +
                        "AND enirdt_ena_entityattributeid = ? AND enirdt_isdefault = 1";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerranges, entityintegerrangedetails " +
                        "WHERE enir_activedetailid = enirdt_entityintegerrangedetailid " +
                        "AND enirdt_ena_entityattributeid = ? AND enirdt_isdefault = 1 " +
                        "FOR UPDATE";
            }

            var ps = EntityIntegerRangeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            
            entityIntegerRange = EntityIntegerRangeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityIntegerRange;
    }
    
    public EntityIntegerRange getDefaultEntityIntegerRange(EntityAttribute entityAttribute) {
        return getDefaultEntityIntegerRange(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public EntityIntegerRange getDefaultEntityIntegerRangeForUpdate(EntityAttribute entityAttribute) {
        return getDefaultEntityIntegerRange(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    public EntityIntegerRangeDetailValue getDefaultEntityIntegerRangeDetailValueForUpdate(EntityAttribute entityAttribute) {
        return getDefaultEntityIntegerRangeForUpdate(entityAttribute).getLastDetailForUpdate().getEntityIntegerRangeDetailValue().clone();
    }
    
    private EntityIntegerRange getEntityIntegerRangeByName(EntityAttribute entityAttribute, String entityIntegerRangeName, EntityPermission entityPermission) {
        EntityIntegerRange entityIntegerRange;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerranges, entityintegerrangedetails " +
                        "WHERE enir_activedetailid = enirdt_entityintegerrangedetailid " +
                        "AND enirdt_ena_entityattributeid = ? AND enirdt_entityintegerrangename = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerranges, entityintegerrangedetails " +
                        "WHERE enir_activedetailid = enirdt_entityintegerrangedetailid " +
                        "AND enirdt_ena_entityattributeid = ? AND enirdt_entityintegerrangename = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityIntegerRangeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setString(2, entityIntegerRangeName);
            
            entityIntegerRange = EntityIntegerRangeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityIntegerRange;
    }
    
    public EntityIntegerRange getEntityIntegerRangeByName(EntityAttribute entityAttribute, String entityIntegerRangeName) {
        return getEntityIntegerRangeByName(entityAttribute, entityIntegerRangeName, EntityPermission.READ_ONLY);
    }
    
    public EntityIntegerRange getEntityIntegerRangeByNameForUpdate(EntityAttribute entityAttribute, String entityIntegerRangeName) {
        return getEntityIntegerRangeByName(entityAttribute, entityIntegerRangeName, EntityPermission.READ_WRITE);
    }
    
    public EntityIntegerRangeDetailValue getEntityIntegerRangeDetailValueForUpdate(EntityIntegerRange entityIntegerRange) {
        return entityIntegerRange == null? null: entityIntegerRange.getLastDetailForUpdate().getEntityIntegerRangeDetailValue().clone();
    }
    
    public EntityIntegerRangeDetailValue getEntityIntegerRangeDetailValueByNameForUpdate(EntityAttribute entityAttribute, String entityIntegerRangeName) {
        return getEntityIntegerRangeDetailValueForUpdate(getEntityIntegerRangeByNameForUpdate(entityAttribute, entityIntegerRangeName));
    }
    
    private List<EntityIntegerRange> getEntityIntegerRanges(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        List<EntityIntegerRange> entityIntegerRanges;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerranges, entityintegerrangedetails " +
                        "WHERE enir_activedetailid = enirdt_entityintegerrangedetailid AND enirdt_ena_entityattributeid = ? " +
                        "ORDER BY enirdt_sortorder, enirdt_entityintegerrangename " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerranges, entityintegerrangedetails " +
                        "WHERE enir_activedetailid = enirdt_entityintegerrangedetailid AND enirdt_ena_entityattributeid = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityIntegerRangeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            
            entityIntegerRanges = EntityIntegerRangeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityIntegerRanges;
    }
    
    public List<EntityIntegerRange> getEntityIntegerRanges(EntityAttribute entityAttribute) {
        return getEntityIntegerRanges(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public List<EntityIntegerRange> getEntityIntegerRangesForUpdate(EntityAttribute entityAttribute) {
        return getEntityIntegerRanges(entityAttribute, EntityPermission.READ_WRITE);
    }

    public long countEntityIntegerRanges(EntityAttribute entityAttribute) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityintegerranges, entityintegerrangedetails " +
                "WHERE enir_activedetailid = enirdt_entityintegerrangedetailid AND enirdt_ena_entityattributeid = ?",
                entityAttribute);
    }

    public EntityIntegerRangeTransfer getEntityIntegerRangeTransfer(UserVisit userVisit, EntityIntegerRange entityIntegerRange, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityIntegerRangeTransferCache().getEntityIntegerRangeTransfer(entityIntegerRange, entityInstance);
    }
    
    public List<EntityIntegerRangeTransfer> getEntityIntegerRangeTransfers(UserVisit userVisit, Collection<EntityIntegerRange> entityIntegerRanges, EntityInstance entityInstance) {
        List<EntityIntegerRangeTransfer> entityIntegerRangeTransfers = new ArrayList<>(entityIntegerRanges.size());
        var entityIntegerRangeTransferCache = getCoreTransferCaches(userVisit).getEntityIntegerRangeTransferCache();

        entityIntegerRanges.forEach((entityIntegerRange) ->
                entityIntegerRangeTransfers.add(entityIntegerRangeTransferCache.getEntityIntegerRangeTransfer(entityIntegerRange, entityInstance))
        );

        return entityIntegerRangeTransfers;
    }

    public List<EntityIntegerRangeTransfer> getEntityIntegerRangeTransfersByEntityAttribute(UserVisit userVisit, EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityIntegerRangeTransfers(userVisit, getEntityIntegerRanges(entityAttribute), entityInstance);
    }

    private void updateEntityIntegerRangeFromValue(EntityIntegerRangeDetailValue entityIntegerRangeDetailValue, boolean checkDefault,
            BasePK updatedBy) {
        if(entityIntegerRangeDetailValue.hasBeenModified()) {
            var entityIntegerRange = EntityIntegerRangeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityIntegerRangeDetailValue.getEntityIntegerRangePK());
            var entityIntegerRangeDetail = entityIntegerRange.getActiveDetailForUpdate();
            
            entityIntegerRangeDetail.setThruTime(session.START_TIME_LONG);
            entityIntegerRangeDetail.store();

            var entityIntegerRangePK = entityIntegerRangeDetail.getEntityIntegerRangePK(); // Not updated
            var entityAttribute = entityIntegerRangeDetail.getEntityAttribute(); // Not updated
            var entityIntegerRangeName = entityIntegerRangeDetailValue.getEntityIntegerRangeName();
            var minimumIntegerValue = entityIntegerRangeDetailValue.getMinimumIntegerValue();
            var maximumIntegerValue = entityIntegerRangeDetailValue.getMaximumIntegerValue();
            var isDefault = entityIntegerRangeDetailValue.getIsDefault();
            var sortOrder = entityIntegerRangeDetailValue.getSortOrder();
            
            if(checkDefault) {
                var defaultEntityIntegerRange = getDefaultEntityIntegerRange(entityAttribute);
                var defaultFound = defaultEntityIntegerRange != null && !defaultEntityIntegerRange.equals(entityIntegerRange);
                
                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultEntityIntegerRangeDetailValue = getDefaultEntityIntegerRangeDetailValueForUpdate(entityAttribute);
                    
                    defaultEntityIntegerRangeDetailValue.setIsDefault(Boolean.FALSE);
                    updateEntityIntegerRangeFromValue(defaultEntityIntegerRangeDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }
            
            entityIntegerRangeDetail = EntityIntegerRangeDetailFactory.getInstance().create(entityIntegerRangePK, entityAttribute.getPrimaryKey(), entityIntegerRangeName,
                    minimumIntegerValue, maximumIntegerValue, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            entityIntegerRange.setActiveDetail(entityIntegerRangeDetail);
            entityIntegerRange.setLastDetail(entityIntegerRangeDetail);
            
            sendEvent(entityIntegerRangePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }
    
    public void updateEntityIntegerRangeFromValue(EntityIntegerRangeDetailValue entityIntegerRangeDetailValue, BasePK updatedBy) {
        updateEntityIntegerRangeFromValue(entityIntegerRangeDetailValue, true, updatedBy);
    }
    
    public EntityIntegerRangeChoicesBean getEntityIntegerRangeChoices(String defaultEntityIntegerRangeChoice, Language language,
            boolean allowNullChoice, EntityAttribute entityAttribute) {
        var entityIntegerRanges = getEntityIntegerRanges(entityAttribute);
        var size = entityIntegerRanges.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;
        
        if(allowNullChoice) {
            labels.add("");
            values.add("");
            
            if(defaultEntityIntegerRangeChoice == null) {
                defaultValue = "";
            }
        }
        
        for(var entityIntegerRange : entityIntegerRanges) {
            var entityIntegerRangeDetail = entityIntegerRange.getLastDetail();
            var label = getBestEntityIntegerRangeDescription(entityIntegerRange, language);
            var value = entityIntegerRangeDetail.getEntityIntegerRangeName();
            
            labels.add(label == null? value: label);
            values.add(value);
            
            var usingDefaultChoice = defaultEntityIntegerRangeChoice != null && defaultEntityIntegerRangeChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && entityIntegerRangeDetail.getIsDefault())) {
                defaultValue = value;
            }
        }
        
        return new EntityIntegerRangeChoicesBean(labels, values, defaultValue);
    }
    
    private void deleteEntityIntegerRange(EntityIntegerRange entityIntegerRange, boolean checkDefault, BasePK deletedBy) {
        var entityIntegerRangeDetail = entityIntegerRange.getLastDetailForUpdate();
        
        deleteEntityIntegerRangeDescriptionsByEntityIntegerRange(entityIntegerRange, deletedBy);
        
        entityIntegerRangeDetail.setThruTime(session.START_TIME_LONG);
        entityIntegerRange.setActiveDetail(null);
        entityIntegerRange.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var entityAttribute = entityIntegerRangeDetail.getEntityAttribute();
            var defaultEntityIntegerRange = getDefaultEntityIntegerRange(entityAttribute);
            if(defaultEntityIntegerRange == null) {
                var entityIntegerRanges = getEntityIntegerRangesForUpdate(entityAttribute);

                if(!entityIntegerRanges.isEmpty()) {
                    var iter = entityIntegerRanges.iterator();
                    if(iter.hasNext()) {
                        defaultEntityIntegerRange = iter.next();
                    }
                    var entityIntegerRangeDetailValue = Objects.requireNonNull(defaultEntityIntegerRange).getLastDetailForUpdate().getEntityIntegerRangeDetailValue().clone();

                    entityIntegerRangeDetailValue.setIsDefault(Boolean.TRUE);
                    updateEntityIntegerRangeFromValue(entityIntegerRangeDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(entityIntegerRange.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }
    
    public void deleteEntityIntegerRange(EntityIntegerRange entityIntegerRange, BasePK deletedBy) {
        deleteEntityIntegerRange(entityIntegerRange, true, deletedBy);
    }

    public void deleteEntityIntegerRangesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityIntegerRanges = getEntityIntegerRangesForUpdate(entityAttribute);
        
        entityIntegerRanges.forEach((entityIntegerRange) ->
                deleteEntityIntegerRange(entityIntegerRange, false, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Integer Range Descriptions
    // --------------------------------------------------------------------------------
    
    public EntityIntegerRangeDescription createEntityIntegerRangeDescription(EntityIntegerRange entityIntegerRange, Language language, String description, BasePK createdBy) {
        var entityIntegerRangeDescription = EntityIntegerRangeDescriptionFactory.getInstance().create(entityIntegerRange, language, description, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);
        
        sendEvent(entityIntegerRange.getPrimaryKey(), EventTypes.MODIFY, entityIntegerRangeDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityIntegerRangeDescription;
    }
    
    private EntityIntegerRangeDescription getEntityIntegerRangeDescription(EntityIntegerRange entityIntegerRange, Language language, EntityPermission entityPermission) {
        EntityIntegerRangeDescription entityIntegerRangeDescription;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerrangedescriptions " +
                        "WHERE enird_enir_entityintegerrangeid = ? AND enird_lang_languageid = ? AND enird_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerrangedescriptions " +
                        "WHERE enird_enir_entityintegerrangeid = ? AND enird_lang_languageid = ? AND enird_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityIntegerRangeDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityIntegerRange.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityIntegerRangeDescription = EntityIntegerRangeDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityIntegerRangeDescription;
    }
    
    public EntityIntegerRangeDescription getEntityIntegerRangeDescription(EntityIntegerRange entityIntegerRange, Language language) {
        return getEntityIntegerRangeDescription(entityIntegerRange, language, EntityPermission.READ_ONLY);
    }
    
    public EntityIntegerRangeDescription getEntityIntegerRangeDescriptionForUpdate(EntityIntegerRange entityIntegerRange, Language language) {
        return getEntityIntegerRangeDescription(entityIntegerRange, language, EntityPermission.READ_WRITE);
    }
    
    public EntityIntegerRangeDescriptionValue getEntityIntegerRangeDescriptionValue(EntityIntegerRangeDescription entityIntegerRangeDescription) {
        return entityIntegerRangeDescription == null? null: entityIntegerRangeDescription.getEntityIntegerRangeDescriptionValue().clone();
    }
    
    public EntityIntegerRangeDescriptionValue getEntityIntegerRangeDescriptionValueForUpdate(EntityIntegerRange entityIntegerRange, Language language) {
        return getEntityIntegerRangeDescriptionValue(getEntityIntegerRangeDescriptionForUpdate(entityIntegerRange, language));
    }
    
    private List<EntityIntegerRangeDescription> getEntityIntegerRangeDescriptionsByEntityIntegerRange(EntityIntegerRange entityIntegerRange, EntityPermission entityPermission) {
        List<EntityIntegerRangeDescription> entityIntegerRangeDescriptions;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerrangedescriptions, languages " +
                        "WHERE enird_enir_entityintegerrangeid = ? AND enird_thrutime = ? AND enird_lang_languageid = lang_languageid " +
                        "ORDER BY lang_sortorder, lang_languageisoname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerrangedescriptions " +
                        "WHERE enird_enir_entityintegerrangeid = ? AND enird_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityIntegerRangeDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityIntegerRange.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityIntegerRangeDescriptions = EntityIntegerRangeDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityIntegerRangeDescriptions;
    }
    
    public List<EntityIntegerRangeDescription> getEntityIntegerRangeDescriptionsByEntityIntegerRange(EntityIntegerRange entityIntegerRange) {
        return getEntityIntegerRangeDescriptionsByEntityIntegerRange(entityIntegerRange, EntityPermission.READ_ONLY);
    }
    
    public List<EntityIntegerRangeDescription> getEntityIntegerRangeDescriptionsByEntityIntegerRangeForUpdate(EntityIntegerRange entityIntegerRange) {
        return getEntityIntegerRangeDescriptionsByEntityIntegerRange(entityIntegerRange, EntityPermission.READ_WRITE);
    }
    
    public String getBestEntityIntegerRangeDescription(EntityIntegerRange entityIntegerRange, Language language) {
        String description;
        var entityIntegerRangeDescription = getEntityIntegerRangeDescription(entityIntegerRange, language);
        
        if(entityIntegerRangeDescription == null && !language.getIsDefault()) {
            entityIntegerRangeDescription = getEntityIntegerRangeDescription(entityIntegerRange, getPartyControl().getDefaultLanguage());
        }
        
        if(entityIntegerRangeDescription == null) {
            description = entityIntegerRange.getLastDetail().getEntityIntegerRangeName();
        } else {
            description = entityIntegerRangeDescription.getDescription();
        }
        
        return description;
    }
    
    public EntityIntegerRangeDescriptionTransfer getEntityIntegerRangeDescriptionTransfer(UserVisit userVisit, EntityIntegerRangeDescription entityIntegerRangeDescription, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityIntegerRangeDescriptionTransferCache().getEntityIntegerRangeDescriptionTransfer(entityIntegerRangeDescription, entityInstance);
    }
    
    public List<EntityIntegerRangeDescriptionTransfer> getEntityIntegerRangeDescriptionTransfersByEntityIntegerRange(UserVisit userVisit, EntityIntegerRange entityIntegerRange, EntityInstance entityInstance) {
        var entityIntegerRangeDescriptions = getEntityIntegerRangeDescriptionsByEntityIntegerRange(entityIntegerRange);
        List<EntityIntegerRangeDescriptionTransfer> entityIntegerRangeDescriptionTransfers = new ArrayList<>(entityIntegerRangeDescriptions.size());
        var entityIntegerRangeDescriptionTransferCache = getCoreTransferCaches(userVisit).getEntityIntegerRangeDescriptionTransferCache();
        
        entityIntegerRangeDescriptions.forEach((entityIntegerRangeDescription) ->
                entityIntegerRangeDescriptionTransfers.add(entityIntegerRangeDescriptionTransferCache.getEntityIntegerRangeDescriptionTransfer(entityIntegerRangeDescription, entityInstance))
        );
        
        return entityIntegerRangeDescriptionTransfers;
    }
    
    public void updateEntityIntegerRangeDescriptionFromValue(EntityIntegerRangeDescriptionValue entityIntegerRangeDescriptionValue, BasePK updatedBy) {
        if(entityIntegerRangeDescriptionValue.hasBeenModified()) {
            var entityIntegerRangeDescription = EntityIntegerRangeDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, entityIntegerRangeDescriptionValue.getPrimaryKey());
            
            entityIntegerRangeDescription.setThruTime(session.START_TIME_LONG);
            entityIntegerRangeDescription.store();

            var entityIntegerRange = entityIntegerRangeDescription.getEntityIntegerRange();
            var language = entityIntegerRangeDescription.getLanguage();
            var description = entityIntegerRangeDescriptionValue.getDescription();
            
            entityIntegerRangeDescription = EntityIntegerRangeDescriptionFactory.getInstance().create(entityIntegerRange, language,
                    description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityIntegerRange.getPrimaryKey(), EventTypes.MODIFY, entityIntegerRangeDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityIntegerRangeDescription(EntityIntegerRangeDescription entityIntegerRangeDescription, BasePK deletedBy) {
        entityIntegerRangeDescription.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityIntegerRangeDescription.getEntityIntegerRangePK(), EventTypes.MODIFY, entityIntegerRangeDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityIntegerRangeDescriptionsByEntityIntegerRange(EntityIntegerRange entityIntegerRange, BasePK deletedBy) {
        var entityIntegerRangeDescriptions = getEntityIntegerRangeDescriptionsByEntityIntegerRangeForUpdate(entityIntegerRange);
        
        entityIntegerRangeDescriptions.forEach((entityIntegerRangeDescription) -> 
                deleteEntityIntegerRangeDescription(entityIntegerRangeDescription, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Long Ranges
    // --------------------------------------------------------------------------------
    
    public EntityLongRange createEntityLongRange(EntityAttribute entityAttribute, String entityLongRangeName, Long minimumLongValue, Long maximumLongValue,
            Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultEntityLongRange = getDefaultEntityLongRange(entityAttribute);
        var defaultFound = defaultEntityLongRange != null;
        
        if(defaultFound && isDefault) {
            var defaultEntityLongRangeDetailValue = getDefaultEntityLongRangeDetailValueForUpdate(entityAttribute);
            
            defaultEntityLongRangeDetailValue.setIsDefault(Boolean.FALSE);
            updateEntityLongRangeFromValue(defaultEntityLongRangeDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var entityLongRange = EntityLongRangeFactory.getInstance().create();
        var entityLongRangeDetail = EntityLongRangeDetailFactory.getInstance().create(entityLongRange, entityAttribute, entityLongRangeName,
                minimumLongValue, maximumLongValue, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        // Convert to R/W
        entityLongRange = EntityLongRangeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, entityLongRange.getPrimaryKey());
        entityLongRange.setActiveDetail(entityLongRangeDetail);
        entityLongRange.setLastDetail(entityLongRangeDetail);
        entityLongRange.store();
        
        sendEvent(entityLongRange.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return entityLongRange;
    }
    
    /** Assume that the entityInstance passed to this function is a ECHO_THREE.EntityLongRange */
    public EntityLongRange getEntityLongRangeByEntityInstance(EntityInstance entityInstance) {
        var pk = new EntityLongRangePK(entityInstance.getEntityUniqueId());
        var entityLongRange = EntityLongRangeFactory.getInstance().getEntityFromPK(EntityPermission.READ_ONLY, pk);
        
        return entityLongRange;
    }
    
    private EntityLongRange getDefaultEntityLongRange(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        EntityLongRange entityLongRange;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongranges, entitylongrangedetails " +
                        "WHERE enlr_activedetailid = enlrdt_entitylongrangedetailid " +
                        "AND enlrdt_ena_entityattributeid = ? AND enlrdt_isdefault = 1";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongranges, entitylongrangedetails " +
                        "WHERE enlr_activedetailid = enlrdt_entitylongrangedetailid " +
                        "AND enlrdt_ena_entityattributeid = ? AND enlrdt_isdefault = 1 " +
                        "FOR UPDATE";
            }

            var ps = EntityLongRangeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            
            entityLongRange = EntityLongRangeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityLongRange;
    }
    
    public EntityLongRange getDefaultEntityLongRange(EntityAttribute entityAttribute) {
        return getDefaultEntityLongRange(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public EntityLongRange getDefaultEntityLongRangeForUpdate(EntityAttribute entityAttribute) {
        return getDefaultEntityLongRange(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    public EntityLongRangeDetailValue getDefaultEntityLongRangeDetailValueForUpdate(EntityAttribute entityAttribute) {
        return getDefaultEntityLongRangeForUpdate(entityAttribute).getLastDetailForUpdate().getEntityLongRangeDetailValue().clone();
    }
    
    private EntityLongRange getEntityLongRangeByName(EntityAttribute entityAttribute, String entityLongRangeName, EntityPermission entityPermission) {
        EntityLongRange entityLongRange;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongranges, entitylongrangedetails " +
                        "WHERE enlr_activedetailid = enlrdt_entitylongrangedetailid " +
                        "AND enlrdt_ena_entityattributeid = ? AND enlrdt_entitylongrangename = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongranges, entitylongrangedetails " +
                        "WHERE enlr_activedetailid = enlrdt_entitylongrangedetailid " +
                        "AND enlrdt_ena_entityattributeid = ? AND enlrdt_entitylongrangename = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityLongRangeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setString(2, entityLongRangeName);
            
            entityLongRange = EntityLongRangeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityLongRange;
    }
    
    public EntityLongRange getEntityLongRangeByName(EntityAttribute entityAttribute, String entityLongRangeName) {
        return getEntityLongRangeByName(entityAttribute, entityLongRangeName, EntityPermission.READ_ONLY);
    }
    
    public EntityLongRange getEntityLongRangeByNameForUpdate(EntityAttribute entityAttribute, String entityLongRangeName) {
        return getEntityLongRangeByName(entityAttribute, entityLongRangeName, EntityPermission.READ_WRITE);
    }
    
    public EntityLongRangeDetailValue getEntityLongRangeDetailValueForUpdate(EntityLongRange entityLongRange) {
        return entityLongRange == null? null: entityLongRange.getLastDetailForUpdate().getEntityLongRangeDetailValue().clone();
    }
    
    public EntityLongRangeDetailValue getEntityLongRangeDetailValueByNameForUpdate(EntityAttribute entityAttribute, String entityLongRangeName) {
        return getEntityLongRangeDetailValueForUpdate(getEntityLongRangeByNameForUpdate(entityAttribute, entityLongRangeName));
    }
    
    private List<EntityLongRange> getEntityLongRanges(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        List<EntityLongRange> entityLongRanges;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongranges, entitylongrangedetails " +
                        "WHERE enlr_activedetailid = enlrdt_entitylongrangedetailid AND enlrdt_ena_entityattributeid = ? " +
                        "ORDER BY enlrdt_sortorder, enlrdt_entitylongrangename " +
                        "_LIMIT_";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongranges, entitylongrangedetails " +
                        "WHERE enlr_activedetailid = enlrdt_entitylongrangedetailid AND enlrdt_ena_entityattributeid = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityLongRangeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            
            entityLongRanges = EntityLongRangeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityLongRanges;
    }
    
    public List<EntityLongRange> getEntityLongRanges(EntityAttribute entityAttribute) {
        return getEntityLongRanges(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public List<EntityLongRange> getEntityLongRangesForUpdate(EntityAttribute entityAttribute) {
        return getEntityLongRanges(entityAttribute, EntityPermission.READ_WRITE);
    }

    public long countEntityLongRanges(EntityAttribute entityAttribute) {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entitylongranges, entitylongrangedetails " +
                "WHERE enlr_activedetailid = enlrdt_entitylongrangedetailid AND enlrdt_ena_entityattributeid = ?",
                entityAttribute);
    }

    public EntityLongRangeTransfer getEntityLongRangeTransfer(UserVisit userVisit, EntityLongRange entityLongRange, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityLongRangeTransferCache().getEntityLongRangeTransfer(entityLongRange, entityInstance);
    }

    public List<EntityLongRangeTransfer> getEntityLongRangeTransfers(UserVisit userVisit, Collection<EntityLongRange> entityLongRanges, EntityInstance entityInstance) {
        List<EntityLongRangeTransfer> entityLongRangeTransfers = new ArrayList<>(entityLongRanges.size());
        var entityLongRangeTransferCache = getCoreTransferCaches(userVisit).getEntityLongRangeTransferCache();

        entityLongRanges.forEach((entityLongRange) ->
                entityLongRangeTransfers.add(entityLongRangeTransferCache.getEntityLongRangeTransfer(entityLongRange, entityInstance))
        );

        return entityLongRangeTransfers;
    }

    public List<EntityLongRangeTransfer> getEntityLongRangeTransfersByEntityAttribute(UserVisit userVisit, EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityLongRangeTransfers(userVisit, getEntityLongRanges(entityAttribute), entityInstance);
    }

    private void updateEntityLongRangeFromValue(EntityLongRangeDetailValue entityLongRangeDetailValue, boolean checkDefault,
            BasePK updatedBy) {
        if(entityLongRangeDetailValue.hasBeenModified()) {
            var entityLongRange = EntityLongRangeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     entityLongRangeDetailValue.getEntityLongRangePK());
            var entityLongRangeDetail = entityLongRange.getActiveDetailForUpdate();
            
            entityLongRangeDetail.setThruTime(session.START_TIME_LONG);
            entityLongRangeDetail.store();

            var entityLongRangePK = entityLongRangeDetail.getEntityLongRangePK(); // Not updated
            var entityAttribute = entityLongRangeDetail.getEntityAttribute(); // Not updated
            var entityLongRangeName = entityLongRangeDetailValue.getEntityLongRangeName();
            var minimumLongValue = entityLongRangeDetailValue.getMinimumLongValue();
            var maximumLongValue = entityLongRangeDetailValue.getMaximumLongValue();
            var isDefault = entityLongRangeDetailValue.getIsDefault();
            var sortOrder = entityLongRangeDetailValue.getSortOrder();
            
            if(checkDefault) {
                var defaultEntityLongRange = getDefaultEntityLongRange(entityAttribute);
                var defaultFound = defaultEntityLongRange != null && !defaultEntityLongRange.equals(entityLongRange);
                
                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultEntityLongRangeDetailValue = getDefaultEntityLongRangeDetailValueForUpdate(entityAttribute);
                    
                    defaultEntityLongRangeDetailValue.setIsDefault(Boolean.FALSE);
                    updateEntityLongRangeFromValue(defaultEntityLongRangeDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }
            
            entityLongRangeDetail = EntityLongRangeDetailFactory.getInstance().create(entityLongRangePK, entityAttribute.getPrimaryKey(), entityLongRangeName,
                    minimumLongValue, maximumLongValue, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            entityLongRange.setActiveDetail(entityLongRangeDetail);
            entityLongRange.setLastDetail(entityLongRangeDetail);
            
            sendEvent(entityLongRangePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }
    
    public void updateEntityLongRangeFromValue(EntityLongRangeDetailValue entityLongRangeDetailValue, BasePK updatedBy) {
        updateEntityLongRangeFromValue(entityLongRangeDetailValue, true, updatedBy);
    }
    
    public EntityLongRangeChoicesBean getEntityLongRangeChoices(String defaultEntityLongRangeChoice, Language language,
            boolean allowNullChoice, EntityAttribute entityAttribute) {
        var entityLongRanges = getEntityLongRanges(entityAttribute);
        var size = entityLongRanges.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;
        
        if(allowNullChoice) {
            labels.add("");
            values.add("");
            
            if(defaultEntityLongRangeChoice == null) {
                defaultValue = "";
            }
        }
        
        for(var entityLongRange : entityLongRanges) {
            var entityLongRangeDetail = entityLongRange.getLastDetail();
            var label = getBestEntityLongRangeDescription(entityLongRange, language);
            var value = entityLongRangeDetail.getEntityLongRangeName();
            
            labels.add(label == null? value: label);
            values.add(value);
            
            var usingDefaultChoice = defaultEntityLongRangeChoice != null && defaultEntityLongRangeChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && entityLongRangeDetail.getIsDefault())) {
                defaultValue = value;
            }
        }
        
        return new EntityLongRangeChoicesBean(labels, values, defaultValue);
    }
    
    private void deleteEntityLongRange(EntityLongRange entityLongRange, boolean checkDefault, BasePK deletedBy) {
        var entityLongRangeDetail = entityLongRange.getLastDetailForUpdate();
        
        deleteEntityLongRangeDescriptionsByEntityLongRange(entityLongRange, deletedBy);
        
        entityLongRangeDetail.setThruTime(session.START_TIME_LONG);
        entityLongRange.setActiveDetail(null);
        entityLongRange.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var entityAttribute = entityLongRangeDetail.getEntityAttribute();
            var defaultEntityLongRange = getDefaultEntityLongRange(entityAttribute);
            if(defaultEntityLongRange == null) {
                var entityLongRanges = getEntityLongRangesForUpdate(entityAttribute);

                if(!entityLongRanges.isEmpty()) {
                    var iter = entityLongRanges.iterator();
                    if(iter.hasNext()) {
                        defaultEntityLongRange = iter.next();
                    }
                    var entityLongRangeDetailValue = Objects.requireNonNull(defaultEntityLongRange).getLastDetailForUpdate().getEntityLongRangeDetailValue().clone();

                    entityLongRangeDetailValue.setIsDefault(Boolean.TRUE);
                    updateEntityLongRangeFromValue(entityLongRangeDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(entityLongRange.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }
    
    public void deleteEntityLongRange(EntityLongRange entityLongRange, BasePK deletedBy) {
        deleteEntityLongRange(entityLongRange, true, deletedBy);
    }

    public void deleteEntityLongRangesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityLongRanges = getEntityLongRangesForUpdate(entityAttribute);
        
        entityLongRanges.forEach((entityLongRange) ->
                deleteEntityLongRange(entityLongRange, false, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Long Range Descriptions
    // --------------------------------------------------------------------------------
    
    public EntityLongRangeDescription createEntityLongRangeDescription(EntityLongRange entityLongRange, Language language, String description, BasePK createdBy) {
        var entityLongRangeDescription = EntityLongRangeDescriptionFactory.getInstance().create(entityLongRange, language, description, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);
        
        sendEvent(entityLongRange.getPrimaryKey(), EventTypes.MODIFY, entityLongRangeDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityLongRangeDescription;
    }
    
    private EntityLongRangeDescription getEntityLongRangeDescription(EntityLongRange entityLongRange, Language language, EntityPermission entityPermission) {
        EntityLongRangeDescription entityLongRangeDescription;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongrangedescriptions " +
                        "WHERE enlrd_enlr_entitylongrangeid = ? AND enlrd_lang_languageid = ? AND enlrd_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongrangedescriptions " +
                        "WHERE enlrd_enlr_entitylongrangeid = ? AND enlrd_lang_languageid = ? AND enlrd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityLongRangeDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityLongRange.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityLongRangeDescription = EntityLongRangeDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityLongRangeDescription;
    }
    
    public EntityLongRangeDescription getEntityLongRangeDescription(EntityLongRange entityLongRange, Language language) {
        return getEntityLongRangeDescription(entityLongRange, language, EntityPermission.READ_ONLY);
    }
    
    public EntityLongRangeDescription getEntityLongRangeDescriptionForUpdate(EntityLongRange entityLongRange, Language language) {
        return getEntityLongRangeDescription(entityLongRange, language, EntityPermission.READ_WRITE);
    }
    
    public EntityLongRangeDescriptionValue getEntityLongRangeDescriptionValue(EntityLongRangeDescription entityLongRangeDescription) {
        return entityLongRangeDescription == null? null: entityLongRangeDescription.getEntityLongRangeDescriptionValue().clone();
    }
    
    public EntityLongRangeDescriptionValue getEntityLongRangeDescriptionValueForUpdate(EntityLongRange entityLongRange, Language language) {
        return getEntityLongRangeDescriptionValue(getEntityLongRangeDescriptionForUpdate(entityLongRange, language));
    }
    
    private List<EntityLongRangeDescription> getEntityLongRangeDescriptionsByEntityLongRange(EntityLongRange entityLongRange, EntityPermission entityPermission) {
        List<EntityLongRangeDescription> entityLongRangeDescriptions;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongrangedescriptions, languages " +
                        "WHERE enlrd_enlr_entitylongrangeid = ? AND enlrd_thrutime = ? AND enlrd_lang_languageid = lang_languageid " +
                        "ORDER BY lang_sortorder, lang_languageisoname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongrangedescriptions " +
                        "WHERE enlrd_enlr_entitylongrangeid = ? AND enlrd_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityLongRangeDescriptionFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityLongRange.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityLongRangeDescriptions = EntityLongRangeDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityLongRangeDescriptions;
    }
    
    public List<EntityLongRangeDescription> getEntityLongRangeDescriptionsByEntityLongRange(EntityLongRange entityLongRange) {
        return getEntityLongRangeDescriptionsByEntityLongRange(entityLongRange, EntityPermission.READ_ONLY);
    }
    
    public List<EntityLongRangeDescription> getEntityLongRangeDescriptionsByEntityLongRangeForUpdate(EntityLongRange entityLongRange) {
        return getEntityLongRangeDescriptionsByEntityLongRange(entityLongRange, EntityPermission.READ_WRITE);
    }
    
    public String getBestEntityLongRangeDescription(EntityLongRange entityLongRange, Language language) {
        String description;
        var entityLongRangeDescription = getEntityLongRangeDescription(entityLongRange, language);
        
        if(entityLongRangeDescription == null && !language.getIsDefault()) {
            entityLongRangeDescription = getEntityLongRangeDescription(entityLongRange, getPartyControl().getDefaultLanguage());
        }
        
        if(entityLongRangeDescription == null) {
            description = entityLongRange.getLastDetail().getEntityLongRangeName();
        } else {
            description = entityLongRangeDescription.getDescription();
        }
        
        return description;
    }
    
    public EntityLongRangeDescriptionTransfer getEntityLongRangeDescriptionTransfer(UserVisit userVisit, EntityLongRangeDescription entityLongRangeDescription, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityLongRangeDescriptionTransferCache().getEntityLongRangeDescriptionTransfer(entityLongRangeDescription, entityInstance);
    }
    
    public List<EntityLongRangeDescriptionTransfer> getEntityLongRangeDescriptionTransfersByEntityLongRange(UserVisit userVisit, EntityLongRange entityLongRange, EntityInstance entityInstance) {
        var entityLongRangeDescriptions = getEntityLongRangeDescriptionsByEntityLongRange(entityLongRange);
        List<EntityLongRangeDescriptionTransfer> entityLongRangeDescriptionTransfers = new ArrayList<>(entityLongRangeDescriptions.size());
        var entityLongRangeDescriptionTransferCache = getCoreTransferCaches(userVisit).getEntityLongRangeDescriptionTransferCache();
        
        entityLongRangeDescriptions.forEach((entityLongRangeDescription) ->
                entityLongRangeDescriptionTransfers.add(entityLongRangeDescriptionTransferCache.getEntityLongRangeDescriptionTransfer(entityLongRangeDescription, entityInstance))
        );
        
        return entityLongRangeDescriptionTransfers;
    }
    
    public void updateEntityLongRangeDescriptionFromValue(EntityLongRangeDescriptionValue entityLongRangeDescriptionValue, BasePK updatedBy) {
        if(entityLongRangeDescriptionValue.hasBeenModified()) {
            var entityLongRangeDescription = EntityLongRangeDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, entityLongRangeDescriptionValue.getPrimaryKey());
            
            entityLongRangeDescription.setThruTime(session.START_TIME_LONG);
            entityLongRangeDescription.store();

            var entityLongRange = entityLongRangeDescription.getEntityLongRange();
            var language = entityLongRangeDescription.getLanguage();
            var description = entityLongRangeDescriptionValue.getDescription();
            
            entityLongRangeDescription = EntityLongRangeDescriptionFactory.getInstance().create(entityLongRange, language,
                    description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityLongRange.getPrimaryKey(), EventTypes.MODIFY, entityLongRangeDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityLongRangeDescription(EntityLongRangeDescription entityLongRangeDescription, BasePK deletedBy) {
        entityLongRangeDescription.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityLongRangeDescription.getEntityLongRangePK(), EventTypes.MODIFY, entityLongRangeDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityLongRangeDescriptionsByEntityLongRange(EntityLongRange entityLongRange, BasePK deletedBy) {
        var entityLongRangeDescriptions = getEntityLongRangeDescriptionsByEntityLongRangeForUpdate(entityLongRange);
        
        entityLongRangeDescriptions.forEach((entityLongRangeDescription) -> 
                deleteEntityLongRangeDescription(entityLongRangeDescription, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Components
    // --------------------------------------------------------------------------------
    
    public Component createComponent(ComponentVendor componentVendor, String componentName, String description, BasePK createdBy) {
        var component = ComponentFactory.getInstance().create();
        var componentDetail = ComponentDetailFactory.getInstance().create(componentVendor, component,
                componentName, description, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        // Convert to R/W
        component = ComponentFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, component.getPrimaryKey());
        component.setActiveDetail(componentDetail);
        component.setLastDetail(componentDetail);
        component.store();
        
        return component;
    }
    
    public Component getComponentByName(ComponentVendor componentVendor, String componentName) {
        Component component;
        
        try {
            var ps = ComponentFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM components, componentdetails " +
                    "WHERE cpnt_componentid = cpntd_cpnt_componentid AND cpntd_cvnd_componentvendorid = ? " +
                    "AND cpntd_componentname = ? AND cpntd_thrutime = ?");
            
            ps.setLong(1, componentVendor.getPrimaryKey().getEntityId());
            ps.setString(2, componentName);
            ps.setLong(3, Session.MAX_TIME);
            
            component = ComponentFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return component;
    }
    
    // --------------------------------------------------------------------------------
    //   Component Versions
    // --------------------------------------------------------------------------------
    
    public ComponentVersion createComponentVersion(Component component, Integer majorRevision, Integer minorRevision,
            ComponentStage componentStage, Integer buildNumber,
            BasePK createdBy) {
        
        return ComponentVersionFactory.getInstance().create(component, majorRevision, minorRevision, componentStage,
                buildNumber, session.START_TIME_LONG, Session.MAX_TIME_LONG);
    }
    
    public ComponentVersion getComponentVersion(Component component) {
        ComponentVersion componentVersion;
        
        try {
            var ps = ComponentVersionFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM componentversions " +
                    "WHERE cvrs_cpnt_componentid = ? AND cvrs_thrutime = ?");
            
            ps.setLong(1, component.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            componentVersion = ComponentVersionFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return componentVersion;
    }
    
    // --------------------------------------------------------------------------------
    //   Mime Type Usage Types
    // --------------------------------------------------------------------------------
    
    public MimeTypeUsageType createMimeTypeUsageType(String mimeTypeUsageTypeName, Boolean isDefault, Integer sortOrder) {
        return MimeTypeUsageTypeFactory.getInstance().create(mimeTypeUsageTypeName, isDefault, sortOrder);
    }
    
    public List<MimeTypeUsageType> getMimeTypeUsageTypes() {
        var ps = MimeTypeUsageTypeFactory.getInstance().prepareStatement(
                "SELECT _ALL_ " +
                "FROM mimetypeusagetypes " +
                "ORDER BY mtyput_sortorder, mtyput_mimetypeusagetypename");
        
        return MimeTypeUsageTypeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
    }
    
    public MimeTypeUsageType getMimeTypeUsageTypeByName(String mimeTypeUsageTypeName) {
        MimeTypeUsageType mimeTypeUsageType;
        
        try {
            var ps = MimeTypeUsageTypeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM mimetypeusagetypes " +
                    "WHERE mtyput_mimetypeusagetypename = ?");
            
            ps.setString(1, mimeTypeUsageTypeName);
            
            mimeTypeUsageType = MimeTypeUsageTypeFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return mimeTypeUsageType;
    }
    
    public MimeTypeUsageTypeChoicesBean getMimeTypeUsageTypeChoices(String defaultMimeTypeUsageTypeChoice, Language language,
            boolean allowNullChoice) {
        var mimeTypeUsageTypes = getMimeTypeUsageTypes();
        var size = mimeTypeUsageTypes.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;
        
        if(allowNullChoice) {
            labels.add("");
            values.add("");
            
            if(defaultMimeTypeUsageTypeChoice == null) {
                defaultValue = "";
            }
        }
        
        for(var mimeTypeUsageType : mimeTypeUsageTypes) {
            var label = getBestMimeTypeUsageTypeDescription(mimeTypeUsageType, language);
            var value = mimeTypeUsageType.getMimeTypeUsageTypeName();
            
            labels.add(label == null? value: label);
            values.add(value);
            
            var usingDefaultChoice = defaultMimeTypeUsageTypeChoice != null && defaultMimeTypeUsageTypeChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && mimeTypeUsageType.getIsDefault())) {
                defaultValue = value;
            }
        }
        
        return new MimeTypeUsageTypeChoicesBean(labels, values, defaultValue);
    }
    
    public MimeTypeUsageTypeTransfer getMimeTypeUsageTypeTransfer(UserVisit userVisit, MimeTypeUsageType mimeTypeUsageType) {
        return getCoreTransferCaches(userVisit).getMimeTypeUsageTypeTransferCache().getMimeTypeUsageTypeTransfer(mimeTypeUsageType);
    }

    public List<MimeTypeUsageTypeTransfer> getMimeTypeUsageTypeTransfers(UserVisit userVisit, Collection<MimeTypeUsageType> mimeTypeUsageTypes) {
        List<MimeTypeUsageTypeTransfer> mimeTypeUsageTypeTransfers = new ArrayList<>(mimeTypeUsageTypes.size());
        var mimeTypeUsageTypeTransferCache = getCoreTransferCaches(userVisit).getMimeTypeUsageTypeTransferCache();

        mimeTypeUsageTypes.forEach((mimeTypeUsageType) ->
                mimeTypeUsageTypeTransfers.add(mimeTypeUsageTypeTransferCache.getMimeTypeUsageTypeTransfer(mimeTypeUsageType))
        );

        return mimeTypeUsageTypeTransfers;
    }

    public List<MimeTypeUsageTypeTransfer> getMimeTypeUsageTypeTransfers(UserVisit userVisit) {
        return getMimeTypeUsageTypeTransfers(userVisit, getMimeTypeUsageTypes());
    }

    // --------------------------------------------------------------------------------
    //   Mime Type Usage Type Descriptions
    // --------------------------------------------------------------------------------
    
    public MimeTypeUsageTypeDescription createMimeTypeUsageTypeDescription(MimeTypeUsageType mimeTypeUsageType, Language language, String description) {
        return MimeTypeUsageTypeDescriptionFactory.getInstance().create(mimeTypeUsageType, language, description);
    }
    
    public MimeTypeUsageTypeDescription getMimeTypeUsageTypeDescription(MimeTypeUsageType mimeTypeUsageType, Language language) {
        MimeTypeUsageTypeDescription mimeTypeUsageTypeDescription;
        
        try {
            var ps = MimeTypeUsageTypeDescriptionFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM mimetypeusagetypedescriptions " +
                    "WHERE mtyputd_mtyput_mimetypeusagetypeid = ? AND mtyputd_lang_languageid = ?");
            
            ps.setLong(1, mimeTypeUsageType.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            
            mimeTypeUsageTypeDescription = MimeTypeUsageTypeDescriptionFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return mimeTypeUsageTypeDescription;
    }
    
    public String getBestMimeTypeUsageTypeDescription(MimeTypeUsageType mimeTypeUsageType, Language language) {
        String description;
        var mimeTypeUsageTypeDescription = getMimeTypeUsageTypeDescription(mimeTypeUsageType, language);
        
        if(mimeTypeUsageTypeDescription == null && !language.getIsDefault()) {
            mimeTypeUsageTypeDescription = getMimeTypeUsageTypeDescription(mimeTypeUsageType, getPartyControl().getDefaultLanguage());
        }
        
        if(mimeTypeUsageTypeDescription == null) {
            description = mimeTypeUsageType.getMimeTypeUsageTypeName();
        } else {
            description = mimeTypeUsageTypeDescription.getDescription();
        }
        
        return description;
    }
    
    // --------------------------------------------------------------------------------
    //   Mime Types
    // --------------------------------------------------------------------------------

    public MimeType createMimeType(String mimeTypeName, EntityAttributeType entityAttributeType, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultMimeType = getDefaultMimeType();
        var defaultFound = defaultMimeType != null;

        if(defaultFound && isDefault) {
            var defaultMimeTypeDetailValue = getDefaultMimeTypeDetailValueForUpdate();

            defaultMimeTypeDetailValue.setIsDefault(Boolean.FALSE);
            updateMimeTypeFromValue(defaultMimeTypeDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var mimeType = MimeTypeFactory.getInstance().create();
        var mimeTypeDetail = MimeTypeDetailFactory.getInstance().create(mimeType, mimeTypeName, entityAttributeType, isDefault, sortOrder,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        // Convert to R/W
        mimeType = MimeTypeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                mimeType.getPrimaryKey());
        mimeType.setActiveDetail(mimeTypeDetail);
        mimeType.setLastDetail(mimeTypeDetail);
        mimeType.store();

        sendEvent(mimeType.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return mimeType;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.MimeType */
    public MimeType getMimeTypeByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new MimeTypePK(entityInstance.getEntityUniqueId());

        return MimeTypeFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public MimeType getMimeTypeByEntityInstance(EntityInstance entityInstance) {
        return getMimeTypeByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public MimeType getMimeTypeByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getMimeTypeByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public long countMimeTypes() {
        return session.queryForLong("""
                SELECT COUNT(*)
                FROM mimetypes
                JOIN mimetypedetails ON mtyp_activedetailid = mtypdt_mimetypedetailid
                """);
    }

    public long countMimeTypesByMimeTypeUsageType(MimeTypeUsageType mimeTypeUsageType) {
        return session.queryForLong("""
                SELECT COUNT(*)
                FROM mimetypes
                JOIN mimetypedetails ON mtyp_activedetailid = mtypdt_mimetypedetailid
                JOIN mimetypeusages ON mtyp_mimetypeid = mtypu_mtyp_mimetypeid
                WHERE mtypu_mtyput_mimetypeusagetypeid = ?
                """, mimeTypeUsageType);
    }

    private static final Map<EntityPermission, String> getMimeTypeByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM mimetypes, mimetypedetails " +
                "WHERE mtyp_activedetailid = mtypdt_mimetypedetailid " +
                "AND mtypdt_mimetypename = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM mimetypes, mimetypedetails " +
                "WHERE mtyp_activedetailid = mtypdt_mimetypedetailid " +
                "AND mtypdt_mimetypename = ? " +
                "FOR UPDATE");
        getMimeTypeByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private MimeType getMimeTypeByName(String mimeTypeName, EntityPermission entityPermission) {
        return MimeTypeFactory.getInstance().getEntityFromQuery(entityPermission, getMimeTypeByNameQueries, mimeTypeName);
    }

    public MimeType getMimeTypeByName(String mimeTypeName) {
        return getMimeTypeByName(mimeTypeName, EntityPermission.READ_ONLY);
    }

    public MimeType getMimeTypeByNameForUpdate(String mimeTypeName) {
        return getMimeTypeByName(mimeTypeName, EntityPermission.READ_WRITE);
    }

    public MimeTypeDetailValue getMimeTypeDetailValueForUpdate(MimeType mimeType) {
        return mimeType == null? null: mimeType.getLastDetailForUpdate().getMimeTypeDetailValue().clone();
    }

    public MimeTypeDetailValue getMimeTypeDetailValueByNameForUpdate(String mimeTypeName) {
        return getMimeTypeDetailValueForUpdate(getMimeTypeByNameForUpdate(mimeTypeName));
    }

    private static final Map<EntityPermission, String> getDefaultMimeTypeQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM mimetypes, mimetypedetails "
                + "WHERE mtyp_activedetailid = mtypdt_mimetypedetailid "
                + "AND mtypdt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM mimetypes, mimetypedetails "
                + "WHERE mtyp_activedetailid = mtypdt_mimetypedetailid "
                + "AND mtypdt_isdefault = 1 "
                + "FOR UPDATE");
        getDefaultMimeTypeQueries = Collections.unmodifiableMap(queryMap);
    }

    private MimeType getDefaultMimeType(EntityPermission entityPermission) {
        return MimeTypeFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultMimeTypeQueries);
    }

    public MimeType getDefaultMimeType() {
        return getDefaultMimeType(EntityPermission.READ_ONLY);
    }

    public MimeType getDefaultMimeTypeForUpdate() {
        return getDefaultMimeType(EntityPermission.READ_WRITE);
    }

    public MimeTypeDetailValue getDefaultMimeTypeDetailValueForUpdate() {
        return getDefaultMimeTypeForUpdate().getLastDetailForUpdate().getMimeTypeDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getMimeTypesQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM mimetypes, mimetypedetails "
                + "WHERE mtyp_activedetailid = mtypdt_mimetypedetailid "
                + "ORDER BY mtypdt_sortorder, mtypdt_mimetypename "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM mimetypes, mimetypedetails "
                + "WHERE mtyp_activedetailid = mtypdt_mimetypedetailid "
                + "FOR UPDATE");
        getMimeTypesQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<MimeType> getMimeTypes(EntityPermission entityPermission) {
        return MimeTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, getMimeTypesQueries);
    }

    public List<MimeType> getMimeTypes() {
        return getMimeTypes(EntityPermission.READ_ONLY);
    }

    public List<MimeType> getMimeTypesForUpdate() {
        return getMimeTypes(EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getMimeTypesByEntityAttributeTypeQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM mimetypes, mimetypedetails "
                + "WHERE mtyp_activedetailid = mtypdt_mimetypedetailid "
                + "AND mtypdt_enat_entityattributetypeid = ? "
                + "ORDER BY mtypdt_sortorder, mtypdt_mimetypename "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM mimetypes, mimetypedetails "
                + "WHERE mtyp_activedetailid = mtypdt_mimetypedetailid "
                + "AND mtypdt_enat_entityattributetypeid = ?"
                + "FOR UPDATE");
        getMimeTypesByEntityAttributeTypeQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<MimeType> getMimeTypesByEntityAttributeType(EntityAttributeType entityAttributeType, EntityPermission entityPermission) {
        return MimeTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, getMimeTypesByEntityAttributeTypeQueries,
                entityAttributeType);
    }

    public List<MimeType> getMimeTypesByEntityAttributeType(EntityAttributeType entityAttributeType) {
        return getMimeTypesByEntityAttributeType(entityAttributeType, EntityPermission.READ_ONLY);
    }

    public List<MimeType> getMimeTypesByEntityAttributeTypeForUpdate(EntityAttributeType entityAttributeType) {
        return getMimeTypesByEntityAttributeType(entityAttributeType, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getMimeTypesByMimeTypeUsageTypeQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM mimetypes, mimetypedetails, mimetypeusages "
                + "WHERE mtyp_activedetailid = mtypdt_mimetypedetailid "
                + "AND mtyp_mimetypeid = mtypu_mtyp_mimetypeid AND mtypu_mtyput_mimetypeusagetypeid = ? "
                + "ORDER BY mtypdt_sortorder, mtypdt_mimetypename "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM mimetypes, mimetypedetails, mimetypeusages "
                + "WHERE mtyp_activedetailid = mtypdt_mimetypedetailid "
                + "AND mtyp_mimetypeid = mtypu_mtyp_mimetypeid AND mtypu_mtyput_mimetypeusagetypeid = ? "
                + "FOR UPDATE");
        getMimeTypesByMimeTypeUsageTypeQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<MimeType> getMimeTypesByMimeTypeUsageType(MimeTypeUsageType mimeTypeUsageType, EntityPermission entityPermission) {
        return MimeTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, getMimeTypesByMimeTypeUsageTypeQueries,
                mimeTypeUsageType);
    }

    public List<MimeType> getMimeTypesByMimeTypeUsageType(MimeTypeUsageType mimeTypeUsageType) {
        return getMimeTypesByMimeTypeUsageType(mimeTypeUsageType, EntityPermission.READ_ONLY);
    }

    public List<MimeType> getMimeTypesByMimeTypeUsageTypeForUpdate(MimeTypeUsageType mimeTypeUsageType) {
        return getMimeTypesByMimeTypeUsageType(mimeTypeUsageType, EntityPermission.READ_WRITE);
    }

    public MimeTypeTransfer getMimeTypeTransfer(UserVisit userVisit, MimeType mimeType) {
        return getCoreTransferCaches(userVisit).getMimeTypeTransferCache().getMimeTypeTransfer(mimeType);
    }

    public List<MimeTypeTransfer> getMimeTypeTransfers(UserVisit userVisit, Collection<MimeType> mimeTypes) {
        List<MimeTypeTransfer> mimeTypeTransfers = new ArrayList<>(mimeTypes.size());
        var mimeTypeTransferCache = getCoreTransferCaches(userVisit).getMimeTypeTransferCache();

        mimeTypes.forEach((mimeType) ->
                mimeTypeTransfers.add(mimeTypeTransferCache.getMimeTypeTransfer(mimeType))
        );

        return mimeTypeTransfers;
    }

    public List<MimeTypeTransfer> getMimeTypeTransfers(UserVisit userVisit) {
        return getMimeTypeTransfers(userVisit, getMimeTypes());
    }

    public List<MimeTypeTransfer> getMimeTypeTransfersByEntityAttributeType(UserVisit userVisit,
            EntityAttributeType entityAttributeType) {
        return getMimeTypeTransfers(userVisit, getMimeTypesByEntityAttributeType(entityAttributeType));
    }

    public List<MimeTypeTransfer> getMimeTypeTransfersByMimeTypeUsageType(UserVisit userVisit,
            MimeTypeUsageType mimeTypeUsageType) {
        return getMimeTypeTransfers(userVisit, getMimeTypesByMimeTypeUsageType(mimeTypeUsageType));
    }

    public MimeTypeChoicesBean getMimeTypeChoices(String defaultMimeTypeChoice, Language language, boolean allowNullChoice) {
        var mimeTypes = getMimeTypes();
        var size = mimeTypes.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultMimeTypeChoice == null) {
                defaultValue = "";
            }
        }

        for(var mimeType : mimeTypes) {
            var mimeTypeDetail = mimeType.getLastDetail();

            var label = getBestMimeTypeDescription(mimeType, language);
            var value = mimeTypeDetail.getMimeTypeName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultMimeTypeChoice != null && defaultMimeTypeChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && mimeTypeDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new MimeTypeChoicesBean(labels, values, defaultValue);
    }

    public MimeTypeChoicesBean getMimeTypeChoices(MimeTypeUsageType mimeTypeUsageType, String defaultMimeTypeChoice, Language language,
            boolean allowNullChoice) {
        var mimeTypes = getMimeTypesByMimeTypeUsageType(mimeTypeUsageType);
        var size = mimeTypes.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultMimeTypeChoice == null) {
                defaultValue = "";
            }
        }

        for(var mimeType : mimeTypes) {
            var mimeTypeDetail = mimeType.getLastDetail();

            var label = getBestMimeTypeDescription(mimeType, language);
            var value = mimeTypeDetail.getMimeTypeName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultMimeTypeChoice != null && defaultMimeTypeChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && mimeTypeDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new MimeTypeChoicesBean(labels, values, defaultValue);
    }

    private void updateMimeTypeFromValue(MimeTypeDetailValue mimeTypeDetailValue, boolean checkDefault,
            BasePK updatedBy) {
        if(mimeTypeDetailValue.hasBeenModified()) {
            var mimeType = MimeTypeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     mimeTypeDetailValue.getMimeTypePK());
            var mimeTypeDetail = mimeType.getActiveDetailForUpdate();

            mimeTypeDetail.setThruTime(session.START_TIME_LONG);
            mimeTypeDetail.store();

            var mimeTypePK = mimeTypeDetail.getMimeTypePK(); // Not updated
            var mimeTypeName = mimeTypeDetailValue.getMimeTypeName();
            var entityAttributeTypePK = mimeTypeDetail.getEntityAttributeTypePK(); // Not updated
            var isDefault = mimeTypeDetailValue.getIsDefault();
            var sortOrder = mimeTypeDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultMimeType = getDefaultMimeType();
                var defaultFound = defaultMimeType != null && !defaultMimeType.equals(mimeType);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultMimeTypeDetailValue = getDefaultMimeTypeDetailValueForUpdate();

                    defaultMimeTypeDetailValue.setIsDefault(Boolean.FALSE);
                    updateMimeTypeFromValue(defaultMimeTypeDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            mimeTypeDetail = MimeTypeDetailFactory.getInstance().create(mimeTypePK, mimeTypeName, entityAttributeTypePK, isDefault, sortOrder,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            mimeType.setActiveDetail(mimeTypeDetail);
            mimeType.setLastDetail(mimeTypeDetail);

            sendEvent(mimeTypePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateMimeTypeFromValue(MimeTypeDetailValue mimeTypeDetailValue, BasePK updatedBy) {
        updateMimeTypeFromValue(mimeTypeDetailValue, true, updatedBy);
    }

    public void deleteMimeType(MimeType mimeType, BasePK deletedBy) {
        deleteMimeTypeDescriptionsByMimeType(mimeType, deletedBy);

        var mimeTypeDetail = mimeType.getLastDetailForUpdate();
        mimeTypeDetail.setThruTime(session.START_TIME_LONG);
        mimeType.setActiveDetail(null);
        mimeType.store();

        // Check for default, and pick one if necessary
        var defaultMimeType = getDefaultMimeType();
        if(defaultMimeType == null) {
            var mimeTypes = getMimeTypesForUpdate();

            if(!mimeTypes.isEmpty()) {
                var iter = mimeTypes.iterator();
                if(iter.hasNext()) {
                    defaultMimeType = iter.next();
                }
                var mimeTypeDetailValue = Objects.requireNonNull(defaultMimeType).getLastDetailForUpdate().getMimeTypeDetailValue().clone();

                mimeTypeDetailValue.setIsDefault(Boolean.TRUE);
                updateMimeTypeFromValue(mimeTypeDetailValue, false, deletedBy);
            }
        }

        sendEvent(mimeType.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Mime Type Descriptions
    // --------------------------------------------------------------------------------

    public MimeTypeDescription createMimeTypeDescription(MimeType mimeType,
            Language language, String description, BasePK createdBy) {
        var mimeTypeDescription = MimeTypeDescriptionFactory.getInstance().create(mimeType,
                language, description, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(mimeType.getPrimaryKey(), EventTypes.MODIFY, mimeTypeDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return mimeTypeDescription;
    }

    private static final Map<EntityPermission, String> getMimeTypeDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM mimetypedescriptions "
                + "WHERE mtypd_mtyp_mimetypeid = ? AND mtypd_lang_languageid = ? AND mtypd_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM mimetypedescriptions "
                + "WHERE mtypd_mtyp_mimetypeid = ? AND mtypd_lang_languageid = ? AND mtypd_thrutime = ? "
                + "FOR UPDATE");
        getMimeTypeDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private MimeTypeDescription getMimeTypeDescription(MimeType mimeType,
            Language language, EntityPermission entityPermission) {
        return MimeTypeDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getMimeTypeDescriptionQueries,
                mimeType, language, Session.MAX_TIME);
    }

    public MimeTypeDescription getMimeTypeDescription(MimeType mimeType, Language language) {
        return getMimeTypeDescription(mimeType, language, EntityPermission.READ_ONLY);
    }

    public MimeTypeDescription getMimeTypeDescriptionForUpdate(MimeType mimeType, Language language) {
        return getMimeTypeDescription(mimeType, language, EntityPermission.READ_WRITE);
    }

    public MimeTypeDescriptionValue getMimeTypeDescriptionValue(MimeTypeDescription mimeTypeDescription) {
        return mimeTypeDescription == null? null: mimeTypeDescription.getMimeTypeDescriptionValue().clone();
    }

    public MimeTypeDescriptionValue getMimeTypeDescriptionValueForUpdate(MimeType mimeType, Language language) {
        return getMimeTypeDescriptionValue(getMimeTypeDescriptionForUpdate(mimeType, language));
    }

    private static final Map<EntityPermission, String> getMimeTypeDescriptionsByMimeTypeQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM mimetypedescriptions, languages "
                + "WHERE mtypd_mtyp_mimetypeid = ? AND mtypd_thrutime = ? AND mtypd_lang_languageid = lang_languageid "
                + "ORDER BY lang_sortorder, lang_languageisoname "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM mimetypedescriptions "
                + "WHERE mtypd_mtyp_mimetypeid = ? AND mtypd_thrutime = ? "
                + "FOR UPDATE");
        getMimeTypeDescriptionsByMimeTypeQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<MimeTypeDescription> getMimeTypeDescriptionsByMimeType(MimeType mimeType,
            EntityPermission entityPermission) {
        return MimeTypeDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getMimeTypeDescriptionsByMimeTypeQueries,
                mimeType, Session.MAX_TIME);
    }

    public List<MimeTypeDescription> getMimeTypeDescriptionsByMimeType(MimeType mimeType) {
        return getMimeTypeDescriptionsByMimeType(mimeType, EntityPermission.READ_ONLY);
    }

    public List<MimeTypeDescription> getMimeTypeDescriptionsByMimeTypeForUpdate(MimeType mimeType) {
        return getMimeTypeDescriptionsByMimeType(mimeType, EntityPermission.READ_WRITE);
    }

    public String getBestMimeTypeDescription(MimeType mimeType, Language language) {
        String description;
        var mimeTypeDescription = getMimeTypeDescription(mimeType, language);

        if(mimeTypeDescription == null && !language.getIsDefault()) {
            mimeTypeDescription = getMimeTypeDescription(mimeType, getPartyControl().getDefaultLanguage());
        }

        if(mimeTypeDescription == null) {
            description = mimeType.getLastDetail().getMimeTypeName();
        } else {
            description = mimeTypeDescription.getDescription();
        }

        return description;
    }

    public MimeTypeDescriptionTransfer getMimeTypeDescriptionTransfer(UserVisit userVisit, MimeTypeDescription mimeTypeDescription) {
        return getCoreTransferCaches(userVisit).getMimeTypeDescriptionTransferCache().getMimeTypeDescriptionTransfer(mimeTypeDescription);
    }

    public List<MimeTypeDescriptionTransfer> getMimeTypeDescriptionTransfersByMimeType(UserVisit userVisit, MimeType mimeType) {
        var mimeTypeDescriptions = getMimeTypeDescriptionsByMimeType(mimeType);
        List<MimeTypeDescriptionTransfer> mimeTypeDescriptionTransfers = new ArrayList<>(mimeTypeDescriptions.size());
        var mimeTypeDescriptionTransferCache = getCoreTransferCaches(userVisit).getMimeTypeDescriptionTransferCache();

        mimeTypeDescriptions.forEach((mimeTypeDescription) ->
                mimeTypeDescriptionTransfers.add(mimeTypeDescriptionTransferCache.getMimeTypeDescriptionTransfer(mimeTypeDescription))
        );

        return mimeTypeDescriptionTransfers;
    }

    public void updateMimeTypeDescriptionFromValue(MimeTypeDescriptionValue mimeTypeDescriptionValue, BasePK updatedBy) {
        if(mimeTypeDescriptionValue.hasBeenModified()) {
            var mimeTypeDescription = MimeTypeDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    mimeTypeDescriptionValue.getPrimaryKey());

            mimeTypeDescription.setThruTime(session.START_TIME_LONG);
            mimeTypeDescription.store();

            var mimeType = mimeTypeDescription.getMimeType();
            var language = mimeTypeDescription.getLanguage();
            var description = mimeTypeDescriptionValue.getDescription();

            mimeTypeDescription = MimeTypeDescriptionFactory.getInstance().create(mimeType, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(mimeType.getPrimaryKey(), EventTypes.MODIFY, mimeTypeDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteMimeTypeDescription(MimeTypeDescription mimeTypeDescription, BasePK deletedBy) {
        mimeTypeDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(mimeTypeDescription.getMimeTypePK(), EventTypes.MODIFY, mimeTypeDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteMimeTypeDescriptionsByMimeType(MimeType mimeType, BasePK deletedBy) {
        var mimeTypeDescriptions = getMimeTypeDescriptionsByMimeTypeForUpdate(mimeType);

        mimeTypeDescriptions.forEach((mimeTypeDescription) -> 
                deleteMimeTypeDescription(mimeTypeDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Mime Type Usages
    // --------------------------------------------------------------------------------
    
    public MimeTypeUsage createMimeTypeUsage(MimeType mimeType, MimeTypeUsageType mimeTypeUsageType) {
        return MimeTypeUsageFactory.getInstance().create(mimeType, mimeTypeUsageType);
    }
    
    public MimeTypeUsage getMimeTypeUsage(MimeType mimeType, MimeTypeUsageType mimeTypeUsageType) {
        MimeTypeUsage mimeTypeUsage;
        
        try {
            var ps = MimeTypeUsageFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM mimetypeusages " +
                    "WHERE mtypu_mtyp_mimetypeid = ? AND mtypu_mtyput_mimetypeusagetypeid = ?");
            
            ps.setLong(1, mimeType.getPrimaryKey().getEntityId());
            ps.setLong(2, mimeTypeUsageType.getPrimaryKey().getEntityId());
            
            mimeTypeUsage = MimeTypeUsageFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return mimeTypeUsage;
    }
    
    public List<MimeTypeUsage> getMimeTypeUsagesByMimeType(MimeType mimeType) {
        List<MimeTypeUsage> mimeTypeUsages;
        
        try {
            var ps = MimeTypeUsageFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ "
                    + "FROM mimetypeusages, mimetypes, mimetypedetails "
                    + "WHERE mtypu_mtyp_mimetypeid = ? "
                    + "AND mtypu_mtyp_mimetypeid = mtyp_mimetypeid AND mtyp_lastdetailid = mtypdt_mimetypedetailid "
                    + "ORDER BY mtypdt_sortorder, mtypdt_mimetypename");
            
            ps.setLong(1, mimeType.getPrimaryKey().getEntityId());
            
            mimeTypeUsages = MimeTypeUsageFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return mimeTypeUsages;
    }
    
    public MimeTypeUsageTransfer getMimeTypeUsageTransfer(UserVisit userVisit, MimeTypeUsage mimeTypeUsage) {
        return getCoreTransferCaches(userVisit).getMimeTypeUsageTransferCache().getMimeTypeUsageTransfer(mimeTypeUsage);
    }
    
    public List<MimeTypeUsageTransfer> getMimeTypeUsageTransfersByMimeType(UserVisit userVisit, Collection<MimeTypeUsage> mimeTypeUsages) {
        List<MimeTypeUsageTransfer> mimeTypeUsageTransfers = new ArrayList<>(mimeTypeUsages.size());
        var mimeTypeUsageTransferCache = getCoreTransferCaches(userVisit).getMimeTypeUsageTransferCache();
        
        mimeTypeUsages.forEach((mimeTypeUsage) ->
                mimeTypeUsageTransfers.add(mimeTypeUsageTransferCache.getMimeTypeUsageTransfer(mimeTypeUsage))
        );
        
        return mimeTypeUsageTransfers;
    }
    
    public List<MimeTypeUsageTransfer> getMimeTypeUsageTransfersByMimeType(UserVisit userVisit, MimeType mimeType) {
        return getMimeTypeUsageTransfersByMimeType(userVisit, getMimeTypeUsagesByMimeType(mimeType));
    }
    
    // --------------------------------------------------------------------------------
    //   Mime Type File Extensions
    // --------------------------------------------------------------------------------
    
    public MimeTypeFileExtension createMimeTypeFileExtension(MimeType mimeType, String fileExtension, Boolean isDefault) {
        return MimeTypeFileExtensionFactory.getInstance().create(mimeType, fileExtension, isDefault);
    }
    
    public MimeTypeFileExtension getDefaultMimeTypeFileExtension(MimeType mimeType) {
        MimeTypeFileExtension mimeTypeFileExtension;
        
        try {
            var ps = MimeTypeFileExtensionFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM mimetypefileextensions " +
                    "WHERE mtypfe_mtyp_mimetypeid = ? AND mtypfe_isdefault = 1");
            
            ps.setLong(1, mimeType.getPrimaryKey().getEntityId());
            
            mimeTypeFileExtension = MimeTypeFileExtensionFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return mimeTypeFileExtension;
    }
    
    public MimeTypeFileExtension getMimeTypeFileExtension(String fileExtension) {
        MimeTypeFileExtension mimeTypeFileExtension;
        
        try {
            var ps = MimeTypeFileExtensionFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM mimetypefileextensions " +
                    "WHERE mtypfe_fileextension = ?");
            
            ps.setString(1, fileExtension);
            
            mimeTypeFileExtension = MimeTypeFileExtensionFactory.getInstance().getEntityFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return mimeTypeFileExtension;
    }
    
    public List<MimeTypeFileExtension> getMimeTypeFileExtensions() {
        var ps = MimeTypeFileExtensionFactory.getInstance().prepareStatement(
                "SELECT _ALL_ " +
                "FROM mimetypefileextensions " +
                "ORDER BY mtypfe_fileextension");
        
        return MimeTypeFileExtensionFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
    }
    
    public List<MimeTypeFileExtension> getMimeTypeFileExtensionsByMimeType(MimeType mimeType) {
        var ps = MimeTypeFileExtensionFactory.getInstance().prepareStatement(
                "SELECT _ALL_ "
                + "FROM mimetypefileextensions "
                + "WHERE mtypfe_mtyp_mimetypeid = ? "
                + "ORDER BY mtypfe_fileextension");
        
        return MimeTypeFileExtensionFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps,
                mimeType);
    }
    
    public MimeTypeFileExtensionTransfer getMimeTypeFileExtensionTransfer(UserVisit userVisit, MimeTypeFileExtension mimeTypeFileExtension) {
        return getCoreTransferCaches(userVisit).getMimeTypeFileExtensionTransferCache().getMimeTypeFileExtensionTransfer(mimeTypeFileExtension);
    }
    
    public List<MimeTypeFileExtensionTransfer> getMimeTypeFileExtensionTransfers(UserVisit userVisit, Collection<MimeTypeFileExtension> mimeTypeFileExtensions) {
        List<MimeTypeFileExtensionTransfer> mimeTypeFileExtensionTransfers = new ArrayList<>(mimeTypeFileExtensions.size());
        var mimeTypeFileExtensionTransferCache = getCoreTransferCaches(userVisit).getMimeTypeFileExtensionTransferCache();
        
        mimeTypeFileExtensions.forEach((mimeTypeFileExtension) ->
                mimeTypeFileExtensionTransfers.add(mimeTypeFileExtensionTransferCache.getMimeTypeFileExtensionTransfer(mimeTypeFileExtension))
        );
        
        return mimeTypeFileExtensionTransfers;
    }
    
    public List<MimeTypeFileExtensionTransfer> getMimeTypeFileExtensionTransfers(UserVisit userVisit) {
        return getMimeTypeFileExtensionTransfers(userVisit, getMimeTypeFileExtensions());
    }
    
    public List<MimeTypeFileExtensionTransfer> getMimeTypeFileExtensionTransfersByMimeType(UserVisit userVisit, MimeType mimeType) {
        return getMimeTypeFileExtensionTransfers(userVisit, getMimeTypeFileExtensionsByMimeType(mimeType));
    }
    
    // --------------------------------------------------------------------------------
    //   Protocols
    // --------------------------------------------------------------------------------

    public Protocol createProtocol(String protocolName, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultProtocol = getDefaultProtocol();
        var defaultFound = defaultProtocol != null;

        if(defaultFound && isDefault) {
            var defaultProtocolDetailValue = getDefaultProtocolDetailValueForUpdate();

            defaultProtocolDetailValue.setIsDefault(Boolean.FALSE);
            updateProtocolFromValue(defaultProtocolDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var protocol = ProtocolFactory.getInstance().create();
        var protocolDetail = ProtocolDetailFactory.getInstance().create(protocol, protocolName, isDefault, sortOrder, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);

        // Convert to R/W
        protocol = ProtocolFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                protocol.getPrimaryKey());
        protocol.setActiveDetail(protocolDetail);
        protocol.setLastDetail(protocolDetail);
        protocol.store();

        sendEvent(protocol.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return protocol;
    }

    private static final Map<EntityPermission, String> getProtocolByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM protocols, protocoldetails " +
                "WHERE prot_activedetailid = protdt_protocoldetailid " +
                "AND protdt_protocolname = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM protocols, protocoldetails " +
                "WHERE prot_activedetailid = protdt_protocoldetailid " +
                "AND protdt_protocolname = ? " +
                "FOR UPDATE");
        getProtocolByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private Protocol getProtocolByName(String protocolName, EntityPermission entityPermission) {
        return ProtocolFactory.getInstance().getEntityFromQuery(entityPermission, getProtocolByNameQueries, protocolName);
    }

    public Protocol getProtocolByName(String protocolName) {
        return getProtocolByName(protocolName, EntityPermission.READ_ONLY);
    }

    public Protocol getProtocolByNameForUpdate(String protocolName) {
        return getProtocolByName(protocolName, EntityPermission.READ_WRITE);
    }

    public ProtocolDetailValue getProtocolDetailValueForUpdate(Protocol protocol) {
        return protocol == null? null: protocol.getLastDetailForUpdate().getProtocolDetailValue().clone();
    }

    public ProtocolDetailValue getProtocolDetailValueByNameForUpdate(String protocolName) {
        return getProtocolDetailValueForUpdate(getProtocolByNameForUpdate(protocolName));
    }

    private static final Map<EntityPermission, String> getDefaultProtocolQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM protocols, protocoldetails " +
                "WHERE prot_activedetailid = protdt_protocoldetailid " +
                "AND protdt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM protocols, protocoldetails " +
                "WHERE prot_activedetailid = protdt_protocoldetailid " +
                "AND protdt_isdefault = 1 " +
                "FOR UPDATE");
        getDefaultProtocolQueries = Collections.unmodifiableMap(queryMap);
    }

    private Protocol getDefaultProtocol(EntityPermission entityPermission) {
        return ProtocolFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultProtocolQueries);
    }

    public Protocol getDefaultProtocol() {
        return getDefaultProtocol(EntityPermission.READ_ONLY);
    }

    public Protocol getDefaultProtocolForUpdate() {
        return getDefaultProtocol(EntityPermission.READ_WRITE);
    }

    public ProtocolDetailValue getDefaultProtocolDetailValueForUpdate() {
        return getDefaultProtocolForUpdate().getLastDetailForUpdate().getProtocolDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getProtocolsQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM protocols, protocoldetails " +
                "WHERE prot_activedetailid = protdt_protocoldetailid " +
                "ORDER BY protdt_sortorder, protdt_protocolname " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM protocols, protocoldetails " +
                "WHERE prot_activedetailid = protdt_protocoldetailid " +
                "FOR UPDATE");
        getProtocolsQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Protocol> getProtocols(EntityPermission entityPermission) {
        return ProtocolFactory.getInstance().getEntitiesFromQuery(entityPermission, getProtocolsQueries);
    }

    public List<Protocol> getProtocols() {
        return getProtocols(EntityPermission.READ_ONLY);
    }

    public List<Protocol> getProtocolsForUpdate() {
        return getProtocols(EntityPermission.READ_WRITE);
    }

    public ProtocolTransfer getProtocolTransfer(UserVisit userVisit, Protocol protocol) {
        return getCoreTransferCaches(userVisit).getProtocolTransferCache().getProtocolTransfer(protocol);
    }

    public List<ProtocolTransfer> getProtocolTransfers(UserVisit userVisit) {
        var protocols = getProtocols();
        List<ProtocolTransfer> protocolTransfers = new ArrayList<>(protocols.size());
        var protocolTransferCache = getCoreTransferCaches(userVisit).getProtocolTransferCache();

        protocols.forEach((protocol) ->
                protocolTransfers.add(protocolTransferCache.getProtocolTransfer(protocol))
        );

        return protocolTransfers;
    }

    public ProtocolChoicesBean getProtocolChoices(String defaultProtocolChoice, Language language, boolean allowNullChoice) {
        var protocols = getProtocols();
        var size = protocols.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultProtocolChoice == null) {
                defaultValue = "";
            }
        }

        for(var protocol : protocols) {
            var protocolDetail = protocol.getLastDetail();

            var label = getBestProtocolDescription(protocol, language);
            var value = protocolDetail.getProtocolName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultProtocolChoice != null && defaultProtocolChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && protocolDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new ProtocolChoicesBean(labels, values, defaultValue);
    }

    private void updateProtocolFromValue(ProtocolDetailValue protocolDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(protocolDetailValue.hasBeenModified()) {
            var protocol = ProtocolFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     protocolDetailValue.getProtocolPK());
            var protocolDetail = protocol.getActiveDetailForUpdate();

            protocolDetail.setThruTime(session.START_TIME_LONG);
            protocolDetail.store();

            var protocolPK = protocolDetail.getProtocolPK(); // Not updated
            var protocolName = protocolDetailValue.getProtocolName();
            var isDefault = protocolDetailValue.getIsDefault();
            var sortOrder = protocolDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultProtocol = getDefaultProtocol();
                var defaultFound = defaultProtocol != null && !defaultProtocol.equals(protocol);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultProtocolDetailValue = getDefaultProtocolDetailValueForUpdate();

                    defaultProtocolDetailValue.setIsDefault(Boolean.FALSE);
                    updateProtocolFromValue(defaultProtocolDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            protocolDetail = ProtocolDetailFactory.getInstance().create(protocolPK, protocolName, isDefault, sortOrder, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            protocol.setActiveDetail(protocolDetail);
            protocol.setLastDetail(protocolDetail);

            sendEvent(protocolPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateProtocolFromValue(ProtocolDetailValue protocolDetailValue, BasePK updatedBy) {
        updateProtocolFromValue(protocolDetailValue, true, updatedBy);
    }

    private void deleteProtocol(Protocol protocol, boolean checkDefault, BasePK deletedBy) {
        var protocolDetail = protocol.getLastDetailForUpdate();

        deleteServicesByProtocol(protocol, deletedBy);
        deleteProtocolDescriptionsByProtocol(protocol, deletedBy);

        protocolDetail.setThruTime(session.START_TIME_LONG);
        protocol.setActiveDetail(null);
        protocol.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultProtocol = getDefaultProtocol();

            if(defaultProtocol == null) {
                var protocols = getProtocolsForUpdate();

                if(!protocols.isEmpty()) {
                    var iter = protocols.iterator();
                    if(iter.hasNext()) {
                        defaultProtocol = iter.next();
                    }
                    var protocolDetailValue = Objects.requireNonNull(defaultProtocol).getLastDetailForUpdate().getProtocolDetailValue().clone();

                    protocolDetailValue.setIsDefault(Boolean.TRUE);
                    updateProtocolFromValue(protocolDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(protocol.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteProtocol(Protocol protocol, BasePK deletedBy) {
        deleteProtocol(protocol, true, deletedBy);
    }

    private void deleteProtocols(List<Protocol> protocols, boolean checkDefault, BasePK deletedBy) {
        protocols.forEach((protocol) -> deleteProtocol(protocol, checkDefault, deletedBy));
    }

    public void deleteProtocols(List<Protocol> protocols, BasePK deletedBy) {
        deleteProtocols(protocols, true, deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Protocol Descriptions
    // --------------------------------------------------------------------------------

    public ProtocolDescription createProtocolDescription(Protocol protocol, Language language, String description, BasePK createdBy) {
        var protocolDescription = ProtocolDescriptionFactory.getInstance().create(protocol, language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(protocol.getPrimaryKey(), EventTypes.MODIFY, protocolDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return protocolDescription;
    }

    private static final Map<EntityPermission, String> getProtocolDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM protocoldescriptions " +
                "WHERE protd_prot_protocolid = ? AND protd_lang_languageid = ? AND protd_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM protocoldescriptions " +
                "WHERE protd_prot_protocolid = ? AND protd_lang_languageid = ? AND protd_thrutime = ? " +
                "FOR UPDATE");
        getProtocolDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private ProtocolDescription getProtocolDescription(Protocol protocol, Language language, EntityPermission entityPermission) {
        return ProtocolDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getProtocolDescriptionQueries,
                protocol, language, Session.MAX_TIME);
    }

    public ProtocolDescription getProtocolDescription(Protocol protocol, Language language) {
        return getProtocolDescription(protocol, language, EntityPermission.READ_ONLY);
    }

    public ProtocolDescription getProtocolDescriptionForUpdate(Protocol protocol, Language language) {
        return getProtocolDescription(protocol, language, EntityPermission.READ_WRITE);
    }

    public ProtocolDescriptionValue getProtocolDescriptionValue(ProtocolDescription protocolDescription) {
        return protocolDescription == null? null: protocolDescription.getProtocolDescriptionValue().clone();
    }

    public ProtocolDescriptionValue getProtocolDescriptionValueForUpdate(Protocol protocol, Language language) {
        return getProtocolDescriptionValue(getProtocolDescriptionForUpdate(protocol, language));
    }

    private static final Map<EntityPermission, String> getProtocolDescriptionsByProtocolQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM protocoldescriptions, languages " +
                "WHERE protd_prot_protocolid = ? AND protd_thrutime = ? AND protd_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM protocoldescriptions " +
                "WHERE protd_prot_protocolid = ? AND protd_thrutime = ? " +
                "FOR UPDATE");
        getProtocolDescriptionsByProtocolQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ProtocolDescription> getProtocolDescriptionsByProtocol(Protocol protocol, EntityPermission entityPermission) {
        return ProtocolDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getProtocolDescriptionsByProtocolQueries,
                protocol, Session.MAX_TIME);
    }

    public List<ProtocolDescription> getProtocolDescriptionsByProtocol(Protocol protocol) {
        return getProtocolDescriptionsByProtocol(protocol, EntityPermission.READ_ONLY);
    }

    public List<ProtocolDescription> getProtocolDescriptionsByProtocolForUpdate(Protocol protocol) {
        return getProtocolDescriptionsByProtocol(protocol, EntityPermission.READ_WRITE);
    }

    public String getBestProtocolDescription(Protocol protocol, Language language) {
        String description;
        var protocolDescription = getProtocolDescription(protocol, language);

        if(protocolDescription == null && !language.getIsDefault()) {
            protocolDescription = getProtocolDescription(protocol, getPartyControl().getDefaultLanguage());
        }

        if(protocolDescription == null) {
            description = protocol.getLastDetail().getProtocolName();
        } else {
            description = protocolDescription.getDescription();
        }

        return description;
    }

    public ProtocolDescriptionTransfer getProtocolDescriptionTransfer(UserVisit userVisit, ProtocolDescription protocolDescription) {
        return getCoreTransferCaches(userVisit).getProtocolDescriptionTransferCache().getProtocolDescriptionTransfer(protocolDescription);
    }

    public List<ProtocolDescriptionTransfer> getProtocolDescriptionTransfersByProtocol(UserVisit userVisit, Protocol protocol) {
        var protocolDescriptions = getProtocolDescriptionsByProtocol(protocol);
        List<ProtocolDescriptionTransfer> protocolDescriptionTransfers = new ArrayList<>(protocolDescriptions.size());
        var protocolDescriptionTransferCache = getCoreTransferCaches(userVisit).getProtocolDescriptionTransferCache();

        protocolDescriptions.forEach((protocolDescription) ->
                protocolDescriptionTransfers.add(protocolDescriptionTransferCache.getProtocolDescriptionTransfer(protocolDescription))
        );

        return protocolDescriptionTransfers;
    }

    public void updateProtocolDescriptionFromValue(ProtocolDescriptionValue protocolDescriptionValue, BasePK updatedBy) {
        if(protocolDescriptionValue.hasBeenModified()) {
            var protocolDescription = ProtocolDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    protocolDescriptionValue.getPrimaryKey());

            protocolDescription.setThruTime(session.START_TIME_LONG);
            protocolDescription.store();

            var protocol = protocolDescription.getProtocol();
            var language = protocolDescription.getLanguage();
            var description = protocolDescriptionValue.getDescription();

            protocolDescription = ProtocolDescriptionFactory.getInstance().create(protocol, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(protocol.getPrimaryKey(), EventTypes.MODIFY, protocolDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteProtocolDescription(ProtocolDescription protocolDescription, BasePK deletedBy) {
        protocolDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(protocolDescription.getProtocolPK(), EventTypes.MODIFY, protocolDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteProtocolDescriptionsByProtocol(Protocol protocol, BasePK deletedBy) {
        var protocolDescriptions = getProtocolDescriptionsByProtocolForUpdate(protocol);

        protocolDescriptions.forEach((protocolDescription) -> 
                deleteProtocolDescription(protocolDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Services
    // --------------------------------------------------------------------------------

    public Service createService(String serviceName, Integer port, Protocol protocol, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultService = getDefaultService();
        var defaultFound = defaultService != null;

        if(defaultFound && isDefault) {
            var defaultServiceDetailValue = getDefaultServiceDetailValueForUpdate();

            defaultServiceDetailValue.setIsDefault(Boolean.FALSE);
            updateServiceFromValue(defaultServiceDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var service = ServiceFactory.getInstance().create();
        var serviceDetail = ServiceDetailFactory.getInstance().create(service, serviceName, port, protocol, isDefault, sortOrder,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        // Convert to R/W
        service = ServiceFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                service.getPrimaryKey());
        service.setActiveDetail(serviceDetail);
        service.setLastDetail(serviceDetail);
        service.store();

        sendEvent(service.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return service;
    }

    private static final Map<EntityPermission, String> getServiceByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM services, servicedetails " +
                "WHERE srv_activedetailid = srvdt_servicedetailid " +
                "AND srvdt_servicename = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM services, servicedetails " +
                "WHERE srv_activedetailid = srvdt_servicedetailid " +
                "AND srvdt_servicename = ? " +
                "FOR UPDATE");
        getServiceByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private Service getServiceByName(String serviceName, EntityPermission entityPermission) {
        return ServiceFactory.getInstance().getEntityFromQuery(entityPermission, getServiceByNameQueries, serviceName);
    }

    public Service getServiceByName(String serviceName) {
        return getServiceByName(serviceName, EntityPermission.READ_ONLY);
    }

    public Service getServiceByNameForUpdate(String serviceName) {
        return getServiceByName(serviceName, EntityPermission.READ_WRITE);
    }

    public ServiceDetailValue getServiceDetailValueForUpdate(Service service) {
        return service == null? null: service.getLastDetailForUpdate().getServiceDetailValue().clone();
    }

    public ServiceDetailValue getServiceDetailValueByNameForUpdate(String serviceName) {
        return getServiceDetailValueForUpdate(getServiceByNameForUpdate(serviceName));
    }

    private static final Map<EntityPermission, String> getDefaultServiceQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM services, servicedetails " +
                "WHERE srv_activedetailid = srvdt_servicedetailid " +
                "AND srvdt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM services, servicedetails " +
                "WHERE srv_activedetailid = srvdt_servicedetailid " +
                "AND srvdt_isdefault = 1 " +
                "FOR UPDATE");
        getDefaultServiceQueries = Collections.unmodifiableMap(queryMap);
    }

    private Service getDefaultService(EntityPermission entityPermission) {
        return ServiceFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultServiceQueries);
    }

    public Service getDefaultService() {
        return getDefaultService(EntityPermission.READ_ONLY);
    }

    public Service getDefaultServiceForUpdate() {
        return getDefaultService(EntityPermission.READ_WRITE);
    }

    public ServiceDetailValue getDefaultServiceDetailValueForUpdate() {
        return getDefaultServiceForUpdate().getLastDetailForUpdate().getServiceDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getServicesQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM services, servicedetails " +
                "WHERE srv_activedetailid = srvdt_servicedetailid " +
                "ORDER BY srvdt_sortorder, srvdt_servicename " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM services, servicedetails " +
                "WHERE srv_activedetailid = srvdt_servicedetailid " +
                "FOR UPDATE");
        getServicesQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Service> getServices(EntityPermission entityPermission) {
        return ServiceFactory.getInstance().getEntitiesFromQuery(entityPermission, getServicesQueries);
    }

    public List<Service> getServices() {
        return getServices(EntityPermission.READ_ONLY);
    }

    public List<Service> getServicesForUpdate() {
        return getServices(EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getServicesByProtocolQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM services, servicedetails " +
                "WHERE srv_activedetailid = srvdt_servicedetailid " +
                "AND srvdt_prot_protocolid = ? " +
                "ORDER BY srvdt_sortorder, srvdt_servicename");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM services, servicedetails " +
                "WHERE srv_activedetailid = srvdt_servicedetailid " +
                "AND srvdt_prot_protocolid = ? " +
                "FOR UPDATE");
        getServicesByProtocolQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Service> getServicesByProtocol(Protocol protocol, EntityPermission entityPermission) {
        return ServiceFactory.getInstance().getEntitiesFromQuery(entityPermission, getServicesByProtocolQueries,
                protocol);
    }

    public List<Service> getServicesByProtocol(Protocol protocol) {
        return getServicesByProtocol(protocol, EntityPermission.READ_ONLY);
    }

    public List<Service> getServicesByProtocolForUpdate(Protocol protocol) {
        return getServicesByProtocol(protocol, EntityPermission.READ_WRITE);
    }

    public ServiceTransfer getServiceTransfer(UserVisit userVisit, Service service) {
        return getCoreTransferCaches(userVisit).getServiceTransferCache().getServiceTransfer(service);
    }

    public List<ServiceTransfer> getServiceTransfers(UserVisit userVisit) {
        var services = getServices();
        List<ServiceTransfer> serviceTransfers = new ArrayList<>(services.size());
        var serviceTransferCache = getCoreTransferCaches(userVisit).getServiceTransferCache();

        services.forEach((service) ->
                serviceTransfers.add(serviceTransferCache.getServiceTransfer(service))
        );

        return serviceTransfers;
    }

    public ServiceChoicesBean getServiceChoices(String defaultServiceChoice, Language language, boolean allowNullChoice) {
        var services = getServices();
        var size = services.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultServiceChoice == null) {
                defaultValue = "";
            }
        }

        for(var service : services) {
            var serviceDetail = service.getLastDetail();

            var label = getBestServiceDescription(service, language);
            var value = serviceDetail.getServiceName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultServiceChoice != null && defaultServiceChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && serviceDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new ServiceChoicesBean(labels, values, defaultValue);
    }

    private void updateServiceFromValue(ServiceDetailValue serviceDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(serviceDetailValue.hasBeenModified()) {
            var service = ServiceFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     serviceDetailValue.getServicePK());
            var serviceDetail = service.getActiveDetailForUpdate();

            serviceDetail.setThruTime(session.START_TIME_LONG);
            serviceDetail.store();

            var servicePK = serviceDetail.getServicePK(); // Not updated
            var serviceName = serviceDetailValue.getServiceName();
            var port = serviceDetailValue.getPort();
            var protocolPK = serviceDetailValue.getProtocolPK();
            var isDefault = serviceDetailValue.getIsDefault();
            var sortOrder = serviceDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultService = getDefaultService();
                var defaultFound = defaultService != null && !defaultService.equals(service);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultServiceDetailValue = getDefaultServiceDetailValueForUpdate();

                    defaultServiceDetailValue.setIsDefault(Boolean.FALSE);
                    updateServiceFromValue(defaultServiceDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            serviceDetail = ServiceDetailFactory.getInstance().create(servicePK, serviceName, port, protocolPK, isDefault, sortOrder, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            service.setActiveDetail(serviceDetail);
            service.setLastDetail(serviceDetail);

            sendEvent(servicePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateServiceFromValue(ServiceDetailValue serviceDetailValue, BasePK updatedBy) {
        updateServiceFromValue(serviceDetailValue, true, updatedBy);
    }

    private void deleteService(Service service, boolean checkDefault, BasePK deletedBy) {
        var serviceDetail = service.getLastDetailForUpdate();

        deleteServerServicesByService(service, deletedBy);
        deleteServiceDescriptionsByService(service, deletedBy);

        serviceDetail.setThruTime(session.START_TIME_LONG);
        service.setActiveDetail(null);
        service.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultService = getDefaultService();

            if(defaultService == null) {
                var services = getServicesForUpdate();

                if(!services.isEmpty()) {
                    var iter = services.iterator();
                    if(iter.hasNext()) {
                        defaultService = iter.next();
                    }
                    var serviceDetailValue = Objects.requireNonNull(defaultService).getLastDetailForUpdate().getServiceDetailValue().clone();

                    serviceDetailValue.setIsDefault(Boolean.TRUE);
                    updateServiceFromValue(serviceDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(service.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteService(Service service, BasePK deletedBy) {
        deleteService(service, true, deletedBy);
    }

    private void deleteServices(List<Service> services, boolean checkDefault, BasePK deletedBy) {
        services.forEach((service) -> deleteService(service, checkDefault, deletedBy));
    }

    public void deleteServices(List<Service> services, BasePK deletedBy) {
        deleteServices(services, true, deletedBy);
    }

    public void deleteServicesByProtocol(Protocol protocol, BasePK deletedBy) {
        deleteServices(getServicesByProtocol(protocol), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Service Descriptions
    // --------------------------------------------------------------------------------

    public ServiceDescription createServiceDescription(Service service, Language language, String description, BasePK createdBy) {
        var serviceDescription = ServiceDescriptionFactory.getInstance().create(service, language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(service.getPrimaryKey(), EventTypes.MODIFY, serviceDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return serviceDescription;
    }

    private static final Map<EntityPermission, String> getServiceDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM servicedescriptions " +
                "WHERE srvd_srv_serviceid = ? AND srvd_lang_languageid = ? AND srvd_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM servicedescriptions " +
                "WHERE srvd_srv_serviceid = ? AND srvd_lang_languageid = ? AND srvd_thrutime = ? " +
                "FOR UPDATE");
        getServiceDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private ServiceDescription getServiceDescription(Service service, Language language, EntityPermission entityPermission) {
        return ServiceDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getServiceDescriptionQueries,
                service, language, Session.MAX_TIME);
    }

    public ServiceDescription getServiceDescription(Service service, Language language) {
        return getServiceDescription(service, language, EntityPermission.READ_ONLY);
    }

    public ServiceDescription getServiceDescriptionForUpdate(Service service, Language language) {
        return getServiceDescription(service, language, EntityPermission.READ_WRITE);
    }

    public ServiceDescriptionValue getServiceDescriptionValue(ServiceDescription serviceDescription) {
        return serviceDescription == null? null: serviceDescription.getServiceDescriptionValue().clone();
    }

    public ServiceDescriptionValue getServiceDescriptionValueForUpdate(Service service, Language language) {
        return getServiceDescriptionValue(getServiceDescriptionForUpdate(service, language));
    }

    private static final Map<EntityPermission, String> getServiceDescriptionsByServiceQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM servicedescriptions, languages " +
                "WHERE srvd_srv_serviceid = ? AND srvd_thrutime = ? AND srvd_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM servicedescriptions " +
                "WHERE srvd_srv_serviceid = ? AND srvd_thrutime = ? " +
                "FOR UPDATE");
        getServiceDescriptionsByServiceQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ServiceDescription> getServiceDescriptionsByService(Service service, EntityPermission entityPermission) {
        return ServiceDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getServiceDescriptionsByServiceQueries,
                service, Session.MAX_TIME);
    }

    public List<ServiceDescription> getServiceDescriptionsByService(Service service) {
        return getServiceDescriptionsByService(service, EntityPermission.READ_ONLY);
    }

    public List<ServiceDescription> getServiceDescriptionsByServiceForUpdate(Service service) {
        return getServiceDescriptionsByService(service, EntityPermission.READ_WRITE);
    }

    public String getBestServiceDescription(Service service, Language language) {
        String description;
        var serviceDescription = getServiceDescription(service, language);

        if(serviceDescription == null && !language.getIsDefault()) {
            serviceDescription = getServiceDescription(service, getPartyControl().getDefaultLanguage());
        }

        if(serviceDescription == null) {
            description = service.getLastDetail().getServiceName();
        } else {
            description = serviceDescription.getDescription();
        }

        return description;
    }

    public ServiceDescriptionTransfer getServiceDescriptionTransfer(UserVisit userVisit, ServiceDescription serviceDescription) {
        return getCoreTransferCaches(userVisit).getServiceDescriptionTransferCache().getServiceDescriptionTransfer(serviceDescription);
    }

    public List<ServiceDescriptionTransfer> getServiceDescriptionTransfersByService(UserVisit userVisit, Service service) {
        var serviceDescriptions = getServiceDescriptionsByService(service);
        List<ServiceDescriptionTransfer> serviceDescriptionTransfers = new ArrayList<>(serviceDescriptions.size());
        var serviceDescriptionTransferCache = getCoreTransferCaches(userVisit).getServiceDescriptionTransferCache();

        serviceDescriptions.forEach((serviceDescription) ->
                serviceDescriptionTransfers.add(serviceDescriptionTransferCache.getServiceDescriptionTransfer(serviceDescription))
        );

        return serviceDescriptionTransfers;
    }

    public void updateServiceDescriptionFromValue(ServiceDescriptionValue serviceDescriptionValue, BasePK updatedBy) {
        if(serviceDescriptionValue.hasBeenModified()) {
            var serviceDescription = ServiceDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    serviceDescriptionValue.getPrimaryKey());

            serviceDescription.setThruTime(session.START_TIME_LONG);
            serviceDescription.store();

            var service = serviceDescription.getService();
            var language = serviceDescription.getLanguage();
            var description = serviceDescriptionValue.getDescription();

            serviceDescription = ServiceDescriptionFactory.getInstance().create(service, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(service.getPrimaryKey(), EventTypes.MODIFY, serviceDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteServiceDescription(ServiceDescription serviceDescription, BasePK deletedBy) {
        serviceDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(serviceDescription.getServicePK(), EventTypes.MODIFY, serviceDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteServiceDescriptionsByService(Service service, BasePK deletedBy) {
        var serviceDescriptions = getServiceDescriptionsByServiceForUpdate(service);

        serviceDescriptions.forEach((serviceDescription) -> 
                deleteServiceDescription(serviceDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Servers
    // --------------------------------------------------------------------------------

    public Server createServer(String serverName, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultServer = getDefaultServer();
        var defaultFound = defaultServer != null;

        if(defaultFound && isDefault) {
            var defaultServerDetailValue = getDefaultServerDetailValueForUpdate();

            defaultServerDetailValue.setIsDefault(Boolean.FALSE);
            updateServerFromValue(defaultServerDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var server = ServerFactory.getInstance().create();
        var serverDetail = ServerDetailFactory.getInstance().create(server, serverName, isDefault, sortOrder, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);

        // Convert to R/W
        server = ServerFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, server.getPrimaryKey());
        server.setActiveDetail(serverDetail);
        server.setLastDetail(serverDetail);
        server.store();

        sendEvent(server.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return server;
    }

    private static final Map<EntityPermission, String> getServerByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM servers, serverdetails " +
                "WHERE serv_activedetailid = servdt_serverdetailid " +
                "AND servdt_servername = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM servers, serverdetails " +
                "WHERE serv_activedetailid = servdt_serverdetailid " +
                "AND servdt_servername = ? " +
                "FOR UPDATE");
        getServerByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private Server getServerByName(String serverName, EntityPermission entityPermission) {
        return ServerFactory.getInstance().getEntityFromQuery(entityPermission, getServerByNameQueries, serverName);
    }

    public Server getServerByName(String serverName) {
        return getServerByName(serverName, EntityPermission.READ_ONLY);
    }

    public Server getServerByNameForUpdate(String serverName) {
        return getServerByName(serverName, EntityPermission.READ_WRITE);
    }

    public ServerDetailValue getServerDetailValueForUpdate(Server server) {
        return server == null? null: server.getLastDetailForUpdate().getServerDetailValue().clone();
    }

    public ServerDetailValue getServerDetailValueByNameForUpdate(String serverName) {
        return getServerDetailValueForUpdate(getServerByNameForUpdate(serverName));
    }

    private static final Map<EntityPermission, String> getDefaultServerQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM servers, serverdetails " +
                "WHERE serv_activedetailid = servdt_serverdetailid " +
                "AND servdt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM servers, serverdetails " +
                "WHERE serv_activedetailid = servdt_serverdetailid " +
                "AND servdt_isdefault = 1 " +
                "FOR UPDATE");
        getDefaultServerQueries = Collections.unmodifiableMap(queryMap);
    }

    private Server getDefaultServer(EntityPermission entityPermission) {
        return ServerFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultServerQueries);
    }

    public Server getDefaultServer() {
        return getDefaultServer(EntityPermission.READ_ONLY);
    }

    public Server getDefaultServerForUpdate() {
        return getDefaultServer(EntityPermission.READ_WRITE);
    }

    public ServerDetailValue getDefaultServerDetailValueForUpdate() {
        return getDefaultServerForUpdate().getLastDetailForUpdate().getServerDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getServersQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM servers, serverdetails " +
                "WHERE serv_activedetailid = servdt_serverdetailid " +
                "ORDER BY servdt_sortorder, servdt_servername " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM servers, serverdetails " +
                "WHERE serv_activedetailid = servdt_serverdetailid " +
                "FOR UPDATE");
        getServersQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Server> getServers(EntityPermission entityPermission) {
        return ServerFactory.getInstance().getEntitiesFromQuery(entityPermission, getServersQueries);
    }

    public List<Server> getServers() {
        return getServers(EntityPermission.READ_ONLY);
    }

    public List<Server> getServersForUpdate() {
        return getServers(EntityPermission.READ_WRITE);
    }

    public ServerTransfer getServerTransfer(UserVisit userVisit, Server server) {
        return getCoreTransferCaches(userVisit).getServerTransferCache().getServerTransfer(server);
    }

    public List<ServerTransfer> getServerTransfers(UserVisit userVisit) {
        var servers = getServers();
        List<ServerTransfer> serverTransfers = new ArrayList<>(servers.size());
        var serverTransferCache = getCoreTransferCaches(userVisit).getServerTransferCache();

        servers.forEach((server) ->
                serverTransfers.add(serverTransferCache.getServerTransfer(server))
        );

        return serverTransfers;
    }

    public ServerChoicesBean getServerChoices(String defaultServerChoice, Language language, boolean allowNullChoice) {
        var servers = getServers();
        var size = servers.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultServerChoice == null) {
                defaultValue = "";
            }
        }

        for(var server : servers) {
            var serverDetail = server.getLastDetail();

            var label = getBestServerDescription(server, language);
            var value = serverDetail.getServerName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultServerChoice != null && defaultServerChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && serverDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new ServerChoicesBean(labels, values, defaultValue);
    }

    private void updateServerFromValue(ServerDetailValue serverDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(serverDetailValue.hasBeenModified()) {
            var server = ServerFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     serverDetailValue.getServerPK());
            var serverDetail = server.getActiveDetailForUpdate();

            serverDetail.setThruTime(session.START_TIME_LONG);
            serverDetail.store();

            var serverPK = serverDetail.getServerPK(); // Not updated
            var serverName = serverDetailValue.getServerName();
            var isDefault = serverDetailValue.getIsDefault();
            var sortOrder = serverDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultServer = getDefaultServer();
                var defaultFound = defaultServer != null && !defaultServer.equals(server);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultServerDetailValue = getDefaultServerDetailValueForUpdate();

                    defaultServerDetailValue.setIsDefault(Boolean.FALSE);
                    updateServerFromValue(defaultServerDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            serverDetail = ServerDetailFactory.getInstance().create(serverPK, serverName, isDefault, sortOrder, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            server.setActiveDetail(serverDetail);
            server.setLastDetail(serverDetail);

            sendEvent(serverPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateServerFromValue(ServerDetailValue serverDetailValue, BasePK updatedBy) {
        updateServerFromValue(serverDetailValue, true, updatedBy);
    }

    private void deleteServer(Server server, boolean checkDefault, BasePK deletedBy) {
        var serverDetail = server.getLastDetailForUpdate();

        deleteServerServicesByServer(server, deletedBy);
        deleteServerDescriptionsByServer(server, deletedBy);

        serverDetail.setThruTime(session.START_TIME_LONG);
        server.setActiveDetail(null);
        server.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultServer = getDefaultServer();

            if(defaultServer == null) {
                var servers = getServersForUpdate();

                if(!servers.isEmpty()) {
                    var iter = servers.iterator();
                    if(iter.hasNext()) {
                        defaultServer = iter.next();
                    }
                    var serverDetailValue = Objects.requireNonNull(defaultServer).getLastDetailForUpdate().getServerDetailValue().clone();

                    serverDetailValue.setIsDefault(Boolean.TRUE);
                    updateServerFromValue(serverDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(server.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteServer(Server server, BasePK deletedBy) {
        deleteServer(server, true, deletedBy);
    }

    private void deleteServers(List<Server> servers, boolean checkDefault, BasePK deletedBy) {
        servers.forEach((server) -> deleteServer(server, checkDefault, deletedBy));
    }

    public void deleteServers(List<Server> servers, BasePK deletedBy) {
        deleteServers(servers, true, deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Server Descriptions
    // --------------------------------------------------------------------------------

    public ServerDescription createServerDescription(Server server, Language language, String description, BasePK createdBy) {
        var serverDescription = ServerDescriptionFactory.getInstance().create(server, language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(server.getPrimaryKey(), EventTypes.MODIFY, serverDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return serverDescription;
    }

    private static final Map<EntityPermission, String> getServerDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM serverdescriptions " +
                "WHERE servd_serv_serverid = ? AND servd_lang_languageid = ? AND servd_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM serverdescriptions " +
                "WHERE servd_serv_serverid = ? AND servd_lang_languageid = ? AND servd_thrutime = ? " +
                "FOR UPDATE");
        getServerDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private ServerDescription getServerDescription(Server server, Language language, EntityPermission entityPermission) {
        return ServerDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getServerDescriptionQueries,
                server, language, Session.MAX_TIME);
    }

    public ServerDescription getServerDescription(Server server, Language language) {
        return getServerDescription(server, language, EntityPermission.READ_ONLY);
    }

    public ServerDescription getServerDescriptionForUpdate(Server server, Language language) {
        return getServerDescription(server, language, EntityPermission.READ_WRITE);
    }

    public ServerDescriptionValue getServerDescriptionValue(ServerDescription serverDescription) {
        return serverDescription == null? null: serverDescription.getServerDescriptionValue().clone();
    }

    public ServerDescriptionValue getServerDescriptionValueForUpdate(Server server, Language language) {
        return getServerDescriptionValue(getServerDescriptionForUpdate(server, language));
    }

    private static final Map<EntityPermission, String> getServerDescriptionsByServerQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM serverdescriptions, languages " +
                "WHERE servd_serv_serverid = ? AND servd_thrutime = ? AND servd_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM serverdescriptions " +
                "WHERE servd_serv_serverid = ? AND servd_thrutime = ? " +
                "FOR UPDATE");
        getServerDescriptionsByServerQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ServerDescription> getServerDescriptionsByServer(Server server, EntityPermission entityPermission) {
        return ServerDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getServerDescriptionsByServerQueries,
                server, Session.MAX_TIME);
    }

    public List<ServerDescription> getServerDescriptionsByServer(Server server) {
        return getServerDescriptionsByServer(server, EntityPermission.READ_ONLY);
    }

    public List<ServerDescription> getServerDescriptionsByServerForUpdate(Server server) {
        return getServerDescriptionsByServer(server, EntityPermission.READ_WRITE);
    }

    public String getBestServerDescription(Server server, Language language) {
        String description;
        var serverDescription = getServerDescription(server, language);

        if(serverDescription == null && !language.getIsDefault()) {
            serverDescription = getServerDescription(server, getPartyControl().getDefaultLanguage());
        }

        if(serverDescription == null) {
            description = server.getLastDetail().getServerName();
        } else {
            description = serverDescription.getDescription();
        }

        return description;
    }

    public ServerDescriptionTransfer getServerDescriptionTransfer(UserVisit userVisit, ServerDescription serverDescription) {
        return getCoreTransferCaches(userVisit).getServerDescriptionTransferCache().getServerDescriptionTransfer(serverDescription);
    }

    public List<ServerDescriptionTransfer> getServerDescriptionTransfersByServer(UserVisit userVisit, Server server) {
        var serverDescriptions = getServerDescriptionsByServer(server);
        List<ServerDescriptionTransfer> serverDescriptionTransfers = new ArrayList<>(serverDescriptions.size());
        var serverDescriptionTransferCache = getCoreTransferCaches(userVisit).getServerDescriptionTransferCache();

        serverDescriptions.forEach((serverDescription) ->
                serverDescriptionTransfers.add(serverDescriptionTransferCache.getServerDescriptionTransfer(serverDescription))
        );

        return serverDescriptionTransfers;
    }

    public void updateServerDescriptionFromValue(ServerDescriptionValue serverDescriptionValue, BasePK updatedBy) {
        if(serverDescriptionValue.hasBeenModified()) {
            var serverDescription = ServerDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    serverDescriptionValue.getPrimaryKey());

            serverDescription.setThruTime(session.START_TIME_LONG);
            serverDescription.store();

            var server = serverDescription.getServer();
            var language = serverDescription.getLanguage();
            var description = serverDescriptionValue.getDescription();

            serverDescription = ServerDescriptionFactory.getInstance().create(server, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(server.getPrimaryKey(), EventTypes.MODIFY, serverDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteServerDescription(ServerDescription serverDescription, BasePK deletedBy) {
        serverDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(serverDescription.getServerPK(), EventTypes.MODIFY, serverDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteServerDescriptionsByServer(Server server, BasePK deletedBy) {
        var serverDescriptions = getServerDescriptionsByServerForUpdate(server);

        serverDescriptions.forEach((serverDescription) -> 
                deleteServerDescription(serverDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Server Services
    // --------------------------------------------------------------------------------

    public ServerService createServerService(Server server, Service service, BasePK createdBy) {
        var serverService = ServerServiceFactory.getInstance().create(server, service, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(server.getPrimaryKey(), EventTypes.MODIFY, serverService.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return serverService;
    }

    private static final Map<EntityPermission, String> getServerServiceQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM serverservices " +
                "WHERE servsrv_serv_serverid = ? AND servsrv_srv_serviceid = ? AND servsrv_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM serverservices " +
                "WHERE servsrv_serv_serverid = ? AND servsrv_srv_serviceid = ? AND servsrv_thrutime = ? " +
                "FOR UPDATE");
        getServerServiceQueries = Collections.unmodifiableMap(queryMap);
    }

    private ServerService getServerService(Server server, Service service, EntityPermission entityPermission) {
        return ServerServiceFactory.getInstance().getEntityFromQuery(entityPermission, getServerServiceQueries,
                server, service, Session.MAX_TIME);
    }

    public ServerService getServerService(Server server, Service service) {
        return getServerService(server, service, EntityPermission.READ_ONLY);
    }

    public ServerService getServerServiceForUpdate(Server server, Service service) {
        return getServerService(server, service, EntityPermission.READ_WRITE);
    }

    public ServerServiceValue getServerServiceValue(ServerService serverService) {
        return serverService == null? null: serverService.getServerServiceValue().clone();
    }

    public ServerServiceValue getServerServiceValueForUpdate(Server server, Service service) {
        return getServerServiceValue(getServerServiceForUpdate(server, service));
    }

    private static final Map<EntityPermission, String> getServerServicesByServerQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM serverservices, services, servicedetails " +
                "WHERE servsrv_serv_serverid = ? AND servsrv_thrutime = ? " +
                "AND servsrv_srv_serviceid = srv_serviceid AND srv_lastdetailid = srvdt_servicedetailid " +
                "ORDER BY srvdt_sortorder, srvdt_servicename");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM serverservices " +
                "WHERE servsrv_serv_serverid = ? AND servsrv_thrutime = ? " +
                "FOR UPDATE");
        getServerServicesByServerQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ServerService> getServerServicesByServer(Server server, EntityPermission entityPermission) {
        return ServerServiceFactory.getInstance().getEntitiesFromQuery(entityPermission, getServerServicesByServerQueries,
                server, Session.MAX_TIME);
    }

    public List<ServerService> getServerServicesByServer(Server server) {
        return getServerServicesByServer(server, EntityPermission.READ_ONLY);
    }

    public List<ServerService> getServerServicesByServerForUpdate(Server server) {
        return getServerServicesByServer(server, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getServerServicesByServiceQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM serverservices, services, servicedetails " +
                "WHERE servsrv_srv_serviceid = ? AND servsrv_thrutime = ? " +
                "AND servsrv_serv_serverid = serv_serverid AND serv_lastdetailid = servdt_serverdetailid " +
                "ORDER BY servdt_sortorder, servdt_servername");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM serverservices " +
                "WHERE servsrv_srv_serviceid = ? AND servsrv_thrutime = ? " +
                "FOR UPDATE");
        getServerServicesByServiceQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ServerService> getServerServicesByService(Service service, EntityPermission entityPermission) {
        return ServerServiceFactory.getInstance().getEntitiesFromQuery(entityPermission, getServerServicesByServiceQueries,
                service, Session.MAX_TIME);
    }

    public List<ServerService> getServerServicesByService(Service service) {
        return getServerServicesByService(service, EntityPermission.READ_ONLY);
    }

    public List<ServerService> getServerServicesByServiceForUpdate(Service service) {
        return getServerServicesByService(service, EntityPermission.READ_WRITE);
    }

    public ServerServiceTransfer getServerServiceTransfer(UserVisit userVisit, ServerService serverService) {
        return getCoreTransferCaches(userVisit).getServerServiceTransferCache().getServerServiceTransfer(serverService);
    }

    public List<ServerServiceTransfer> getServerServiceTransfersByServer(UserVisit userVisit, Server server) {
        var serverServices = getServerServicesByServer(server);
        List<ServerServiceTransfer> serverServiceTransfers = new ArrayList<>(serverServices.size());
        var serverServiceTransferCache = getCoreTransferCaches(userVisit).getServerServiceTransferCache();

        serverServices.forEach((serverService) ->
                serverServiceTransfers.add(serverServiceTransferCache.getServerServiceTransfer(serverService))
        );

        return serverServiceTransfers;
    }

    public void deleteServerService(ServerService serverService, BasePK deletedBy) {
        var scaleControl = Session.getModelController(ScaleControl.class);
        
        scaleControl.deleteScalesByServerService(serverService, deletedBy);

        serverService.setThruTime(session.START_TIME_LONG);

        sendEvent(serverService.getServerPK(), EventTypes.MODIFY, serverService.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteServerServices(List<ServerService> serverServices, BasePK deletedBy) {
        serverServices.forEach((serverService) -> 
                deleteServerService(serverService, deletedBy)
        );
    }

    public void deleteServerServicesByServer(Server server, BasePK deletedBy) {
        deleteServerServices(getServerServicesByServerForUpdate(server), deletedBy);
    }

    public void deleteServerServicesByService(Service service, BasePK deletedBy) {
        deleteServerServices(getServerServicesByServiceForUpdate(service), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Entity Boolean Defaults
    // --------------------------------------------------------------------------------

    public EntityBooleanDefault createEntityBooleanDefault(EntityAttribute entityAttribute, Boolean booleanAttribute,
            BasePK createdBy) {
        var entityBooleanDefault = EntityBooleanDefaultFactory.getInstance().create(entityAttribute,
                booleanAttribute, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityBooleanDefault.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return entityBooleanDefault;
    }

    public long countEntityBooleanDefaultHistory(EntityAttribute entityAttribute) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitybooleandefaults
                    WHERE enbldef_ena_entityattributeid = ?
                    """, entityAttribute);
    }

    private static final Map<EntityPermission, String> getEntityBooleanDefaultHistoryQueries;

    static {
        getEntityBooleanDefaultHistoryQueries = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitybooleandefaults
                WHERE enbldef_ena_entityattributeid = ?
                ORDER BY enbldef_thrutime
                _LIMIT_
                """);
    }

    public List<EntityBooleanDefault> getEntityBooleanDefaultHistory(EntityAttribute entityAttribute) {
        return EntityBooleanDefaultFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityBooleanDefaultHistoryQueries,
                entityAttribute);
    }

    private EntityBooleanDefault getEntityBooleanDefault(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        EntityBooleanDefault entityBooleanDefault;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitybooleandefaults " +
                        "WHERE enbldef_ena_entityattributeid = ? AND enbldef_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitybooleandefaults " +
                        "WHERE enbldef_ena_entityattributeid = ? AND enbldef_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityBooleanDefaultFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);

            entityBooleanDefault = EntityBooleanDefaultFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityBooleanDefault;
    }

    public EntityBooleanDefault getEntityBooleanDefault(EntityAttribute entityAttribute) {
        return getEntityBooleanDefault(entityAttribute, EntityPermission.READ_ONLY);
    }

    public EntityBooleanDefault getEntityBooleanDefaultForUpdate(EntityAttribute entityAttribute) {
        return getEntityBooleanDefault(entityAttribute, EntityPermission.READ_WRITE);
    }

    public EntityBooleanDefaultValue getEntityBooleanDefaultValueForUpdate(EntityBooleanDefault entityBooleanDefault) {
        return entityBooleanDefault == null? null: entityBooleanDefault.getEntityBooleanDefaultValue().clone();
    }

    public EntityBooleanDefaultValue getEntityBooleanDefaultValueForUpdate(EntityAttribute entityAttribute) {
        return getEntityBooleanDefaultValueForUpdate(getEntityBooleanDefaultForUpdate(entityAttribute));
    }

    public EntityBooleanDefaultTransfer getEntityBooleanDefaultTransfer(UserVisit userVisit, EntityBooleanDefault entityBooleanDefault) {
        return getCoreTransferCaches(userVisit).getEntityBooleanDefaultTransferCache().getEntityBooleanDefaultTransfer(entityBooleanDefault);
    }

    public void updateEntityBooleanDefaultFromValue(EntityBooleanDefaultValue entityBooleanDefaultValue, BasePK updatedBy) {
        if(entityBooleanDefaultValue.hasBeenModified()) {
            var entityBooleanDefault = EntityBooleanDefaultFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityBooleanDefaultValue);
            var entityAttribute = entityBooleanDefault.getEntityAttribute();

            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityBooleanDefault.setThruTime(session.START_TIME_LONG);
                entityBooleanDefault.store();
            } else {
                entityBooleanDefault.remove();
            }

            entityBooleanDefault = EntityBooleanDefaultFactory.getInstance().create(entityAttribute,
                    entityBooleanDefaultValue.getBooleanAttribute(), session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityBooleanDefault.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteEntityBooleanDefault(EntityBooleanDefault entityBooleanDefault, BasePK deletedBy) {
        var entityAttribute = entityBooleanDefault.getEntityAttribute();

        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityBooleanDefault.setThruTime(session.START_TIME_LONG);
        } else {
            entityBooleanDefault.remove();
        }

        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityBooleanDefault.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deleteEntityBooleanDefaultByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityBooleanDefault = getEntityBooleanDefaultForUpdate(entityAttribute);

        if(entityBooleanDefault != null) {
            deleteEntityBooleanDefault(entityBooleanDefault, deletedBy);
        }
    }

    // --------------------------------------------------------------------------------
    //   Entity Boolean Attributes
    // --------------------------------------------------------------------------------

    public EntityBooleanAttribute createEntityBooleanAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Boolean booleanAttribute, BasePK createdBy) {
        return createEntityBooleanAttribute(entityAttribute.getPrimaryKey(), entityInstance, booleanAttribute,
                createdBy);
    }

    public EntityBooleanAttribute createEntityBooleanAttribute(EntityAttributePK entityAttribute, EntityInstance entityInstance,
            Boolean booleanAttribute, BasePK createdBy) {
        var entityBooleanAttribute = EntityBooleanAttributeFactory.getInstance().create(entityAttribute,
                entityInstance.getPrimaryKey(), booleanAttribute, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute, EventTypes.CREATE, createdBy);

        return entityBooleanAttribute;
    }

    public long countEntityBooleanAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitybooleanattributes
                    WHERE enbla_ena_entityattributeid = ? AND enbla_eni_entityinstanceid = ?
                    """, entityAttribute, entityInstance);
    }

    private static final Map<EntityPermission, String> getEntityBooleanAttributeHistoryQueries;

    static {
        var queryMap = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitybooleanattributes
                WHERE enbla_ena_entityattributeid = ? AND enbla_eni_entityinstanceid = ?
                ORDER BY enbla_thrutime
                _LIMIT_
                """);
        getEntityBooleanAttributeHistoryQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<EntityBooleanAttribute> getEntityBooleanAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return EntityBooleanAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityBooleanAttributeHistoryQueries,
                entityAttribute, entityInstance);
    }
    
    private EntityBooleanAttribute getEntityBooleanAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityPermission entityPermission) {
        EntityBooleanAttribute entityBooleanAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitybooleanattributes " +
                        "WHERE enbla_ena_entityattributeid = ? AND enbla_eni_entityinstanceid = ? AND enbla_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitybooleanattributes " +
                        "WHERE enbla_ena_entityattributeid = ? AND enbla_eni_entityinstanceid = ? AND enbla_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityBooleanAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityBooleanAttribute = EntityBooleanAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityBooleanAttribute;
    }
    
    public EntityBooleanAttribute getEntityBooleanAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityBooleanAttribute(entityAttribute, entityInstance, EntityPermission.READ_ONLY);
    }
    
    public EntityBooleanAttribute getEntityBooleanAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityBooleanAttribute(entityAttribute, entityInstance, EntityPermission.READ_WRITE);
    }
    
    public EntityBooleanAttributeValue getEntityBooleanAttributeValueForUpdate(EntityBooleanAttribute entityBooleanAttribute) {
        return entityBooleanAttribute == null? null: entityBooleanAttribute.getEntityBooleanAttributeValue().clone();
    }
    
    public EntityBooleanAttributeValue getEntityBooleanAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityBooleanAttributeValueForUpdate(getEntityBooleanAttributeForUpdate(entityAttribute, entityInstance));
    }
    
    public List<EntityBooleanAttribute> getEntityBooleanAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityBooleanAttribute> entityBooleanAttributes;
        
        try {
            var ps = EntityBooleanAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitybooleanattributes " +
                    "WHERE enbla_ena_entityattributeid = ? AND enbla_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityBooleanAttributes = EntityBooleanAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityBooleanAttributes;
    }
    
    public List<EntityBooleanAttribute> getEntityBooleanAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityBooleanAttribute> entityBooleanAttributes;
        
        try {
            var ps = EntityBooleanAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitybooleanattributes " +
                    "WHERE enbla_eni_entityinstanceid = ? AND enbla_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityBooleanAttributes = EntityBooleanAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityBooleanAttributes;
    }
    
    public EntityBooleanAttributeTransfer getEntityBooleanAttributeTransfer(UserVisit userVisit, EntityBooleanAttribute entityBooleanAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityBooleanAttributeTransferCache().getEntityBooleanAttributeTransfer(entityBooleanAttribute, entityInstance);
    }
    
    public void updateEntityBooleanAttributeFromValue(EntityBooleanAttributeValue entityBooleanAttributeValue, BasePK updatedBy) {
        if(entityBooleanAttributeValue.hasBeenModified()) {
            var entityBooleanAttribute = EntityBooleanAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityBooleanAttributeValue);
            var entityAttribute = entityBooleanAttribute.getEntityAttribute();
            var entityInstance = entityBooleanAttribute.getEntityInstance();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityBooleanAttribute.setThruTime(session.START_TIME_LONG);
                entityBooleanAttribute.store();
            } else {
                entityBooleanAttribute.remove();
            }
            
            EntityBooleanAttributeFactory.getInstance().create(entityAttribute, entityInstance, entityBooleanAttributeValue.getBooleanAttribute(), session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityBooleanAttribute(EntityBooleanAttribute entityBooleanAttribute, BasePK deletedBy) {
        var entityAttribute = entityBooleanAttribute.getEntityAttribute();
        var entityInstance = entityBooleanAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityBooleanAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityBooleanAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityBooleanAttributes(List<EntityBooleanAttribute> entityBooleanAttributes, BasePK deletedBy) {
        entityBooleanAttributes.forEach((entityBooleanAttribute) -> 
                deleteEntityBooleanAttribute(entityBooleanAttribute, deletedBy)
        );
    }
    
    public void deleteEntityBooleanAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityBooleanAttributes(getEntityBooleanAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityBooleanAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityBooleanAttributes(getEntityBooleanAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Date Attributes
    // --------------------------------------------------------------------------------
    
    public EntityDateAttribute createEntityDateAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance, Integer dateAttribute, BasePK createdBy) {
        var entityDateAttribute = EntityDateAttributeFactory.getInstance().create(entityAttribute, entityInstance, dateAttribute, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityDateAttribute;
    }

    public long countEntityDateAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitydateattributes
                    WHERE enda_ena_entityattributeid = ? AND enda_eni_entityinstanceid = ?
                    """, entityAttribute, entityInstance);
    }

    private static final Map<EntityPermission, String> getEntityDateAttributeHistoryQueries;

    static {
        var queryMap = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitydateattributes
                WHERE enda_ena_entityattributeid = ? AND enda_eni_entityinstanceid = ?
                ORDER BY enda_thrutime
                _LIMIT_
                """);
        getEntityDateAttributeHistoryQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<EntityDateAttribute> getEntityDateAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return EntityDateAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityDateAttributeHistoryQueries,
                entityAttribute, entityInstance);
    }

    private EntityDateAttribute getEntityDateAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance, EntityPermission entityPermission) {
        EntityDateAttribute entityDateAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitydateattributes " +
                        "WHERE enda_ena_entityattributeid = ? AND enda_eni_entityinstanceid = ? AND enda_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitydateattributes " +
                        "WHERE enda_ena_entityattributeid = ? AND enda_eni_entityinstanceid = ? AND enda_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityDateAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityDateAttribute = EntityDateAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityDateAttribute;
    }
    
    public EntityDateAttribute getEntityDateAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityDateAttribute(entityAttribute, entityInstance, EntityPermission.READ_ONLY);
    }
    
    public EntityDateAttribute getEntityDateAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityDateAttribute(entityAttribute, entityInstance, EntityPermission.READ_WRITE);
    }
    
    public EntityDateAttributeValue getEntityDateAttributeValueForUpdate(EntityDateAttribute entityDateAttribute) {
        return entityDateAttribute == null? null: entityDateAttribute.getEntityDateAttributeValue().clone();
    }
    
    public EntityDateAttributeValue getEntityDateAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityDateAttributeValueForUpdate(getEntityDateAttributeForUpdate(entityAttribute, entityInstance));
    }
    
    public List<EntityDateAttribute> getEntityDateAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityDateAttribute> entityDateAttributes;
        
        try {
            var ps = EntityDateAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitydateattributes " +
                    "WHERE enda_ena_entityattributeid = ? AND enda_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityDateAttributes = EntityDateAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityDateAttributes;
    }
    
    public List<EntityDateAttribute> getEntityDateAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityDateAttribute> entityDateAttributes;
        
        try {
            var ps = EntityDateAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitydateattributes " +
                    "WHERE enda_eni_entityinstanceid = ? AND enda_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityDateAttributes = EntityDateAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityDateAttributes;
    }
    
    public EntityDateAttributeTransfer getEntityDateAttributeTransfer(UserVisit userVisit, EntityDateAttribute entityDateAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityDateAttributeTransferCache().getEntityDateAttributeTransfer(entityDateAttribute, entityInstance);
    }
    
    public void updateEntityDateAttributeFromValue(EntityDateAttributeValue entityDateAttributeValue, BasePK updatedBy) {
        if(entityDateAttributeValue.hasBeenModified()) {
            var entityDateAttribute = EntityDateAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityDateAttributeValue);
            var entityAttribute = entityDateAttribute.getEntityAttribute();
            var entityInstance = entityDateAttribute.getEntityInstance();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityDateAttribute.setThruTime(session.START_TIME_LONG);
                entityDateAttribute.store();
            } else {
                entityDateAttribute.remove();
            }
            
            EntityDateAttributeFactory.getInstance().create(entityAttribute, entityInstance, entityDateAttributeValue.getDateAttribute(), session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityDateAttribute(EntityDateAttribute entityDateAttribute, BasePK deletedBy) {
        var entityAttribute = entityDateAttribute.getEntityAttribute();
        var entityInstance = entityDateAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityDateAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityDateAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityDateAttributes(List<EntityDateAttribute> entityDateAttributes, BasePK deletedBy) {
        entityDateAttributes.forEach((entityDateAttribute) -> 
                deleteEntityDateAttribute(entityDateAttribute, deletedBy)
        );
    }
    
    public void deleteEntityDateAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityDateAttributes(getEntityDateAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityDateAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityDateAttributes(getEntityDateAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Entity Integer Defaults
    // --------------------------------------------------------------------------------

    public EntityIntegerDefault createEntityIntegerDefault(EntityAttribute entityAttribute, Integer integerAttribute,
            BasePK createdBy) {
        var entityIntegerDefault = EntityIntegerDefaultFactory.getInstance().create(entityAttribute,
                integerAttribute, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityIntegerDefault.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return entityIntegerDefault;
    }

    public long countEntityIntegerDefaultHistory(EntityAttribute entityAttribute) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entityintegerdefaults
                    WHERE enidef_thrutime = ?
                    """, entityAttribute);
    }

    private static final Map<EntityPermission, String> getEntityIntegerDefaultHistoryQueries;

    static {
        getEntityIntegerDefaultHistoryQueries = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entityintegerdefaults
                WHERE enidef_ena_entityattributeid = ?
                ORDER BY enidef_thrutime
                _LIMIT_
                """);
    }

    public List<EntityIntegerDefault> getEntityIntegerDefaultHistory(EntityAttribute entityAttribute) {
        return EntityIntegerDefaultFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityIntegerDefaultHistoryQueries,
                entityAttribute);
    }

    private EntityIntegerDefault getEntityIntegerDefault(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        EntityIntegerDefault entityIntegerDefault;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerdefaults " +
                        "WHERE enidef_ena_entityattributeid = ? AND enidef_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerdefaults " +
                        "WHERE enidef_ena_entityattributeid = ? AND enidef_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityIntegerDefaultFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);

            entityIntegerDefault = EntityIntegerDefaultFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityIntegerDefault;
    }

    public EntityIntegerDefault getEntityIntegerDefault(EntityAttribute entityAttribute) {
        return getEntityIntegerDefault(entityAttribute, EntityPermission.READ_ONLY);
    }

    public EntityIntegerDefault getEntityIntegerDefaultForUpdate(EntityAttribute entityAttribute) {
        return getEntityIntegerDefault(entityAttribute, EntityPermission.READ_WRITE);
    }

    public EntityIntegerDefaultValue getEntityIntegerDefaultValueForUpdate(EntityIntegerDefault entityIntegerDefault) {
        return entityIntegerDefault == null? null: entityIntegerDefault.getEntityIntegerDefaultValue().clone();
    }

    public EntityIntegerDefaultValue getEntityIntegerDefaultValueForUpdate(EntityAttribute entityAttribute) {
        return getEntityIntegerDefaultValueForUpdate(getEntityIntegerDefaultForUpdate(entityAttribute));
    }

    public EntityIntegerDefaultTransfer getEntityIntegerDefaultTransfer(UserVisit userVisit, EntityIntegerDefault entityIntegerDefault) {
        return getCoreTransferCaches(userVisit).getEntityIntegerDefaultTransferCache().getEntityIntegerDefaultTransfer(entityIntegerDefault);
    }

    public void updateEntityIntegerDefaultFromValue(EntityIntegerDefaultValue entityIntegerDefaultValue, BasePK updatedBy) {
        if(entityIntegerDefaultValue.hasBeenModified()) {
            var entityIntegerDefault = EntityIntegerDefaultFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityIntegerDefaultValue);
            var entityAttribute = entityIntegerDefault.getEntityAttribute();

            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityIntegerDefault.setThruTime(session.START_TIME_LONG);
                entityIntegerDefault.store();
            } else {
                entityIntegerDefault.remove();
            }

            entityIntegerDefault = EntityIntegerDefaultFactory.getInstance().create(entityAttribute,
                    entityIntegerDefaultValue.getIntegerAttribute(), session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityIntegerDefault.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteEntityIntegerDefault(EntityIntegerDefault entityIntegerDefault, BasePK deletedBy) {
        var entityAttribute = entityIntegerDefault.getEntityAttribute();

        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityIntegerDefault.setThruTime(session.START_TIME_LONG);
        } else {
            entityIntegerDefault.remove();
        }

        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityIntegerDefault.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deleteEntityIntegerDefaultByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityIntegerDefault = getEntityIntegerDefaultForUpdate(entityAttribute);

        if(entityIntegerDefault != null) {
            deleteEntityIntegerDefault(entityIntegerDefault, deletedBy);
        }
    }

    // --------------------------------------------------------------------------------
    //   Entity Integer Attributes
    // --------------------------------------------------------------------------------

    public EntityIntegerAttribute createEntityIntegerAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Integer integerAttribute, BasePK createdBy) {
        return createEntityIntegerAttribute(entityAttribute.getPrimaryKey(), entityInstance, integerAttribute,
                createdBy);
    }

    public EntityIntegerAttribute createEntityIntegerAttribute(EntityAttributePK entityAttribute, EntityInstance entityInstance,
            Integer integerAttribute, BasePK createdBy) {
        var entityIntegerAttribute = EntityIntegerAttributeFactory.getInstance().create(entityAttribute,
                entityInstance.getPrimaryKey(), integerAttribute, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute, EventTypes.CREATE, createdBy);

        return entityIntegerAttribute;
    }
    
    public long countEntityIntegerAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entityintegerattributes
                    WHERE enia_ena_entityattributeid = ? AND enia_eni_entityinstanceid = ?
                    """, entityAttribute, entityInstance);
    }

    private static final Map<EntityPermission, String> getEntityIntegerAttributeHistoryQueries;

    static {
        var queryMap = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entityintegerattributes
                WHERE enia_ena_entityattributeid = ? AND enia_eni_entityinstanceid = ?
                ORDER BY enia_thrutime
                _LIMIT_
                """);
        getEntityIntegerAttributeHistoryQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<EntityIntegerAttribute> getEntityIntegerAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return EntityIntegerAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityIntegerAttributeHistoryQueries,
                entityAttribute, entityInstance);
    }

    private EntityIntegerAttribute getEntityIntegerAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityPermission entityPermission) {
        EntityIntegerAttribute entityIntegerAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerattributes " +
                        "WHERE enia_ena_entityattributeid = ? AND enia_eni_entityinstanceid = ? AND enia_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityintegerattributes " +
                        "WHERE enia_ena_entityattributeid = ? AND enia_eni_entityinstanceid = ? AND enia_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityIntegerAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityIntegerAttribute = EntityIntegerAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityIntegerAttribute;
    }
    
    public EntityIntegerAttribute getEntityIntegerAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityIntegerAttribute(entityAttribute, entityInstance, EntityPermission.READ_ONLY);
    }
    
    public EntityIntegerAttribute getEntityIntegerAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityIntegerAttribute(entityAttribute, entityInstance, EntityPermission.READ_WRITE);
    }
    
    public EntityIntegerAttributeValue getEntityIntegerAttributeValueForUpdate(EntityIntegerAttribute entityIntegerAttribute) {
        return entityIntegerAttribute == null? null: entityIntegerAttribute.getEntityIntegerAttributeValue().clone();
    }
    
    public EntityIntegerAttributeValue getEntityIntegerAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityIntegerAttributeValueForUpdate(getEntityIntegerAttributeForUpdate(entityAttribute, entityInstance));
    }
    
    public List<EntityIntegerAttribute> getEntityIntegerAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityIntegerAttribute> entityIntegerAttributes;
        
        try {
            var ps = EntityIntegerAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityintegerattributes " +
                    "WHERE enia_ena_entityattributeid = ? AND enia_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityIntegerAttributes = EntityIntegerAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityIntegerAttributes;
    }
    
    public List<EntityIntegerAttribute> getEntityIntegerAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityIntegerAttribute> entityIntegerAttributes;
        
        try {
            var ps = EntityIntegerAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityintegerattributes " +
                    "WHERE enia_eni_entityinstanceid = ? AND enia_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityIntegerAttributes = EntityIntegerAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityIntegerAttributes;
    }
    
    public EntityIntegerAttributeTransfer getEntityIntegerAttributeTransfer(UserVisit userVisit, EntityIntegerAttribute entityIntegerAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityIntegerAttributeTransferCache().getEntityIntegerAttributeTransfer(entityIntegerAttribute, entityInstance);
    }
    
    public void updateEntityIntegerAttributeFromValue(EntityIntegerAttributeValue entityIntegerAttributeValue, BasePK updatedBy) {
        if(entityIntegerAttributeValue.hasBeenModified()) {
            var entityIntegerAttribute = EntityIntegerAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityIntegerAttributeValue);
            var entityAttribute = entityIntegerAttribute.getEntityAttribute();
            var entityInstance = entityIntegerAttribute.getEntityInstance();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityIntegerAttribute.setThruTime(session.START_TIME_LONG);
                entityIntegerAttribute.store();
            } else {
                entityIntegerAttribute.remove();
            }
            
            EntityIntegerAttributeFactory.getInstance().create(entityAttribute, entityInstance, entityIntegerAttributeValue.getIntegerAttribute(), session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    public void deleteEntityIntegerAttribute(EntityIntegerAttribute entityIntegerAttribute, BasePK deletedBy) {
        var entityAttribute = entityIntegerAttribute.getEntityAttribute();
        var entityInstance = entityIntegerAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityIntegerAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityIntegerAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityIntegerAttributes(List<EntityIntegerAttribute> entityIntegerAttributes, BasePK deletedBy) {
        entityIntegerAttributes.forEach((entityIntegerAttribute) -> 
                deleteEntityIntegerAttribute(entityIntegerAttribute, deletedBy)
        );
    }
    
    public void deleteEntityIntegerAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityIntegerAttributes(getEntityIntegerAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityIntegerAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityIntegerAttributes(getEntityIntegerAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Entity List Item Defaults
    // --------------------------------------------------------------------------------

    public EntityListItemDefault createEntityListItemDefault(EntityAttribute entityAttribute,
            EntityListItem entityListItem, BasePK createdBy) {
        var entityListItemDefault = EntityListItemDefaultFactory.getInstance().create(session,
                entityAttribute, entityListItem, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityListItemDefault.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return entityListItemDefault;
    }

    public long countEntityListItemDefaultHistory(EntityAttribute entityAttribute) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitylistitemdefaults
                    WHERE eladef_ena_entityattributeid = ?
                    """, entityAttribute);
    }

    private static final Map<EntityPermission, String> getEntityListItemDefaultHistoryQueries;

    static {
        getEntityListItemDefaultHistoryQueries = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitylistitemdefaults
                WHERE eladef_ena_entityattributeid = ?
                ORDER BY eladef_thrutime
                _LIMIT_
                """);
    }

    public List<EntityListItemDefault> getEntityListItemDefaultHistory(EntityAttribute entityAttribute) {
        return EntityListItemDefaultFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityListItemDefaultHistoryQueries,
                entityAttribute);
    }

    private EntityListItemDefault getEntityListItemDefault(EntityAttribute entityAttribute,
            EntityPermission entityPermission) {
        EntityListItemDefault entityListItemDefault;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitemdefaults " +
                        "WHERE eladef_ena_entityattributeid = ? AND eladef_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitemdefaults " +
                        "WHERE eladef_ena_entityattributeid = ? AND eladef_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityListItemDefaultFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);

            entityListItemDefault = EntityListItemDefaultFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityListItemDefault;
    }

    public EntityListItemDefault getEntityListItemDefault(EntityAttribute entityAttribute) {
        return getEntityListItemDefault(entityAttribute, EntityPermission.READ_ONLY);
    }

    public EntityListItemDefault getEntityListItemDefaultForUpdate(EntityAttribute entityAttribute) {
        return getEntityListItemDefault(entityAttribute, EntityPermission.READ_WRITE);
    }

    public EntityListItemDefaultValue getEntityListItemDefaultValueForUpdate(EntityListItemDefault entityListItemDefault) {
        return entityListItemDefault == null? null: entityListItemDefault.getEntityListItemDefaultValue().clone();
    }

    public EntityListItemDefaultValue getEntityListItemDefaultValueForUpdate(EntityAttribute entityAttribute) {
        return getEntityListItemDefaultValueForUpdate(getEntityListItemDefaultForUpdate(entityAttribute));
    }

    private EntityListItemDefault getEntityListItemDefaultByEntityListItem(EntityListItem entityListItem, EntityPermission entityPermission) {
        EntityListItemDefault entityListItemDefault;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ "
                        + "FROM entitylistitemdefaults "
                        + "WHERE eladef_eli_entitylistitemid = ? AND eladef_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ "
                        + "FROM entitylistitemdefaults "
                        + "WHERE eladef_eli_entitylistitemid = ? AND eladef_thrutime = ? "
                        + "FOR UPDATE";
            }

            var ps = EntityListItemDefaultFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityListItem.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);

            entityListItemDefault = EntityListItemDefaultFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityListItemDefault;
    }

    public EntityListItemDefault getEntityListItemDefaultByEntityListItem(EntityListItem entityListItem) {
        return getEntityListItemDefaultByEntityListItem(entityListItem, EntityPermission.READ_ONLY);
    }

    public EntityListItemDefault getEntityListItemDefaultByEntityListItemForUpdate(EntityListItem entityListItem) {
        return getEntityListItemDefaultByEntityListItem(entityListItem, EntityPermission.READ_WRITE);
    }

    public EntityListItemDefaultTransfer getEntityListItemDefaultTransfer(UserVisit userVisit, EntityListItemDefault entityListItemDefault) {
        return getCoreTransferCaches(userVisit).getEntityListItemDefaultTransferCache().getEntityListItemDefaultTransfer(entityListItemDefault);
    }

    public void updateEntityListItemDefaultFromValue(EntityListItemDefaultValue entityListItemDefaultValue, BasePK updatedBy) {
        if(entityListItemDefaultValue.hasBeenModified()) {
            var entityListItemDefault = EntityListItemDefaultFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityListItemDefaultValue);
            var entityAttribute = entityListItemDefault.getEntityAttribute();

            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityListItemDefault.setThruTime(session.START_TIME_LONG);
                entityListItemDefault.store();
            } else {
                entityListItemDefault.remove();
            }

            entityListItemDefault = EntityListItemDefaultFactory.getInstance().create(entityAttribute.getPrimaryKey(),
                    entityListItemDefaultValue.getEntityListItemPK(), session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityListItemDefault.getPrimaryKey(), EventTypes.DELETE, updatedBy);
        }
    }

    public void deleteEntityListItemDefault(EntityListItemDefault entityListItemDefault, BasePK deletedBy) {
        var entityAttribute = entityListItemDefault.getEntityAttribute();

        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityListItemDefault.setThruTime(session.START_TIME_LONG);
        } else {
            entityListItemDefault.remove();
        }

        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityListItemDefault.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deleteEntityListItemDefaultByEntityListItem(EntityListItem entityListItem, BasePK deletedBy) {
        var deleteEntityListItemDefault = getEntityListItemDefaultByEntityListItemForUpdate(entityListItem);

        if(deleteEntityListItemDefault != null) {
            deleteEntityListItemDefault(deleteEntityListItemDefault, deletedBy);
        }
    }

    // --------------------------------------------------------------------------------
    //   Entity List Item Attributes
    // --------------------------------------------------------------------------------
    
    public EntityListItemAttribute createEntityListItemAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityListItem entityListItem, BasePK createdBy) {
        var entityListItemAttribute = EntityListItemAttributeFactory.getInstance().create(session,
                entityAttribute, entityInstance, entityListItem, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityListItemAttribute;
    }

    public long countEntityListItemAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitylistitemattributes
                    WHERE ela_ena_entityattributeid = ? AND ela_eni_entityinstanceid = ?
                    """, entityAttribute, entityInstance);
    }

    private static final Map<EntityPermission, String> getEntityListItemAttributeHistoryQueries;

    static {
        var queryMap = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitylistitemattributes
                WHERE ela_ena_entityattributeid = ? AND ela_eni_entityinstanceid = ?
                ORDER BY ela_thrutime
                _LIMIT_
                """);
        getEntityListItemAttributeHistoryQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<EntityListItemAttribute> getEntityListItemAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return EntityListItemAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityListItemAttributeHistoryQueries,
                entityAttribute, entityInstance);
    }

    private EntityListItemAttribute getEntityListItemAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityPermission entityPermission) {
        EntityListItemAttribute entityListItemAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitemattributes " +
                        "WHERE ela_ena_entityattributeid = ? AND ela_eni_entityinstanceid = ? AND ela_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylistitemattributes " +
                        "WHERE ela_ena_entityattributeid = ? AND ela_eni_entityinstanceid = ? AND ela_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityListItemAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityListItemAttribute = EntityListItemAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityListItemAttribute;
    }
    
    public EntityListItemAttribute getEntityListItemAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityListItemAttribute(entityAttribute, entityInstance, EntityPermission.READ_ONLY);
    }
    
    public EntityListItemAttribute getEntityListItemAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityListItemAttribute(entityAttribute, entityInstance, EntityPermission.READ_WRITE);
    }
    
    public EntityListItemAttributeValue getEntityListItemAttributeValueForUpdate(EntityListItemAttribute entityListItemAttribute) {
        return entityListItemAttribute == null? null: entityListItemAttribute.getEntityListItemAttributeValue().clone();
    }
    
    public EntityListItemAttributeValue getEntityListItemAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityListItemAttributeValueForUpdate(getEntityListItemAttributeForUpdate(entityAttribute, entityInstance));
    }
    
    private List<EntityListItemAttribute> getEntityListItemAttributesByEntityListItem(EntityListItem entityListItem, EntityPermission entityPermission) {
        List<EntityListItemAttribute> entityListItemAttributes;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ "
                        + "FROM entitylistitemattributes, entityinstances "
                        + "WHERE ela_eli_entitylistitemid = ? AND ela_thrutime = ? "
                        + "AND ela_eni_entityinstanceid = eni_entityinstanceid "
                        + "ORDER BY eni_entityuniqueid";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ "
                        + "FROM entitylistitemattributes "
                        + "WHERE ela_eli_entitylistitemid = ? AND ela_thrutime = ? "
                        + "FOR UPDATE";
            }

            var ps = EntityListItemAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityListItem.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityListItemAttributes = EntityListItemAttributeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityListItemAttributes;
    }
    
    public List<EntityListItemAttribute> getEntityListItemAttributesByEntityListItem(EntityListItem entityListItem) {
        return getEntityListItemAttributesByEntityListItem(entityListItem, EntityPermission.READ_ONLY);
    }
    
    public List<EntityListItemAttribute> getEntityListItemAttributesByEntityListItemForUpdate(EntityListItem entityListItem) {
        return getEntityListItemAttributesByEntityListItem(entityListItem, EntityPermission.READ_WRITE);
    }
    
    public List<EntityListItemAttribute> getEntityListItemAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityListItemAttribute> entityListItemAttributes;
        
        try {
            var ps = EntityListItemAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitylistitemattributes " +
                    "WHERE ela_eni_entityinstanceid = ? AND ela_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityListItemAttributes = EntityListItemAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityListItemAttributes;
    }
    
    public EntityListItemAttributeTransfer getEntityListItemAttributeTransfer(UserVisit userVisit, EntityListItemAttribute entityListItemAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityListItemAttributeTransferCache().getEntityListItemAttributeTransfer(entityListItemAttribute, entityInstance);
    }
    
    public void updateEntityListItemAttributeFromValue(EntityListItemAttributeValue entityListItemAttributeValue, BasePK updatedBy) {
        if(entityListItemAttributeValue.hasBeenModified()) {
            var entityListItemAttribute = EntityListItemAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityListItemAttributeValue);
            var entityAttribute = entityListItemAttribute.getEntityAttribute();
            var entityInstance = entityListItemAttribute.getEntityInstance();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityListItemAttribute.setThruTime(session.START_TIME_LONG);
                entityListItemAttribute.store();
            } else {
                entityListItemAttribute.remove();
            }
            
            EntityListItemAttributeFactory.getInstance().create(entityAttribute.getPrimaryKey(), entityInstance.getPrimaryKey(), entityListItemAttributeValue.getEntityListItemPK(),
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityListItemAttribute(EntityListItemAttribute entityListItemAttribute, BasePK deletedBy) {
        var entityAttribute = entityListItemAttribute.getEntityAttribute();
        var entityInstance = entityListItemAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityListItemAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityListItemAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityListItemAttributes(List<EntityListItemAttribute> entityListItemAttributes, BasePK deletedBy) {
        entityListItemAttributes.forEach((entityListItemAttribute) -> 
                deleteEntityListItemAttribute(entityListItemAttribute, deletedBy)
        );
    }
    
    public void deleteEntityListItemAttributesByEntityListItem(EntityListItem entityListItem, BasePK deletedBy) {
        deleteEntityListItemAttributes(getEntityListItemAttributesByEntityListItemForUpdate(entityListItem), deletedBy);
    }
    
    public void deleteEntityListItemAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityListItemAttributes(getEntityListItemAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Entity Long Defaults
    // --------------------------------------------------------------------------------

    public EntityLongDefault createEntityLongDefault(EntityAttribute entityAttribute, Long longAttribute,
            BasePK createdBy) {
        var entityLongDefault = EntityLongDefaultFactory.getInstance().create(entityAttribute,
                longAttribute, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityLongDefault.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return entityLongDefault;
    }

    public long countEntityLongDefaultHistory(EntityAttribute entityAttribute) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitylongdefaults
                    WHERE enldef_thrutime = ?
                    """, entityAttribute);
    }

    private static final Map<EntityPermission, String> getEntityLongDefaultHistoryQueries;

    static {
        getEntityLongDefaultHistoryQueries = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitylongdefaults
                WHERE enldef_ena_entityattributeid = ?
                ORDER BY enldef_thrutime
                _LIMIT_
                """);
    }

    public List<EntityLongDefault> getEntityLongDefaultHistory(EntityAttribute entityAttribute) {
        return EntityLongDefaultFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityLongDefaultHistoryQueries,
                entityAttribute);
    }

    private EntityLongDefault getEntityLongDefault(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        EntityLongDefault entityLongDefault;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongdefaults " +
                        "WHERE enldef_ena_entityattributeid = ? AND enldef_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongdefaults " +
                        "WHERE enldef_ena_entityattributeid = ? AND enldef_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityLongDefaultFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);

            entityLongDefault = EntityLongDefaultFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityLongDefault;
    }

    public EntityLongDefault getEntityLongDefault(EntityAttribute entityAttribute) {
        return getEntityLongDefault(entityAttribute, EntityPermission.READ_ONLY);
    }

    public EntityLongDefault getEntityLongDefaultForUpdate(EntityAttribute entityAttribute) {
        return getEntityLongDefault(entityAttribute, EntityPermission.READ_WRITE);
    }

    public EntityLongDefaultValue getEntityLongDefaultValueForUpdate(EntityLongDefault entityLongDefault) {
        return entityLongDefault == null? null: entityLongDefault.getEntityLongDefaultValue().clone();
    }

    public EntityLongDefaultValue getEntityLongDefaultValueForUpdate(EntityAttribute entityAttribute) {
        return getEntityLongDefaultValueForUpdate(getEntityLongDefaultForUpdate(entityAttribute));
    }

    public EntityLongDefaultTransfer getEntityLongDefaultTransfer(UserVisit userVisit, EntityLongDefault entityLongDefault) {
        return getCoreTransferCaches(userVisit).getEntityLongDefaultTransferCache().getEntityLongDefaultTransfer(entityLongDefault);
    }

    public void updateEntityLongDefaultFromValue(EntityLongDefaultValue entityLongDefaultValue, BasePK updatedBy) {
        if(entityLongDefaultValue.hasBeenModified()) {
            var entityLongDefault = EntityLongDefaultFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityLongDefaultValue);
            var entityAttribute = entityLongDefault.getEntityAttribute();

            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityLongDefault.setThruTime(session.START_TIME_LONG);
                entityLongDefault.store();
            } else {
                entityLongDefault.remove();
            }

            entityLongDefault = EntityLongDefaultFactory.getInstance().create(entityAttribute,
                    entityLongDefaultValue.getLongAttribute(), session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityLongDefault.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteEntityLongDefault(EntityLongDefault entityLongDefault, BasePK deletedBy) {
        var entityAttribute = entityLongDefault.getEntityAttribute();

        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityLongDefault.setThruTime(session.START_TIME_LONG);
        } else {
            entityLongDefault.remove();
        }

        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityLongDefault.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deleteEntityLongDefaultByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        var entityLongDefault = getEntityLongDefaultForUpdate(entityAttribute);

        if(entityLongDefault != null) {
            deleteEntityLongDefault(entityLongDefault, deletedBy);
        }
    }

    // --------------------------------------------------------------------------------
    //   Entity Long Attributes
    // --------------------------------------------------------------------------------

    public EntityLongAttribute createEntityLongAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Long longAttribute, BasePK createdBy) {
        return createEntityLongAttribute(entityAttribute.getPrimaryKey(), entityInstance, longAttribute,
                createdBy);
    }

    public EntityLongAttribute createEntityLongAttribute(EntityAttributePK entityAttribute, EntityInstance entityInstance,
            Long longAttribute, BasePK createdBy) {
        var entityLongAttribute = EntityLongAttributeFactory.getInstance().create(entityAttribute,
                entityInstance.getPrimaryKey(), longAttribute, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute, EventTypes.CREATE, createdBy);

        return entityLongAttribute;
    }

    public long countEntityLongAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitylongattributes
                    WHERE enla_ena_entityattributeid = ? AND enla_eni_entityinstanceid = ?
                    """, entityAttribute, entityInstance);
    }

    private static final Map<EntityPermission, String> getEntityLongAttributeHistoryQueries;

    static {
        var queryMap = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitylongattributes
                WHERE enla_ena_entityattributeid = ? AND enla_eni_entityinstanceid = ?
                ORDER BY enla_thrutime
                _LIMIT_
                """);
        getEntityLongAttributeHistoryQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<EntityLongAttribute> getEntityLongAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return EntityLongAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityLongAttributeHistoryQueries,
                entityAttribute, entityInstance);
    }

    private EntityLongAttribute getEntityLongAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityPermission entityPermission) {
        EntityLongAttribute entityLongAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongattributes " +
                        "WHERE enla_ena_entityattributeid = ? AND enla_eni_entityinstanceid = ? AND enla_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitylongattributes " +
                        "WHERE enla_ena_entityattributeid = ? AND enla_eni_entityinstanceid = ? AND enla_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityLongAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityLongAttribute = EntityLongAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityLongAttribute;
    }
    
    public EntityLongAttribute getEntityLongAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityLongAttribute(entityAttribute, entityInstance, EntityPermission.READ_ONLY);
    }
    
    public EntityLongAttribute getEntityLongAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityLongAttribute(entityAttribute, entityInstance, EntityPermission.READ_WRITE);
    }
    
    public EntityLongAttributeValue getEntityLongAttributeValueForUpdate(EntityLongAttribute entityLongAttribute) {
        return entityLongAttribute == null? null: entityLongAttribute.getEntityLongAttributeValue().clone();
    }
    
    public EntityLongAttributeValue getEntityLongAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityLongAttributeValueForUpdate(getEntityLongAttributeForUpdate(entityAttribute, entityInstance));
    }
    
    public List<EntityLongAttribute> getEntityLongAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityLongAttribute> entityLongAttributes;
        
        try {
            var ps = EntityLongAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitylongattributes " +
                    "WHERE enla_ena_entityattributeid = ? AND enla_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityLongAttributes = EntityLongAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityLongAttributes;
    }
    
    public List<EntityLongAttribute> getEntityLongAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityLongAttribute> entityLongAttributes;
        
        try {
            var ps = EntityLongAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitylongattributes " +
                    "WHERE enla_eni_entityinstanceid = ? AND enla_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityLongAttributes = EntityLongAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityLongAttributes;
    }
    
    public EntityLongAttributeTransfer getEntityLongAttributeTransfer(UserVisit userVisit, EntityLongAttribute entityLongAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityLongAttributeTransferCache().getEntityLongAttributeTransfer(entityLongAttribute, entityInstance);
    }
    
    public void updateEntityLongAttributeFromValue(EntityLongAttributeValue entityLongAttributeValue, BasePK updatedBy) {
        if(entityLongAttributeValue.hasBeenModified()) {
            var entityLongAttribute = EntityLongAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityLongAttributeValue);
            var entityAttribute = entityLongAttribute.getEntityAttribute();
            var entityInstance = entityLongAttribute.getEntityInstance();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityLongAttribute.setThruTime(session.START_TIME_LONG);
                entityLongAttribute.store();
            } else {
                entityLongAttribute.remove();
            }
            
            EntityLongAttributeFactory.getInstance().create(entityAttribute, entityInstance, entityLongAttributeValue.getLongAttribute(), session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityLongAttribute(EntityLongAttribute entityLongAttribute, BasePK deletedBy) {
        var entityAttribute = entityLongAttribute.getEntityAttribute();
        var entityInstance = entityLongAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityLongAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityLongAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityLongAttributes(List<EntityLongAttribute> entityLongAttributes, BasePK deletedBy) {
        entityLongAttributes.forEach((entityLongAttribute) -> 
                deleteEntityLongAttribute(entityLongAttribute, deletedBy)
        );
    }
    
    public void deleteEntityLongAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityLongAttributes(getEntityLongAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityLongAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityLongAttributes(getEntityLongAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Multiple List Item Attributes
    // --------------------------------------------------------------------------------
    
    public EntityMultipleListItemAttribute createEntityMultipleListItemAttribute(EntityAttribute entityAttribute,
            EntityInstance entityInstance, EntityListItem entityListItem, BasePK createdBy) {
        var entityMultipleListItemAttribute = EntityMultipleListItemAttributeFactory.getInstance().create(session,
                entityAttribute, entityInstance, entityListItem, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityMultipleListItemAttribute;
    }

    public long countEntityMultipleListItemAttributes(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitymultiplelistitemattributes
                    WHERE emlia_ena_entityattributeid = ? AND emlia_eni_entityinstanceid = ? AND emlia_thrutime = ?
                    """, entityAttribute, entityInstance, Session.MAX_TIME);
    }

    public List<EntityMultipleListItemAttribute> getEntityMultipleListItemAttributes(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        List<EntityMultipleListItemAttribute> entityMultipleListItemAttributes;
        
        try {
            var ps = EntityMultipleListItemAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ "
                    + "FROM entitymultiplelistitemattributes, entitylistitems, entitylistitemdetails "
                    + "WHERE emlia_ena_entityattributeid = ? AND emlia_eni_entityinstanceid = ? AND emlia_thrutime = ? "
                    + "AND emlia_eli_entitylistitemid = eli_entitylistitemid AND eli_lastdetailid = elidt_entitylistitemdetailid "
                    + "ORDER BY elidt_sortorder, elidt_entitylistitemname");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityMultipleListItemAttributes = EntityMultipleListItemAttributeFactory.getInstance().getEntitiesFromQuery(session,
                    EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityMultipleListItemAttributes;
    }
    
    private EntityMultipleListItemAttribute getEntityMultipleListItemAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityListItem entityListItem, EntityPermission entityPermission) {
        EntityMultipleListItemAttribute entityMultipleListItemAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitymultiplelistitemattributes " +
                        "WHERE emlia_ena_entityattributeid = ? AND emlia_eni_entityinstanceid = ? AND emlia_eli_entitylistitemid = ? " +
                        "AND emlia_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitymultiplelistitemattributes " +
                        "WHERE emlia_ena_entityattributeid = ? AND emlia_eni_entityinstanceid = ? AND emlia_eli_entitylistitemid = ? " +
                        "AND emlia_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityMultipleListItemAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, entityListItem.getPrimaryKey().getEntityId());
            ps.setLong(4, Session.MAX_TIME);
            
            entityMultipleListItemAttribute = EntityMultipleListItemAttributeFactory.getInstance().getEntityFromQuery(session,
                    entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityMultipleListItemAttribute;
    }
    
    public EntityMultipleListItemAttribute getEntityMultipleListItemAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityListItem entityListItem) {
        return getEntityMultipleListItemAttribute(entityAttribute, entityInstance, entityListItem, EntityPermission.READ_ONLY);
    }
    
    public EntityMultipleListItemAttribute getEntityMultipleListItemAttributeForUpdate(EntityAttribute entityAttribute,
            EntityInstance entityInstance, EntityListItem entityListItem) {
        return getEntityMultipleListItemAttribute(entityAttribute, entityInstance, entityListItem, EntityPermission.READ_WRITE);
    }
    
    private List<EntityMultipleListItemAttribute> getEntityMultipleListItemAttributesByEntityListItem(EntityListItem entityListItem, EntityPermission entityPermission) {
        List<EntityMultipleListItemAttribute> entityMultipleListItemAttributes;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ "
                        + "FROM entitymultiplelistitemattributes, entityinstances "
                        + "WHERE emlia_eli_entitylistitemid = ? AND emlia_thrutime = ? "
                        + "AND emlia_eni_entityinstanceid = eni_entityinstanceid "
                        + "ORDER BY eni_entityuniqueid";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ "
                        + "FROM entitymultiplelistitemattributes "
                        + "WHERE emlia_eli_entitylistitemid = ? AND emlia_thrutime = ? "
                        + "FOR UPDATE";
            }

            var ps = EntityMultipleListItemAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityListItem.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityMultipleListItemAttributes = EntityMultipleListItemAttributeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityMultipleListItemAttributes;
    }
    
    public List<EntityMultipleListItemAttribute> getEntityMultipleListItemAttributesByEntityListItem(EntityListItem entityListItem) {
        return getEntityMultipleListItemAttributesByEntityListItem(entityListItem, EntityPermission.READ_ONLY);
    }
    
    public List<EntityMultipleListItemAttribute> getEntityMultipleListItemAttributesByEntityListItemForUpdate(EntityListItem entityListItem) {
        return getEntityMultipleListItemAttributesByEntityListItem(entityListItem, EntityPermission.READ_WRITE);
    }
    
    public List<EntityMultipleListItemAttribute> getEntityMultipleListItemAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityMultipleListItemAttribute> entityMultipleListItemAttributes;
        
        try {
            var ps = EntityMultipleListItemAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitymultiplelistitemattributes " +
                    "WHERE emlia_eni_entityinstanceid = ? AND emlia_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityMultipleListItemAttributes = EntityMultipleListItemAttributeFactory.getInstance().getEntitiesFromQuery(session,
                    EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityMultipleListItemAttributes;
    }
    
    public EntityMultipleListItemAttributeTransfer getEntityMultipleListItemAttributeTransfer(UserVisit userVisit, EntityMultipleListItemAttribute entityMultipleListItemAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityMultipleListItemAttributeTransferCache().getEntityMultipleListItemAttributeTransfer(entityMultipleListItemAttribute, entityInstance);
    }
    
    public List<EntityMultipleListItemAttributeTransfer> getEntityMultipleListItemAttributeTransfers(UserVisit userVisit, Collection<EntityMultipleListItemAttribute> entityMultipleListItemAttributes, EntityInstance entityInstance) {
        List<EntityMultipleListItemAttributeTransfer> entityMultipleListItemAttributeTransfers = new ArrayList<>(entityMultipleListItemAttributes.size());
        var entityMultipleListItemAttributeTransferCache = getCoreTransferCaches(userVisit).getEntityMultipleListItemAttributeTransferCache();
        
        entityMultipleListItemAttributes.forEach((entityMultipleListItemAttribute) ->
                entityMultipleListItemAttributeTransfers.add(entityMultipleListItemAttributeTransferCache.getEntityMultipleListItemAttributeTransfer(entityMultipleListItemAttribute, entityInstance))
        );
        
        return entityMultipleListItemAttributeTransfers;
    }
    
    public List<EntityMultipleListItemAttributeTransfer> getEntityMultipleListItemAttributeTransfers(UserVisit userVisit, EntityAttribute entityAttribute,
            EntityInstance entityInstance) {
        return getEntityMultipleListItemAttributeTransfers(userVisit, getEntityMultipleListItemAttributes(entityAttribute, entityInstance), entityInstance);
    }
    
    public void deleteEntityMultipleListItemAttribute(EntityMultipleListItemAttribute entityMultipleListItemAttribute, BasePK deletedBy) {
        var entityAttribute = entityMultipleListItemAttribute.getEntityAttribute();
        var entityInstance = entityMultipleListItemAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityMultipleListItemAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityMultipleListItemAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityMultipleListItemAttributes(List<EntityMultipleListItemAttribute> entityMultipleListItemAttributes, BasePK deletedBy) {
        entityMultipleListItemAttributes.forEach((entityMultipleListItemAttribute) -> 
                deleteEntityMultipleListItemAttribute(entityMultipleListItemAttribute, deletedBy)
        );
    }
    
    public void deleteEntityMultipleListItemAttributesByEntityListItem(EntityListItem entityListItem, BasePK deletedBy) {
        deleteEntityMultipleListItemAttributes(getEntityMultipleListItemAttributesByEntityListItemForUpdate(entityListItem), deletedBy);
    }
    
    public void deleteEntityMultipleListItemAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityMultipleListItemAttributes(getEntityMultipleListItemAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Name Attributes
    // --------------------------------------------------------------------------------
    
    public EntityNameAttribute createEntityNameAttribute(EntityAttribute entityAttribute, String nameAttribute,
            EntityInstance entityInstance, BasePK createdBy) {
        var entityNameAttribute = EntityNameAttributeFactory.getInstance().create(entityAttribute,
                nameAttribute, entityInstance, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityNameAttribute;
    }

    public long countEntityNameAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitynameattributes
                    WHERE enna_ena_entityattributeid = ? AND enna_eni_entityinstanceid = ?
                    """, entityAttribute, entityInstance);
    }

    private static final Map<EntityPermission, String> getEntityNameAttributeHistoryQueries;

    static {
        var queryMap = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitynameattributes
                WHERE enna_ena_entityattributeid = ? AND enna_eni_entityinstanceid = ?
                ORDER BY enna_thrutime
                _LIMIT_
                """);
        getEntityNameAttributeHistoryQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<EntityNameAttribute> getEntityNameAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return EntityNameAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityNameAttributeHistoryQueries,
                entityAttribute, entityInstance);
    }

    private EntityNameAttribute getEntityNameAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityPermission entityPermission) {
        EntityNameAttribute entityNameAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitynameattributes " +
                        "WHERE enna_ena_entityattributeid = ? AND enna_eni_entityinstanceid = ? AND enna_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitynameattributes " +
                        "WHERE enna_ena_entityattributeid = ? AND enna_eni_entityinstanceid = ? AND enna_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityNameAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityNameAttribute = EntityNameAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityNameAttribute;
    }
    
    public EntityNameAttribute getEntityNameAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityNameAttribute(entityAttribute, entityInstance, EntityPermission.READ_ONLY);
    }
    
    public EntityNameAttribute getEntityNameAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityNameAttribute(entityAttribute, entityInstance, EntityPermission.READ_WRITE);
    }
    
    public EntityNameAttributeValue getEntityNameAttributeValueForUpdate(EntityNameAttribute entityNameAttribute) {
        return entityNameAttribute == null? null: entityNameAttribute.getEntityNameAttributeValue().clone();
    }
    
    public EntityNameAttributeValue getEntityNameAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityNameAttributeValueForUpdate(getEntityNameAttributeForUpdate(entityAttribute, entityInstance));
    }
    
    public List<EntityNameAttribute> getEntityNameAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityNameAttribute> entityNameAttributes;
        
        try {
            var ps = EntityNameAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitynameattributes " +
                    "WHERE enna_ena_entityattributeid = ? AND enna_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityNameAttributes = EntityNameAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityNameAttributes;
    }
    
    public List<EntityNameAttribute> getEntityNameAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityNameAttribute> entityNameAttributes;
        
        try {
            var ps = EntityNameAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitynameattributes " +
                    "WHERE enna_eni_entityinstanceid = ? AND enna_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityNameAttributes = EntityNameAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityNameAttributes;
    }
    
    public EntityNameAttributeTransfer getEntityNameAttributeTransfer(UserVisit userVisit, EntityNameAttribute entityNameAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityNameAttributeTransferCache().getEntityNameAttributeTransfer(entityNameAttribute, entityInstance);
    }
    
    public void updateEntityNameAttributeFromValue(EntityNameAttributeValue entityNameAttributeValue, BasePK updatedBy) {
        if(entityNameAttributeValue.hasBeenModified()) {
            var entityNameAttribute = EntityNameAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityNameAttributeValue);
            var entityAttribute = entityNameAttribute.getEntityAttribute();
            var entityInstance = entityNameAttribute.getEntityInstance();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityNameAttribute.setThruTime(session.START_TIME_LONG);
                entityNameAttribute.store();
            } else {
                entityNameAttribute.remove();
            }
            
            EntityNameAttributeFactory.getInstance().create(entityAttribute, entityNameAttributeValue.getNameAttribute(), entityInstance, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityNameAttribute(EntityNameAttribute entityNameAttribute, BasePK deletedBy) {
        var entityAttribute = entityNameAttribute.getEntityAttribute();
        var entityInstance = entityNameAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityNameAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityNameAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityNameAttributes(List<EntityNameAttribute> entityNameAttributes, BasePK deletedBy) {
        entityNameAttributes.forEach((entityNameAttribute) -> 
                deleteEntityNameAttribute(entityNameAttribute, deletedBy)
        );
    }
    
    public void deleteEntityNameAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityNameAttributes(getEntityNameAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityNameAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityNameAttributes(getEntityNameAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }
    
    public List<EntityNameAttribute> getEntityNameAttributesByName(EntityAttribute entityAttribute, String nameAttribute) {
        List<EntityNameAttribute> entityNameAttributes;
        
        try {
            var ps = EntityNameAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitynameattributes " +
                    "WHERE enna_ena_entityattributeid = ? AND enna_nameattribute = ? AND enna_thrutime = ?");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setString(2, nameAttribute);
            ps.setLong(3, Session.MAX_TIME);
            
            entityNameAttributes = EntityNameAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityNameAttributes;
    }

    // --------------------------------------------------------------------------------
    //   Entity String Defaults
    // --------------------------------------------------------------------------------

    public EntityStringDefault createEntityStringDefault(EntityAttribute entityAttribute, Language language,
            String stringAttribute, BasePK createdBy) {
        var entityStringDefault = EntityStringDefaultFactory.getInstance().create(entityAttribute, language,
                stringAttribute, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityStringDefault.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return entityStringDefault;
    }

    public long countEntityStringDefaultHistory(EntityAttribute entityAttribute, Language language) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitystringdefaults
                    WHERE ensdef_ena_entityattributeid = ? AND ensdef_lang_languageid = ?
                    """, entityAttribute, language);
    }

    private static final Map<EntityPermission, String> getEntityStringDefaultHistoryQueries;

    static {
        getEntityStringDefaultHistoryQueries = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitystringdefaults
                WHERE ensdef_ena_entityattributeid = ? AND ensdef_lang_languageid = ?
                ORDER BY ensdef_thrutime
                _LIMIT_
                """);
    }

    public List<EntityStringDefault> getEntityStringDefaultHistory(EntityAttribute entityAttribute, Language language) {
        return EntityStringDefaultFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityStringDefaultHistoryQueries,
                entityAttribute, language);
    }

    private EntityStringDefault getEntityStringDefault(EntityAttribute entityAttribute, Language language, EntityPermission entityPermission) {
        EntityStringDefault entityStringDefault;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitystringdefaults " +
                        "WHERE ensdef_ena_entityattributeid = ? AND ensdef_lang_languageid = ? AND ensdef_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitystringdefaults " +
                        "WHERE ensdef_ena_entityattributeid = ? AND ensdef_lang_languageid = ? AND ensdef_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityStringDefaultFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, language.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);

            entityStringDefault = EntityStringDefaultFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityStringDefault;
    }

    public EntityStringDefault getEntityStringDefault(EntityAttribute entityAttribute, Language language) {
        return getEntityStringDefault(entityAttribute, language, EntityPermission.READ_ONLY);
    }

    public EntityStringDefault getEntityStringDefaultForUpdate(EntityAttribute entityAttribute, Language language) {
        return getEntityStringDefault(entityAttribute, language, EntityPermission.READ_WRITE);
    }

    public EntityStringDefaultValue getEntityStringDefaultValueForUpdate(EntityStringDefault entityStringDefault) {
        return entityStringDefault == null? null: entityStringDefault.getEntityStringDefaultValue().clone();
    }

    public EntityStringDefaultValue getEntityStringDefaultValueForUpdate(EntityAttribute entityAttribute, Language language) {
        return getEntityStringDefaultValueForUpdate(getEntityStringDefaultForUpdate(entityAttribute, language));
    }

    public List<EntityStringDefault> getEntityStringDefaultsByEntityAttribute(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        List<EntityStringDefault> entityStringDefaults;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitystringdefaults " +
                        "JOIN languages ON ensdef_lang_languageid = lang_languageid " +
                        "WHERE ensdef_ena_entityattributeid = ? AND ensdef_thrutime = ? " +
                        "ORDER BY lang_sortorder, lang_languageisoname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitystringdefaults " +
                        "WHERE ensdef_ena_entityattributeid = ? AND ensdef_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityStringDefaultFactory.getInstance().prepareStatement(query);

            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);

            entityStringDefaults = EntityStringDefaultFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityStringDefaults;
    }

    public List<EntityStringDefault> getEntityStringDefaultsByEntityAttribute(EntityAttribute entityAttribute) {
        return getEntityStringDefaultsByEntityAttribute(entityAttribute, EntityPermission.READ_ONLY);
    }

    public List<EntityStringDefault> getEntityStringDefaultsByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        return getEntityStringDefaultsByEntityAttribute(entityAttribute, EntityPermission.READ_ONLY);
    }


    public EntityStringDefaultTransfer getEntityStringDefaultTransfer(UserVisit userVisit, EntityStringDefault entityStringDefault) {
        return getCoreTransferCaches(userVisit).getEntityStringDefaultTransferCache().getEntityStringDefaultTransfer(entityStringDefault);
    }

    public void updateEntityStringDefaultFromValue(EntityStringDefaultValue entityStringDefaultValue, BasePK updatedBy) {
        if(entityStringDefaultValue.hasBeenModified()) {
            var entityStringDefault = EntityStringDefaultFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityStringDefaultValue);
            var entityAttribute = entityStringDefault.getEntityAttribute();
            var language = entityStringDefault.getLanguage();

            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityStringDefault.setThruTime(session.START_TIME_LONG);
                entityStringDefault.store();
            } else {
                entityStringDefault.remove();
            }

            entityStringDefault = EntityStringDefaultFactory.getInstance().create(entityAttribute, language,
                    entityStringDefaultValue.getStringAttribute(), session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityStringDefault.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteEntityStringDefault(EntityStringDefault entityStringDefault, BasePK deletedBy) {
        var entityAttribute = entityStringDefault.getEntityAttribute();

        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityStringDefault.setThruTime(session.START_TIME_LONG);
        } else {
            entityStringDefault.remove();
        }

        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityStringDefault.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deleteEntityStringDefaults(Collection<EntityStringDefault> entityStringDefaults, BasePK deletedBy) {
        entityStringDefaults.forEach((entityStringDefault) ->
                deleteEntityStringDefault(entityStringDefault, deletedBy));
    }

    public void deleteEntityStringDefaultByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityStringDefaults(getEntityStringDefaultsByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Entity String Attributes
    // --------------------------------------------------------------------------------

    public EntityStringAttribute createEntityStringAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Language language, String stringAttribute, BasePK createdBy) {
        return createEntityStringAttribute(entityAttribute.getPrimaryKey(), entityInstance, language, stringAttribute,
                createdBy);
    }

    public EntityStringAttribute createEntityStringAttribute(EntityAttributePK entityAttribute, EntityInstance entityInstance,
            Language language, String stringAttribute, BasePK createdBy) {
        var entityStringAttribute = EntityStringAttributeFactory.getInstance().create(entityAttribute,
                entityInstance.getPrimaryKey(), language.getPrimaryKey(), stringAttribute, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute, EventTypes.CREATE, createdBy);

        return entityStringAttribute;
    }
    
    public long countEntityStringAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Language language) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitystringattributes
                    WHERE ensa_ena_entityattributeid = ? AND ensa_eni_entityinstanceid = ? AND ensa_lang_languageid = ?
                    """, entityAttribute, entityInstance, language);
    }

    private static final Map<EntityPermission, String> getEntityStringAttributeHistoryQueries;

    static {
        getEntityStringAttributeHistoryQueries = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitystringattributes
                WHERE ensa_ena_entityattributeid = ? AND ensa_eni_entityinstanceid = ? AND ensa_lang_languageid = ?
                ORDER BY ensa_thrutime
                _LIMIT_
                """);
    }

    public List<EntityStringAttribute> getEntityStringAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Language language) {
        return EntityStringAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityStringAttributeHistoryQueries,
                entityAttribute, entityInstance, language);
    }

    private EntityStringAttribute getEntityStringAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Language language, EntityPermission entityPermission) {
        EntityStringAttribute entityStringAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitystringattributes " +
                        "WHERE ensa_ena_entityattributeid = ? AND ensa_eni_entityinstanceid = ? AND ensa_lang_languageid = ? AND ensa_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitystringattributes " +
                        "WHERE ensa_ena_entityattributeid = ? AND ensa_eni_entityinstanceid = ? AND ensa_lang_languageid = ? AND ensa_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityStringAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, language.getPrimaryKey().getEntityId());
            ps.setLong(4, Session.MAX_TIME);
            
            entityStringAttribute = EntityStringAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityStringAttribute;
    }
    
    public EntityStringAttribute getEntityStringAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        return getEntityStringAttribute(entityAttribute, entityInstance, language, EntityPermission.READ_ONLY);
    }
    
    public EntityStringAttribute getEntityStringAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        return getEntityStringAttribute(entityAttribute, entityInstance, language, EntityPermission.READ_WRITE);
    }
    
    public EntityStringAttribute getBestEntityStringAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        var entityStringAttribute = getEntityStringAttribute(entityAttribute, entityInstance, language);
        
        if(entityStringAttribute == null && !language.getIsDefault()) {
            entityStringAttribute = getEntityStringAttribute(entityAttribute, entityInstance, getPartyControl().getDefaultLanguage());
        }
        
        return entityStringAttribute;
    }
    
    public EntityStringAttributeValue getEntityStringAttributeValueForUpdate(EntityStringAttribute entityStringAttribute) {
        return entityStringAttribute == null? null: entityStringAttribute.getEntityStringAttributeValue().clone();
    }
    
    public EntityStringAttributeValue getEntityStringAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        return getEntityStringAttributeValueForUpdate(getEntityStringAttributeForUpdate(entityAttribute, entityInstance, language));
    }
    
    public List<EntityStringAttribute> getEntityStringAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityStringAttribute> entityStringAttributes;
        
        try {
            var ps = EntityStringAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitystringattributes " +
                    "WHERE ensa_ena_entityattributeid = ? AND ensa_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityStringAttributes = EntityStringAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityStringAttributes;
    }
    
    public List<EntityStringAttribute> getEntityStringAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityStringAttribute> entityStringAttributes;
        
        try {
            var ps = EntityStringAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitystringattributes " +
                    "WHERE ensa_eni_entityinstanceid = ? AND ensa_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityStringAttributes = EntityStringAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityStringAttributes;
    }
    
    public EntityStringAttributeTransfer getEntityStringAttributeTransfer(UserVisit userVisit, EntityStringAttribute entityStringAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityStringAttributeTransferCache().getEntityStringAttributeTransfer(entityStringAttribute, entityInstance);
    }
    
    public void updateEntityStringAttributeFromValue(EntityStringAttributeValue entityStringAttributeValue, BasePK updatedBy) {
        if(entityStringAttributeValue.hasBeenModified()) {
            var entityStringAttribute = EntityStringAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityStringAttributeValue);
            var entityAttribute = entityStringAttribute.getEntityAttribute();
            var entityInstance = entityStringAttribute.getEntityInstance();
            var language = entityStringAttribute.getLanguage();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityStringAttribute.setThruTime(session.START_TIME_LONG);
                entityStringAttribute.store();
            } else {
                entityStringAttribute.remove();
            }
            
            EntityStringAttributeFactory.getInstance().create(entityAttribute, entityInstance, language, entityStringAttributeValue.getStringAttribute(), session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityStringAttribute(EntityStringAttribute entityStringAttribute, BasePK deletedBy) {
        var entityAttribute = entityStringAttribute.getEntityAttribute();
        var entityInstance = entityStringAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityStringAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityStringAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityStringAttributes(List<EntityStringAttribute> entityStringAttributes, BasePK deletedBy) {
        entityStringAttributes.forEach((entityStringAttribute) -> 
                deleteEntityStringAttribute(entityStringAttribute, deletedBy)
        );
    }
    
    public void deleteEntityStringAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityStringAttributes(getEntityStringAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityStringAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityStringAttributes(getEntityStringAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Long Attributes
    // --------------------------------------------------------------------------------
    
    public EntityGeoPointAttribute createEntityGeoPointAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Integer latitude, Integer longitude, Long elevation, Long altitude, BasePK createdBy) {
        var entityGeoPointAttribute = EntityGeoPointAttributeFactory.getInstance().create(entityAttribute, entityInstance, latitude,
                longitude, elevation, altitude, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityGeoPointAttribute;
    }

    public long countEntityGeoPointAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitygeopointattributes
                    WHERE engeopnta_ena_entityattributeid = ? AND engeopnta_eni_entityinstanceid = ?
                    """, entityAttribute, entityInstance);
    }

    private static final Map<EntityPermission, String> getEntityGeoPointAttributeHistoryQueries;

    static {
        var queryMap = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitygeopointattributes
                WHERE engeopnta_ena_entityattributeid = ? AND engeopnta_eni_entityinstanceid = ?
                ORDER BY engeopnta_thrutime
                _LIMIT_
                """);
        getEntityGeoPointAttributeHistoryQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<EntityGeoPointAttribute> getEntityGeoPointAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return EntityGeoPointAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityGeoPointAttributeHistoryQueries,
                entityAttribute, entityInstance);
    }

    private EntityGeoPointAttribute getEntityGeoPointAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityPermission entityPermission) {
        EntityGeoPointAttribute entityGeoPointAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitygeopointattributes " +
                        "WHERE engeopnta_ena_entityattributeid = ? AND engeopnta_eni_entityinstanceid = ? AND engeopnta_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitygeopointattributes " +
                        "WHERE engeopnta_ena_entityattributeid = ? AND engeopnta_eni_entityinstanceid = ? AND engeopnta_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityGeoPointAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityGeoPointAttribute = EntityGeoPointAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityGeoPointAttribute;
    }
    
    public EntityGeoPointAttribute getEntityGeoPointAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityGeoPointAttribute(entityAttribute, entityInstance, EntityPermission.READ_ONLY);
    }
    
    public EntityGeoPointAttribute getEntityGeoPointAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityGeoPointAttribute(entityAttribute, entityInstance, EntityPermission.READ_WRITE);
    }
    
    public EntityGeoPointAttributeValue getEntityGeoPointAttributeValueForUpdate(EntityGeoPointAttribute entityGeoPointAttribute) {
        return entityGeoPointAttribute == null? null: entityGeoPointAttribute.getEntityGeoPointAttributeValue().clone();
    }
    
    public EntityGeoPointAttributeValue getEntityGeoPointAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityGeoPointAttributeValueForUpdate(getEntityGeoPointAttributeForUpdate(entityAttribute, entityInstance));
    }
    
    public List<EntityGeoPointAttribute> getEntityGeoPointAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityGeoPointAttribute> entityGeoPointAttributes;
        
        try {
            var ps = EntityGeoPointAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitygeopointattributes " +
                    "WHERE engeopnta_ena_entityattributeid = ? AND engeopnta_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityGeoPointAttributes = EntityGeoPointAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityGeoPointAttributes;
    }
    
    public List<EntityGeoPointAttribute> getEntityGeoPointAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityGeoPointAttribute> entityGeoPointAttributes;
        
        try {
            var ps = EntityGeoPointAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitygeopointattributes " +
                    "WHERE engeopnta_eni_entityinstanceid = ? AND engeopnta_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityGeoPointAttributes = EntityGeoPointAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityGeoPointAttributes;
    }
    
    public EntityGeoPointAttributeTransfer getEntityGeoPointAttributeTransfer(UserVisit userVisit, EntityGeoPointAttribute entityGeoPointAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityGeoPointAttributeTransferCache().getEntityGeoPointAttributeTransfer(entityGeoPointAttribute, entityInstance);
    }
    
    public void updateEntityGeoPointAttributeFromValue(EntityGeoPointAttributeValue entityGeoPointAttributeValue, BasePK updatedBy) {
        if(entityGeoPointAttributeValue.hasBeenModified()) {
            var entityGeoPointAttribute = EntityGeoPointAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityGeoPointAttributeValue);
            var entityAttribute = entityGeoPointAttribute.getEntityAttribute();
            var entityInstance = entityGeoPointAttribute.getEntityInstance();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityGeoPointAttribute.setThruTime(session.START_TIME_LONG);
                entityGeoPointAttribute.store();
            } else {
                entityGeoPointAttribute.remove();
            }
            
            EntityGeoPointAttributeFactory.getInstance().create(entityAttribute, entityInstance, entityGeoPointAttributeValue.getLatitude(),
                    entityGeoPointAttributeValue.getLongitude(), entityGeoPointAttributeValue.getElevation(), entityGeoPointAttributeValue.getAltitude(),
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityGeoPointAttribute(EntityGeoPointAttribute entityGeoPointAttribute, BasePK deletedBy) {
        var entityAttribute = entityGeoPointAttribute.getEntityAttribute();
        var entityInstance = entityGeoPointAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityGeoPointAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityGeoPointAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityGeoPointAttributes(List<EntityGeoPointAttribute> entityGeoPointAttributes, BasePK deletedBy) {
        entityGeoPointAttributes.forEach((entityGeoPointAttribute) -> 
                deleteEntityGeoPointAttribute(entityGeoPointAttribute, deletedBy)
        );
    }
    
    public void deleteEntityGeoPointAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityGeoPointAttributes(getEntityGeoPointAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityGeoPointAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityGeoPointAttributes(getEntityGeoPointAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Time Attributes
    // --------------------------------------------------------------------------------
    
    public EntityTimeAttribute createEntityTimeAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance, Long timeAttribute, BasePK createdBy) {
        var entityTimeAttribute = EntityTimeAttributeFactory.getInstance().create(entityAttribute, entityInstance, timeAttribute, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityTimeAttribute;
    }

    public long countEntityTimeAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entitytimeattributes
                    WHERE enta_ena_entityattributeid = ? AND enta_eni_entityinstanceid = ?
                    """, entityAttribute, entityInstance);
    }

    private static final Map<EntityPermission, String> getEntityTimeAttributeHistoryQueries;

    static {
        var queryMap = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entitytimeattributes
                WHERE enta_ena_entityattributeid = ? AND enta_eni_entityinstanceid = ?
                ORDER BY enta_thrutime
                _LIMIT_
                """);
        getEntityTimeAttributeHistoryQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<EntityTimeAttribute> getEntityTimeAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return EntityTimeAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityTimeAttributeHistoryQueries,
                entityAttribute, entityInstance);
    }

    private EntityTimeAttribute getEntityTimeAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance, EntityPermission entityPermission) {
        EntityTimeAttribute entityTimeAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitytimeattributes " +
                        "WHERE enta_ena_entityattributeid = ? AND enta_eni_entityinstanceid = ? AND enta_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitytimeattributes " +
                        "WHERE enta_ena_entityattributeid = ? AND enta_eni_entityinstanceid = ? AND enta_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityTimeAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityTimeAttribute = EntityTimeAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityTimeAttribute;
    }
    
    public EntityTimeAttribute getEntityTimeAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityTimeAttribute(entityAttribute, entityInstance, EntityPermission.READ_ONLY);
    }
    
    public EntityTimeAttribute getEntityTimeAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityTimeAttribute(entityAttribute, entityInstance, EntityPermission.READ_WRITE);
    }
    
    public EntityTimeAttributeValue getEntityTimeAttributeValueForUpdate(EntityTimeAttribute entityTimeAttribute) {
        return entityTimeAttribute == null? null: entityTimeAttribute.getEntityTimeAttributeValue().clone();
    }
    
    public EntityTimeAttributeValue getEntityTimeAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityTimeAttributeValueForUpdate(getEntityTimeAttributeForUpdate(entityAttribute, entityInstance));
    }
    
    public List<EntityTimeAttribute> getEntityTimeAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityTimeAttribute> entityTimeAttributes;
        
        try {
            var ps = EntityTimeAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitytimeattributes " +
                    "WHERE enta_ena_entityattributeid = ? AND enta_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityTimeAttributes = EntityTimeAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityTimeAttributes;
    }
    
    public List<EntityTimeAttribute> getEntityTimeAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityTimeAttribute> entityTimeAttributes;
        
        try {
            var ps = EntityTimeAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitytimeattributes " +
                    "WHERE enta_eni_entityinstanceid = ? AND enta_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityTimeAttributes = EntityTimeAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityTimeAttributes;
    }
    
    public EntityTimeAttributeTransfer getEntityTimeAttributeTransfer(UserVisit userVisit, EntityTimeAttribute entityTimeAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityTimeAttributeTransferCache().getEntityTimeAttributeTransfer(entityTimeAttribute, entityInstance);
    }
    
    public void updateEntityTimeAttributeFromValue(EntityTimeAttributeValue entityTimeAttributeValue, BasePK updatedBy) {
        if(entityTimeAttributeValue.hasBeenModified()) {
            var entityTimeAttribute = EntityTimeAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityTimeAttributeValue);
            var entityAttribute = entityTimeAttribute.getEntityAttribute();
            var entityInstance = entityTimeAttribute.getEntityInstance();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityTimeAttribute.setThruTime(session.START_TIME_LONG);
                entityTimeAttribute.store();
            } else {
                entityTimeAttribute.remove();
            }
            
            EntityTimeAttributeFactory.getInstance().create(entityAttribute, entityInstance, entityTimeAttributeValue.getTimeAttribute(), session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityTimeAttribute(EntityTimeAttribute entityTimeAttribute, BasePK deletedBy) {
        var entityAttribute = entityTimeAttribute.getEntityAttribute();
        var entityInstance = entityTimeAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityTimeAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityTimeAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityTimeAttributes(List<EntityTimeAttribute> entityTimeAttributes, BasePK deletedBy) {
        entityTimeAttributes.forEach((entityTimeAttribute) -> 
                deleteEntityTimeAttribute(entityTimeAttribute, deletedBy)
        );
    }
    
    public void deleteEntityTimeAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityTimeAttributes(getEntityTimeAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityTimeAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityTimeAttributes(getEntityTimeAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Blob Attributes
    // --------------------------------------------------------------------------------
    
    public EntityBlobAttribute createEntityBlobAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Language language, ByteArray blobAttribute, MimeType mimeType, BasePK createdBy) {
        var entityBlobAttribute = EntityBlobAttributeFactory.getInstance().create(entityAttribute,
                entityInstance, language, blobAttribute, mimeType, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityBlobAttribute;
    }
    
    private EntityBlobAttribute getEntityBlobAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Language language, EntityPermission entityPermission) {
        EntityBlobAttribute entityBlobAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityblobattributes " +
                        "WHERE enba_ena_entityattributeid = ? AND enba_eni_entityinstanceid = ? AND enba_lang_languageid = ? " +
                        "AND enba_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityblobattributes " +
                        "WHERE enba_ena_entityattributeid = ? AND enba_eni_entityinstanceid = ? AND enba_lang_languageid = ? " +
                        "AND enba_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityBlobAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, language.getPrimaryKey().getEntityId());
            ps.setLong(4, Session.MAX_TIME);
            
            entityBlobAttribute = EntityBlobAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityBlobAttribute;
    }
    
    public EntityBlobAttribute getEntityBlobAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        return getEntityBlobAttribute(entityAttribute, entityInstance, language, EntityPermission.READ_ONLY);
    }
    
    public EntityBlobAttribute getEntityBlobAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        return getEntityBlobAttribute(entityAttribute, entityInstance, language, EntityPermission.READ_WRITE);
    }
    
    public EntityBlobAttribute getBestEntityBlobAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        var entityBlobAttribute = getEntityBlobAttribute(entityAttribute, entityInstance, language);
        
        if(entityBlobAttribute == null && !language.getIsDefault()) {
            entityBlobAttribute = getEntityBlobAttribute(entityAttribute, entityInstance, getPartyControl().getDefaultLanguage());
        }
        
        return entityBlobAttribute;
    }
    
    public EntityBlobAttributeValue getEntityBlobAttributeValueForUpdate(EntityBlobAttribute entityBlobAttribute) {
        return entityBlobAttribute == null? null: entityBlobAttribute.getEntityBlobAttributeValue().clone();
    }
    
    public EntityBlobAttributeValue getEntityBlobAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        return getEntityBlobAttributeValueForUpdate(getEntityBlobAttributeForUpdate(entityAttribute, entityInstance, language));
    }
    
    public List<EntityBlobAttribute> getEntityBlobAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityBlobAttribute> entityBlobAttributes;
        
        try {
            var ps = EntityBlobAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityblobattributes " +
                    "WHERE enba_ena_entityattributeid = ? AND enba_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityBlobAttributes = EntityBlobAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityBlobAttributes;
    }
    
    public List<EntityBlobAttribute> getEntityBlobAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityBlobAttribute> entityBlobAttributes;
        
        try {
            var ps = EntityBlobAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityblobattributes " +
                    "WHERE enba_eni_entityinstanceid = ? AND enba_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityBlobAttributes = EntityBlobAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityBlobAttributes;
    }
    
    public EntityBlobAttributeTransfer getEntityBlobAttributeTransfer(UserVisit userVisit, EntityBlobAttribute entityBlobAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityBlobAttributeTransferCache().getEntityBlobAttributeTransfer(entityBlobAttribute, entityInstance);
    }
    
    public void updateEntityBlobAttributeFromValue(EntityBlobAttributeValue entityBlobAttributeValue, BasePK updatedBy) {
        if(entityBlobAttributeValue.hasBeenModified()) {
            var entityBlobAttribute = EntityBlobAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityBlobAttributeValue);
            var entityAttribute = entityBlobAttribute.getEntityAttribute();
            var entityInstance = entityBlobAttribute.getEntityInstance();
            var language = entityBlobAttribute.getLanguage();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityBlobAttribute.setThruTime(session.START_TIME_LONG);
                entityBlobAttribute.store();
            } else {
                entityBlobAttribute.remove();
            }
            
            EntityBlobAttributeFactory.getInstance().create(entityAttribute.getPrimaryKey(), entityInstance.getPrimaryKey(), language.getPrimaryKey(),
                    entityBlobAttributeValue.getBlobAttribute(), entityBlobAttributeValue.getMimeTypePK(), session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityBlobAttribute(EntityBlobAttribute entityBlobAttribute, BasePK deletedBy) {
        var entityAttribute = entityBlobAttribute.getEntityAttribute();
        var entityInstance = entityBlobAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityBlobAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityBlobAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityBlobAttributes(List<EntityBlobAttribute> entityBlobAttributes, BasePK deletedBy) {
        entityBlobAttributes.forEach((entityBlobAttribute) -> 
                deleteEntityBlobAttribute(entityBlobAttribute, deletedBy)
        );
    }
    
    public void deleteEntityBlobAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityBlobAttributes(getEntityBlobAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityBlobAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityBlobAttributes(getEntityBlobAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Clob Attributes
    // --------------------------------------------------------------------------------
    
    public EntityClobAttribute createEntityClobAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Language language, String clobAttribute, MimeType mimeType, BasePK createdBy) {
        var entityClobAttribute = EntityClobAttributeFactory.getInstance().create(entityAttribute,
                entityInstance, language, clobAttribute, mimeType, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityClobAttribute;
    }

    public long countEntityClobAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entityclobattributes
                    WHERE enca_ena_entityattributeid = ? AND enca_eni_entityinstanceid = ?
                    """, entityAttribute, entityInstance);
    }

    private static final Map<EntityPermission, String> getEntityClobAttributeHistoryQueries;

    static {
        var queryMap = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entityclobattributes
                WHERE enca_ena_entityattributeid = ? AND enca_eni_entityinstanceid = ?
                ORDER BY enca_thrutime
                _LIMIT_
                """);
        getEntityClobAttributeHistoryQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<EntityClobAttribute> getEntityClobAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return EntityClobAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityClobAttributeHistoryQueries,
                entityAttribute, entityInstance);
    }

    private EntityClobAttribute getEntityClobAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            Language language, EntityPermission entityPermission) {
        EntityClobAttribute entityClobAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityclobattributes " +
                        "WHERE enca_ena_entityattributeid = ? AND enca_eni_entityinstanceid = ? AND enca_lang_languageid = ? " +
                        "AND enca_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityclobattributes " +
                        "WHERE enca_ena_entityattributeid = ? AND enca_eni_entityinstanceid = ? AND enca_lang_languageid = ? " +
                        "AND enca_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityClobAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, language.getPrimaryKey().getEntityId());
            ps.setLong(4, Session.MAX_TIME);
            
            entityClobAttribute = EntityClobAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityClobAttribute;
    }
    
    public EntityClobAttribute getEntityClobAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        return getEntityClobAttribute(entityAttribute, entityInstance, language, EntityPermission.READ_ONLY);
    }
    
    public EntityClobAttribute getEntityClobAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        return getEntityClobAttribute(entityAttribute, entityInstance, language, EntityPermission.READ_WRITE);
    }
    
    public EntityClobAttribute getBestEntityClobAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        var entityClobAttribute = getEntityClobAttribute(entityAttribute, entityInstance, language);
        
        if(entityClobAttribute == null && !language.getIsDefault()) {
            entityClobAttribute = getEntityClobAttribute(entityAttribute, entityInstance, getPartyControl().getDefaultLanguage());
        }
        
        return entityClobAttribute;
    }
    
    public EntityClobAttributeValue getEntityClobAttributeValueForUpdate(EntityClobAttribute entityClobAttribute) {
        return entityClobAttribute == null? null: entityClobAttribute.getEntityClobAttributeValue().clone();
    }
    
    public EntityClobAttributeValue getEntityClobAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance, Language language) {
        return getEntityClobAttributeValueForUpdate(getEntityClobAttributeForUpdate(entityAttribute, entityInstance, language));
    }
    
    public List<EntityClobAttribute> getEntityClobAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityClobAttribute> entityClobAttributes;
        
        try {
            var ps = EntityClobAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityclobattributes " +
                    "WHERE enca_ena_entityattributeid = ? AND enca_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityClobAttributes = EntityClobAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityClobAttributes;
    }
    
    public List<EntityClobAttribute> getEntityClobAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityClobAttribute> entityClobAttributes;
        
        try {
            var ps = EntityClobAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityclobattributes " +
                    "WHERE enca_eni_entityinstanceid = ? AND enca_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityClobAttributes = EntityClobAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityClobAttributes;
    }
    
    public EntityClobAttributeTransfer getEntityClobAttributeTransfer(UserVisit userVisit, EntityClobAttribute entityClobAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityClobAttributeTransferCache().getEntityClobAttributeTransfer(entityClobAttribute, entityInstance);
    }
    
    public void updateEntityClobAttributeFromValue(EntityClobAttributeValue entityClobAttributeValue, BasePK updatedBy) {
        if(entityClobAttributeValue.hasBeenModified()) {
            var entityClobAttribute = EntityClobAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityClobAttributeValue);
            var entityAttribute = entityClobAttribute.getEntityAttribute();
            var entityInstance = entityClobAttribute.getEntityInstance();
            var language = entityClobAttribute.getLanguage();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityClobAttribute.setThruTime(session.START_TIME_LONG);
                entityClobAttribute.store();
            } else {
                entityClobAttribute.remove();
            }
            
            EntityClobAttributeFactory.getInstance().create(entityAttribute.getPrimaryKey(), entityInstance.getPrimaryKey(), language.getPrimaryKey(),
                    entityClobAttributeValue.getClobAttribute(), entityClobAttributeValue.getMimeTypePK(), session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityClobAttribute(EntityClobAttribute entityClobAttribute, BasePK deletedBy) {
        var entityAttribute = entityClobAttribute.getEntityAttribute();
        var entityInstance = entityClobAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityClobAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityClobAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityClobAttributes(List<EntityClobAttribute> entityClobAttributes, BasePK deletedBy) {
        entityClobAttributes.forEach((entityClobAttribute) -> 
                deleteEntityClobAttribute(entityClobAttribute, deletedBy)
        );
    }
    
    public void deleteEntityClobAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityClobAttributes(getEntityClobAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityClobAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityClobAttributes(getEntityClobAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Attribute Entity Types
    // --------------------------------------------------------------------------------
    
    public EntityAttributeEntityType createEntityAttributeEntityType(EntityAttribute entityAttribute, EntityType allowedEntityType, BasePK createdBy) {
        var entityAttributeEntityType = EntityAttributeEntityTypeFactory.getInstance().create(entityAttribute, allowedEntityType,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityAttribute.getPrimaryKey(), EventTypes.MODIFY, entityAttributeEntityType.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityAttributeEntityType;
    }
    
    public long countEntityAttributeEntityTypesByEntityAttribute(EntityAttribute entityAttribute) {
        return session.queryForLong(
                "SELECT COUNT(*) "
                + "FROM entityattributeentitytypes "
                + "WHERE enaent_ena_entityattributeid = ? AND enaent_thrutime = ?",
                entityAttribute, Session.MAX_TIME);
    }

    public long countEntityAttributeEntityTypesByAllowedEntityType(EntityType allowedEntityType) {
        return session.queryForLong(
                "SELECT COUNT(*) "
                + "FROM entityattributeentitytypes "
                + "WHERE enaent_allowedentitytypeid = ? AND enaent_thrutime = ?",
                allowedEntityType, Session.MAX_TIME);
    }

    public boolean entityAttributeEntityTypeExists(EntityAttribute entityAttribute, EntityType allowedEntityType) {
        return 1 == session.queryForLong(
                "SELECT COUNT(*) "
                + "FROM entityattributeentitytypes "
                + "WHERE enaent_ena_entityattributeid = ? AND enaent_allowedentitytypeid = ? AND enaent_thrutime = ?",
                entityAttribute, allowedEntityType, Session.MAX_TIME);
    }

    private static final Map<EntityPermission, String> getEntityAttributeEntityTypeQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM entityattributeentitytypes "
                + "WHERE enaent_ena_entityattributeid = ? AND enaent_allowedentitytypeid = ? AND enaent_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM entityattributeentitytypes "
                + "WHERE enaent_ena_entityattributeid = ? AND enaent_allowedentitytypeid = ? AND enaent_thrutime = ? "
                + "FOR UPDATE");
        getEntityAttributeEntityTypeQueries = Collections.unmodifiableMap(queryMap);
    }

    private EntityAttributeEntityType getEntityAttributeEntityType(EntityAttribute entityAttribute, EntityType allowedEntityType, EntityPermission entityPermission) {
        return EntityAttributeEntityTypeFactory.getInstance().getEntityFromQuery(entityPermission, getEntityAttributeEntityTypeQueries,
                entityAttribute, allowedEntityType, Session.MAX_TIME_LONG);
    }

    public EntityAttributeEntityType getEntityAttributeEntityType(EntityAttribute entityAttribute, EntityType allowedEntityType) {
        return getEntityAttributeEntityType(entityAttribute, allowedEntityType, EntityPermission.READ_ONLY);
    }

    public EntityAttributeEntityType getEntityAttributeEntityTypeForUpdate(EntityAttribute entityAttribute, EntityType allowedEntityType) {
        return getEntityAttributeEntityType(entityAttribute, allowedEntityType, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getEntityAttributeEntityTypesByEntityAttributeQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM entityattributeentitytypes, entitytypes, entitytypedetails, componentvendors, componentvendordetails "
                + "WHERE enaent_ena_entityattributeid = ? AND enaent_thrutime = ? "
                + "AND enaent_allowedentitytypeid = ent_entitytypeid AND ent_lastdetailid = entdt_entitytypedetailid "
                + "AND entdt_cvnd_componentvendorid = cvnd_componentvendorid AND cvnd_lastdetailid = cvndd_componentvendordetailid "
                + "ORDER BY entdt_sortorder, entdt_entitytypename, cvndd_componentvendorname "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM entityattributeentitytypes "
                + "WHERE enaent_ena_entityattributeid = ? AND enaent_thrutime = ? "
                + "FOR UPDATE");
        getEntityAttributeEntityTypesByEntityAttributeQueries = Collections.unmodifiableMap(queryMap);
    }
    
    private List<EntityAttributeEntityType> getEntityAttributeEntityTypesByEntityAttribute(EntityAttribute entityAttribute, EntityPermission entityPermission) {
        return EntityAttributeEntityTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, getEntityAttributeEntityTypesByEntityAttributeQueries,
                entityAttribute, Session.MAX_TIME_LONG);
    }
    
    public List<EntityAttributeEntityType> getEntityAttributeEntityTypesByEntityAttribute(EntityAttribute entityAttribute) {
        return getEntityAttributeEntityTypesByEntityAttribute(entityAttribute, EntityPermission.READ_ONLY);
    }
    
    public List<EntityAttributeEntityType> getEntityAttributeEntityTypesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        return getEntityAttributeEntityTypesByEntityAttribute(entityAttribute, EntityPermission.READ_WRITE);
    }
    
    private static final Map<EntityPermission, String> getEntityAttributeEntityTypesByAllowedEntityTypeQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM entityattributeentitytypes, entityattributes, entityattributedetails "
                + "WHERE enaent_allowedentitytypeid = ? AND enaent_thrutime = ? "
                + "AND enaent_ena_entityattributeid = ena_entityattributeid AND ena_lastdetailid = enadt_entityAttributedetailid "
                + "ORDER BY enadt_sortorder, enadt_entityAttributename");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM entityattributeentitytypes "
                + "WHERE enaent_ena_entityattributeid = ? AND enaent_thrutime = ? "
                + "FOR UPDATE");
        getEntityAttributeEntityTypesByAllowedEntityTypeQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<EntityAttributeEntityType> getEntityAttributeEntityTypesByAllowedEntityType(EntityType allowedEntityType, EntityPermission entityPermission) {
        return EntityAttributeEntityTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, getEntityAttributeEntityTypesByAllowedEntityTypeQueries,
                allowedEntityType, Session.MAX_TIME_LONG);
    }

    public List<EntityAttributeEntityType> getEntityAttributeEntityTypesByAllowedEntityType(EntityType allowedEntityType) {
        return getEntityAttributeEntityTypesByAllowedEntityType(allowedEntityType, EntityPermission.READ_ONLY);
    }

    public List<EntityAttributeEntityType> getEntityAttributeEntityTypesByAllowedEntityTypeForUpdate(EntityType allowedEntityType) {
        return getEntityAttributeEntityTypesByAllowedEntityType(allowedEntityType, EntityPermission.READ_WRITE);
    }

    public EntityAttributeEntityTypeTransfer getEntityAttributeEntityTypeTransfer(UserVisit userVisit, EntityAttributeEntityType entityAttributeEntityType, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityAttributeEntityTypeTransferCache().getEntityAttributeEntityTypeTransfer(entityAttributeEntityType, entityInstance);
    }
    
    public List<EntityAttributeEntityTypeTransfer> getEntityAttributeEntityTypeTransfers(UserVisit userVisit, Collection<EntityAttributeEntityType> entityAttributeEntityTypes, EntityInstance entityInstance) {
        List<EntityAttributeEntityTypeTransfer> entityAttributeEntityTypeTransfers = new ArrayList<>(entityAttributeEntityTypes.size());
        var entityAttributeEntityTypeTransferCache = getCoreTransferCaches(userVisit).getEntityAttributeEntityTypeTransferCache();

        entityAttributeEntityTypes.forEach((entityAttributeEntityType) ->
                entityAttributeEntityTypeTransfers.add(entityAttributeEntityTypeTransferCache.getEntityAttributeEntityTypeTransfer(entityAttributeEntityType, entityInstance))
        );

        return entityAttributeEntityTypeTransfers;
    }

    public List<EntityAttributeEntityTypeTransfer> getEntityAttributeEntityTypeTransfersByEntityAttribute(UserVisit userVisit, EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityAttributeEntityTypeTransfers(userVisit, getEntityAttributeEntityTypesByEntityAttribute(entityAttribute), entityInstance);
    }

    public List<EntityAttributeEntityTypeTransfer> getEntityAttributeEntityTypeTransfersByAllowedEntityType(UserVisit userVisit, EntityType allowedEntityType, EntityInstance entityInstance) {
        return getEntityAttributeEntityTypeTransfers(userVisit, getEntityAttributeEntityTypesByAllowedEntityType(allowedEntityType), entityInstance);
    }

    public void deleteEntityAttributeEntityType(EntityAttributeEntityType entityAttributeEntityType, BasePK deletedBy) {
        entityAttributeEntityType.setThruTime(session.START_TIME_LONG);
        
        sendEvent(entityAttributeEntityType.getEntityAttributePK(), EventTypes.MODIFY, entityAttributeEntityType.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityAttributeEntityTypes(List<EntityAttributeEntityType> entityAttributeEntityTypes, BasePK deletedBy) {
        entityAttributeEntityTypes.forEach((entityAttributeEntityType) -> 
                deleteEntityAttributeEntityType(entityAttributeEntityType, deletedBy)
        );
    }
    
    public void deleteEntityAttributeEntityTypesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityAttributeEntityTypes(getEntityAttributeEntityTypesByEntityAttributeForUpdate(entityAttribute),  deletedBy);
    }

    public void deleteEntityAttributeEntityTypesByAllowedEntityType(EntityType allowedEntityType, BasePK deletedBy) {
        deleteEntityAttributeEntityTypes(getEntityAttributeEntityTypesByAllowedEntityTypeForUpdate(allowedEntityType),  deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Entity Entity Attributes
    // --------------------------------------------------------------------------------
    
    public EntityEntityAttribute createEntityEntityAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityInstance entityInstanceAttribute, BasePK createdBy) {
        var entityEntityAttribute = EntityEntityAttributeFactory.getInstance().create(entityAttribute, entityInstance,
                entityInstanceAttribute, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityEntityAttribute;
    }

    public long countEntityEntityAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return session.queryForLong("""
                    SELECT COUNT(*)
                    FROM entityentityattributes
                    WHERE eea_ena_entityattributeid = ? AND eea_eni_entityinstanceid = ?
                    """, entityAttribute, entityInstance);
    }

    private static final Map<EntityPermission, String> getEntityEntityAttributeHistoryQueries;

    static {
        var queryMap = Map.of(
                EntityPermission.READ_ONLY, """
                SELECT _ALL_
                FROM entityentityattributes
                WHERE eea_ena_entityattributeid = ? AND eea_eni_entityinstanceid = ?
                ORDER BY eea_thrutime
                _LIMIT_
                """);
        getEntityEntityAttributeHistoryQueries = Collections.unmodifiableMap(queryMap);
    }

    public List<EntityEntityAttribute> getEntityEntityAttributeHistory(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return EntityEntityAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_ONLY, getEntityEntityAttributeHistoryQueries,
                entityAttribute, entityInstance);
    }

    private EntityEntityAttribute getEntityEntityAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance, EntityPermission entityPermission) {
        EntityEntityAttribute entityEntityAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityentityattributes " +
                        "WHERE eea_ena_entityattributeid = ? AND eea_eni_entityinstanceid = ? " +
                        "AND eea_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityentityattributes " +
                        "WHERE eea_ena_entityattributeid = ? AND eea_eni_entityinstanceid = ? " +
                        "AND eea_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityEntityAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityEntityAttribute = EntityEntityAttributeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityEntityAttribute;
    }
    
    public EntityEntityAttribute getEntityEntityAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityEntityAttribute(entityAttribute, entityInstance, EntityPermission.READ_ONLY);
    }
    
    public EntityEntityAttribute getEntityEntityAttributeForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityEntityAttribute(entityAttribute, entityInstance, EntityPermission.READ_WRITE);
    }
    
    public EntityEntityAttributeValue getEntityEntityAttributeValueForUpdate(EntityEntityAttribute entityEntityAttribute) {
        return entityEntityAttribute == null? null: entityEntityAttribute.getEntityEntityAttributeValue().clone();
    }
    
    public EntityEntityAttributeValue getEntityEntityAttributeValueForUpdate(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        return getEntityEntityAttributeValueForUpdate(getEntityEntityAttributeForUpdate(entityAttribute, entityInstance));
    }
    
    public List<EntityEntityAttribute> getEntityEntityAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityEntityAttribute> entityEntityAttributes;
        
        try {
            var ps = EntityEntityAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityentityattributes " +
                    "WHERE eea_eni_entityinstanceid = ? AND eea_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityEntityAttributes = EntityEntityAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityEntityAttributes;
    }
    
    public List<EntityEntityAttribute> getEntityEntityAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityEntityAttribute> entityEntityAttributes;
        
        try {
            var ps = EntityEntityAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityentityattributes " +
                    "WHERE eea_eni_entityinstanceid = ? AND eea_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityEntityAttributes = EntityEntityAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityEntityAttributes;
    }
    
    public List<EntityEntityAttribute> getEntityEntityAttributesByEntityInstanceAttributeForUpdate(EntityInstance entityInstanceAttribute) {
        List<EntityEntityAttribute> entityEntityAttributes;
        
        try {
            var ps = EntityEntityAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityentityattributes " +
                    "WHERE eea_entityinstanceattributeid = ? AND eea_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstanceAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityEntityAttributes = EntityEntityAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityEntityAttributes;
    }
    
    public EntityEntityAttributeTransfer getEntityEntityAttributeTransfer(UserVisit userVisit, EntityEntityAttribute entityEntityAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityEntityAttributeTransferCache().getEntityEntityAttributeTransfer(entityEntityAttribute, entityInstance);
    }
    
    public void updateEntityEntityAttributeFromValue(EntityEntityAttributeValue entityEntityAttributeValue, BasePK updatedBy) {
        if(entityEntityAttributeValue.hasBeenModified()) {
            var entityEntityAttribute = EntityEntityAttributeFactory.getInstance().getEntityFromValue(session, EntityPermission.READ_WRITE, entityEntityAttributeValue);
            var entityAttribute = entityEntityAttribute.getEntityAttribute();
            var entityInstance = entityEntityAttribute.getEntityInstance();
            
            if(entityAttribute.getLastDetail().getTrackRevisions()) {
                entityEntityAttribute.setThruTime(session.START_TIME_LONG);
                entityEntityAttribute.store();
            } else {
                entityEntityAttribute.remove();
            }
            
            EntityEntityAttributeFactory.getInstance().create(entityAttribute.getPrimaryKey(), entityInstance.getPrimaryKey(),
                    entityEntityAttributeValue.getEntityInstanceAttributePK(), session.START_TIME_LONG, Session.MAX_TIME_LONG);
            
            sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }
    
    public void deleteEntityEntityAttribute(EntityEntityAttribute entityEntityAttribute, BasePK deletedBy) {
        var entityAttribute = entityEntityAttribute.getEntityAttribute();
        var entityInstance = entityEntityAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityEntityAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityEntityAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityEntityAttributes(List<EntityEntityAttribute> entityEntityAttributes, BasePK deletedBy) {
        entityEntityAttributes.forEach((entityEntityAttribute) -> 
                deleteEntityEntityAttribute(entityEntityAttribute, deletedBy)
        );
    }
    
    public void deleteEntityEntityAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityEntityAttributes(getEntityEntityAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityEntityAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityEntityAttributes(getEntityEntityAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
        deleteEntityEntityAttributes(getEntityEntityAttributesByEntityInstanceAttributeForUpdate(entityInstance), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Collection Attributes
    // --------------------------------------------------------------------------------
    
    public EntityCollectionAttribute createEntityCollectionAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityInstance entityInstanceAttribute, BasePK createdBy) {
        var entityCollectionAttribute = EntityCollectionAttributeFactory.getInstance().create(entityAttribute, entityInstance,
                entityInstanceAttribute, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return entityCollectionAttribute;
    }
    
    public List<EntityCollectionAttribute> getEntityCollectionAttributes(EntityAttribute entityAttribute, EntityInstance entityInstance) {
        List<EntityCollectionAttribute> entityCollectionAttributes;
        
        try {
            var ps = EntityCollectionAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ "
                    + "FROM entitycollectionattributes, entityinstances, entitytypes, entitytypedetails, componentvendors, componentvendordetails "
                    + "WHERE eca_ena_entityattributeid = ? AND eca_eni_entityinstanceid = ? AND eca_thrutime = ? "
                    + "AND eca_entityinstanceattributeid = eni_entityinstanceid "
                    + "AND eni_ent_entitytypeid = ent_entitytypeid AND ent_lastdetailid = entdt_entitytypedetailid "
                    + "AND entdt_cvnd_componentvendorid = cvnd_componentvendorid AND cvnd_lastdetailid = cvndd_componentvendordetailid "
                    + "ORDER BY cvndd_componentvendorname, entdt_sortorder, entdt_entitytypename, eni_entityuniqueid");

            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            entityCollectionAttributes = EntityCollectionAttributeFactory.getInstance().getEntitiesFromQuery(session,
                    EntityPermission.READ_ONLY, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityCollectionAttributes;
    }
    
    private EntityCollectionAttribute getEntityCollectionAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityInstance entityInstanceAttribute, EntityPermission entityPermission) {
        EntityCollectionAttribute entityCollectionAttribute;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entitycollectionattributes " +
                        "WHERE eca_ena_entityattributeid = ? AND eca_eni_entityinstanceid = ? AND eca_entityinstanceattributeid = ? " +
                        "AND eca_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entitycollectionattributes " +
                        "WHERE eca_ena_entityattributeid = ? AND eca_eni_entityinstanceid = ? AND eca_entityinstanceattributeid = ? " +
                        "AND eca_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityCollectionAttributeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(3, entityInstanceAttribute.getPrimaryKey().getEntityId());
            ps.setLong(4, Session.MAX_TIME);
            
            entityCollectionAttribute = EntityCollectionAttributeFactory.getInstance().getEntityFromQuery(session,
                    entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityCollectionAttribute;
    }
    
    public EntityCollectionAttribute getEntityCollectionAttribute(EntityAttribute entityAttribute, EntityInstance entityInstance,
            EntityInstance entityInstanceAttribute) {
        return getEntityCollectionAttribute(entityAttribute, entityInstance, entityInstanceAttribute, EntityPermission.READ_ONLY);
    }
    
    public EntityCollectionAttribute getEntityCollectionAttributeForUpdate(EntityAttribute entityAttribute,
            EntityInstance entityInstance, EntityInstance entityInstanceAttribute) {
        return getEntityCollectionAttribute(entityAttribute, entityInstance, entityInstanceAttribute, EntityPermission.READ_WRITE);
    }
    
    public List<EntityCollectionAttribute> getEntityCollectionAttributesByEntityAttributeForUpdate(EntityAttribute entityAttribute) {
        List<EntityCollectionAttribute> entityCollectionAttributes;
        
        try {
            var ps = EntityCollectionAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitycollectionattributes " +
                    "WHERE eca_eni_entityinstanceid = ? AND eca_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityCollectionAttributes = EntityCollectionAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityCollectionAttributes;
    }
    
    public List<EntityCollectionAttribute> getEntityCollectionAttributesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityCollectionAttribute> entityCollectionAttributes;
        
        try {
            var ps = EntityCollectionAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitycollectionattributes " +
                    "WHERE eca_eni_entityinstanceid = ? AND eca_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityCollectionAttributes = EntityCollectionAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityCollectionAttributes;
    }
    
    public List<EntityCollectionAttribute> getEntityCollectionAttributesByEntityInstanceAttributeForUpdate(EntityInstance entityInstanceAttribute) {
        List<EntityCollectionAttribute> entityCollectionAttributes;
        
        try {
            var ps = EntityCollectionAttributeFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entitycollectionattributes " +
                    "WHERE eca_entityinstanceattributeid = ? AND eca_thrutime = ? " +
                    "FOR UPDATE");
            
            ps.setLong(1, entityInstanceAttribute.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            entityCollectionAttributes = EntityCollectionAttributeFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityCollectionAttributes;
    }
    
    public EntityCollectionAttributeTransfer getEntityCollectionAttributeTransfer(UserVisit userVisit, EntityCollectionAttribute entityCollectionAttribute, EntityInstance entityInstance) {
        return getCoreTransferCaches(userVisit).getEntityCollectionAttributeTransferCache().getEntityCollectionAttributeTransfer(entityCollectionAttribute, entityInstance);
    }
    
    public List<EntityCollectionAttributeTransfer> getEntityCollectionAttributeTransfers(UserVisit userVisit, Collection<EntityCollectionAttribute> entityCollectionAttributes, EntityInstance entityInstance) {
        List<EntityCollectionAttributeTransfer> entityCollectionAttributeTransfers = new ArrayList<>(entityCollectionAttributes.size());
        var entityCollectionAttributeTransferCache = getCoreTransferCaches(userVisit).getEntityCollectionAttributeTransferCache();
        
        entityCollectionAttributes.forEach((entityCollectionAttribute) ->
                entityCollectionAttributeTransfers.add(entityCollectionAttributeTransferCache.getEntityCollectionAttributeTransfer(entityCollectionAttribute, entityInstance))
        );
        
        return entityCollectionAttributeTransfers;
    }
    
    public List<EntityCollectionAttributeTransfer> getEntityCollectionAttributeTransfers(UserVisit userVisit, EntityAttribute entityAttribute,
            EntityInstance entityInstance) {
        return getEntityCollectionAttributeTransfers(userVisit, getEntityCollectionAttributes(entityAttribute, entityInstance), entityInstance);
    }
    
    public void deleteEntityCollectionAttribute(EntityCollectionAttribute entityCollectionAttribute, BasePK deletedBy) {
        var entityAttribute = entityCollectionAttribute.getEntityAttribute();
        var entityInstance = entityCollectionAttribute.getEntityInstance();
        
        if(entityAttribute.getLastDetail().getTrackRevisions()) {
            entityCollectionAttribute.setThruTime(session.START_TIME_LONG);
        } else {
            entityCollectionAttribute.remove();
        }
        
        sendEvent(entityInstance, EventTypes.MODIFY, entityAttribute.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }
    
    public void deleteEntityCollectionAttributes(List<EntityCollectionAttribute> entityCollectionAttributes, BasePK deletedBy) {
        entityCollectionAttributes.forEach((entityCollectionAttribute) -> 
                deleteEntityCollectionAttribute(entityCollectionAttribute, deletedBy)
        );
    }
    
    public void deleteEntityCollectionAttributesByEntityAttribute(EntityAttribute entityAttribute, BasePK deletedBy) {
        deleteEntityCollectionAttributes(getEntityCollectionAttributesByEntityAttributeForUpdate(entityAttribute), deletedBy);
    }
    
    public void deleteEntityCollectionAttributesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEntityCollectionAttributes(getEntityCollectionAttributesByEntityInstanceForUpdate(entityInstance), deletedBy);
        deleteEntityCollectionAttributes(getEntityCollectionAttributesByEntityInstanceAttributeForUpdate(entityInstance), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Base Encryption Keys
    // --------------------------------------------------------------------------------
    
    public BaseEncryptionKey createBaseEncryptionKey(ExecutionErrorAccumulator eea, BaseKey baseKey1, BaseKey baseKey2, PartyPK createdBy) {
        var activeBaseEncryptionKey = getActiveBaseEncryptionKey();
        BaseEncryptionKey baseEncryptionKey = null;
        
        if(activeBaseEncryptionKey != null) {
            setBaseEncryptionKeyStatus(eea, activeBaseEncryptionKey, WorkflowDestination_BASE_ENCRYPTION_KEY_STATUS_ACTIVE_TO_INACTIVE, createdBy);
        }
        
        if(!eea.hasExecutionErrors()) {
            var sequenceControl = Session.getModelController(SequenceControl.class);
            var sequence = sequenceControl.getDefaultSequenceUsingNames(SequenceTypes.BASE_ENCRYPTION_KEY.name());
            var baseEncryptionKeyName = SequenceGeneratorLogic.getInstance().getNextSequenceValue(sequence);
            var sha1Hash = Sha1Utils.getInstance().encode(baseKey1, baseKey2);
            baseEncryptionKey = createBaseEncryptionKey(baseEncryptionKeyName, sha1Hash, createdBy);

            var entityInstance = getEntityInstanceByBaseEntity(baseEncryptionKey);
            getWorkflowControl().addEntityToWorkflowUsingNames(null, Workflow_BASE_ENCRYPTION_KEY_STATUS, entityInstance, null, null,createdBy);
        }
        
        return baseEncryptionKey;
    }
    
    public BaseEncryptionKey createBaseEncryptionKey(String baseEncryptionKeyName, String sha1Hash, BasePK createdBy) {
        var baseEncryptionKey = BaseEncryptionKeyFactory.getInstance().create(baseEncryptionKeyName,
                sha1Hash);
        
        sendEvent(baseEncryptionKey.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return baseEncryptionKey;
    }
    
    private List<BaseEncryptionKey> getBaseEncryptionKeys(EntityPermission entityPermission) {
        String query = null;
        
        if(entityPermission.equals(EntityPermission.READ_ONLY)) {
            query = "SELECT _ALL_ " +
                    "FROM baseencryptionkeys " +
                    "ORDER BY bek_baseencryptionkeyname";
        } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
            query = "SELECT _ALL_ " +
                    "FROM baseencryptionkeys " +
                    "FOR UPDATE";
        }

        var ps = BaseEncryptionKeyFactory.getInstance().prepareStatement(query);
        
        return BaseEncryptionKeyFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
    }
    
    public List<BaseEncryptionKey> getBaseEncryptionKeys() {
        return getBaseEncryptionKeys(EntityPermission.READ_ONLY);
    }
    
    public List<BaseEncryptionKey> getBaseEncryptionKeysForUpdate() {
        return getBaseEncryptionKeys(EntityPermission.READ_WRITE);
    }
    
    private BaseEncryptionKey getActiveBaseEncryptionKey(EntityPermission entityPermission) {
        var workflowStep = getWorkflowControl().getWorkflowStepUsingNames(Workflow_BASE_ENCRYPTION_KEY_STATUS,
                WorkflowStep_BASE_ENCRYPTION_KEY_STATUS_ACTIVE);
        BaseEncryptionKey baseEncryptionKey = null;
        
        if(workflowStep != null) {
            List<BaseEncryptionKey> baseEncryptionKeys;
            
            try {
                var query = new StringBuilder("SELECT _ALL_ " +
                        "FROM componentvendors, componentvendordetails, entitytypes, entitytypedetails, entityinstances, " +
                        "baseencryptionkeys, workflowentitystatuses, entitytimes " +
                        "WHERE cvnd_activedetailid = cvndd_componentvendordetailid AND cvndd_componentvendorname = ? " +
                        "AND ent_activedetailid = entdt_entitytypedetailid " +
                        "AND cvnd_componentvendorid = entdt_cvnd_componentvendorid " +
                        "AND entdt_entitytypename = ? " +
                        "AND ent_entitytypeid = eni_ent_entitytypeid AND bek_baseencryptionkeyid = eni_entityuniqueid " +
                        "AND eni_entityinstanceid = wkfles_eni_entityinstanceid AND wkfles_wkfls_workflowstepid = ? AND wkfles_thrutime = ? " +
                        "AND eni_entityinstanceid = etim_eni_entityinstanceid ");
                
                if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                    query.append("ORDER BY etim_createdtime DESC");
                } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                    query.append("FOR UPDATE");
                }

                var ps = BaseEncryptionKeyFactory.getInstance().prepareStatement(query.toString());
                
                ps.setString(1, ComponentVendors.ECHO_THREE.name());
                ps.setString(2, EntityTypes.BaseEncryptionKey.name());
                ps.setLong(3, workflowStep.getPrimaryKey().getEntityId());
                ps.setLong(4, Session.MAX_TIME);
                
                baseEncryptionKeys = BaseEncryptionKeyFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
            } catch (SQLException se) {
                throw new PersistenceDatabaseException(se);
            }
            
            if(!baseEncryptionKeys.isEmpty()) {
                baseEncryptionKey = baseEncryptionKeys.iterator().next();
            }
        }
        
        return baseEncryptionKey;
    }
    
    public BaseEncryptionKey getActiveBaseEncryptionKey() {
        return getActiveBaseEncryptionKey(EntityPermission.READ_ONLY);
    }
    
    public BaseEncryptionKey getActiveBaseEncryptionKeyForUpdate() {
        return getActiveBaseEncryptionKey(EntityPermission.READ_WRITE);
    }
    
    private BaseEncryptionKey getBaseEncryptionKeyByName(String baseEncryptionKeyName, EntityPermission entityPermission) {
        BaseEncryptionKey baseEncryptionKey;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM baseencryptionkeys " +
                        "WHERE bek_baseencryptionkeyname = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM baseencryptionkeys " +
                        "WHERE bek_baseencryptionkeyname = ? " +
                        "FOR UPDATE";
            }

            var ps = BaseEncryptionKeyFactory.getInstance().prepareStatement(query);
            
            ps.setString(1, baseEncryptionKeyName);
            
            baseEncryptionKey = BaseEncryptionKeyFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return baseEncryptionKey;
    }
    
    public BaseEncryptionKey getBaseEncryptionKeyByName(String baseEncryptionKeyName) {
        return getBaseEncryptionKeyByName(baseEncryptionKeyName, EntityPermission.READ_ONLY);
    }
    
    public BaseEncryptionKey getBaseEncryptionKeyByNameForUpdate(String baseEncryptionKeyName) {
        return getBaseEncryptionKeyByName(baseEncryptionKeyName, EntityPermission.READ_WRITE);
    }
    
    private BaseEncryptionKey getBaseEncryptionKeyBySha1Hash(String sha1Hash, EntityPermission entityPermission) {
        BaseEncryptionKey baseEncryptionKey;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM baseencryptionkeys " +
                        "WHERE bek_sha1hash = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM baseencryptionkeys " +
                        "WHERE bek_sha1hash = ? " +
                        "FOR UPDATE";
            }

            var ps = BaseEncryptionKeyFactory.getInstance().prepareStatement(query);
            
            ps.setString(1, sha1Hash);
            
            baseEncryptionKey = BaseEncryptionKeyFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return baseEncryptionKey;
    }
    
    public BaseEncryptionKey getBaseEncryptionKeyBySha1Hash(String sha1Hash) {
        return getBaseEncryptionKeyBySha1Hash(sha1Hash, EntityPermission.READ_ONLY);
    }
    
    public BaseEncryptionKey getBaseEncryptionKeyBySha1HashForUpdate(String sha1Hash) {
        return getBaseEncryptionKeyBySha1Hash(sha1Hash, EntityPermission.READ_WRITE);
    }
    
    public BaseEncryptionKeyTransfer getBaseEncryptionKeyTransfer(UserVisit userVisit, BaseEncryptionKey baseEncryptionKey) {
        return getCoreTransferCaches(userVisit).getBaseEncryptionKeyTransferCache().getBaseEncryptionKeyTransfer(baseEncryptionKey);
    }
    
    public BaseEncryptionKeyTransfer getActiveBaseEncryptionKeyTransfer(UserVisit userVisit) {
        return getCoreTransferCaches(userVisit).getBaseEncryptionKeyTransferCache().getBaseEncryptionKeyTransfer(getActiveBaseEncryptionKey());
    }
    
    public List<BaseEncryptionKeyTransfer> getBaseEncryptionKeyTransfers(UserVisit userVisit) {
        var baseEncryptionKeys = getBaseEncryptionKeys();
        List<BaseEncryptionKeyTransfer> baseEncryptionKeyTransfers = new ArrayList<>(baseEncryptionKeys.size());
        var baseEncryptionKeyTransferCache = getCoreTransferCaches(userVisit).getBaseEncryptionKeyTransferCache();
        
        baseEncryptionKeys.forEach((baseEncryptionKey) ->
                baseEncryptionKeyTransfers.add(baseEncryptionKeyTransferCache.getBaseEncryptionKeyTransfer(baseEncryptionKey))
        );
        
        return baseEncryptionKeyTransfers;
    }
    
    public BaseEncryptionKeyStatusChoicesBean getBaseEncryptionKeyStatusChoices(String defaultBaseEncryptionKeyStatusChoice,
            Language language, boolean allowNullChoice, BaseEncryptionKey baseEncryptionKey, PartyPK partyPK) {
        var workflowControl = getWorkflowControl();
        var baseEncryptionKeyStatusChoicesBean = new BaseEncryptionKeyStatusChoicesBean();
        
        if(baseEncryptionKey == null) {
            workflowControl.getWorkflowEntranceChoices(baseEncryptionKeyStatusChoicesBean, defaultBaseEncryptionKeyStatusChoice, language, allowNullChoice,
                    workflowControl.getWorkflowByName(Workflow_BASE_ENCRYPTION_KEY_STATUS), partyPK);
        } else {
            var entityInstance = getCoreControl().getEntityInstanceByBasePK(baseEncryptionKey.getPrimaryKey());
            var workflowEntityStatus = workflowControl.getWorkflowEntityStatusByEntityInstanceUsingNames(Workflow_BASE_ENCRYPTION_KEY_STATUS,
                    entityInstance);
            
            workflowControl.getWorkflowDestinationChoices(baseEncryptionKeyStatusChoicesBean, defaultBaseEncryptionKeyStatusChoice, language, allowNullChoice,
                    workflowEntityStatus.getWorkflowStep(), partyPK);
        }
        
        return baseEncryptionKeyStatusChoicesBean;
    }
    
    public void setBaseEncryptionKeyStatus(ExecutionErrorAccumulator eea, BaseEncryptionKey baseEncryptionKey, String baseEncryptionKeyStatusChoice, PartyPK modifiedBy) {
        var workflowControl = getWorkflowControl();
        var entityInstance = getEntityInstanceByBaseEntity(baseEncryptionKey);
        var workflowEntityStatus = workflowControl.getWorkflowEntityStatusByEntityInstanceForUpdateUsingNames(Workflow_BASE_ENCRYPTION_KEY_STATUS,
                entityInstance);
        var workflowDestination = baseEncryptionKeyStatusChoice == null? null:
            workflowControl.getWorkflowDestinationByName(workflowEntityStatus.getWorkflowStep(), baseEncryptionKeyStatusChoice);
        
        if(workflowDestination != null || baseEncryptionKeyStatusChoice == null) {
            workflowControl.transitionEntityInWorkflow(eea, workflowEntityStatus, workflowDestination, null, modifiedBy);
        } else {
            eea.addExecutionError(ExecutionErrors.UnknownBaseEncryptionKeyStatusChoice.name(), baseEncryptionKeyStatusChoice);
        }
    }
    
    // --------------------------------------------------------------------------------
    //   Entity Encryption Keys
    // --------------------------------------------------------------------------------
    
    public EntityEncryptionKey createEntityEncryptionKey(String entityEncryptionKeyName, Boolean isExternal, String secretKey, String initializationVector) {
        return EntityEncryptionKeyFactory.getInstance().create(entityEncryptionKeyName, isExternal, secretKey, initializationVector);
    }
    
    private EntityEncryptionKey getEntityEncryptionKeyByName(String entityEncryptionKeyName, EntityPermission entityPermission) {
        EntityEncryptionKey entityEncryptionKey;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM entityencryptionkeys " +
                        "WHERE eek_entityencryptionkeyname = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM entityencryptionkeys " +
                        "WHERE eek_entityencryptionkeyname = ? " +
                        "FOR UPDATE";
            }

            var ps = EntityEncryptionKeyFactory.getInstance().prepareStatement(query);
            
            ps.setString(1, entityEncryptionKeyName);
            
            entityEncryptionKey = EntityEncryptionKeyFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return entityEncryptionKey;
    }
    
    public EntityEncryptionKey getEntityEncryptionKeyByName(String entityEncryptionKeyName) {
        return getEntityEncryptionKeyByName(entityEncryptionKeyName, EntityPermission.READ_ONLY);
    }
    
    public EntityEncryptionKey getEntityEncryptionKeyByNameForUpdate(String entityEncryptionKeyName) {
        return getEntityEncryptionKeyByName(entityEncryptionKeyName, EntityPermission.READ_WRITE);
    }
    
    public List<EntityEncryptionKey> getEntityEncryptionKeysForUpdate() {
        var ps = EntityEncryptionKeyFactory.getInstance().prepareStatement(
                "SELECT _ALL_ " +
                "FROM entityencryptionkeys " +
                "FOR UPDATE");
        
        return EntityEncryptionKeyFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
    }
    
    public long countEntityEncryptionKeys() {
        return session.queryForLong(
                "SELECT COUNT(*) " +
                "FROM entityencryptionkeys");
    }
    
    // --------------------------------------------------------------------------------
    //   Event Subscribers
    // --------------------------------------------------------------------------------
    
    public EventSubscriber createEventSubscriber(EntityInstance entityInstance, String description, Integer sortOrder,
            BasePK createdBy) {
        var sequenceControl = Session.getModelController(SequenceControl.class);
        var sequenceType = sequenceControl.getSequenceTypeByName(SequenceTypes.EVENT_SUBSCRIBER.name());
        var sequence = sequenceControl.getDefaultSequence(sequenceType);
        var eventSubscriberName = SequenceGeneratorLogic.getInstance().getNextSequenceValue(sequence);
        
        return createEventSubscriber(eventSubscriberName, entityInstance, description, sortOrder, createdBy);
    }
    
    public EventSubscriber createEventSubscriber(String eventSubscriberName, EntityInstance entityInstance, String description,
            Integer sortOrder, BasePK createdBy) {
        var eventSubscriber = EventSubscriberFactory.getInstance().create();
        var eventSubscriberDetail = EventSubscriberDetailFactory.getInstance().create(session,
                eventSubscriber, eventSubscriberName, entityInstance, description, sortOrder, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);
        
        // Convert to R/W
        eventSubscriber = EventSubscriberFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                eventSubscriber.getPrimaryKey());
        eventSubscriber.setActiveDetail(eventSubscriberDetail);
        eventSubscriber.setLastDetail(eventSubscriberDetail);
        eventSubscriber.store();
        
        sendEvent(eventSubscriber.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);
        
        return eventSubscriber;
    }
    
    private EventSubscriber getEventSubscriberByName(String eventSubscriberName, EntityPermission entityPermission) {
        EventSubscriber eventSubscriber;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM eventsubscribers, eventsubscriberdetails " +
                        "WHERE evs_activedetailid = evsdt_eventsubscriberdetailid AND evsdt_eventsubscribername = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM eventsubscribers, eventsubscriberdetails " +
                        "WHERE evs_activedetailid = evsdt_eventsubscriberdetailid AND evsdt_eventsubscribername = ? " +
                        "FOR UPDATE";
            }

            var ps = EventSubscriberFactory.getInstance().prepareStatement(query);
            
            ps.setString(1, eventSubscriberName);
            
            eventSubscriber = EventSubscriberFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return eventSubscriber;
    }
    
    public EventSubscriber getEventSubscriberByName(String eventSubscriberName) {
        return getEventSubscriberByName(eventSubscriberName, EntityPermission.READ_ONLY);
    }
    
    public EventSubscriber getEventSubscriberByNameForUpdate(String eventSubscriberName) {
        return getEventSubscriberByName(eventSubscriberName, EntityPermission.READ_WRITE);
    }
    
    private List<EventSubscriber> getEventSubscribersByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        List<EventSubscriber> eventSubscribers;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM eventsubscribers, eventsubscriberdetails " +
                        "WHERE evs_activedetailid = evsdt_eventsubscriberdetailid AND evsdt_eni_entityinstanceid = ? " +
                        "ORDER BY evsdt_sortorder, evsdt_eventsubscribername";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM eventsubscribers, eventsubscriberdetails " +
                        "WHERE evs_activedetailid = evsdt_eventsubscriberdetailid AND evsdt_eni_entityinstanceid = ? " +
                        "FOR UPDATE";
            }

            var ps = EventSubscriberFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            
            eventSubscribers = EventSubscriberFactory.getInstance().getEntitiesFromQuery(entityPermission,
                    ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return eventSubscribers;
    }
    
    public List<EventSubscriber> getEventSubscribersByEntityInstance(EntityInstance entityInstance) {
        return getEventSubscribersByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }
    
    public List<EventSubscriber> getEventSubscribersByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getEventSubscribersByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }
    
//    public EventSubscriberTransfer getEventSubscriberTransfer(UserVisit userVisit, EventSubscriber eventSubscriber) {
//        return getPaymentTransferCaches(userVisit).getEventSubscriberTransferCache().getEventSubscriberTransfer(eventSubscriber);
//    }
//    
//    public List<EventSubscriberTransfer> getEventSubscriberTransfersByEntityInstance(UserVisit userVisit, EntityInstance entityInstance) {
//        List<EventSubscriber> eventSubscribers = getEventSubscribersByEntityInstance(entityInstance);
//        List<EventSubscriberTransfer> eventSubscriberTransfers = new ArrayList<EventSubscriberTransfer>(eventSubscribers.size());
//        EventSubscriberTransferCache eventSubscriberTransferCache = getPaymentTransferCaches(userVisit).getEventSubscriberTransferCache();
//        
//        for(var eventSubscriber : eventSubscribers) {
//            eventSubscriberTransfers.add(eventSubscriberTransferCache.getEventSubscriberTransfer(eventSubscriber));
//        }
//        
//        return eventSubscriberTransfers;
//    }
    
    public void deleteEventSubscriber(EventSubscriber eventSubscriber, BasePK deletedBy) {
        removeQueuedSubscriberEventsByEventSubscriber(eventSubscriber);

        var eventSubscriberDetail = eventSubscriber.getLastDetailForUpdate();
        eventSubscriberDetail.setThruTime(session.START_TIME_LONG);
        eventSubscriber.setActiveDetail(null);
        eventSubscriber.store();
        
        sendEvent(eventSubscriber.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }
    
    public void deleteEventSubscribers(List<EventSubscriber> eventSubscribers, BasePK deletedBy) {
        eventSubscribers.forEach((eventSubscriber) -> 
                deleteEventSubscriber(eventSubscriber, deletedBy)
        );
    }
    
    public void deleteEventSubscribersByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        deleteEventSubscribers(getEventSubscribersByEntityInstanceForUpdate(entityInstance), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Queued Events
    // --------------------------------------------------------------------------------
    
    public QueuedSubscriberEvent createQueuedSubscriberEvent(EventSubscriber eventSubscriber, Event event) {
        return QueuedSubscriberEventFactory.getInstance().create(eventSubscriber, event);
    }
    
    private List<QueuedSubscriberEvent> getQueuedSubscriberEventsByEventSubscriber(EventSubscriber eventSubscriber,
            EntityPermission entityPermission) {
        List<QueuedSubscriberEvent> queuedSubscriberEvents;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM queuedsubscriberevents, events " +
                        "WHERE qsev_evs_eventsubscriberid = ? AND qsev_ev_eventid = ev_eventid " +
                        "ORDER BY ev_eventtime";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM queuedsubscriberevents " +
                        "WHERE qsev_evs_eventsubscriberid = ? " +
                        "FOR UPDATE";
            }

            var ps = QueuedSubscriberEventFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, eventSubscriber.getPrimaryKey().getEntityId());
            
            queuedSubscriberEvents = QueuedSubscriberEventFactory.getInstance().getEntitiesFromQuery(entityPermission,
                    ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return queuedSubscriberEvents;
    }
    
    public List<QueuedSubscriberEvent> getQueuedSubscriberEventsByEventSubscriber(EventSubscriber eventSubscriber) {
        return getQueuedSubscriberEventsByEventSubscriber(eventSubscriber, EntityPermission.READ_ONLY);
    }
    
    public List<QueuedSubscriberEvent> getQueuedSubscriberEventsByEventSubscriberForUpdate(EventSubscriber eventSubscriber) {
        return getQueuedSubscriberEventsByEventSubscriber(eventSubscriber, EntityPermission.READ_WRITE);
    }
    
    public void removeQueuedSubscriberEvent(QueuedSubscriberEvent queuedSubscriberEvent) {
        queuedSubscriberEvent.remove();
    }
    
    public void removeQueuedSubscriberEvents(List<QueuedSubscriberEvent> queuedSubscriberEvents) {
        queuedSubscriberEvents.forEach(this::removeQueuedSubscriberEvent);
    }
    
    public void removeQueuedSubscriberEventsByEventSubscriber(EventSubscriber eventSubscriber) {
        removeQueuedSubscriberEvents(getQueuedSubscriberEventsByEventSubscriberForUpdate(eventSubscriber));
    }
    
    // --------------------------------------------------------------------------------
    //   Event Subscriber Event Types
    // --------------------------------------------------------------------------------
    
    public EventSubscriberEventType createEventSubscriberEventType(EventSubscriber eventSubscriber, EventType eventType,
            BasePK createdBy) {
        var eventSubscriberEventType = EventSubscriberEventTypeFactory.getInstance().create(session,
                eventSubscriber, eventType, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(eventSubscriber.getPrimaryKey(), EventTypes.MODIFY, eventSubscriberEventType.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return eventSubscriberEventType;
    }
    
    private List<EventSubscriberEventType> getEventSubscriberEventTypes(EventType eventType, EntityPermission entityPermission) {
        List<EventSubscriberEventType> eventSubscriberEventTypes;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM eventsubscribereventtypes, eventsubscribers, eventsubscriberdetails " +
                        "WHERE evsevt_evty_eventtypeid = ? AND evsevt_thrutime = ? " +
                        "AND evsevt_evs_eventsubscriberid = evs_eventsubscriberid AND evs_lastdetailid = evsdt_eventsubscriberdetailid " +
                        "ORDER BY evsdt_eventsubscribername";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM eventsubscribereventtypes " +
                        "WHERE evsevt_evty_eventtypeid = ? AND evsevt_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EventSubscriberEventTypeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, eventType.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);
            
            eventSubscriberEventTypes = EventSubscriberEventTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return eventSubscriberEventTypes;
    }
    
    public List<EventSubscriberEventType> getEventSubscriberEventTypes(EventType eventType) {
        return getEventSubscriberEventTypes(eventType, EntityPermission.READ_ONLY);
    }
    
    public List<EventSubscriberEventType> getEventSubscriberEventTypesForUpdate(EventType eventType) {
        return getEventSubscriberEventTypes(eventType, EntityPermission.READ_WRITE);
    }
    
    // --------------------------------------------------------------------------------
    //   Event Subscriber Entity Types
    // --------------------------------------------------------------------------------
    
    public EventSubscriberEntityType createEventSubscriberEntityType(EventSubscriber eventSubscriber, EntityType entityType,
            EventType eventType, BasePK createdBy) {
        var eventSubscriberEntityType = EventSubscriberEntityTypeFactory.getInstance().create(session,
                eventSubscriber, entityType, eventType, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(eventSubscriber.getPrimaryKey(), EventTypes.MODIFY, eventSubscriberEntityType.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return eventSubscriberEntityType;
    }
    
    private List<EventSubscriberEntityType> getEventSubscriberEntityTypes(EntityType entityType, EventType eventType, 
            EntityPermission entityPermission) {
        List<EventSubscriberEntityType> eventSubscriberEntityTypes;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM eventsubscriberentitytypes, eventsubscribers, eventsubscriberdetails " +
                        "WHERE evset_ent_entitytypeid = ? AND evset_evty_eventtypeid = ? AND evset_thrutime = ? " +
                        "AND evset_evs_eventsubscriberid = evs_eventsubscriberid AND evs_lastdetailid = evsdt_eventsubscriberdetailid " +
                        "ORDER BY evsdt_eventsubscribername";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM eventsubscriberentitytypes " +
                        "WHERE evset_ent_entitytypeid = ? AND evset_evty_eventtypeid = ? AND evset_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EventSubscriberEntityTypeFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityType.getPrimaryKey().getEntityId());
            ps.setLong(2, eventType.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            eventSubscriberEntityTypes = EventSubscriberEntityTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return eventSubscriberEntityTypes;
    }
    
    public List<EventSubscriberEntityType> getEventSubscriberEntityTypes(EntityType entityType, EventType eventType) {
        return getEventSubscriberEntityTypes(entityType, eventType, EntityPermission.READ_ONLY);
    }
    
    public List<EventSubscriberEntityType> getEventSubscriberEntityTypesForUpdate(EntityType entityType, EventType eventType) {
        return getEventSubscriberEntityTypes(entityType, eventType, EntityPermission.READ_WRITE);
    }
    
    // --------------------------------------------------------------------------------
    //   Event Subscriber Entity Instances
    // --------------------------------------------------------------------------------
    
    public EventSubscriberEntityInstance createEventSubscriberEntityInstance(EventSubscriber eventSubscriber,
            EntityInstance entityInstance, EventType eventType, BasePK createdBy) {
        var eventSubscriberEntityInstance = EventSubscriberEntityInstanceFactory.getInstance().create(session,
                eventSubscriber, entityInstance, eventType, session.START_TIME_LONG, Session.MAX_TIME_LONG);
        
        sendEvent(eventSubscriber.getPrimaryKey(), EventTypes.MODIFY, eventSubscriberEntityInstance.getPrimaryKey(), EventTypes.CREATE, createdBy);
        
        return eventSubscriberEntityInstance;
    }
    
    private List<EventSubscriberEntityInstance> getEventSubscriberEntityInstances(EntityInstance entityInstance, 
            EventType eventType, EntityPermission entityPermission) {
        List<EventSubscriberEntityInstance> eventSubscriberEntityInstances;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM eventsubscriberentityinstances, eventsubscribers, eventsubscriberdetails " +
                        "WHERE evsei_eni_entityinstanceid = ? AND evsei_evty_eventtypeid = ? AND evsei_thrutime = ? " +
                        "AND evsei_evs_eventsubscriberid = evs_eventsubscriberid AND evs_lastdetailid = evsdt_eventsubscriberdetailid " +
                        "ORDER BY evsdt_eventsubscribername";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM eventsubscriberentityinstances " +
                        "WHERE evsei_eni_entityinstanceid = ? AND evsei_evty_eventtypeid = ? AND evsei_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = EventSubscriberEntityInstanceFactory.getInstance().prepareStatement(query);
            
            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, eventType.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);
            
            eventSubscriberEntityInstances = EventSubscriberEntityInstanceFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }
        
        return eventSubscriberEntityInstances;
    }
    
    public List<EventSubscriberEntityInstance> getEventSubscriberEntityInstances(EntityInstance entityInstance, EventType eventType) {
        return getEventSubscriberEntityInstances(entityInstance, eventType, EntityPermission.READ_ONLY);
    }
    
    public List<EventSubscriberEntityInstance> getEventSubscriberEntityInstancesForUpdate(EntityInstance entityInstance, EventType eventType) {
        return getEventSubscriberEntityInstances(entityInstance, eventType, EntityPermission.READ_WRITE);
    }
    
    // --------------------------------------------------------------------------------
    //   Utilities
    // --------------------------------------------------------------------------------
    
    private void queueEntityInstanceToIndexing(final EntityInstance entityInstance) {
        var indexControl = Session.getModelController(IndexControl.class);

        if(indexControl.isEntityTypeUsedByIndexTypes(entityInstance.getEntityType())) {
            try {
                QueuedEntityLogic.getInstance().createQueuedEntityUsingNames(null, QueueTypes.INDEXING.name(), entityInstance);
            } catch(UnknownQueueTypeNameException uqtne) {
                // This will be thrown early in the setup process because the QueueType has not yet been created.
                // Log as an informational message, but otherwise ignore it.
                getLog().info(uqtne.getMessage());
            }
        }
    }

    private EntityTime createOrGetEntityTime(final EntityInstance entityInstance, final Long eventTime) {
        var entityTime = getEntityTimeForUpdate(entityInstance);

        // This is why we don't call setCreatedTime(...) on CREATE events - it's already taken care of here.
        if(entityTime == null) {
            // Initially created read-only, convert to read/write. If we're in sendEvent(...),
            // we need an EntityTime. If there wasn't one previously, we do the best we can,
            // using the eventTime as its createdTime.
            createEntityTime(entityInstance, eventTime, null, null);
            entityTime = getEntityTimeForUpdate(entityInstance);
        }

        return entityTime;
    }

    private void pruneEvents(final EntityInstance entityInstance, final EventType eventType, final Integer maximumHistory) {
        final var events = getEventsByEntityInstanceAndEventTypeForUpdate(entityInstance, eventType);
        final var eventCountToRemove = events.size() - maximumHistory;

        if(eventCountToRemove > 0) {
            final var i = events.iterator();

            for(var j = 0; j < eventCountToRemove; j++) {
                removeEvent(i.next());
            }
        }
    }

    @Override
    public Event sendEvent(final EntityInstance entityInstance, final EventTypes eventTypeEnum, final EntityInstance relatedEntityInstance,
            final EventTypes relatedEventTypeEnum, final BasePK createdByBasePK) {
        final var eventType = getEventTypeByEventTypesFromCache(eventTypeEnum);
        final var relatedEventType = relatedEventTypeEnum == null ? null : getEventTypeByEventTypesFromCache(relatedEventTypeEnum);
        final var createdByEntityInstance = createdByBasePK == null ? null : getEntityInstanceByBasePK(createdByBasePK);
        Event event = null;

        if(CoreDebugFlags.LogSentEvents) {
            var entityInstanceUtils = EntityInstanceUtils.getInstance();

            getLog().info("entityInstance = " + entityInstanceUtils.getEntityRefByEntityInstance(entityInstance)
                    + ", eventType = " + eventType.getEventTypeName()
                    + ", relatedEntityInstance = " + entityInstanceUtils.getEntityRefByEntityInstance(relatedEntityInstance)
                    + ", relatedEventType = " + (relatedEventType == null ? "(null)" : relatedEventType.getEventTypeName())
                    + ", createdByEntityInstance = " + entityInstanceUtils.getEntityRefByEntityInstance(createdByEntityInstance));
        }

        final var eventTime = session.START_TIME_LONG;
        final var entityTime = createOrGetEntityTime(entityInstance, eventTime);
        var shouldClearCache = false;
        var shouldQueueEntityInstanceToIndexing = false;
        var shouldUpdateVisitedTime = false;
        var shouldQueueEventToSubscribers = false;
        var shouldCreateEntityAttributeDefaults = false;
        Integer maximumHistory = null;

        switch(eventTypeEnum) {
            case CREATE -> {
                shouldCreateEntityAttributeDefaults = true;
                shouldQueueEntityInstanceToIndexing = true;
                shouldQueueEventToSubscribers = true;
            }
            case READ -> {
                shouldUpdateVisitedTime = true;
                shouldQueueEventToSubscribers = true;
            }
            case TOUCH -> {
                entityTime.setModifiedTime(eventTime);
                shouldClearCache = true;
                shouldQueueEntityInstanceToIndexing = true;
                maximumHistory = 5;
            }
            case MODIFY -> {
                entityTime.setModifiedTime(eventTime);
                shouldClearCache = true;
                shouldQueueEntityInstanceToIndexing = true;
                shouldQueueEventToSubscribers = true;
            }
            case DELETE -> {
                deleteEntityInstanceDependencies(entityInstance, createdByBasePK);
                entityTime.setDeletedTime(eventTime);
                shouldClearCache = true;
                shouldQueueEntityInstanceToIndexing = true;
                shouldQueueEventToSubscribers = true;
            }
        }

        // Support for tracking the last time an EntityInstance (just as an Employee Party) has visited a given
        // EntityInstance. If the EntityInstance has not been modified since the last visit, the READ event caused
        // by the visit will be suppressed vs. being recorded.
        var shouldSuppressEvent = false;
        if(shouldUpdateVisitedTime && createdByEntityInstance != null) {
            final var entityVisit = getEntityVisitForUpdate(createdByEntityInstance, entityInstance);

            if(entityVisit == null) {
                createEntityVisit(createdByEntityInstance, entityInstance);
            } else {
                var modifiedTime = entityTime.getModifiedTime();

                // Prefer the real modified time, but if that's null (meaning it has never been modified),
                // fall back to the created time.
                if(modifiedTime == null) {
                    modifiedTime = entityTime.getCreatedTime();
                }

                // There is a possible override for suppressing events in here by EntityType. This was added to ensure
                // that full auditing is available for some EntityTypes such as PartyPaymentMethod.
                if(entityVisit.getVisitedTime() >= modifiedTime && !entityInstance.getEntityType().getLastDetail().getKeepAllHistory()) {
                    shouldSuppressEvent = true;
                }

                entityVisit.setVisitedTime(eventTime);
            }
        }

        if(!shouldSuppressEvent) {
            final var eventGroup = createdByBasePK == null ? null : getActiveEventGroup(createdByBasePK);

            event = createEvent(eventGroup, eventTime, entityInstance, eventType, relatedEntityInstance, relatedEventType,
                    createdByEntityInstance);

            if(shouldQueueEventToSubscribers) {
                createQueuedEvent(event);
            }
            
            if(maximumHistory != null) {
                pruneEvents(entityInstance, eventType, maximumHistory);
            }

            EventTopic.getInstance().sendEvent(event);

            SentEventEventBus.eventBus.post(new SentEvent(event));
        }

        if(shouldClearCache) {
            removeCacheEntriesByEntityInstance(entityInstance);
        }

        if(shouldQueueEntityInstanceToIndexing) {
            queueEntityInstanceToIndexing(entityInstance);
        }

        if(shouldCreateEntityAttributeDefaults) {
            createEntityAttributeDefaults(entityInstance, createdByBasePK);
        }

        return event;
    }

    @Override
    public Event sendEvent(final BasePK basePK, final EventTypes eventType, final BasePK relatedBasePK,
            final EventTypes relatedEventType, final BasePK createdByBasePK) {
        var entityInstance = getEntityInstanceByBasePK(basePK);
        Event event = null;

        if(entityInstance == null) {
            getLog().error("sendEventUsingNames: getEntityInstanceByBasePK failed on " + basePK.toString());
        } else {
            var relatedEntityInstance = relatedBasePK == null ? null : getEntityInstanceByBasePK(relatedBasePK);
            
            event = sendEvent(entityInstance, eventType, relatedEntityInstance, relatedEventType, createdByBasePK);
        }
        
        return event;
    }
    
    @Override
    public Event sendEvent(final EntityInstance entityInstance, final EventTypes eventType, final BasePK relatedBasePK,
            final EventTypes relatedEventType, final BasePK createdByBasePK) {
        var relatedEntityInstance = relatedBasePK == null ? null : getEntityInstanceByBasePK(relatedBasePK);
        
        return sendEvent(entityInstance, eventType, relatedEntityInstance, relatedEventType, createdByBasePK);
    }
    
    // --------------------------------------------------------------------------------
    //   Party Entity Types
    // --------------------------------------------------------------------------------
    
    public PartyEntityType createPartyEntityType(Party party, EntityType entityType, Boolean confirmDelete, BasePK createdBy) {
        var partyEntityType = PartyEntityTypeFactory.getInstance().create(party, entityType, confirmDelete, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(party.getPrimaryKey(), EventTypes.MODIFY, partyEntityType.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return partyEntityType;
    }

    private PartyEntityType getPartyEntityType(Party party, EntityType entityType, EntityPermission entityPermission) {
        PartyEntityType partyEntityType;
        
        try {
            String query = null;
            
            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM partyentitytypes " +
                        "WHERE pent_par_partyid = ? AND pent_ent_entitytypeid = ? AND pent_thrutime = ?";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM partyentitytypes " +
                        "WHERE pent_par_partyid = ? AND pent_ent_entitytypeid = ? AND pent_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = PartyEntityTypeFactory.getInstance().prepareStatement(query);

            ps.setLong(1, party.getPrimaryKey().getEntityId());
            ps.setLong(2, entityType.getPrimaryKey().getEntityId());
            ps.setLong(3, Session.MAX_TIME);

            partyEntityType = PartyEntityTypeFactory.getInstance().getEntityFromQuery(entityPermission, ps);
        } catch(SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return partyEntityType;
    }

    public PartyEntityType getPartyEntityType(Party party, EntityType entityType) {
        return getPartyEntityType(party, entityType, EntityPermission.READ_ONLY);
    }

    public PartyEntityType getPartyEntityTypeForUpdate(Party party, EntityType entityType) {
        return getPartyEntityType(party, entityType, EntityPermission.READ_WRITE);
    }

    public PartyEntityTypeValue getPartyEntityTypeValue(PartyEntityType partyEntityType) {
        return partyEntityType == null ? null : partyEntityType.getPartyEntityTypeValue().clone();
    }

    public PartyEntityTypeValue getPartyEntityTypeValueForUpdate(Party party, EntityType entityType) {
        return getPartyEntityTypeValue(getPartyEntityTypeForUpdate(party, entityType));
    }

    private List<PartyEntityType> getPartyEntityTypesByParty(Party party, EntityPermission entityPermission) {
        List<PartyEntityType> partyEntityTypes;

        try {
            String query = null;

            if(entityPermission.equals(EntityPermission.READ_ONLY)) {
                query = "SELECT _ALL_ " +
                        "FROM partyentitytypes, entitytypes, entitytypedetails, componentvendors, componentvendordetails " +
                        "WHERE pent_par_partyid = ? AND pent_thrutime = ? " +
                        "AND pent_ent_entitytypeid = ent_entitytypeid AND ent_lastdetailid = entdt_entitytypedetailid " +
                        "AND entdt_cvnd_componentvendorid = cvnd_componentvendorid AND cvnd_lastdetailid = cvndd_componentvendordetailid " +
                        "ORDER BY entdt_sortorder, entdt_entitytypename, cvndd_componentvendorname";
            } else if(entityPermission.equals(EntityPermission.READ_WRITE)) {
                query = "SELECT _ALL_ " +
                        "FROM partyentitytypes " +
                        "WHERE pent_par_partyid = ? AND pent_thrutime = ? " +
                        "FOR UPDATE";
            }

            var ps = PartyEntityTypeFactory.getInstance().prepareStatement(query);

            ps.setLong(1, party.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);

            partyEntityTypes = PartyEntityTypeFactory.getInstance().getEntitiesFromQuery(entityPermission, ps);
        } catch(SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return partyEntityTypes;
    }

    public List<PartyEntityType> getPartyEntityTypesByParty(Party party) {
        return getPartyEntityTypesByParty(party, EntityPermission.READ_ONLY);
    }

    public List<PartyEntityType> getPartyEntityTypesByPartyForUpdate(Party party) {
        return getPartyEntityTypesByParty(party, EntityPermission.READ_WRITE);
    }

    public PartyEntityTypeTransfer getPartyEntityTypeTransfer(UserVisit userVisit, PartyEntityType partyEntityType) {
        return getCoreTransferCaches(userVisit).getPartyEntityTypeTransferCache().getPartyEntityTypeTransfer(partyEntityType);
    }

    public List<PartyEntityTypeTransfer> getPartyEntityTypeTransfersByParty(UserVisit userVisit, Party party) {
        var partyEntityTypes = getPartyEntityTypesByParty(party);
        List<PartyEntityTypeTransfer> partyEntityTypeTransfers = new ArrayList<>(partyEntityTypes.size());
        var partyEntityTypeTransferCache = getCoreTransferCaches(userVisit).getPartyEntityTypeTransferCache();

        partyEntityTypes.forEach((partyEntityType) ->
                partyEntityTypeTransfers.add(partyEntityTypeTransferCache.getPartyEntityTypeTransfer(partyEntityType))
        );

        return partyEntityTypeTransfers;
    }

    public void updatePartyEntityTypeFromValue(PartyEntityTypeValue partyEntityTypeValue, BasePK updatedBy) {
        if(partyEntityTypeValue.hasBeenModified()) {
            var partyEntityType = PartyEntityTypeFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, partyEntityTypeValue.getPrimaryKey());

            partyEntityType.setThruTime(session.START_TIME_LONG);
            partyEntityType.store();

            var partyPK = partyEntityType.getPartyPK(); // Not updated
            var entityTypePK = partyEntityType.getEntityTypePK(); // Not updated
            var confirmDelete = partyEntityTypeValue.getConfirmDelete();

            partyEntityType = PartyEntityTypeFactory.getInstance().create(partyPK, entityTypePK, confirmDelete, session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(partyPK, EventTypes.MODIFY, partyEntityType.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deletePartyEntityType(PartyEntityType partyEntityType, BasePK deletedBy) {
        partyEntityType.setThruTime(session.START_TIME_LONG);

        sendEvent(partyEntityType.getPartyPK(), EventTypes.MODIFY, partyEntityType.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deletePartyEntityTypesByParty(Party party, BasePK deletedBy) {
        getPartyEntityTypesByPartyForUpdate(party).forEach((partyEntityType) ->
                deletePartyEntityType(partyEntityType, deletedBy)
        );
    }
    
    // --------------------------------------------------------------------------------
    //   Applications
    // --------------------------------------------------------------------------------

    public Application createApplication(String applicationName, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultApplication = getDefaultApplication();
        var defaultFound = defaultApplication != null;

        if(defaultFound && isDefault) {
            var defaultApplicationDetailValue = getDefaultApplicationDetailValueForUpdate();

            defaultApplicationDetailValue.setIsDefault(Boolean.FALSE);
            updateApplicationFromValue(defaultApplicationDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var application = ApplicationFactory.getInstance().create();
        var applicationDetail = ApplicationDetailFactory.getInstance().create(application, applicationName, isDefault, sortOrder, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);

        // Convert to R/W
        application = ApplicationFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, application.getPrimaryKey());
        application.setActiveDetail(applicationDetail);
        application.setLastDetail(applicationDetail);
        application.store();

        sendEvent(application.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return application;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.Application */
    public Application getApplicationByEntityInstance(EntityInstance entityInstance) {
        var pk = new ApplicationPK(entityInstance.getEntityUniqueId());

        return ApplicationFactory.getInstance().getEntityFromPK(EntityPermission.READ_ONLY, pk);
    }

    private static final Map<EntityPermission, String> getApplicationByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM applications, applicationdetails " +
                "WHERE appl_activedetailid = appldt_applicationdetailid " +
                "AND appldt_applicationname = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM applications, applicationdetails " +
                "WHERE appl_activedetailid = appldt_applicationdetailid " +
                "AND appldt_applicationname = ? " +
                "FOR UPDATE");
        getApplicationByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private Application getApplicationByName(String applicationName, EntityPermission entityPermission) {
        return ApplicationFactory.getInstance().getEntityFromQuery(entityPermission, getApplicationByNameQueries, applicationName);
    }

    public Application getApplicationByName(String applicationName) {
        return getApplicationByName(applicationName, EntityPermission.READ_ONLY);
    }

    public Application getApplicationByNameForUpdate(String applicationName) {
        return getApplicationByName(applicationName, EntityPermission.READ_WRITE);
    }

    public ApplicationDetailValue getApplicationDetailValueForUpdate(Application application) {
        return application == null? null: application.getLastDetailForUpdate().getApplicationDetailValue().clone();
    }

    public ApplicationDetailValue getApplicationDetailValueByNameForUpdate(String applicationName) {
        return getApplicationDetailValueForUpdate(getApplicationByNameForUpdate(applicationName));
    }

    private static final Map<EntityPermission, String> getDefaultApplicationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM applications, applicationdetails " +
                "WHERE appl_activedetailid = appldt_applicationdetailid " +
                "AND appldt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM applications, applicationdetails " +
                "WHERE appl_activedetailid = appldt_applicationdetailid " +
                "AND appldt_isdefault = 1 " +
                "FOR UPDATE");
        getDefaultApplicationQueries = Collections.unmodifiableMap(queryMap);
    }

    private Application getDefaultApplication(EntityPermission entityPermission) {
        return ApplicationFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultApplicationQueries);
    }

    public Application getDefaultApplication() {
        return getDefaultApplication(EntityPermission.READ_ONLY);
    }

    public Application getDefaultApplicationForUpdate() {
        return getDefaultApplication(EntityPermission.READ_WRITE);
    }

    public ApplicationDetailValue getDefaultApplicationDetailValueForUpdate() {
        return getDefaultApplicationForUpdate().getLastDetailForUpdate().getApplicationDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getApplicationsQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM applications, applicationdetails " +
                "WHERE appl_activedetailid = appldt_applicationdetailid " +
                "ORDER BY appldt_sortorder, appldt_applicationname " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM applications, applicationdetails " +
                "WHERE appl_activedetailid = appldt_applicationdetailid " +
                "FOR UPDATE");
        getApplicationsQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Application> getApplications(EntityPermission entityPermission) {
        return ApplicationFactory.getInstance().getEntitiesFromQuery(entityPermission, getApplicationsQueries);
    }

    public List<Application> getApplications() {
        return getApplications(EntityPermission.READ_ONLY);
    }

    public List<Application> getApplicationsForUpdate() {
        return getApplications(EntityPermission.READ_WRITE);
    }

    public ApplicationTransfer getApplicationTransfer(UserVisit userVisit, Application application) {
        return getCoreTransferCaches(userVisit).getApplicationTransferCache().getApplicationTransfer(application);
    }

    public List<ApplicationTransfer> getApplicationTransfers(UserVisit userVisit) {
        var applications = getApplications();
        List<ApplicationTransfer> applicationTransfers = new ArrayList<>(applications.size());
        var applicationTransferCache = getCoreTransferCaches(userVisit).getApplicationTransferCache();

        applications.forEach((application) ->
                applicationTransfers.add(applicationTransferCache.getApplicationTransfer(application))
        );

        return applicationTransfers;
    }

    public ApplicationChoicesBean getApplicationChoices(String defaultApplicationChoice, Language language, boolean allowNullChoice) {
        var applications = getApplications();
        var size = applications.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultApplicationChoice == null) {
                defaultValue = "";
            }
        }

        for(var application : applications) {
            var applicationDetail = application.getLastDetail();

            var label = getBestApplicationDescription(application, language);
            var value = applicationDetail.getApplicationName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultApplicationChoice != null && defaultApplicationChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && applicationDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new ApplicationChoicesBean(labels, values, defaultValue);
    }

    private void updateApplicationFromValue(ApplicationDetailValue applicationDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(applicationDetailValue.hasBeenModified()) {
            var application = ApplicationFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     applicationDetailValue.getApplicationPK());
            var applicationDetail = application.getActiveDetailForUpdate();

            applicationDetail.setThruTime(session.START_TIME_LONG);
            applicationDetail.store();

            var applicationPK = applicationDetail.getApplicationPK(); // Not updated
            var applicationName = applicationDetailValue.getApplicationName();
            var isDefault = applicationDetailValue.getIsDefault();
            var sortOrder = applicationDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultApplication = getDefaultApplication();
                var defaultFound = defaultApplication != null && !defaultApplication.equals(application);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultApplicationDetailValue = getDefaultApplicationDetailValueForUpdate();

                    defaultApplicationDetailValue.setIsDefault(Boolean.FALSE);
                    updateApplicationFromValue(defaultApplicationDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            applicationDetail = ApplicationDetailFactory.getInstance().create(applicationPK, applicationName, isDefault, sortOrder, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            application.setActiveDetail(applicationDetail);
            application.setLastDetail(applicationDetail);

            sendEvent(applicationPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateApplicationFromValue(ApplicationDetailValue applicationDetailValue, BasePK updatedBy) {
        updateApplicationFromValue(applicationDetailValue, true, updatedBy);
    }

    private void deleteApplication(Application application, boolean checkDefault, BasePK deletedBy) {
        var applicationDetail = application.getLastDetailForUpdate();

        deleteApplicationDescriptionsByApplication(application, deletedBy);
        deleteApplicationEditorsByApplication(application, deletedBy);
        deleteApplicationEditorUsesByApplication(application, deletedBy);

        applicationDetail.setThruTime(session.START_TIME_LONG);
        application.setActiveDetail(null);
        application.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultApplication = getDefaultApplication();

            if(defaultApplication == null) {
                var applications = getApplicationsForUpdate();

                if(!applications.isEmpty()) {
                    var iter = applications.iterator();
                    if(iter.hasNext()) {
                        defaultApplication = iter.next();
                    }
                    var applicationDetailValue = Objects.requireNonNull(defaultApplication).getLastDetailForUpdate().getApplicationDetailValue().clone();

                    applicationDetailValue.setIsDefault(Boolean.TRUE);
                    updateApplicationFromValue(applicationDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(application.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteApplication(Application application, BasePK deletedBy) {
        deleteApplication(application, true, deletedBy);
    }

    private void deleteApplications(List<Application> applications, boolean checkDefault, BasePK deletedBy) {
        applications.forEach((application) -> deleteApplication(application, checkDefault, deletedBy));
    }

    public void deleteApplications(List<Application> applications, BasePK deletedBy) {
        deleteApplications(applications, true, deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Application Descriptions
    // --------------------------------------------------------------------------------

    public ApplicationDescription createApplicationDescription(Application application, Language language, String description, BasePK createdBy) {
        var applicationDescription = ApplicationDescriptionFactory.getInstance().create(application, language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(application.getPrimaryKey(), EventTypes.MODIFY, applicationDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return applicationDescription;
    }

    private static final Map<EntityPermission, String> getApplicationDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM applicationdescriptions " +
                "WHERE appld_appl_applicationid = ? AND appld_lang_languageid = ? AND appld_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM applicationdescriptions " +
                "WHERE appld_appl_applicationid = ? AND appld_lang_languageid = ? AND appld_thrutime = ? " +
                "FOR UPDATE");
        getApplicationDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private ApplicationDescription getApplicationDescription(Application application, Language language, EntityPermission entityPermission) {
        return ApplicationDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getApplicationDescriptionQueries,
                application, language, Session.MAX_TIME);
    }

    public ApplicationDescription getApplicationDescription(Application application, Language language) {
        return getApplicationDescription(application, language, EntityPermission.READ_ONLY);
    }

    public ApplicationDescription getApplicationDescriptionForUpdate(Application application, Language language) {
        return getApplicationDescription(application, language, EntityPermission.READ_WRITE);
    }

    public ApplicationDescriptionValue getApplicationDescriptionValue(ApplicationDescription applicationDescription) {
        return applicationDescription == null? null: applicationDescription.getApplicationDescriptionValue().clone();
    }

    public ApplicationDescriptionValue getApplicationDescriptionValueForUpdate(Application application, Language language) {
        return getApplicationDescriptionValue(getApplicationDescriptionForUpdate(application, language));
    }

    private static final Map<EntityPermission, String> getApplicationDescriptionsByApplicationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM applicationdescriptions, languages " +
                "WHERE appld_appl_applicationid = ? AND appld_thrutime = ? AND appld_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM applicationdescriptions " +
                "WHERE appld_appl_applicationid = ? AND appld_thrutime = ? " +
                "FOR UPDATE");
        getApplicationDescriptionsByApplicationQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ApplicationDescription> getApplicationDescriptionsByApplication(Application application, EntityPermission entityPermission) {
        return ApplicationDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getApplicationDescriptionsByApplicationQueries,
                application, Session.MAX_TIME);
    }

    public List<ApplicationDescription> getApplicationDescriptionsByApplication(Application application) {
        return getApplicationDescriptionsByApplication(application, EntityPermission.READ_ONLY);
    }

    public List<ApplicationDescription> getApplicationDescriptionsByApplicationForUpdate(Application application) {
        return getApplicationDescriptionsByApplication(application, EntityPermission.READ_WRITE);
    }

    public String getBestApplicationDescription(Application application, Language language) {
        String description;
        var applicationDescription = getApplicationDescription(application, language);

        if(applicationDescription == null && !language.getIsDefault()) {
            applicationDescription = getApplicationDescription(application, getPartyControl().getDefaultLanguage());
        }

        if(applicationDescription == null) {
            description = application.getLastDetail().getApplicationName();
        } else {
            description = applicationDescription.getDescription();
        }

        return description;
    }

    public ApplicationDescriptionTransfer getApplicationDescriptionTransfer(UserVisit userVisit, ApplicationDescription applicationDescription) {
        return getCoreTransferCaches(userVisit).getApplicationDescriptionTransferCache().getApplicationDescriptionTransfer(applicationDescription);
    }

    public List<ApplicationDescriptionTransfer> getApplicationDescriptionTransfersByApplication(UserVisit userVisit, Application application) {
        var applicationDescriptions = getApplicationDescriptionsByApplication(application);
        List<ApplicationDescriptionTransfer> applicationDescriptionTransfers = new ArrayList<>(applicationDescriptions.size());
        var applicationDescriptionTransferCache = getCoreTransferCaches(userVisit).getApplicationDescriptionTransferCache();

        applicationDescriptions.forEach((applicationDescription) ->
                applicationDescriptionTransfers.add(applicationDescriptionTransferCache.getApplicationDescriptionTransfer(applicationDescription))
        );

        return applicationDescriptionTransfers;
    }

    public void updateApplicationDescriptionFromValue(ApplicationDescriptionValue applicationDescriptionValue, BasePK updatedBy) {
        if(applicationDescriptionValue.hasBeenModified()) {
            var applicationDescription = ApplicationDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    applicationDescriptionValue.getPrimaryKey());

            applicationDescription.setThruTime(session.START_TIME_LONG);
            applicationDescription.store();

            var application = applicationDescription.getApplication();
            var language = applicationDescription.getLanguage();
            var description = applicationDescriptionValue.getDescription();

            applicationDescription = ApplicationDescriptionFactory.getInstance().create(application, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(application.getPrimaryKey(), EventTypes.MODIFY, applicationDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteApplicationDescription(ApplicationDescription applicationDescription, BasePK deletedBy) {
        applicationDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(applicationDescription.getApplicationPK(), EventTypes.MODIFY, applicationDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteApplicationDescriptionsByApplication(Application application, BasePK deletedBy) {
        var applicationDescriptions = getApplicationDescriptionsByApplicationForUpdate(application);

        applicationDescriptions.forEach((applicationDescription) -> 
                deleteApplicationDescription(applicationDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Editors
    // --------------------------------------------------------------------------------

    public Editor createEditor(String editorName, Boolean hasDimensions, Integer minimumHeight, Integer minimumWidth, Integer maximumHeight,
            Integer maximumWidth, Integer defaultHeight, Integer defaultWidth, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultEditor = getDefaultEditor();
        var defaultFound = defaultEditor != null;

        if(defaultFound && isDefault) {
            var defaultEditorDetailValue = getDefaultEditorDetailValueForUpdate();

            defaultEditorDetailValue.setIsDefault(Boolean.FALSE);
            updateEditorFromValue(defaultEditorDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var editor = EditorFactory.getInstance().create();
        var editorDetail = EditorDetailFactory.getInstance().create(editor, editorName, hasDimensions, minimumHeight, minimumWidth, maximumHeight,
                maximumWidth, defaultHeight, defaultWidth, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        // Convert to R/W
        editor = EditorFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, editor.getPrimaryKey());
        editor.setActiveDetail(editorDetail);
        editor.setLastDetail(editorDetail);
        editor.store();

        sendEvent(editor.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return editor;
    }

    private static final Map<EntityPermission, String> getEditorByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM editors, editordetails " +
                "WHERE edtr_activedetailid = edtrdt_editordetailid " +
                "AND edtrdt_editorname = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM editors, editordetails " +
                "WHERE edtr_activedetailid = edtrdt_editordetailid " +
                "AND edtrdt_editorname = ? " +
                "FOR UPDATE");
        getEditorByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private Editor getEditorByName(String editorName, EntityPermission entityPermission) {
        return EditorFactory.getInstance().getEntityFromQuery(entityPermission, getEditorByNameQueries, editorName);
    }

    public Editor getEditorByName(String editorName) {
        return getEditorByName(editorName, EntityPermission.READ_ONLY);
    }

    public Editor getEditorByNameForUpdate(String editorName) {
        return getEditorByName(editorName, EntityPermission.READ_WRITE);
    }

    public EditorDetailValue getEditorDetailValueForUpdate(Editor editor) {
        return editor == null? null: editor.getLastDetailForUpdate().getEditorDetailValue().clone();
    }

    public EditorDetailValue getEditorDetailValueByNameForUpdate(String editorName) {
        return getEditorDetailValueForUpdate(getEditorByNameForUpdate(editorName));
    }

    private static final Map<EntityPermission, String> getDefaultEditorQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM editors, editordetails " +
                "WHERE edtr_activedetailid = edtrdt_editordetailid " +
                "AND edtrdt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM editors, editordetails " +
                "WHERE edtr_activedetailid = edtrdt_editordetailid " +
                "AND edtrdt_isdefault = 1 " +
                "FOR UPDATE");
        getDefaultEditorQueries = Collections.unmodifiableMap(queryMap);
    }

    private Editor getDefaultEditor(EntityPermission entityPermission) {
        return EditorFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultEditorQueries);
    }

    public Editor getDefaultEditor() {
        return getDefaultEditor(EntityPermission.READ_ONLY);
    }

    public Editor getDefaultEditorForUpdate() {
        return getDefaultEditor(EntityPermission.READ_WRITE);
    }

    public EditorDetailValue getDefaultEditorDetailValueForUpdate() {
        return getDefaultEditorForUpdate().getLastDetailForUpdate().getEditorDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getEditorsQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM editors, editordetails " +
                "WHERE edtr_activedetailid = edtrdt_editordetailid " +
                "ORDER BY edtrdt_sortorder, edtrdt_editorname " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM editors, editordetails " +
                "WHERE edtr_activedetailid = edtrdt_editordetailid " +
                "FOR UPDATE");
        getEditorsQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Editor> getEditors(EntityPermission entityPermission) {
        return EditorFactory.getInstance().getEntitiesFromQuery(entityPermission, getEditorsQueries);
    }

    public List<Editor> getEditors() {
        return getEditors(EntityPermission.READ_ONLY);
    }

    public List<Editor> getEditorsForUpdate() {
        return getEditors(EntityPermission.READ_WRITE);
    }

    public EditorTransfer getEditorTransfer(UserVisit userVisit, Editor editor) {
        return getCoreTransferCaches(userVisit).getEditorTransferCache().getEditorTransfer(editor);
    }

    public List<EditorTransfer> getEditorTransfers(UserVisit userVisit) {
        var editors = getEditors();
        List<EditorTransfer> editorTransfers = new ArrayList<>(editors.size());
        var editorTransferCache = getCoreTransferCaches(userVisit).getEditorTransferCache();

        editors.forEach((editor) ->
                editorTransfers.add(editorTransferCache.getEditorTransfer(editor))
        );

        return editorTransfers;
    }

    public EditorChoicesBean getEditorChoices(String defaultEditorChoice, Language language, boolean allowNullChoice) {
        var editors = getEditors();
        var size = editors.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultEditorChoice == null) {
                defaultValue = "";
            }
        }

        for(var editor : editors) {
            var editorDetail = editor.getLastDetail();

            var label = getBestEditorDescription(editor, language);
            var value = editorDetail.getEditorName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultEditorChoice != null && defaultEditorChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && editorDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new EditorChoicesBean(labels, values, defaultValue);
    }

    private void updateEditorFromValue(EditorDetailValue editorDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(editorDetailValue.hasBeenModified()) {
            var editor = EditorFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     editorDetailValue.getEditorPK());
            var editorDetail = editor.getActiveDetailForUpdate();

            editorDetail.setThruTime(session.START_TIME_LONG);
            editorDetail.store();

            var editorPK = editorDetail.getEditorPK(); // Not updated
            var editorName = editorDetailValue.getEditorName();
            var hasDimensions = editorDetailValue.getHasDimensions();
            var minimumHeight = editorDetailValue.getMinimumHeight();
            var minimumWidth = editorDetailValue.getMinimumWidth();
            var maximumHeight = editorDetailValue.getMaximumHeight();
            var maximumWidth = editorDetailValue.getMaximumWidth();
            var defaultHeight = editorDetailValue.getDefaultHeight();
            var defaultWidth = editorDetailValue.getDefaultWidth();
            var isDefault = editorDetailValue.getIsDefault();
            var sortOrder = editorDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultEditor = getDefaultEditor();
                var defaultFound = defaultEditor != null && !defaultEditor.equals(editor);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultEditorDetailValue = getDefaultEditorDetailValueForUpdate();

                    defaultEditorDetailValue.setIsDefault(Boolean.FALSE);
                    updateEditorFromValue(defaultEditorDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            editorDetail = EditorDetailFactory.getInstance().create(editorPK, editorName, hasDimensions, minimumHeight, minimumWidth, maximumHeight,
                    maximumWidth, defaultHeight, defaultWidth, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);

            editor.setActiveDetail(editorDetail);
            editor.setLastDetail(editorDetail);

            sendEvent(editorPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateEditorFromValue(EditorDetailValue editorDetailValue, BasePK updatedBy) {
        updateEditorFromValue(editorDetailValue, true, updatedBy);
    }

    private void deleteEditor(Editor editor, boolean checkDefault, BasePK deletedBy) {
        var editorDetail = editor.getLastDetailForUpdate();

        deleteEditorDescriptionsByEditor(editor, deletedBy);
        deleteApplicationEditorsByEditor(editor, deletedBy);

        editorDetail.setThruTime(session.START_TIME_LONG);
        editor.setActiveDetail(null);
        editor.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultEditor = getDefaultEditor();

            if(defaultEditor == null) {
                var editors = getEditorsForUpdate();

                if(!editors.isEmpty()) {
                    var iter = editors.iterator();
                    if(iter.hasNext()) {
                        defaultEditor = iter.next();
                    }
                    var editorDetailValue = Objects.requireNonNull(defaultEditor).getLastDetailForUpdate().getEditorDetailValue().clone();

                    editorDetailValue.setIsDefault(Boolean.TRUE);
                    updateEditorFromValue(editorDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(editor.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteEditor(Editor editor, BasePK deletedBy) {
        deleteEditor(editor, true, deletedBy);
    }

    private void deleteEditors(List<Editor> editors, boolean checkDefault, BasePK deletedBy) {
        editors.forEach((editor) -> deleteEditor(editor, checkDefault, deletedBy));
    }

    public void deleteEditors(List<Editor> editors, BasePK deletedBy) {
        deleteEditors(editors, true, deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Editor Descriptions
    // --------------------------------------------------------------------------------

    public EditorDescription createEditorDescription(Editor editor, Language language, String description, BasePK createdBy) {
        var editorDescription = EditorDescriptionFactory.getInstance().create(editor, language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(editor.getPrimaryKey(), EventTypes.MODIFY, editorDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return editorDescription;
    }

    private static final Map<EntityPermission, String> getEditorDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM editordescriptions " +
                "WHERE edtrd_edtr_editorid = ? AND edtrd_lang_languageid = ? AND edtrd_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM editordescriptions " +
                "WHERE edtrd_edtr_editorid = ? AND edtrd_lang_languageid = ? AND edtrd_thrutime = ? " +
                "FOR UPDATE");
        getEditorDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private EditorDescription getEditorDescription(Editor editor, Language language, EntityPermission entityPermission) {
        return EditorDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getEditorDescriptionQueries,
                editor, language, Session.MAX_TIME);
    }

    public EditorDescription getEditorDescription(Editor editor, Language language) {
        return getEditorDescription(editor, language, EntityPermission.READ_ONLY);
    }

    public EditorDescription getEditorDescriptionForUpdate(Editor editor, Language language) {
        return getEditorDescription(editor, language, EntityPermission.READ_WRITE);
    }

    public EditorDescriptionValue getEditorDescriptionValue(EditorDescription editorDescription) {
        return editorDescription == null? null: editorDescription.getEditorDescriptionValue().clone();
    }

    public EditorDescriptionValue getEditorDescriptionValueForUpdate(Editor editor, Language language) {
        return getEditorDescriptionValue(getEditorDescriptionForUpdate(editor, language));
    }

    private static final Map<EntityPermission, String> getEditorDescriptionsByEditorQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM editordescriptions, languages " +
                "WHERE edtrd_edtr_editorid = ? AND edtrd_thrutime = ? AND edtrd_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM editordescriptions " +
                "WHERE edtrd_edtr_editorid = ? AND edtrd_thrutime = ? " +
                "FOR UPDATE");
        getEditorDescriptionsByEditorQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<EditorDescription> getEditorDescriptionsByEditor(Editor editor, EntityPermission entityPermission) {
        return EditorDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getEditorDescriptionsByEditorQueries,
                editor, Session.MAX_TIME);
    }

    public List<EditorDescription> getEditorDescriptionsByEditor(Editor editor) {
        return getEditorDescriptionsByEditor(editor, EntityPermission.READ_ONLY);
    }

    public List<EditorDescription> getEditorDescriptionsByEditorForUpdate(Editor editor) {
        return getEditorDescriptionsByEditor(editor, EntityPermission.READ_WRITE);
    }

    public String getBestEditorDescription(Editor editor, Language language) {
        String description;
        var editorDescription = getEditorDescription(editor, language);

        if(editorDescription == null && !language.getIsDefault()) {
            editorDescription = getEditorDescription(editor, getPartyControl().getDefaultLanguage());
        }

        if(editorDescription == null) {
            description = editor.getLastDetail().getEditorName();
        } else {
            description = editorDescription.getDescription();
        }

        return description;
    }

    public EditorDescriptionTransfer getEditorDescriptionTransfer(UserVisit userVisit, EditorDescription editorDescription) {
        return getCoreTransferCaches(userVisit).getEditorDescriptionTransferCache().getEditorDescriptionTransfer(editorDescription);
    }

    public List<EditorDescriptionTransfer> getEditorDescriptionTransfersByEditor(UserVisit userVisit, Editor editor) {
        var editorDescriptions = getEditorDescriptionsByEditor(editor);
        List<EditorDescriptionTransfer> editorDescriptionTransfers = new ArrayList<>(editorDescriptions.size());
        var editorDescriptionTransferCache = getCoreTransferCaches(userVisit).getEditorDescriptionTransferCache();

        editorDescriptions.forEach((editorDescription) ->
                editorDescriptionTransfers.add(editorDescriptionTransferCache.getEditorDescriptionTransfer(editorDescription))
        );

        return editorDescriptionTransfers;
    }

    public void updateEditorDescriptionFromValue(EditorDescriptionValue editorDescriptionValue, BasePK updatedBy) {
        if(editorDescriptionValue.hasBeenModified()) {
            var editorDescription = EditorDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    editorDescriptionValue.getPrimaryKey());

            editorDescription.setThruTime(session.START_TIME_LONG);
            editorDescription.store();

            var editor = editorDescription.getEditor();
            var language = editorDescription.getLanguage();
            var description = editorDescriptionValue.getDescription();

            editorDescription = EditorDescriptionFactory.getInstance().create(editor, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(editor.getPrimaryKey(), EventTypes.MODIFY, editorDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteEditorDescription(EditorDescription editorDescription, BasePK deletedBy) {
        editorDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(editorDescription.getEditorPK(), EventTypes.MODIFY, editorDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteEditorDescriptionsByEditor(Editor editor, BasePK deletedBy) {
        var editorDescriptions = getEditorDescriptionsByEditorForUpdate(editor);

        editorDescriptions.forEach((editorDescription) -> 
                deleteEditorDescription(editorDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Application Editors
    // --------------------------------------------------------------------------------

    public ApplicationEditor createApplicationEditor(Application application, Editor editor, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultApplicationEditor = getDefaultApplicationEditor(application);
        var defaultFound = defaultApplicationEditor != null;

        if(defaultFound && isDefault) {
            var defaultApplicationEditorDetailValue = getDefaultApplicationEditorDetailValueForUpdate(application);

            defaultApplicationEditorDetailValue.setIsDefault(Boolean.FALSE);
            updateApplicationEditorFromValue(defaultApplicationEditorDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var applicationEditor = ApplicationEditorFactory.getInstance().create();
        var applicationEditorDetail = ApplicationEditorDetailFactory.getInstance().create(applicationEditor, application, editor, isDefault,
                sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        // Convert to R/W
        applicationEditor = ApplicationEditorFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, applicationEditor.getPrimaryKey());
        applicationEditor.setActiveDetail(applicationEditorDetail);
        applicationEditor.setLastDetail(applicationEditorDetail);
        applicationEditor.store();

        sendEvent(applicationEditor.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return applicationEditor;
    }

    private static final Map<EntityPermission, String> getApplicationEditorQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM applicationeditors, applicationeditordetails "
                + "WHERE appledtr_activedetailid = appledtrdt_applicationeditordetailid "
                + "AND appledtrdt_appl_applicationid = ? AND appledtrdt_edtr_editorid = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM applicationeditors, applicationeditordetails "
                + "WHERE appledtr_activedetailid = appledtrdt_applicationeditordetailid "
                + "AND appledtrdt_appl_applicationid = ? AND appledtrdt_edtr_editorid = ? "
                + "FOR UPDATE");
        getApplicationEditorQueries = Collections.unmodifiableMap(queryMap);
    }

    private ApplicationEditor getApplicationEditor(Application application, Editor editor, EntityPermission entityPermission) {
        return ApplicationEditorFactory.getInstance().getEntityFromQuery(entityPermission, getApplicationEditorQueries,
                application, editor);
    }

    public ApplicationEditor getApplicationEditor(Application application, Editor editor) {
        return getApplicationEditor(application, editor, EntityPermission.READ_ONLY);
    }

    public ApplicationEditor getApplicationEditorForUpdate(Application application, Editor editor) {
        return getApplicationEditor(application, editor, EntityPermission.READ_WRITE);
    }

    public ApplicationEditorDetailValue getApplicationEditorDetailValueForUpdate(ApplicationEditor applicationEditor) {
        return applicationEditor == null? null: applicationEditor.getLastDetailForUpdate().getApplicationEditorDetailValue().clone();
    }

    public ApplicationEditorDetailValue getApplicationEditorDetailValueForUpdate(Application application, Editor editor) {
        return getApplicationEditorDetailValueForUpdate(getApplicationEditorForUpdate(application, editor));
    }

    private static final Map<EntityPermission, String> getDefaultApplicationEditorQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM applicationeditors, applicationeditordetails "
                + "WHERE appledtr_activedetailid = appledtrdt_applicationeditordetailid "
                + "AND appledtrdt_appl_applicationid = ? AND appledtrdt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM applicationeditors, applicationeditordetails "
                + "WHERE appledtr_activedetailid = appledtrdt_applicationeditordetailid "
                + "AND appledtrdt_appl_applicationid = ? AND appledtrdt_isdefault = 1 "
                + "FOR UPDATE");
        getDefaultApplicationEditorQueries = Collections.unmodifiableMap(queryMap);
    }

    private ApplicationEditor getDefaultApplicationEditor(Application application, EntityPermission entityPermission) {
        return ApplicationEditorFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultApplicationEditorQueries,
                application);
    }

    public ApplicationEditor getDefaultApplicationEditor(Application application) {
        return getDefaultApplicationEditor(application, EntityPermission.READ_ONLY);
    }

    public ApplicationEditor getDefaultApplicationEditorForUpdate(Application application) {
        return getDefaultApplicationEditor(application, EntityPermission.READ_WRITE);
    }

    public ApplicationEditorDetailValue getDefaultApplicationEditorDetailValueForUpdate(Application application) {
        return getDefaultApplicationEditorForUpdate(application).getLastDetailForUpdate().getApplicationEditorDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getApplicationEditorsByApplicationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM applicationeditors, applicationeditordetails, editors, editordetails "
                + "WHERE appledtr_activedetailid = appledtrdt_applicationeditordetailid AND appledtrdt_appl_applicationid = ? "
                + "AND appledtrdt_edtr_editorid = edtr_editorid AND edtr_lastdetailid = edtrdt_editordetailid "
                + "ORDER BY edtrdt_sortorder, edtrdt_editorname "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM applicationeditors, applicationeditordetails "
                + "WHERE appledtr_activedetailid = appledtrdt_applicationeditordetailid AND appledtrdt_appl_applicationid = ? "
                + "FOR UPDATE");
        getApplicationEditorsByApplicationQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ApplicationEditor> getApplicationEditorsByApplication(Application application, EntityPermission entityPermission) {
        return ApplicationEditorFactory.getInstance().getEntitiesFromQuery(entityPermission, getApplicationEditorsByApplicationQueries,
                application);
    }

    public List<ApplicationEditor> getApplicationEditorsByApplication(Application application) {
        return getApplicationEditorsByApplication(application, EntityPermission.READ_ONLY);
    }

    public List<ApplicationEditor> getApplicationEditorsByApplicationForUpdate(Application application) {
        return getApplicationEditorsByApplication(application, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getApplicationEditorsByEditorQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM applicationeditors, applicationeditordetails, applications, applicationdetails "
                + "WHERE appledtr_activedetailid = appledtrdt_applicationeditordetailid AND appledtrdt_edtr_editorid = ? "
                + "AND appledtrdt_appl_applicationid = appl_applicationid AND appl_lastdetailid = appldt_applicationdetailid "
                + "ORDER BY appldt_sortorder, appldt_applicationname "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM applicationeditors, applicationeditordetails "
                + "WHERE appledtr_activedetailid = appledtrdt_applicationeditordetailid AND appledtrdt_edtr_editorid = ? "
                + "FOR UPDATE");
        getApplicationEditorsByEditorQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ApplicationEditor> getApplicationEditorsByEditor(Editor editor, EntityPermission entityPermission) {
        return ApplicationEditorFactory.getInstance().getEntitiesFromQuery(entityPermission, getApplicationEditorsByEditorQueries,
                editor);
    }

    public List<ApplicationEditor> getApplicationEditorsByEditor(Editor editor) {
        return getApplicationEditorsByEditor(editor, EntityPermission.READ_ONLY);
    }

    public List<ApplicationEditor> getApplicationEditorsByEditorForUpdate(Editor editor) {
        return getApplicationEditorsByEditor(editor, EntityPermission.READ_WRITE);
    }

    public ApplicationEditorTransfer getApplicationEditorTransfer(UserVisit userVisit, ApplicationEditor applicationEditor) {
        return getCoreTransferCaches(userVisit).getApplicationEditorTransferCache().getApplicationEditorTransfer(applicationEditor);
    }

    public List<ApplicationEditorTransfer> getApplicationEditorTransfers(List<ApplicationEditor> applicationEditors, UserVisit userVisit) {
        List<ApplicationEditorTransfer> applicationEditorTransfers = new ArrayList<>(applicationEditors.size());
        var applicationEditorTransferCache = getCoreTransferCaches(userVisit).getApplicationEditorTransferCache();

        applicationEditors.forEach((applicationEditor) ->
                applicationEditorTransfers.add(applicationEditorTransferCache.getApplicationEditorTransfer(applicationEditor))
        );

        return applicationEditorTransfers;
    }

    public List<ApplicationEditorTransfer> getApplicationEditorTransfersByApplication(UserVisit userVisit, Application application) {
        return getApplicationEditorTransfers(getApplicationEditorsByApplication(application), userVisit);
    }
    
    public List<ApplicationEditorTransfer> getApplicationEditorTransfersByEditor(UserVisit userVisit, Editor editor) {
        return getApplicationEditorTransfers(getApplicationEditorsByEditor(editor), userVisit);
    }
    
    public ApplicationEditorChoicesBean getApplicationEditorChoices(String defaultApplicationEditorChoice, Language language, boolean allowNullChoice,
            Application application) {
        var applicationEditors = getApplicationEditorsByApplication(application);
        var size = applicationEditors.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultApplicationEditorChoice == null) {
                defaultValue = "";
            }
        }

        for(var applicationEditor : applicationEditors) {
            var applicationEditorDetail = applicationEditor.getLastDetail();
            var editor = applicationEditorDetail.getEditor();

            var label = getBestEditorDescription(editor, language);
            var value = editor.getLastDetail().getEditorName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultApplicationEditorChoice != null && defaultApplicationEditorChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && applicationEditorDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new ApplicationEditorChoicesBean(labels, values, defaultValue);
    }

    private void updateApplicationEditorFromValue(ApplicationEditorDetailValue applicationEditorDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(applicationEditorDetailValue.hasBeenModified()) {
            var applicationEditor = ApplicationEditorFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     applicationEditorDetailValue.getApplicationEditorPK());
            var applicationEditorDetail = applicationEditor.getActiveDetailForUpdate();

            applicationEditorDetail.setThruTime(session.START_TIME_LONG);
            applicationEditorDetail.store();

            var applicationEditorPK = applicationEditorDetail.getApplicationEditorPK(); // Not updated
            var application = applicationEditorDetail.getApplication();
            var applicationPK = application.getPrimaryKey(); // Not updated
            var editorPK = applicationEditorDetail.getEditorPK(); // Not updated
            var isDefault = applicationEditorDetailValue.getIsDefault();
            var sortOrder = applicationEditorDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultApplicationEditor = getDefaultApplicationEditor(application);
                var defaultFound = defaultApplicationEditor != null && !defaultApplicationEditor.equals(applicationEditor);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultApplicationEditorDetailValue = getDefaultApplicationEditorDetailValueForUpdate(application);

                    defaultApplicationEditorDetailValue.setIsDefault(Boolean.FALSE);
                    updateApplicationEditorFromValue(defaultApplicationEditorDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            applicationEditorDetail = ApplicationEditorDetailFactory.getInstance().create(applicationEditorPK, applicationPK, editorPK, isDefault, sortOrder,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            applicationEditor.setActiveDetail(applicationEditorDetail);
            applicationEditor.setLastDetail(applicationEditorDetail);

            sendEvent(applicationEditorPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateApplicationEditorFromValue(ApplicationEditorDetailValue applicationEditorDetailValue, BasePK updatedBy) {
        updateApplicationEditorFromValue(applicationEditorDetailValue, true, updatedBy);
    }

    private void deleteApplicationEditor(ApplicationEditor applicationEditor, boolean checkDefault, BasePK deletedBy) {
        var applicationEditorDetail = applicationEditor.getLastDetailForUpdate();
        var application = applicationEditorDetail.getApplication();

        deleteApplicationEditorUsesByDefaultApplicationEditor(applicationEditor, deletedBy);
        deletePartyApplicationEditorUsesByApplicationEditor(applicationEditor, deletedBy);
        
        applicationEditorDetail.setThruTime(session.START_TIME_LONG);
        applicationEditor.setActiveDetail(null);
        applicationEditor.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultApplicationEditor = getDefaultApplicationEditor(application);

            if(defaultApplicationEditor == null) {
                var applicationEditors = getApplicationEditorsByApplicationForUpdate(application);

                if(!applicationEditors.isEmpty()) {
                    var iter = applicationEditors.iterator();
                    if(iter.hasNext()) {
                        defaultApplicationEditor = iter.next();
                    }
                    var applicationEditorDetailValue = Objects.requireNonNull(defaultApplicationEditor).getLastDetailForUpdate().getApplicationEditorDetailValue().clone();

                    applicationEditorDetailValue.setIsDefault(Boolean.TRUE);
                    updateApplicationEditorFromValue(applicationEditorDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(applicationEditor.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteApplicationEditor(ApplicationEditor applicationEditor, BasePK deletedBy) {
        deleteApplicationEditor(applicationEditor, true, deletedBy);
    }

    private void deleteApplicationEditors(List<ApplicationEditor> applicationEditors, boolean checkDefault, BasePK deletedBy) {
        applicationEditors.forEach((applicationEditor) -> deleteApplicationEditor(applicationEditor, checkDefault, deletedBy));
    }

    public void deleteApplicationEditors(List<ApplicationEditor> applicationEditors, BasePK deletedBy) {
        deleteApplicationEditors(applicationEditors, true, deletedBy);
    }
    
    public void deleteApplicationEditorsByApplication(Application application, BasePK deletedBy) {
        deleteApplicationEditors(getApplicationEditorsByApplicationForUpdate(application), false, deletedBy);
    }
    
    public void deleteApplicationEditorsByEditor(Editor editor, BasePK deletedBy) {
        deleteApplicationEditors(getApplicationEditorsByEditorForUpdate(editor), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Application Editor Uses
    // --------------------------------------------------------------------------------

    public ApplicationEditorUse createApplicationEditorUse(Application application, String applicationEditorUseName, ApplicationEditor defaultApplicationEditor,
            Integer defaultHeight, Integer defaultWidth, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultApplicationEditorUse = getDefaultApplicationEditorUse(application);
        var defaultFound = defaultApplicationEditorUse != null;

        if(defaultFound && isDefault) {
            var defaultApplicationEditorUseDetailValue = getDefaultApplicationEditorUseDetailValueForUpdate(application);

            defaultApplicationEditorUseDetailValue.setIsDefault(Boolean.FALSE);
            updateApplicationEditorUseFromValue(defaultApplicationEditorUseDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var applicationEditorUse = ApplicationEditorUseFactory.getInstance().create();
        var applicationEditorUseDetail = ApplicationEditorUseDetailFactory.getInstance().create(applicationEditorUse, application,
                applicationEditorUseName, defaultApplicationEditor, defaultHeight, defaultWidth, isDefault, sortOrder, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);

        // Convert to R/W
        applicationEditorUse = ApplicationEditorUseFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, applicationEditorUse.getPrimaryKey());
        applicationEditorUse.setActiveDetail(applicationEditorUseDetail);
        applicationEditorUse.setLastDetail(applicationEditorUseDetail);
        applicationEditorUse.store();

        sendEvent(applicationEditorUse.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return applicationEditorUse;
    }

    private static final Map<EntityPermission, String> getApplicationEditorUseByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM applicationeditoruses, applicationeditorusedetails "
                + "WHERE appledtruse_activedetailid = appledtrusedt_applicationeditorusedetailid "
                + "AND appledtrusedt_appl_applicationid = ? AND appledtrusedt_applicationeditorusename = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM applicationeditoruses, applicationeditorusedetails "
                + "WHERE appledtruse_activedetailid = appledtrusedt_applicationeditorusedetailid "
                + "AND appledtrusedt_appl_applicationid = ? AND appledtrusedt_applicationeditorusename = ? "
                + "FOR UPDATE");
        getApplicationEditorUseByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private ApplicationEditorUse getApplicationEditorUseByName(Application application, String applicationEditorUseName, EntityPermission entityPermission) {
        return ApplicationEditorUseFactory.getInstance().getEntityFromQuery(entityPermission, getApplicationEditorUseByNameQueries,
                application, applicationEditorUseName);
    }

    public ApplicationEditorUse getApplicationEditorUseByName(Application application, String applicationEditorUseName) {
        return getApplicationEditorUseByName(application, applicationEditorUseName, EntityPermission.READ_ONLY);
    }

    public ApplicationEditorUse getApplicationEditorUseByNameForUpdate(Application application, String applicationEditorUseName) {
        return getApplicationEditorUseByName(application, applicationEditorUseName, EntityPermission.READ_WRITE);
    }

    public ApplicationEditorUseDetailValue getApplicationEditorUseDetailValueForUpdate(ApplicationEditorUse applicationEditorUse) {
        return applicationEditorUse == null ? null : applicationEditorUse.getLastDetailForUpdate().getApplicationEditorUseDetailValue().clone();
    }

    public ApplicationEditorUseDetailValue getApplicationEditorUseDetailValueByNameForUpdate(Application application, String applicationEditorUseName) {
        return getApplicationEditorUseDetailValueForUpdate(getApplicationEditorUseByNameForUpdate(application, applicationEditorUseName));
    }

    private static final Map<EntityPermission, String> getDefaultApplicationEditorUseQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM applicationeditoruses, applicationeditorusedetails "
                + "WHERE appledtruse_activedetailid = appledtrusedt_applicationeditorusedetailid "
                + "AND appledtrusedt_appl_applicationid = ? AND appledtrusedt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM applicationeditoruses, applicationeditorusedetails "
                + "WHERE appledtruse_activedetailid = appledtrusedt_applicationeditorusedetailid "
                + "AND appledtrusedt_appl_applicationid = ? AND appledtrusedt_isdefault = 1 "
                + "FOR UPDATE");
        getDefaultApplicationEditorUseQueries = Collections.unmodifiableMap(queryMap);
    }

    private ApplicationEditorUse getDefaultApplicationEditorUse(Application application, EntityPermission entityPermission) {
        return ApplicationEditorUseFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultApplicationEditorUseQueries,
                application);
    }

    public ApplicationEditorUse getDefaultApplicationEditorUse(Application application) {
        return getDefaultApplicationEditorUse(application, EntityPermission.READ_ONLY);
    }

    public ApplicationEditorUse getDefaultApplicationEditorUseForUpdate(Application application) {
        return getDefaultApplicationEditorUse(application, EntityPermission.READ_WRITE);
    }

    public ApplicationEditorUseDetailValue getDefaultApplicationEditorUseDetailValueForUpdate(Application application) {
        return getDefaultApplicationEditorUseForUpdate(application).getLastDetailForUpdate().getApplicationEditorUseDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getApplicationEditorUsesByApplicationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM applicationeditoruses, applicationeditorusedetails "
                + "WHERE appledtruse_activedetailid = appledtrusedt_applicationeditorusedetailid AND appledtrusedt_appl_applicationid = ? "
                + "ORDER BY appledtrusedt_sortorder, appledtrusedt_applicationeditorusename "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM applicationeditoruses, applicationeditorusedetails "
                + "WHERE appledtruse_activedetailid = appledtrusedt_applicationeditorusedetailid AND appledtrusedt_appl_applicationid = ? "
                + "FOR UPDATE");
        getApplicationEditorUsesByApplicationQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ApplicationEditorUse> getApplicationEditorUsesByApplication(Application application, EntityPermission entityPermission) {
        return ApplicationEditorUseFactory.getInstance().getEntitiesFromQuery(entityPermission, getApplicationEditorUsesByApplicationQueries,
                application);
    }

    public List<ApplicationEditorUse> getApplicationEditorUsesByApplication(Application application) {
        return getApplicationEditorUsesByApplication(application, EntityPermission.READ_ONLY);
    }

    public List<ApplicationEditorUse> getApplicationEditorUsesByApplicationForUpdate(Application application) {
        return getApplicationEditorUsesByApplication(application, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getApplicationEditorUsesByDefaultApplicationEditorQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM applicationeditoruses, applicationeditorusedetails, applications, applicationdetails "
                + "WHERE appledtruse_activedetailid = appledtrusedt_applicationeditorusedetailid AND appledtrusedt_defaultapplicationeditorid = ? "
                + "AND appledtrusedt_appl_applicationid = appl_applicationid AND appl_lastdetailid = appldt_applicationdetailid "
                + "ORDER BY appledtrusedt_sortorder, appledtrusedt_applicationeditorusename, appldt_sortorder, appldt_applicationname "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM applicationeditoruses, applicationeditorusedetails "
                + "WHERE appledtruse_activedetailid = appledtrusedt_applicationeditorusedetailid AND appledtrusedt_defaultapplicationeditorid = ? "
                + "FOR UPDATE");
        getApplicationEditorUsesByDefaultApplicationEditorQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ApplicationEditorUse> getApplicationEditorUsesByDefaultApplicationEditor(ApplicationEditor defaultApplicationEditor,
            EntityPermission entityPermission) {
        return ApplicationEditorUseFactory.getInstance().getEntitiesFromQuery(entityPermission, getApplicationEditorUsesByDefaultApplicationEditorQueries,
                defaultApplicationEditor);
    }

    public List<ApplicationEditorUse> getApplicationEditorUsesByDefaultApplicationEditor(ApplicationEditor defaultApplicationEditor) {
        return getApplicationEditorUsesByDefaultApplicationEditor(defaultApplicationEditor, EntityPermission.READ_ONLY);
    }

    public List<ApplicationEditorUse> getApplicationEditorUsesByDefaultApplicationEditorForUpdate(ApplicationEditor defaultApplicationEditor) {
        return getApplicationEditorUsesByDefaultApplicationEditor(defaultApplicationEditor, EntityPermission.READ_WRITE);
    }

    public ApplicationEditorUseTransfer getApplicationEditorUseTransfer(UserVisit userVisit, ApplicationEditorUse applicationEditorUse) {
        return getCoreTransferCaches(userVisit).getApplicationEditorUseTransferCache().getApplicationEditorUseTransfer(applicationEditorUse);
    }

    public List<ApplicationEditorUseTransfer> getApplicationEditorUseTransfers(List<ApplicationEditorUse> applicationEditorUses, UserVisit userVisit) {
        List<ApplicationEditorUseTransfer> applicationEditorUseTransfers = new ArrayList<>(applicationEditorUses.size());
        var applicationEditorUseTransferCache = getCoreTransferCaches(userVisit).getApplicationEditorUseTransferCache();

        applicationEditorUses.forEach((applicationEditorUse) ->
                applicationEditorUseTransfers.add(applicationEditorUseTransferCache.getApplicationEditorUseTransfer(applicationEditorUse))
        );

        return applicationEditorUseTransfers;
    }

    public List<ApplicationEditorUseTransfer> getApplicationEditorUseTransfersByApplication(UserVisit userVisit, Application application) {
        return getApplicationEditorUseTransfers(getApplicationEditorUsesByApplication(application), userVisit);
    }
    
    public List<ApplicationEditorUseTransfer> getApplicationEditorUseTransfersByDefaultApplicationEditor(UserVisit userVisit, ApplicationEditor defaultApplicationEditor) {
        return getApplicationEditorUseTransfers(getApplicationEditorUsesByDefaultApplicationEditor(defaultApplicationEditor), userVisit);
    }
    
    public ApplicationEditorUseChoicesBean getApplicationEditorUseChoices(String defaultApplicationEditorUseChoice, Language language, boolean allowNullChoice,
            Application application) {
        var applicationEditorUses = getApplicationEditorUsesByApplication(application);
        var size = applicationEditorUses.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultApplicationEditorUseChoice == null) {
                defaultValue = "";
            }
        }

        for(var applicationEditorUse : applicationEditorUses) {
            var applicationEditorUseDetail = applicationEditorUse.getLastDetail();

            var label = getBestApplicationEditorUseDescription(applicationEditorUse, language);
            var value = applicationEditorUseDetail.getApplicationEditorUseName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultApplicationEditorUseChoice != null && defaultApplicationEditorUseChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && applicationEditorUseDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new ApplicationEditorUseChoicesBean(labels, values, defaultValue);
    }

    private void updateApplicationEditorUseFromValue(ApplicationEditorUseDetailValue applicationEditorUseDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(applicationEditorUseDetailValue.hasBeenModified()) {
            var applicationEditorUse = ApplicationEditorUseFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     applicationEditorUseDetailValue.getApplicationEditorUsePK());
            var applicationEditorUseDetail = applicationEditorUse.getActiveDetailForUpdate();

            applicationEditorUseDetail.setThruTime(session.START_TIME_LONG);
            applicationEditorUseDetail.store();

            var applicationEditorUsePK = applicationEditorUseDetail.getApplicationEditorUsePK(); // Not updated
            var application = applicationEditorUseDetail.getApplication();
            var applicationPK = application.getPrimaryKey(); // Not updated
            var applicationEditorUseName = applicationEditorUseDetailValue.getApplicationEditorUseName();
            var defaultApplicationEditorPK = applicationEditorUseDetailValue.getDefaultApplicationEditorPK();
            var defaultHeight = applicationEditorUseDetailValue.getDefaultHeight();
            var defaultWidth = applicationEditorUseDetailValue.getDefaultWidth();
            var isDefault = applicationEditorUseDetailValue.getIsDefault();
            var sortOrder = applicationEditorUseDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultApplicationEditorUse = getDefaultApplicationEditorUse(application);
                var defaultFound = defaultApplicationEditorUse != null && !defaultApplicationEditorUse.equals(applicationEditorUse);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultApplicationEditorUseDetailValue = getDefaultApplicationEditorUseDetailValueForUpdate(application);

                    defaultApplicationEditorUseDetailValue.setIsDefault(Boolean.FALSE);
                    updateApplicationEditorUseFromValue(defaultApplicationEditorUseDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            applicationEditorUseDetail = ApplicationEditorUseDetailFactory.getInstance().create(applicationEditorUsePK, applicationPK, applicationEditorUseName,
                    defaultApplicationEditorPK, defaultHeight, defaultWidth, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);

            applicationEditorUse.setActiveDetail(applicationEditorUseDetail);
            applicationEditorUse.setLastDetail(applicationEditorUseDetail);

            sendEvent(applicationEditorUsePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateApplicationEditorUseFromValue(ApplicationEditorUseDetailValue applicationEditorUseDetailValue, BasePK updatedBy) {
        updateApplicationEditorUseFromValue(applicationEditorUseDetailValue, true, updatedBy);
    }

    private void deleteApplicationEditorUse(ApplicationEditorUse applicationEditorUse, boolean checkDefault, BasePK deletedBy) {
        var applicationEditorUseDetail = applicationEditorUse.getLastDetailForUpdate();
        var application = applicationEditorUseDetail.getApplication();

        deleteApplicationEditorUseDescriptionsByApplicationEditorUse(applicationEditorUse, deletedBy);
        deletePartyApplicationEditorUsesByParty(applicationEditorUse, deletedBy);
        
        applicationEditorUseDetail.setThruTime(session.START_TIME_LONG);
        applicationEditorUse.setActiveDetail(null);
        applicationEditorUse.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultApplicationEditorUse = getDefaultApplicationEditorUse(application);

            if(defaultApplicationEditorUse == null) {
                var applicationEditorUses = getApplicationEditorUsesByApplicationForUpdate(application);

                if(!applicationEditorUses.isEmpty()) {
                    var iter = applicationEditorUses.iterator();
                    if(iter.hasNext()) {
                        defaultApplicationEditorUse = iter.next();
                    }
                    var applicationEditorUseDetailValue = Objects.requireNonNull(defaultApplicationEditorUse).getLastDetailForUpdate().getApplicationEditorUseDetailValue().clone();

                    applicationEditorUseDetailValue.setIsDefault(Boolean.TRUE);
                    updateApplicationEditorUseFromValue(applicationEditorUseDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(applicationEditorUse.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteApplicationEditorUse(ApplicationEditorUse applicationEditorUse, BasePK deletedBy) {
        deleteApplicationEditorUse(applicationEditorUse, true, deletedBy);
    }

    private void deleteApplicationEditorUses(List<ApplicationEditorUse> applicationEditorUses, boolean checkDefault, BasePK deletedBy) {
        applicationEditorUses.forEach((applicationEditorUse) -> deleteApplicationEditorUse(applicationEditorUse, checkDefault, deletedBy));
    }

    public void deleteApplicationEditorUses(List<ApplicationEditorUse> applicationEditorUses, BasePK deletedBy) {
        deleteApplicationEditorUses(applicationEditorUses, true, deletedBy);
    }
    
    public void deleteApplicationEditorUsesByApplication(Application application, BasePK deletedBy) {
        deleteApplicationEditorUses(getApplicationEditorUsesByApplicationForUpdate(application), false, deletedBy);
    }
    
    public void deleteApplicationEditorUsesByDefaultApplicationEditor(ApplicationEditor defaultApplicationEditor, BasePK deletedBy) {
        deleteApplicationEditorUses(getApplicationEditorUsesByDefaultApplicationEditorForUpdate(defaultApplicationEditor), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Application Editor Use Descriptions
    // --------------------------------------------------------------------------------

    public ApplicationEditorUseDescription createApplicationEditorUseDescription(ApplicationEditorUse applicationEditorUse, Language language,
            String description, BasePK createdBy) {
        var applicationEditorUseDescription = ApplicationEditorUseDescriptionFactory.getInstance().create(applicationEditorUse,
                language, description, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(applicationEditorUse.getPrimaryKey(), EventTypes.MODIFY, applicationEditorUseDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return applicationEditorUseDescription;
    }

    private static final Map<EntityPermission, String> getApplicationEditorUseDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM applicationeditorusedescriptions " +
                "WHERE appledtrused_appledtruse_applicationeditoruseid = ? AND appledtrused_lang_languageid = ? AND appledtrused_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM applicationeditorusedescriptions " +
                "WHERE appledtrused_appledtruse_applicationeditoruseid = ? AND appledtrused_lang_languageid = ? AND appledtrused_thrutime = ? " +
                "FOR UPDATE");
        getApplicationEditorUseDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private ApplicationEditorUseDescription getApplicationEditorUseDescription(ApplicationEditorUse applicationEditorUse, Language language, EntityPermission entityPermission) {
        return ApplicationEditorUseDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getApplicationEditorUseDescriptionQueries,
                applicationEditorUse, language, Session.MAX_TIME);
    }

    public ApplicationEditorUseDescription getApplicationEditorUseDescription(ApplicationEditorUse applicationEditorUse, Language language) {
        return getApplicationEditorUseDescription(applicationEditorUse, language, EntityPermission.READ_ONLY);
    }

    public ApplicationEditorUseDescription getApplicationEditorUseDescriptionForUpdate(ApplicationEditorUse applicationEditorUse, Language language) {
        return getApplicationEditorUseDescription(applicationEditorUse, language, EntityPermission.READ_WRITE);
    }

    public ApplicationEditorUseDescriptionValue getApplicationEditorUseDescriptionValue(ApplicationEditorUseDescription applicationEditorUseDescription) {
        return applicationEditorUseDescription == null? null: applicationEditorUseDescription.getApplicationEditorUseDescriptionValue().clone();
    }

    public ApplicationEditorUseDescriptionValue getApplicationEditorUseDescriptionValueForUpdate(ApplicationEditorUse applicationEditorUse, Language language) {
        return getApplicationEditorUseDescriptionValue(getApplicationEditorUseDescriptionForUpdate(applicationEditorUse, language));
    }

    private static final Map<EntityPermission, String> getApplicationEditorUseDescriptionsByApplicationEditorUseQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM applicationeditorusedescriptions, languages " +
                "WHERE appledtrused_appledtruse_applicationeditoruseid = ? AND appledtrused_thrutime = ? AND appledtrused_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM applicationeditorusedescriptions " +
                "WHERE appledtrused_appledtruse_applicationeditoruseid = ? AND appledtrused_thrutime = ? " +
                "FOR UPDATE");
        getApplicationEditorUseDescriptionsByApplicationEditorUseQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ApplicationEditorUseDescription> getApplicationEditorUseDescriptionsByApplicationEditorUse(ApplicationEditorUse applicationEditorUse, EntityPermission entityPermission) {
        return ApplicationEditorUseDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getApplicationEditorUseDescriptionsByApplicationEditorUseQueries,
                applicationEditorUse, Session.MAX_TIME);
    }

    public List<ApplicationEditorUseDescription> getApplicationEditorUseDescriptionsByApplicationEditorUse(ApplicationEditorUse applicationEditorUse) {
        return getApplicationEditorUseDescriptionsByApplicationEditorUse(applicationEditorUse, EntityPermission.READ_ONLY);
    }

    public List<ApplicationEditorUseDescription> getApplicationEditorUseDescriptionsByApplicationEditorUseForUpdate(ApplicationEditorUse applicationEditorUse) {
        return getApplicationEditorUseDescriptionsByApplicationEditorUse(applicationEditorUse, EntityPermission.READ_WRITE);
    }

    public String getBestApplicationEditorUseDescription(ApplicationEditorUse applicationEditorUse, Language language) {
        String description;
        var applicationEditorUseDescription = getApplicationEditorUseDescription(applicationEditorUse, language);

        if(applicationEditorUseDescription == null && !language.getIsDefault()) {
            applicationEditorUseDescription = getApplicationEditorUseDescription(applicationEditorUse, getPartyControl().getDefaultLanguage());
        }

        if(applicationEditorUseDescription == null) {
            description = applicationEditorUse.getLastDetail().getApplicationEditorUseName();
        } else {
            description = applicationEditorUseDescription.getDescription();
        }

        return description;
    }

    public ApplicationEditorUseDescriptionTransfer getApplicationEditorUseDescriptionTransfer(UserVisit userVisit, ApplicationEditorUseDescription applicationEditorUseDescription) {
        return getCoreTransferCaches(userVisit).getApplicationEditorUseDescriptionTransferCache().getApplicationEditorUseDescriptionTransfer(applicationEditorUseDescription);
    }

    public List<ApplicationEditorUseDescriptionTransfer> getApplicationEditorUseDescriptionTransfersByApplicationEditorUse(UserVisit userVisit, ApplicationEditorUse applicationEditorUse) {
        var applicationEditorUseDescriptions = getApplicationEditorUseDescriptionsByApplicationEditorUse(applicationEditorUse);
        List<ApplicationEditorUseDescriptionTransfer> applicationEditorUseDescriptionTransfers = new ArrayList<>(applicationEditorUseDescriptions.size());
        var applicationEditorUseDescriptionTransferCache = getCoreTransferCaches(userVisit).getApplicationEditorUseDescriptionTransferCache();

        applicationEditorUseDescriptions.forEach((applicationEditorUseDescription) ->
                applicationEditorUseDescriptionTransfers.add(applicationEditorUseDescriptionTransferCache.getApplicationEditorUseDescriptionTransfer(applicationEditorUseDescription))
        );

        return applicationEditorUseDescriptionTransfers;
    }

    public void updateApplicationEditorUseDescriptionFromValue(ApplicationEditorUseDescriptionValue applicationEditorUseDescriptionValue, BasePK updatedBy) {
        if(applicationEditorUseDescriptionValue.hasBeenModified()) {
            var applicationEditorUseDescription = ApplicationEditorUseDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    applicationEditorUseDescriptionValue.getPrimaryKey());

            applicationEditorUseDescription.setThruTime(session.START_TIME_LONG);
            applicationEditorUseDescription.store();

            var applicationEditorUse = applicationEditorUseDescription.getApplicationEditorUse();
            var language = applicationEditorUseDescription.getLanguage();
            var description = applicationEditorUseDescriptionValue.getDescription();

            applicationEditorUseDescription = ApplicationEditorUseDescriptionFactory.getInstance().create(applicationEditorUse, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(applicationEditorUse.getPrimaryKey(), EventTypes.MODIFY, applicationEditorUseDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteApplicationEditorUseDescription(ApplicationEditorUseDescription applicationEditorUseDescription, BasePK deletedBy) {
        applicationEditorUseDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(applicationEditorUseDescription.getApplicationEditorUsePK(), EventTypes.MODIFY, applicationEditorUseDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteApplicationEditorUseDescriptionsByApplicationEditorUse(ApplicationEditorUse applicationEditorUse, BasePK deletedBy) {
        var applicationEditorUseDescriptions = getApplicationEditorUseDescriptionsByApplicationEditorUseForUpdate(applicationEditorUse);

        applicationEditorUseDescriptions.forEach((applicationEditorUseDescription) -> 
                deleteApplicationEditorUseDescription(applicationEditorUseDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Party Application Editor Uses
    // --------------------------------------------------------------------------------

    public PartyApplicationEditorUse createPartyApplicationEditorUse(Party party, ApplicationEditorUse applicationEditorUse,
            ApplicationEditor applicationEditor, Integer preferredHeight, Integer preferredWidth, BasePK createdBy) {
        var partyApplicationEditorUse = PartyApplicationEditorUseFactory.getInstance().create();
        var partyApplicationEditorUseDetail = PartyApplicationEditorUseDetailFactory.getInstance().create(partyApplicationEditorUse,
                party, applicationEditorUse, applicationEditor, preferredHeight, preferredWidth, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        // Convert to R/W
        partyApplicationEditorUse = PartyApplicationEditorUseFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, partyApplicationEditorUse.getPrimaryKey());
        partyApplicationEditorUse.setActiveDetail(partyApplicationEditorUseDetail);
        partyApplicationEditorUse.setLastDetail(partyApplicationEditorUseDetail);
        partyApplicationEditorUse.store();

        sendEvent(partyApplicationEditorUse.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return partyApplicationEditorUse;
    }

    private static final Map<EntityPermission, String> getPartyApplicationEditorUseQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM partyapplicationeditoruses, partyapplicationeditorusedetails "
                + "WHERE parappledtruse_activedetailid = parappledtrusedt_partyapplicationeditorusedetailid "
                + "AND parappledtrusedt_par_partyid = ? AND parappledtrusedt_appledtruse_applicationeditoruseid = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM partyapplicationeditoruses, partyapplicationeditorusedetails "
                + "WHERE parappledtruse_activedetailid = parappledtrusedt_partyapplicationeditorusedetailid "
                + "AND parappledtrusedt_par_partyid = ? AND parappledtrusedt_appledtruse_applicationeditoruseid = ? "
                + "FOR UPDATE");
        getPartyApplicationEditorUseQueries = Collections.unmodifiableMap(queryMap);
    }

    private PartyApplicationEditorUse getPartyApplicationEditorUse(Party party, ApplicationEditorUse applicationEditorUse, EntityPermission entityPermission) {
        return PartyApplicationEditorUseFactory.getInstance().getEntityFromQuery(entityPermission, getPartyApplicationEditorUseQueries,
                party, applicationEditorUse);
    }

    public PartyApplicationEditorUse getPartyApplicationEditorUse(Party party, ApplicationEditorUse applicationEditorUse) {
        return getPartyApplicationEditorUse(party, applicationEditorUse, EntityPermission.READ_ONLY);
    }

    public PartyApplicationEditorUse getPartyApplicationEditorUseForUpdate(Party party, ApplicationEditorUse applicationEditorUse) {
        return getPartyApplicationEditorUse(party, applicationEditorUse, EntityPermission.READ_WRITE);
    }

    public PartyApplicationEditorUseDetailValue getPartyApplicationEditorUseDetailValueForUpdate(PartyApplicationEditorUse partyApplicationEditorUse) {
        return partyApplicationEditorUse == null? null: partyApplicationEditorUse.getLastDetailForUpdate().getPartyApplicationEditorUseDetailValue().clone();
    }

    public PartyApplicationEditorUseDetailValue getPartyApplicationEditorUseDetailValueForUpdate(Party party, ApplicationEditorUse applicationEditorUse) {
        return getPartyApplicationEditorUseDetailValueForUpdate(getPartyApplicationEditorUseForUpdate(party, applicationEditorUse));
    }

    private static final Map<EntityPermission, String> getPartyApplicationEditorUsesByPartyQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM partyapplicationeditoruses, partyapplicationeditorusedetails, applicationeditoruses, applicationeditorusedetails "
                + "WHERE parappledtruse_activedetailid = parappledtrusedt_partyapplicationeditorusedetailid AND parappledtrusedt_par_partyid = ? "
                + "AND parappledtrusedt_appledtruse_applicationeditoruseid = appledtruse_applicationeditoruseid AND appledtruse_lastdetailid = appledtrusedt_applicationeditorusedetailid "
                + "ORDER BY appledtrusedt_sortorder, appledtrusedt_applicationeditorusename "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM partyapplicationeditoruses, partyapplicationeditorusedetails "
                + "WHERE parappledtruse_activedetailid = parappledtrusedt_partyapplicationeditorusedetailid AND parappledtrusedt_par_partyid = ? "
                + "FOR UPDATE");
        getPartyApplicationEditorUsesByPartyQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<PartyApplicationEditorUse> getPartyApplicationEditorUsesByParty(Party party, EntityPermission entityPermission) {
        return PartyApplicationEditorUseFactory.getInstance().getEntitiesFromQuery(entityPermission, getPartyApplicationEditorUsesByPartyQueries,
                party);
    }

    public List<PartyApplicationEditorUse> getPartyApplicationEditorUsesByParty(Party party) {
        return getPartyApplicationEditorUsesByParty(party, EntityPermission.READ_ONLY);
    }

    public List<PartyApplicationEditorUse> getPartyApplicationEditorUsesByPartyForUpdate(Party party) {
        return getPartyApplicationEditorUsesByParty(party, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getPartyApplicationEditorUsesByApplicationEditorUseQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM partyapplicationeditoruses, partyapplicationeditorusedetails, parties, partydetails "
                + "WHERE parappledtruse_activedetailid = parappledtrusedt_partyapplicationeditorusedetailid AND parappledtrusedt_appledtruse_applicationeditoruseid = ? "
                + "AND parappledtrusedt_par_partyid = par_partyid AND par_lastdetailid = pardt_partydetailid "
                + "ORDER BY pardt_partyname "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM partyapplicationeditoruses, partyapplicationeditorusedetails, parties, partydetails "
                + "WHERE parappledtruse_activedetailid = parappledtrusedt_partyapplicationeditorusedetailid AND parappledtrusedt_appledtruse_applicationeditoruseid = ? "
                + "FOR UPDATE");
        getPartyApplicationEditorUsesByApplicationEditorUseQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<PartyApplicationEditorUse> getPartyApplicationEditorUsesByApplicationEditorUse(ApplicationEditorUse applicationEditorUse,
            EntityPermission entityPermission) {
        return PartyApplicationEditorUseFactory.getInstance().getEntitiesFromQuery(entityPermission, getPartyApplicationEditorUsesByApplicationEditorUseQueries,
                applicationEditorUse);
    }

    public List<PartyApplicationEditorUse> getPartyApplicationEditorUsesByApplicationEditorUse(ApplicationEditorUse applicationEditorUse) {
        return getPartyApplicationEditorUsesByApplicationEditorUse(applicationEditorUse, EntityPermission.READ_ONLY);
    }

    public List<PartyApplicationEditorUse> getPartyApplicationEditorUsesByApplicationEditorUseForUpdate(ApplicationEditorUse applicationEditorUse) {
        return getPartyApplicationEditorUsesByApplicationEditorUse(applicationEditorUse, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getPartyApplicationEditorUsesByApplicationEditorQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM partyapplicationeditoruses, partyapplicationeditorusedetails, parties, partydetails, applicationeditoruses, applicationeditorusedetails "
                + "WHERE parappledtruse_activedetailid = parappledtrusedt_partyapplicationeditorusedetailid AND parappledtrusedt_appledtr_applicationeditorid = ? "
                + "AND parappledtrusedt_par_partyid = par_partyid AND par_lastdetailid = pardt_partydetailid "
                + "AND parappledtrusedt_appledtruse_applicationeditoruseid = appledtruse_applicationeditoruseid AND appledtruse_lastdetailid = appledtrusedt_applicationeditorusedetailid "
                + "ORDER BY pardt_partyname, appledtrusedt_sortorder, appledtrusedt_applicationeditorusename "
                + "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM partyapplicationeditoruses, partyapplicationeditorusedetails "
                + "WHERE parappledtruse_activedetailid = parappledtrusedt_partyapplicationeditorusedetailid AND parappledtrusedt_appledtr_applicationeditorid = ? "
                + "FOR UPDATE");
        getPartyApplicationEditorUsesByApplicationEditorQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<PartyApplicationEditorUse> getPartyApplicationEditorUsesByApplicationEditor(ApplicationEditor applicationEditor,
            EntityPermission entityPermission) {
        return PartyApplicationEditorUseFactory.getInstance().getEntitiesFromQuery(entityPermission, getPartyApplicationEditorUsesByApplicationEditorQueries,
                applicationEditor);
    }

    public List<PartyApplicationEditorUse> getPartyApplicationEditorUsesByApplicationEditor(ApplicationEditor applicationEditor) {
        return getPartyApplicationEditorUsesByApplicationEditor(applicationEditor, EntityPermission.READ_ONLY);
    }

    public List<PartyApplicationEditorUse> getPartyApplicationEditorUsesByApplicationEditorForUpdate(ApplicationEditor applicationEditor) {
        return getPartyApplicationEditorUsesByApplicationEditor(applicationEditor, EntityPermission.READ_WRITE);
    }

    public PartyApplicationEditorUseTransfer getPartyApplicationEditorUseTransfer(UserVisit userVisit, PartyApplicationEditorUse partyApplicationEditorUse) {
        return getCoreTransferCaches(userVisit).getPartyApplicationEditorUseTransferCache().getPartyApplicationEditorUseTransfer(partyApplicationEditorUse);
    }

    public List<PartyApplicationEditorUseTransfer> getPartyApplicationEditorUseTransfers(List<PartyApplicationEditorUse> partyApplicationEditorUses, UserVisit userVisit) {
        List<PartyApplicationEditorUseTransfer> partyApplicationEditorUseTransfers = new ArrayList<>(partyApplicationEditorUses.size());
        var partyApplicationEditorUseTransferCache = getCoreTransferCaches(userVisit).getPartyApplicationEditorUseTransferCache();

        partyApplicationEditorUses.forEach((partyApplicationEditorUse) ->
                partyApplicationEditorUseTransfers.add(partyApplicationEditorUseTransferCache.getPartyApplicationEditorUseTransfer(partyApplicationEditorUse))
        );

        return partyApplicationEditorUseTransfers;
    }

    public List<PartyApplicationEditorUseTransfer> getPartyApplicationEditorUseTransfersByParty(UserVisit userVisit, Party party) {
        return getPartyApplicationEditorUseTransfers(getPartyApplicationEditorUsesByParty(party), userVisit);
    }
    
    public List<PartyApplicationEditorUseTransfer> getPartyApplicationEditorUseTransfersByApplicationEditorUse(UserVisit userVisit, ApplicationEditorUse applicationEditorUse) {
        return getPartyApplicationEditorUseTransfers(getPartyApplicationEditorUsesByApplicationEditorUse(applicationEditorUse), userVisit);
    }
    
    public List<PartyApplicationEditorUseTransfer> getPartyApplicationEditorUseTransfersByApplicationEditor(UserVisit userVisit, ApplicationEditor applicationEditor) {
        return getPartyApplicationEditorUseTransfers(getPartyApplicationEditorUsesByApplicationEditor(applicationEditor), userVisit);
    }
    
    public void updatePartyApplicationEditorUseFromValue(PartyApplicationEditorUseDetailValue partyApplicationEditorUseDetailValue, BasePK updatedBy) {
        if(partyApplicationEditorUseDetailValue.hasBeenModified()) {
            var partyApplicationEditorUse = PartyApplicationEditorUseFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     partyApplicationEditorUseDetailValue.getPartyApplicationEditorUsePK());
            var partyApplicationEditorUseDetail = partyApplicationEditorUse.getActiveDetailForUpdate();

            partyApplicationEditorUseDetail.setThruTime(session.START_TIME_LONG);
            partyApplicationEditorUseDetail.store();

            var partyApplicationEditorUsePK = partyApplicationEditorUseDetail.getPartyApplicationEditorUsePK(); // Not updated
            var partyPK = partyApplicationEditorUseDetail.getPartyPK(); // Not updated
            var applicationEditorUsePK = partyApplicationEditorUseDetail.getApplicationEditorUsePK(); // Not updated
            var applicationEditorPK = partyApplicationEditorUseDetailValue.getApplicationEditorPK();
            var preferredHeight = partyApplicationEditorUseDetailValue.getPreferredHeight();
            var preferredWidth = partyApplicationEditorUseDetailValue.getPreferredWidth();
            
            partyApplicationEditorUseDetail = PartyApplicationEditorUseDetailFactory.getInstance().create(partyApplicationEditorUsePK, partyPK,
                    applicationEditorUsePK, applicationEditorPK, preferredHeight, preferredWidth, session.START_TIME_LONG, Session.MAX_TIME_LONG);

            partyApplicationEditorUse.setActiveDetail(partyApplicationEditorUseDetail);
            partyApplicationEditorUse.setLastDetail(partyApplicationEditorUseDetail);

            sendEvent(partyApplicationEditorUsePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void deletePartyApplicationEditorUse(PartyApplicationEditorUse partyApplicationEditorUse, BasePK deletedBy) {
        var partyApplicationEditorUseDetail = partyApplicationEditorUse.getLastDetailForUpdate();

        partyApplicationEditorUseDetail.setThruTime(session.START_TIME_LONG);
        partyApplicationEditorUse.setActiveDetail(null);
        partyApplicationEditorUse.store();

        sendEvent(partyApplicationEditorUse.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deletePartyApplicationEditorUses(List<PartyApplicationEditorUse> partyApplicationEditorUses, BasePK deletedBy) {
        partyApplicationEditorUses.forEach((partyApplicationEditorUse) -> 
                deletePartyApplicationEditorUse(partyApplicationEditorUse, deletedBy)
        );
    }

    public void deletePartyApplicationEditorUsesByParty(Party party, BasePK deletedBy) {
        deletePartyApplicationEditorUses(getPartyApplicationEditorUsesByPartyForUpdate(party), deletedBy);
    }

    public void deletePartyApplicationEditorUsesByParty(ApplicationEditorUse applicationEditorUse, BasePK deletedBy) {
        deletePartyApplicationEditorUses(getPartyApplicationEditorUsesByApplicationEditorUseForUpdate(applicationEditorUse), deletedBy);
    }

    public void deletePartyApplicationEditorUsesByApplicationEditor(ApplicationEditor applicationEditor, BasePK deletedBy) {
        deletePartyApplicationEditorUses(getPartyApplicationEditorUsesByApplicationEditorForUpdate(applicationEditor), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Colors
    // --------------------------------------------------------------------------------

    public Color createColor(String colorName, Integer red, Integer green, Integer blue, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultColor = getDefaultColor();
        var defaultFound = defaultColor != null;

        if(defaultFound && isDefault) {
            var defaultColorDetailValue = getDefaultColorDetailValueForUpdate();

            defaultColorDetailValue.setIsDefault(Boolean.FALSE);
            updateColorFromValue(defaultColorDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var color = ColorFactory.getInstance().create();
        var colorDetail = ColorDetailFactory.getInstance().create(color, colorName, red, green, blue, isDefault, sortOrder, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);

        // Convert to R/W
        color = ColorFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, color.getPrimaryKey());
        color.setActiveDetail(colorDetail);
        color.setLastDetail(colorDetail);
        color.store();

        sendEvent(color.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return color;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.Color */
    public Color getColorByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new ColorPK(entityInstance.getEntityUniqueId());

        return ColorFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public Color getColorByEntityInstance(EntityInstance entityInstance) {
        return getColorByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public Color getColorByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getColorByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public long countColors() {
        return session.queryForLong("""
                SELECT COUNT(*)
                FROM colors, colordetails
                WHERE clr_activedetailid = clrdt_colordetailid
                """);
    }

    private static final Map<EntityPermission, String> getColorByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM colors, colordetails " +
                "WHERE clr_activedetailid = clrdt_colordetailid " +
                "AND clrdt_colorname = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM colors, colordetails " +
                "WHERE clr_activedetailid = clrdt_colordetailid " +
                "AND clrdt_colorname = ? " +
                "FOR UPDATE");
        getColorByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private Color getColorByName(String colorName, EntityPermission entityPermission) {
        return ColorFactory.getInstance().getEntityFromQuery(entityPermission, getColorByNameQueries, colorName);
    }

    public Color getColorByName(String colorName) {
        return getColorByName(colorName, EntityPermission.READ_ONLY);
    }

    public Color getColorByNameForUpdate(String colorName) {
        return getColorByName(colorName, EntityPermission.READ_WRITE);
    }

    public ColorDetailValue getColorDetailValueForUpdate(Color color) {
        return color == null? null: color.getLastDetailForUpdate().getColorDetailValue().clone();
    }

    public ColorDetailValue getColorDetailValueByNameForUpdate(String colorName) {
        return getColorDetailValueForUpdate(getColorByNameForUpdate(colorName));
    }

    private static final Map<EntityPermission, String> getDefaultColorQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM colors, colordetails " +
                "WHERE clr_activedetailid = clrdt_colordetailid " +
                "AND clrdt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM colors, colordetails " +
                "WHERE clr_activedetailid = clrdt_colordetailid " +
                "AND clrdt_isdefault = 1 " +
                "FOR UPDATE");
        getDefaultColorQueries = Collections.unmodifiableMap(queryMap);
    }

    private Color getDefaultColor(EntityPermission entityPermission) {
        return ColorFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultColorQueries);
    }

    public Color getDefaultColor() {
        return getDefaultColor(EntityPermission.READ_ONLY);
    }

    public Color getDefaultColorForUpdate() {
        return getDefaultColor(EntityPermission.READ_WRITE);
    }

    public ColorDetailValue getDefaultColorDetailValueForUpdate() {
        return getDefaultColorForUpdate().getLastDetailForUpdate().getColorDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getColorsQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM colors, colordetails " +
                "WHERE clr_activedetailid = clrdt_colordetailid " +
                "ORDER BY clrdt_sortorder, clrdt_colorname " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM colors, colordetails " +
                "WHERE clr_activedetailid = clrdt_colordetailid " +
                "FOR UPDATE");
        getColorsQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Color> getColors(EntityPermission entityPermission) {
        return ColorFactory.getInstance().getEntitiesFromQuery(entityPermission, getColorsQueries);
    }

    public List<Color> getColors() {
        return getColors(EntityPermission.READ_ONLY);
    }

    public List<Color> getColorsForUpdate() {
        return getColors(EntityPermission.READ_WRITE);
    }

    public ColorTransfer getColorTransfer(UserVisit userVisit, Color color) {
        return getCoreTransferCaches(userVisit).getColorTransferCache().getColorTransfer(color);
    }

    public List<ColorTransfer> getColorTransfers(UserVisit userVisit, Collection<Color> entities) {
        List<ColorTransfer> transfers = new ArrayList<>(entities.size());
        var transferCache = getCoreTransferCaches(userVisit).getColorTransferCache();
        
        entities.forEach((entity) ->
                transfers.add(transferCache.getColorTransfer(entity))
        );
        
        return transfers;
    }
    
    public List<ColorTransfer> getColorTransfers(UserVisit userVisit) {
        return getColorTransfers(userVisit, getColors());
    }

    public ColorChoicesBean getColorChoices(String defaultColorChoice, Language language, boolean allowNullChoice) {
        var colors = getColors();
        var size = colors.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultColorChoice == null) {
                defaultValue = "";
            }
        }

        for(var color : colors) {
            var colorDetail = color.getLastDetail();

            var label = getBestColorDescription(color, language);
            var value = colorDetail.getColorName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultColorChoice != null && defaultColorChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && colorDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new ColorChoicesBean(labels, values, defaultValue);
    }

    private void updateColorFromValue(ColorDetailValue colorDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(colorDetailValue.hasBeenModified()) {
            var color = ColorFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     colorDetailValue.getColorPK());
            var colorDetail = color.getActiveDetailForUpdate();

            colorDetail.setThruTime(session.START_TIME_LONG);
            colorDetail.store();

            var colorPK = colorDetail.getColorPK(); // Not updated
            var colorName = colorDetailValue.getColorName();
            var red = colorDetailValue.getRed();
            var green = colorDetailValue.getGreen();
            var blue = colorDetailValue.getBlue();
            var isDefault = colorDetailValue.getIsDefault();
            var sortOrder = colorDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultColor = getDefaultColor();
                var defaultFound = defaultColor != null && !defaultColor.equals(color);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultColorDetailValue = getDefaultColorDetailValueForUpdate();

                    defaultColorDetailValue.setIsDefault(Boolean.FALSE);
                    updateColorFromValue(defaultColorDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            colorDetail = ColorDetailFactory.getInstance().create(colorPK, colorName, red, green, blue, isDefault, sortOrder, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            color.setActiveDetail(colorDetail);
            color.setLastDetail(colorDetail);

            sendEvent(colorPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateColorFromValue(ColorDetailValue colorDetailValue, BasePK updatedBy) {
        updateColorFromValue(colorDetailValue, true, updatedBy);
    }

    private void deleteColor(Color color, boolean checkDefault, BasePK deletedBy) {
        var colorDetail = color.getLastDetailForUpdate();

        deleteAppearancesByColor(color, deletedBy);
        deleteColorDescriptionsByColor(color, deletedBy);

        colorDetail.setThruTime(session.START_TIME_LONG);
        color.setActiveDetail(null);
        color.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultColor = getDefaultColor();

            if(defaultColor == null) {
                var colors = getColorsForUpdate();

                if(!colors.isEmpty()) {
                    var iter = colors.iterator();
                    if(iter.hasNext()) {
                        defaultColor = iter.next();
                    }
                    var colorDetailValue = Objects.requireNonNull(defaultColor).getLastDetailForUpdate().getColorDetailValue().clone();

                    colorDetailValue.setIsDefault(Boolean.TRUE);
                    updateColorFromValue(colorDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(color.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteColor(Color color, BasePK deletedBy) {
        deleteColor(color, true, deletedBy);
    }

    private void deleteColors(List<Color> colors, boolean checkDefault, BasePK deletedBy) {
        colors.forEach((color) -> deleteColor(color, checkDefault, deletedBy));
    }

    public void deleteColors(List<Color> colors, BasePK deletedBy) {
        deleteColors(colors, true, deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Color Descriptions
    // --------------------------------------------------------------------------------

    public ColorDescription createColorDescription(Color color, Language language, String description, BasePK createdBy) {
        var colorDescription = ColorDescriptionFactory.getInstance().create(color, language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(color.getPrimaryKey(), EventTypes.MODIFY, colorDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return colorDescription;
    }

    private static final Map<EntityPermission, String> getColorDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM colordescriptions " +
                "WHERE clrd_clr_colorid = ? AND clrd_lang_languageid = ? AND clrd_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM colordescriptions " +
                "WHERE clrd_clr_colorid = ? AND clrd_lang_languageid = ? AND clrd_thrutime = ? " +
                "FOR UPDATE");
        getColorDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private ColorDescription getColorDescription(Color color, Language language, EntityPermission entityPermission) {
        return ColorDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getColorDescriptionQueries,
                color, language, Session.MAX_TIME);
    }

    public ColorDescription getColorDescription(Color color, Language language) {
        return getColorDescription(color, language, EntityPermission.READ_ONLY);
    }

    public ColorDescription getColorDescriptionForUpdate(Color color, Language language) {
        return getColorDescription(color, language, EntityPermission.READ_WRITE);
    }

    public ColorDescriptionValue getColorDescriptionValue(ColorDescription colorDescription) {
        return colorDescription == null? null: colorDescription.getColorDescriptionValue().clone();
    }

    public ColorDescriptionValue getColorDescriptionValueForUpdate(Color color, Language language) {
        return getColorDescriptionValue(getColorDescriptionForUpdate(color, language));
    }

    private static final Map<EntityPermission, String> getColorDescriptionsByColorQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM colordescriptions, languages " +
                "WHERE clrd_clr_colorid = ? AND clrd_thrutime = ? AND clrd_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM colordescriptions " +
                "WHERE clrd_clr_colorid = ? AND clrd_thrutime = ? " +
                "FOR UPDATE");
        getColorDescriptionsByColorQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<ColorDescription> getColorDescriptionsByColor(Color color, EntityPermission entityPermission) {
        return ColorDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getColorDescriptionsByColorQueries,
                color, Session.MAX_TIME);
    }

    public List<ColorDescription> getColorDescriptionsByColor(Color color) {
        return getColorDescriptionsByColor(color, EntityPermission.READ_ONLY);
    }

    public List<ColorDescription> getColorDescriptionsByColorForUpdate(Color color) {
        return getColorDescriptionsByColor(color, EntityPermission.READ_WRITE);
    }

    public String getBestColorDescription(Color color, Language language) {
        String description;
        var colorDescription = getColorDescription(color, language);

        if(colorDescription == null && !language.getIsDefault()) {
            colorDescription = getColorDescription(color, getPartyControl().getDefaultLanguage());
        }

        if(colorDescription == null) {
            description = color.getLastDetail().getColorName();
        } else {
            description = colorDescription.getDescription();
        }

        return description;
    }

    public ColorDescriptionTransfer getColorDescriptionTransfer(UserVisit userVisit, ColorDescription colorDescription) {
        return getCoreTransferCaches(userVisit).getColorDescriptionTransferCache().getColorDescriptionTransfer(colorDescription);
    }

    public List<ColorDescriptionTransfer> getColorDescriptionTransfersByColor(UserVisit userVisit, Color color) {
        var colorDescriptions = getColorDescriptionsByColor(color);
        List<ColorDescriptionTransfer> colorDescriptionTransfers = new ArrayList<>(colorDescriptions.size());
        var colorDescriptionTransferCache = getCoreTransferCaches(userVisit).getColorDescriptionTransferCache();

        colorDescriptions.forEach((colorDescription) ->
                colorDescriptionTransfers.add(colorDescriptionTransferCache.getColorDescriptionTransfer(colorDescription))
        );

        return colorDescriptionTransfers;
    }

    public void updateColorDescriptionFromValue(ColorDescriptionValue colorDescriptionValue, BasePK updatedBy) {
        if(colorDescriptionValue.hasBeenModified()) {
            var colorDescription = ColorDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    colorDescriptionValue.getPrimaryKey());

            colorDescription.setThruTime(session.START_TIME_LONG);
            colorDescription.store();

            var color = colorDescription.getColor();
            var language = colorDescription.getLanguage();
            var description = colorDescriptionValue.getDescription();

            colorDescription = ColorDescriptionFactory.getInstance().create(color, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(color.getPrimaryKey(), EventTypes.MODIFY, colorDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteColorDescription(ColorDescription colorDescription, BasePK deletedBy) {
        colorDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(colorDescription.getColorPK(), EventTypes.MODIFY, colorDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteColorDescriptionsByColor(Color color, BasePK deletedBy) {
        var colorDescriptions = getColorDescriptionsByColorForUpdate(color);

        colorDescriptions.forEach((colorDescription) -> 
                deleteColorDescription(colorDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Font Styles
    // --------------------------------------------------------------------------------

    public FontStyle createFontStyle(String fontStyleName, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultFontStyle = getDefaultFontStyle();
        var defaultFound = defaultFontStyle != null;

        if(defaultFound && isDefault) {
            var defaultFontStyleDetailValue = getDefaultFontStyleDetailValueForUpdate();

            defaultFontStyleDetailValue.setIsDefault(Boolean.FALSE);
            updateFontStyleFromValue(defaultFontStyleDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var fontStyle = FontStyleFactory.getInstance().create();
        var fontStyleDetail = FontStyleDetailFactory.getInstance().create(fontStyle, fontStyleName, isDefault, sortOrder, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);

        // Convert to R/W
        fontStyle = FontStyleFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, fontStyle.getPrimaryKey());
        fontStyle.setActiveDetail(fontStyleDetail);
        fontStyle.setLastDetail(fontStyleDetail);
        fontStyle.store();

        sendEvent(fontStyle.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return fontStyle;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.FontStyle */
    public FontStyle getFontStyleByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new FontStylePK(entityInstance.getEntityUniqueId());

        return FontStyleFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public FontStyle getFontStyleByEntityInstance(EntityInstance entityInstance) {
        return getFontStyleByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public FontStyle getFontStyleByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getFontStyleByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public long countFontStyles() {
        return session.queryForLong("""
                SELECT COUNT(*)
                FROM fontstyles, fontstyledetails
                WHERE fntstyl_activedetailid = fntstyldt_fontstyledetailid
                """);
    }

    private static final Map<EntityPermission, String> getFontStyleByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM fontstyles, fontstyledetails " +
                "WHERE fntstyl_activedetailid = fntstyldt_fontstyledetailid " +
                "AND fntstyldt_fontstylename = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM fontstyles, fontstyledetails " +
                "WHERE fntstyl_activedetailid = fntstyldt_fontstyledetailid " +
                "AND fntstyldt_fontstylename = ? " +
                "FOR UPDATE");
        getFontStyleByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private FontStyle getFontStyleByName(String fontStyleName, EntityPermission entityPermission) {
        return FontStyleFactory.getInstance().getEntityFromQuery(entityPermission, getFontStyleByNameQueries, fontStyleName);
    }

    public FontStyle getFontStyleByName(String fontStyleName) {
        return getFontStyleByName(fontStyleName, EntityPermission.READ_ONLY);
    }

    public FontStyle getFontStyleByNameForUpdate(String fontStyleName) {
        return getFontStyleByName(fontStyleName, EntityPermission.READ_WRITE);
    }

    public FontStyleDetailValue getFontStyleDetailValueForUpdate(FontStyle fontStyle) {
        return fontStyle == null? null: fontStyle.getLastDetailForUpdate().getFontStyleDetailValue().clone();
    }

    public FontStyleDetailValue getFontStyleDetailValueByNameForUpdate(String fontStyleName) {
        return getFontStyleDetailValueForUpdate(getFontStyleByNameForUpdate(fontStyleName));
    }

    private static final Map<EntityPermission, String> getDefaultFontStyleQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM fontstyles, fontstyledetails " +
                "WHERE fntstyl_activedetailid = fntstyldt_fontstyledetailid " +
                "AND fntstyldt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM fontstyles, fontstyledetails " +
                "WHERE fntstyl_activedetailid = fntstyldt_fontstyledetailid " +
                "AND fntstyldt_isdefault = 1 " +
                "FOR UPDATE");
        getDefaultFontStyleQueries = Collections.unmodifiableMap(queryMap);
    }

    private FontStyle getDefaultFontStyle(EntityPermission entityPermission) {
        return FontStyleFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultFontStyleQueries);
    }

    public FontStyle getDefaultFontStyle() {
        return getDefaultFontStyle(EntityPermission.READ_ONLY);
    }

    public FontStyle getDefaultFontStyleForUpdate() {
        return getDefaultFontStyle(EntityPermission.READ_WRITE);
    }

    public FontStyleDetailValue getDefaultFontStyleDetailValueForUpdate() {
        return getDefaultFontStyleForUpdate().getLastDetailForUpdate().getFontStyleDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getFontStylesQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM fontstyles, fontstyledetails " +
                "WHERE fntstyl_activedetailid = fntstyldt_fontstyledetailid " +
                "ORDER BY fntstyldt_sortorder, fntstyldt_fontstylename " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM fontstyles, fontstyledetails " +
                "WHERE fntstyl_activedetailid = fntstyldt_fontstyledetailid " +
                "FOR UPDATE");
        getFontStylesQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<FontStyle> getFontStyles(EntityPermission entityPermission) {
        return FontStyleFactory.getInstance().getEntitiesFromQuery(entityPermission, getFontStylesQueries);
    }

    public List<FontStyle> getFontStyles() {
        return getFontStyles(EntityPermission.READ_ONLY);
    }

    public List<FontStyle> getFontStylesForUpdate() {
        return getFontStyles(EntityPermission.READ_WRITE);
    }

    public FontStyleTransfer getFontStyleTransfer(UserVisit userVisit, FontStyle fontStyle) {
        return getCoreTransferCaches(userVisit).getFontStyleTransferCache().getFontStyleTransfer(fontStyle);
    }

    public List<FontStyleTransfer> getFontStyleTransfers(UserVisit userVisit, Collection<FontStyle> entities) {
        List<FontStyleTransfer> transfers = new ArrayList<>(entities.size());
        var transferCache = getCoreTransferCaches(userVisit).getFontStyleTransferCache();
        
        entities.forEach((entity) ->
                transfers.add(transferCache.getFontStyleTransfer(entity))
        );
        
        return transfers;
    }
    
    public List<FontStyleTransfer> getFontStyleTransfers(UserVisit userVisit) {
        return getFontStyleTransfers(userVisit, getFontStyles());
    }

    public FontStyleChoicesBean getFontStyleChoices(String defaultFontStyleChoice, Language language, boolean allowNullChoice) {
        var fontStyles = getFontStyles();
        var size = fontStyles.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultFontStyleChoice == null) {
                defaultValue = "";
            }
        }

        for(var fontStyle : fontStyles) {
            var fontStyleDetail = fontStyle.getLastDetail();

            var label = getBestFontStyleDescription(fontStyle, language);
            var value = fontStyleDetail.getFontStyleName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultFontStyleChoice != null && defaultFontStyleChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && fontStyleDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new FontStyleChoicesBean(labels, values, defaultValue);
    }

    private void updateFontStyleFromValue(FontStyleDetailValue fontStyleDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(fontStyleDetailValue.hasBeenModified()) {
            var fontStyle = FontStyleFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     fontStyleDetailValue.getFontStylePK());
            var fontStyleDetail = fontStyle.getActiveDetailForUpdate();

            fontStyleDetail.setThruTime(session.START_TIME_LONG);
            fontStyleDetail.store();

            var fontStylePK = fontStyleDetail.getFontStylePK(); // Not updated
            var fontStyleName = fontStyleDetailValue.getFontStyleName();
            var isDefault = fontStyleDetailValue.getIsDefault();
            var sortOrder = fontStyleDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultFontStyle = getDefaultFontStyle();
                var defaultFound = defaultFontStyle != null && !defaultFontStyle.equals(fontStyle);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultFontStyleDetailValue = getDefaultFontStyleDetailValueForUpdate();

                    defaultFontStyleDetailValue.setIsDefault(Boolean.FALSE);
                    updateFontStyleFromValue(defaultFontStyleDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            fontStyleDetail = FontStyleDetailFactory.getInstance().create(fontStylePK, fontStyleName, isDefault, sortOrder, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            fontStyle.setActiveDetail(fontStyleDetail);
            fontStyle.setLastDetail(fontStyleDetail);

            sendEvent(fontStylePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateFontStyleFromValue(FontStyleDetailValue fontStyleDetailValue, BasePK updatedBy) {
        updateFontStyleFromValue(fontStyleDetailValue, true, updatedBy);
    }

    private void deleteFontStyle(FontStyle fontStyle, boolean checkDefault, BasePK deletedBy) {
        var fontStyleDetail = fontStyle.getLastDetailForUpdate();

        deleteAppearancesByFontStyle(fontStyle, deletedBy);
        deleteFontStyleDescriptionsByFontStyle(fontStyle, deletedBy);

        fontStyleDetail.setThruTime(session.START_TIME_LONG);
        fontStyle.setActiveDetail(null);
        fontStyle.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultFontStyle = getDefaultFontStyle();

            if(defaultFontStyle == null) {
                var fontStyles = getFontStylesForUpdate();

                if(!fontStyles.isEmpty()) {
                    var iter = fontStyles.iterator();
                    if(iter.hasNext()) {
                        defaultFontStyle = iter.next();
                    }
                    var fontStyleDetailValue = Objects.requireNonNull(defaultFontStyle).getLastDetailForUpdate().getFontStyleDetailValue().clone();

                    fontStyleDetailValue.setIsDefault(Boolean.TRUE);
                    updateFontStyleFromValue(fontStyleDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(fontStyle.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteFontStyle(FontStyle fontStyle, BasePK deletedBy) {
        deleteFontStyle(fontStyle, true, deletedBy);
    }

    private void deleteFontStyles(List<FontStyle> fontStyles, boolean checkDefault, BasePK deletedBy) {
        fontStyles.forEach((fontStyle) -> deleteFontStyle(fontStyle, checkDefault, deletedBy));
    }

    public void deleteFontStyles(List<FontStyle> fontStyles, BasePK deletedBy) {
        deleteFontStyles(fontStyles, true, deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Font Style Descriptions
    // --------------------------------------------------------------------------------

    public FontStyleDescription createFontStyleDescription(FontStyle fontStyle, Language language, String description, BasePK createdBy) {
        var fontStyleDescription = FontStyleDescriptionFactory.getInstance().create(fontStyle, language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(fontStyle.getPrimaryKey(), EventTypes.MODIFY, fontStyleDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return fontStyleDescription;
    }

    private static final Map<EntityPermission, String> getFontStyleDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM fontstyledescriptions " +
                "WHERE fntstyld_fntstyl_fontstyleid = ? AND fntstyld_lang_languageid = ? AND fntstyld_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM fontstyledescriptions " +
                "WHERE fntstyld_fntstyl_fontstyleid = ? AND fntstyld_lang_languageid = ? AND fntstyld_thrutime = ? " +
                "FOR UPDATE");
        getFontStyleDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private FontStyleDescription getFontStyleDescription(FontStyle fontStyle, Language language, EntityPermission entityPermission) {
        return FontStyleDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getFontStyleDescriptionQueries,
                fontStyle, language, Session.MAX_TIME);
    }

    public FontStyleDescription getFontStyleDescription(FontStyle fontStyle, Language language) {
        return getFontStyleDescription(fontStyle, language, EntityPermission.READ_ONLY);
    }

    public FontStyleDescription getFontStyleDescriptionForUpdate(FontStyle fontStyle, Language language) {
        return getFontStyleDescription(fontStyle, language, EntityPermission.READ_WRITE);
    }

    public FontStyleDescriptionValue getFontStyleDescriptionValue(FontStyleDescription fontStyleDescription) {
        return fontStyleDescription == null? null: fontStyleDescription.getFontStyleDescriptionValue().clone();
    }

    public FontStyleDescriptionValue getFontStyleDescriptionValueForUpdate(FontStyle fontStyle, Language language) {
        return getFontStyleDescriptionValue(getFontStyleDescriptionForUpdate(fontStyle, language));
    }

    private static final Map<EntityPermission, String> getFontStyleDescriptionsByFontStyleQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM fontstyledescriptions, languages " +
                "WHERE fntstyld_fntstyl_fontstyleid = ? AND fntstyld_thrutime = ? AND fntstyld_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM fontstyledescriptions " +
                "WHERE fntstyld_fntstyl_fontstyleid = ? AND fntstyld_thrutime = ? " +
                "FOR UPDATE");
        getFontStyleDescriptionsByFontStyleQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<FontStyleDescription> getFontStyleDescriptionsByFontStyle(FontStyle fontStyle, EntityPermission entityPermission) {
        return FontStyleDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getFontStyleDescriptionsByFontStyleQueries,
                fontStyle, Session.MAX_TIME);
    }

    public List<FontStyleDescription> getFontStyleDescriptionsByFontStyle(FontStyle fontStyle) {
        return getFontStyleDescriptionsByFontStyle(fontStyle, EntityPermission.READ_ONLY);
    }

    public List<FontStyleDescription> getFontStyleDescriptionsByFontStyleForUpdate(FontStyle fontStyle) {
        return getFontStyleDescriptionsByFontStyle(fontStyle, EntityPermission.READ_WRITE);
    }

    public String getBestFontStyleDescription(FontStyle fontStyle, Language language) {
        String description;
        var fontStyleDescription = getFontStyleDescription(fontStyle, language);

        if(fontStyleDescription == null && !language.getIsDefault()) {
            fontStyleDescription = getFontStyleDescription(fontStyle, getPartyControl().getDefaultLanguage());
        }

        if(fontStyleDescription == null) {
            description = fontStyle.getLastDetail().getFontStyleName();
        } else {
            description = fontStyleDescription.getDescription();
        }

        return description;
    }

    public FontStyleDescriptionTransfer getFontStyleDescriptionTransfer(UserVisit userVisit, FontStyleDescription fontStyleDescription) {
        return getCoreTransferCaches(userVisit).getFontStyleDescriptionTransferCache().getFontStyleDescriptionTransfer(fontStyleDescription);
    }

    public List<FontStyleDescriptionTransfer> getFontStyleDescriptionTransfersByFontStyle(UserVisit userVisit, FontStyle fontStyle) {
        var fontStyleDescriptions = getFontStyleDescriptionsByFontStyle(fontStyle);
        List<FontStyleDescriptionTransfer> fontStyleDescriptionTransfers = new ArrayList<>(fontStyleDescriptions.size());
        var fontStyleDescriptionTransferCache = getCoreTransferCaches(userVisit).getFontStyleDescriptionTransferCache();

        fontStyleDescriptions.forEach((fontStyleDescription) ->
                fontStyleDescriptionTransfers.add(fontStyleDescriptionTransferCache.getFontStyleDescriptionTransfer(fontStyleDescription))
        );

        return fontStyleDescriptionTransfers;
    }

    public void updateFontStyleDescriptionFromValue(FontStyleDescriptionValue fontStyleDescriptionValue, BasePK updatedBy) {
        if(fontStyleDescriptionValue.hasBeenModified()) {
            var fontStyleDescription = FontStyleDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    fontStyleDescriptionValue.getPrimaryKey());

            fontStyleDescription.setThruTime(session.START_TIME_LONG);
            fontStyleDescription.store();

            var fontStyle = fontStyleDescription.getFontStyle();
            var language = fontStyleDescription.getLanguage();
            var description = fontStyleDescriptionValue.getDescription();

            fontStyleDescription = FontStyleDescriptionFactory.getInstance().create(fontStyle, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(fontStyle.getPrimaryKey(), EventTypes.MODIFY, fontStyleDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteFontStyleDescription(FontStyleDescription fontStyleDescription, BasePK deletedBy) {
        fontStyleDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(fontStyleDescription.getFontStylePK(), EventTypes.MODIFY, fontStyleDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteFontStyleDescriptionsByFontStyle(FontStyle fontStyle, BasePK deletedBy) {
        var fontStyleDescriptions = getFontStyleDescriptionsByFontStyleForUpdate(fontStyle);

        fontStyleDescriptions.forEach((fontStyleDescription) -> 
                deleteFontStyleDescription(fontStyleDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Font Weights
    // --------------------------------------------------------------------------------

    public FontWeight createFontWeight(String fontWeightName, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultFontWeight = getDefaultFontWeight();
        var defaultFound = defaultFontWeight != null;

        if(defaultFound && isDefault) {
            var defaultFontWeightDetailValue = getDefaultFontWeightDetailValueForUpdate();

            defaultFontWeightDetailValue.setIsDefault(Boolean.FALSE);
            updateFontWeightFromValue(defaultFontWeightDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var fontWeight = FontWeightFactory.getInstance().create();
        var fontWeightDetail = FontWeightDetailFactory.getInstance().create(fontWeight, fontWeightName, isDefault, sortOrder, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);

        // Convert to R/W
        fontWeight = FontWeightFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, fontWeight.getPrimaryKey());
        fontWeight.setActiveDetail(fontWeightDetail);
        fontWeight.setLastDetail(fontWeightDetail);
        fontWeight.store();

        sendEvent(fontWeight.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return fontWeight;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.FontWeight */
    public FontWeight getFontWeightByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new FontWeightPK(entityInstance.getEntityUniqueId());

        return FontWeightFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public FontWeight getFontWeightByEntityInstance(EntityInstance entityInstance) {
        return getFontWeightByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public FontWeight getFontWeightByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getFontWeightByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public long countFontWeights() {
        return session.queryForLong("""
                SELECT COUNT(*)
                FROM fontweights, fontweightdetails
                WHERE fntwght_activedetailid = fntwghtdt_fontweightdetailid
                """);
    }

    private static final Map<EntityPermission, String> getFontWeightByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM fontweights, fontweightdetails " +
                "WHERE fntwght_activedetailid = fntwghtdt_fontweightdetailid " +
                "AND fntwghtdt_fontweightname = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM fontweights, fontweightdetails " +
                "WHERE fntwght_activedetailid = fntwghtdt_fontweightdetailid " +
                "AND fntwghtdt_fontweightname = ? " +
                "FOR UPDATE");
        getFontWeightByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private FontWeight getFontWeightByName(String fontWeightName, EntityPermission entityPermission) {
        return FontWeightFactory.getInstance().getEntityFromQuery(entityPermission, getFontWeightByNameQueries, fontWeightName);
    }

    public FontWeight getFontWeightByName(String fontWeightName) {
        return getFontWeightByName(fontWeightName, EntityPermission.READ_ONLY);
    }

    public FontWeight getFontWeightByNameForUpdate(String fontWeightName) {
        return getFontWeightByName(fontWeightName, EntityPermission.READ_WRITE);
    }

    public FontWeightDetailValue getFontWeightDetailValueForUpdate(FontWeight fontWeight) {
        return fontWeight == null? null: fontWeight.getLastDetailForUpdate().getFontWeightDetailValue().clone();
    }

    public FontWeightDetailValue getFontWeightDetailValueByNameForUpdate(String fontWeightName) {
        return getFontWeightDetailValueForUpdate(getFontWeightByNameForUpdate(fontWeightName));
    }

    private static final Map<EntityPermission, String> getDefaultFontWeightQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM fontweights, fontweightdetails " +
                "WHERE fntwght_activedetailid = fntwghtdt_fontweightdetailid " +
                "AND fntwghtdt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM fontweights, fontweightdetails " +
                "WHERE fntwght_activedetailid = fntwghtdt_fontweightdetailid " +
                "AND fntwghtdt_isdefault = 1 " +
                "FOR UPDATE");
        getDefaultFontWeightQueries = Collections.unmodifiableMap(queryMap);
    }

    private FontWeight getDefaultFontWeight(EntityPermission entityPermission) {
        return FontWeightFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultFontWeightQueries);
    }

    public FontWeight getDefaultFontWeight() {
        return getDefaultFontWeight(EntityPermission.READ_ONLY);
    }

    public FontWeight getDefaultFontWeightForUpdate() {
        return getDefaultFontWeight(EntityPermission.READ_WRITE);
    }

    public FontWeightDetailValue getDefaultFontWeightDetailValueForUpdate() {
        return getDefaultFontWeightForUpdate().getLastDetailForUpdate().getFontWeightDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getFontWeightsQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM fontweights, fontweightdetails " +
                "WHERE fntwght_activedetailid = fntwghtdt_fontweightdetailid " +
                "ORDER BY fntwghtdt_sortorder, fntwghtdt_fontweightname " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM fontweights, fontweightdetails " +
                "WHERE fntwght_activedetailid = fntwghtdt_fontweightdetailid " +
                "FOR UPDATE");
        getFontWeightsQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<FontWeight> getFontWeights(EntityPermission entityPermission) {
        return FontWeightFactory.getInstance().getEntitiesFromQuery(entityPermission, getFontWeightsQueries);
    }

    public List<FontWeight> getFontWeights() {
        return getFontWeights(EntityPermission.READ_ONLY);
    }

    public List<FontWeight> getFontWeightsForUpdate() {
        return getFontWeights(EntityPermission.READ_WRITE);
    }

    public FontWeightTransfer getFontWeightTransfer(UserVisit userVisit, FontWeight fontWeight) {
        return getCoreTransferCaches(userVisit).getFontWeightTransferCache().getFontWeightTransfer(fontWeight);
    }

    public List<FontWeightTransfer> getFontWeightTransfers(UserVisit userVisit, Collection<FontWeight> entities) {
        List<FontWeightTransfer> transfers = new ArrayList<>(entities.size());
        var transferCache = getCoreTransferCaches(userVisit).getFontWeightTransferCache();
        
        entities.forEach((entity) ->
                transfers.add(transferCache.getFontWeightTransfer(entity))
        );
        
        return transfers;
    }
    
    public List<FontWeightTransfer> getFontWeightTransfers(UserVisit userVisit) {
        return getFontWeightTransfers(userVisit, getFontWeights());
    }

    public FontWeightChoicesBean getFontWeightChoices(String defaultFontWeightChoice, Language language, boolean allowNullChoice) {
        var fontWeights = getFontWeights();
        var size = fontWeights.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultFontWeightChoice == null) {
                defaultValue = "";
            }
        }

        for(var fontWeight : fontWeights) {
            var fontWeightDetail = fontWeight.getLastDetail();

            var label = getBestFontWeightDescription(fontWeight, language);
            var value = fontWeightDetail.getFontWeightName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultFontWeightChoice != null && defaultFontWeightChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && fontWeightDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new FontWeightChoicesBean(labels, values, defaultValue);
    }

    private void updateFontWeightFromValue(FontWeightDetailValue fontWeightDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(fontWeightDetailValue.hasBeenModified()) {
            var fontWeight = FontWeightFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     fontWeightDetailValue.getFontWeightPK());
            var fontWeightDetail = fontWeight.getActiveDetailForUpdate();

            fontWeightDetail.setThruTime(session.START_TIME_LONG);
            fontWeightDetail.store();

            var fontWeightPK = fontWeightDetail.getFontWeightPK(); // Not updated
            var fontWeightName = fontWeightDetailValue.getFontWeightName();
            var isDefault = fontWeightDetailValue.getIsDefault();
            var sortOrder = fontWeightDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultFontWeight = getDefaultFontWeight();
                var defaultFound = defaultFontWeight != null && !defaultFontWeight.equals(fontWeight);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultFontWeightDetailValue = getDefaultFontWeightDetailValueForUpdate();

                    defaultFontWeightDetailValue.setIsDefault(Boolean.FALSE);
                    updateFontWeightFromValue(defaultFontWeightDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            fontWeightDetail = FontWeightDetailFactory.getInstance().create(fontWeightPK, fontWeightName, isDefault, sortOrder, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            fontWeight.setActiveDetail(fontWeightDetail);
            fontWeight.setLastDetail(fontWeightDetail);

            sendEvent(fontWeightPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateFontWeightFromValue(FontWeightDetailValue fontWeightDetailValue, BasePK updatedBy) {
        updateFontWeightFromValue(fontWeightDetailValue, true, updatedBy);
    }

    private void deleteFontWeight(FontWeight fontWeight, boolean checkDefault, BasePK deletedBy) {
        var fontWeightDetail = fontWeight.getLastDetailForUpdate();

        deleteAppearancesByFontWeight(fontWeight, deletedBy);
        deleteFontWeightDescriptionsByFontWeight(fontWeight, deletedBy);

        fontWeightDetail.setThruTime(session.START_TIME_LONG);
        fontWeight.setActiveDetail(null);
        fontWeight.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultFontWeight = getDefaultFontWeight();

            if(defaultFontWeight == null) {
                var fontWeights = getFontWeightsForUpdate();

                if(!fontWeights.isEmpty()) {
                    var iter = fontWeights.iterator();
                    if(iter.hasNext()) {
                        defaultFontWeight = iter.next();
                    }
                    var fontWeightDetailValue = Objects.requireNonNull(defaultFontWeight).getLastDetailForUpdate().getFontWeightDetailValue().clone();

                    fontWeightDetailValue.setIsDefault(Boolean.TRUE);
                    updateFontWeightFromValue(fontWeightDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(fontWeight.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteFontWeight(FontWeight fontWeight, BasePK deletedBy) {
        deleteFontWeight(fontWeight, true, deletedBy);
    }

    private void deleteFontWeights(List<FontWeight> fontWeights, boolean checkDefault, BasePK deletedBy) {
        fontWeights.forEach((fontWeight) -> deleteFontWeight(fontWeight, checkDefault, deletedBy));
    }

    public void deleteFontWeights(List<FontWeight> fontWeights, BasePK deletedBy) {
        deleteFontWeights(fontWeights, true, deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Font Weight Descriptions
    // --------------------------------------------------------------------------------

    public FontWeightDescription createFontWeightDescription(FontWeight fontWeight, Language language, String description, BasePK createdBy) {
        var fontWeightDescription = FontWeightDescriptionFactory.getInstance().create(fontWeight, language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(fontWeight.getPrimaryKey(), EventTypes.MODIFY, fontWeightDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return fontWeightDescription;
    }

    private static final Map<EntityPermission, String> getFontWeightDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM fontweightdescriptions " +
                "WHERE fntwghtd_fntwght_fontweightid = ? AND fntwghtd_lang_languageid = ? AND fntwghtd_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM fontweightdescriptions " +
                "WHERE fntwghtd_fntwght_fontweightid = ? AND fntwghtd_lang_languageid = ? AND fntwghtd_thrutime = ? " +
                "FOR UPDATE");
        getFontWeightDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private FontWeightDescription getFontWeightDescription(FontWeight fontWeight, Language language, EntityPermission entityPermission) {
        return FontWeightDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getFontWeightDescriptionQueries,
                fontWeight, language, Session.MAX_TIME);
    }

    public FontWeightDescription getFontWeightDescription(FontWeight fontWeight, Language language) {
        return getFontWeightDescription(fontWeight, language, EntityPermission.READ_ONLY);
    }

    public FontWeightDescription getFontWeightDescriptionForUpdate(FontWeight fontWeight, Language language) {
        return getFontWeightDescription(fontWeight, language, EntityPermission.READ_WRITE);
    }

    public FontWeightDescriptionValue getFontWeightDescriptionValue(FontWeightDescription fontWeightDescription) {
        return fontWeightDescription == null? null: fontWeightDescription.getFontWeightDescriptionValue().clone();
    }

    public FontWeightDescriptionValue getFontWeightDescriptionValueForUpdate(FontWeight fontWeight, Language language) {
        return getFontWeightDescriptionValue(getFontWeightDescriptionForUpdate(fontWeight, language));
    }

    private static final Map<EntityPermission, String> getFontWeightDescriptionsByFontWeightQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM fontweightdescriptions, languages " +
                "WHERE fntwghtd_fntwght_fontweightid = ? AND fntwghtd_thrutime = ? AND fntwghtd_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM fontweightdescriptions " +
                "WHERE fntwghtd_fntwght_fontweightid = ? AND fntwghtd_thrutime = ? " +
                "FOR UPDATE");
        getFontWeightDescriptionsByFontWeightQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<FontWeightDescription> getFontWeightDescriptionsByFontWeight(FontWeight fontWeight, EntityPermission entityPermission) {
        return FontWeightDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getFontWeightDescriptionsByFontWeightQueries,
                fontWeight, Session.MAX_TIME);
    }

    public List<FontWeightDescription> getFontWeightDescriptionsByFontWeight(FontWeight fontWeight) {
        return getFontWeightDescriptionsByFontWeight(fontWeight, EntityPermission.READ_ONLY);
    }

    public List<FontWeightDescription> getFontWeightDescriptionsByFontWeightForUpdate(FontWeight fontWeight) {
        return getFontWeightDescriptionsByFontWeight(fontWeight, EntityPermission.READ_WRITE);
    }

    public String getBestFontWeightDescription(FontWeight fontWeight, Language language) {
        String description;
        var fontWeightDescription = getFontWeightDescription(fontWeight, language);

        if(fontWeightDescription == null && !language.getIsDefault()) {
            fontWeightDescription = getFontWeightDescription(fontWeight, getPartyControl().getDefaultLanguage());
        }

        if(fontWeightDescription == null) {
            description = fontWeight.getLastDetail().getFontWeightName();
        } else {
            description = fontWeightDescription.getDescription();
        }

        return description;
    }

    public FontWeightDescriptionTransfer getFontWeightDescriptionTransfer(UserVisit userVisit, FontWeightDescription fontWeightDescription) {
        return getCoreTransferCaches(userVisit).getFontWeightDescriptionTransferCache().getFontWeightDescriptionTransfer(fontWeightDescription);
    }

    public List<FontWeightDescriptionTransfer> getFontWeightDescriptionTransfersByFontWeight(UserVisit userVisit, FontWeight fontWeight) {
        var fontWeightDescriptions = getFontWeightDescriptionsByFontWeight(fontWeight);
        List<FontWeightDescriptionTransfer> fontWeightDescriptionTransfers = new ArrayList<>(fontWeightDescriptions.size());
        var fontWeightDescriptionTransferCache = getCoreTransferCaches(userVisit).getFontWeightDescriptionTransferCache();

        fontWeightDescriptions.forEach((fontWeightDescription) ->
                fontWeightDescriptionTransfers.add(fontWeightDescriptionTransferCache.getFontWeightDescriptionTransfer(fontWeightDescription))
        );

        return fontWeightDescriptionTransfers;
    }

    public void updateFontWeightDescriptionFromValue(FontWeightDescriptionValue fontWeightDescriptionValue, BasePK updatedBy) {
        if(fontWeightDescriptionValue.hasBeenModified()) {
            var fontWeightDescription = FontWeightDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    fontWeightDescriptionValue.getPrimaryKey());

            fontWeightDescription.setThruTime(session.START_TIME_LONG);
            fontWeightDescription.store();

            var fontWeight = fontWeightDescription.getFontWeight();
            var language = fontWeightDescription.getLanguage();
            var description = fontWeightDescriptionValue.getDescription();

            fontWeightDescription = FontWeightDescriptionFactory.getInstance().create(fontWeight, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(fontWeight.getPrimaryKey(), EventTypes.MODIFY, fontWeightDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteFontWeightDescription(FontWeightDescription fontWeightDescription, BasePK deletedBy) {
        fontWeightDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(fontWeightDescription.getFontWeightPK(), EventTypes.MODIFY, fontWeightDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteFontWeightDescriptionsByFontWeight(FontWeight fontWeight, BasePK deletedBy) {
        var fontWeightDescriptions = getFontWeightDescriptionsByFontWeightForUpdate(fontWeight);

        fontWeightDescriptions.forEach((fontWeightDescription) -> 
                deleteFontWeightDescription(fontWeightDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Text Decorations
    // --------------------------------------------------------------------------------

    public TextDecoration createTextDecoration(String textDecorationName, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultTextDecoration = getDefaultTextDecoration();
        var defaultFound = defaultTextDecoration != null;

        if(defaultFound && isDefault) {
            var defaultTextDecorationDetailValue = getDefaultTextDecorationDetailValueForUpdate();

            defaultTextDecorationDetailValue.setIsDefault(Boolean.FALSE);
            updateTextDecorationFromValue(defaultTextDecorationDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var textDecoration = TextDecorationFactory.getInstance().create();
        var textDecorationDetail = TextDecorationDetailFactory.getInstance().create(textDecoration, textDecorationName, isDefault, sortOrder, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);

        // Convert to R/W
        textDecoration = TextDecorationFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, textDecoration.getPrimaryKey());
        textDecoration.setActiveDetail(textDecorationDetail);
        textDecoration.setLastDetail(textDecorationDetail);
        textDecoration.store();

        sendEvent(textDecoration.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return textDecoration;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.TextDecoration */
    public TextDecoration getTextDecorationByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new TextDecorationPK(entityInstance.getEntityUniqueId());

        return TextDecorationFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public TextDecoration getTextDecorationByEntityInstance(EntityInstance entityInstance) {
        return getTextDecorationByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public TextDecoration getTextDecorationByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getTextDecorationByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public long countTextDecorations() {
        return session.queryForLong("""
                SELECT COUNT(*)
                FROM textdecorations, textdecorationdetails
                WHERE txtdcrtn_activedetailid = txtdcrtndt_textdecorationdetailid
                """);
    }

    private static final Map<EntityPermission, String> getTextDecorationByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM textdecorations, textdecorationdetails " +
                "WHERE txtdcrtn_activedetailid = txtdcrtndt_textdecorationdetailid " +
                "AND txtdcrtndt_textdecorationname = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM textdecorations, textdecorationdetails " +
                "WHERE txtdcrtn_activedetailid = txtdcrtndt_textdecorationdetailid " +
                "AND txtdcrtndt_textdecorationname = ? " +
                "FOR UPDATE");
        getTextDecorationByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private TextDecoration getTextDecorationByName(String textDecorationName, EntityPermission entityPermission) {
        return TextDecorationFactory.getInstance().getEntityFromQuery(entityPermission, getTextDecorationByNameQueries, textDecorationName);
    }

    public TextDecoration getTextDecorationByName(String textDecorationName) {
        return getTextDecorationByName(textDecorationName, EntityPermission.READ_ONLY);
    }

    public TextDecoration getTextDecorationByNameForUpdate(String textDecorationName) {
        return getTextDecorationByName(textDecorationName, EntityPermission.READ_WRITE);
    }

    public TextDecorationDetailValue getTextDecorationDetailValueForUpdate(TextDecoration textDecoration) {
        return textDecoration == null? null: textDecoration.getLastDetailForUpdate().getTextDecorationDetailValue().clone();
    }

    public TextDecorationDetailValue getTextDecorationDetailValueByNameForUpdate(String textDecorationName) {
        return getTextDecorationDetailValueForUpdate(getTextDecorationByNameForUpdate(textDecorationName));
    }

    private static final Map<EntityPermission, String> getDefaultTextDecorationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM textdecorations, textdecorationdetails " +
                "WHERE txtdcrtn_activedetailid = txtdcrtndt_textdecorationdetailid " +
                "AND txtdcrtndt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM textdecorations, textdecorationdetails " +
                "WHERE txtdcrtn_activedetailid = txtdcrtndt_textdecorationdetailid " +
                "AND txtdcrtndt_isdefault = 1 " +
                "FOR UPDATE");
        getDefaultTextDecorationQueries = Collections.unmodifiableMap(queryMap);
    }

    private TextDecoration getDefaultTextDecoration(EntityPermission entityPermission) {
        return TextDecorationFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultTextDecorationQueries);
    }

    public TextDecoration getDefaultTextDecoration() {
        return getDefaultTextDecoration(EntityPermission.READ_ONLY);
    }

    public TextDecoration getDefaultTextDecorationForUpdate() {
        return getDefaultTextDecoration(EntityPermission.READ_WRITE);
    }

    public TextDecorationDetailValue getDefaultTextDecorationDetailValueForUpdate() {
        return getDefaultTextDecorationForUpdate().getLastDetailForUpdate().getTextDecorationDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getTextDecorationsQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM textdecorations, textdecorationdetails " +
                "WHERE txtdcrtn_activedetailid = txtdcrtndt_textdecorationdetailid " +
                "ORDER BY txtdcrtndt_sortorder, txtdcrtndt_textdecorationname " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM textdecorations, textdecorationdetails " +
                "WHERE txtdcrtn_activedetailid = txtdcrtndt_textdecorationdetailid " +
                "FOR UPDATE");
        getTextDecorationsQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<TextDecoration> getTextDecorations(EntityPermission entityPermission) {
        return TextDecorationFactory.getInstance().getEntitiesFromQuery(entityPermission, getTextDecorationsQueries);
    }

    public List<TextDecoration> getTextDecorations() {
        return getTextDecorations(EntityPermission.READ_ONLY);
    }

    public List<TextDecoration> getTextDecorationsForUpdate() {
        return getTextDecorations(EntityPermission.READ_WRITE);
    }

    public TextDecorationTransfer getTextDecorationTransfer(UserVisit userVisit, TextDecoration textDecoration) {
        return getCoreTransferCaches(userVisit).getTextDecorationTransferCache().getTextDecorationTransfer(textDecoration);
    }

    public List<TextDecorationTransfer> getTextDecorationTransfers(UserVisit userVisit, Collection<TextDecoration> entities) {
        List<TextDecorationTransfer> transfers = new ArrayList<>(entities.size());
        var transferCache = getCoreTransferCaches(userVisit).getTextDecorationTransferCache();
        
        entities.forEach((entity) ->
                transfers.add(transferCache.getTextDecorationTransfer(entity))
        );
        
        return transfers;
    }
    
    public List<TextDecorationTransfer> getTextDecorationTransfers(UserVisit userVisit) {
        return getTextDecorationTransfers(userVisit, getTextDecorations());
    }

    public TextDecorationChoicesBean getTextDecorationChoices(String defaultTextDecorationChoice, Language language, boolean allowNullChoice) {
        var textDecorations = getTextDecorations();
        var size = textDecorations.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultTextDecorationChoice == null) {
                defaultValue = "";
            }
        }

        for(var textDecoration : textDecorations) {
            var textDecorationDetail = textDecoration.getLastDetail();

            var label = getBestTextDecorationDescription(textDecoration, language);
            var value = textDecorationDetail.getTextDecorationName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultTextDecorationChoice != null && defaultTextDecorationChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && textDecorationDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new TextDecorationChoicesBean(labels, values, defaultValue);
    }

    private void updateTextDecorationFromValue(TextDecorationDetailValue textDecorationDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(textDecorationDetailValue.hasBeenModified()) {
            var textDecoration = TextDecorationFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     textDecorationDetailValue.getTextDecorationPK());
            var textDecorationDetail = textDecoration.getActiveDetailForUpdate();

            textDecorationDetail.setThruTime(session.START_TIME_LONG);
            textDecorationDetail.store();

            var textDecorationPK = textDecorationDetail.getTextDecorationPK(); // Not updated
            var textDecorationName = textDecorationDetailValue.getTextDecorationName();
            var isDefault = textDecorationDetailValue.getIsDefault();
            var sortOrder = textDecorationDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultTextDecoration = getDefaultTextDecoration();
                var defaultFound = defaultTextDecoration != null && !defaultTextDecoration.equals(textDecoration);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultTextDecorationDetailValue = getDefaultTextDecorationDetailValueForUpdate();

                    defaultTextDecorationDetailValue.setIsDefault(Boolean.FALSE);
                    updateTextDecorationFromValue(defaultTextDecorationDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            textDecorationDetail = TextDecorationDetailFactory.getInstance().create(textDecorationPK, textDecorationName, isDefault, sortOrder, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            textDecoration.setActiveDetail(textDecorationDetail);
            textDecoration.setLastDetail(textDecorationDetail);

            sendEvent(textDecorationPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateTextDecorationFromValue(TextDecorationDetailValue textDecorationDetailValue, BasePK updatedBy) {
        updateTextDecorationFromValue(textDecorationDetailValue, true, updatedBy);
    }

    private void deleteTextDecoration(TextDecoration textDecoration, boolean checkDefault, BasePK deletedBy) {
        var textDecorationDetail = textDecoration.getLastDetailForUpdate();

        deleteAppearanceTextDecorationsByTextDecoration(textDecoration, deletedBy);
        deleteTextDecorationDescriptionsByTextDecoration(textDecoration, deletedBy);

        textDecorationDetail.setThruTime(session.START_TIME_LONG);
        textDecoration.setActiveDetail(null);
        textDecoration.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultTextDecoration = getDefaultTextDecoration();

            if(defaultTextDecoration == null) {
                var textDecorations = getTextDecorationsForUpdate();

                if(!textDecorations.isEmpty()) {
                    var iter = textDecorations.iterator();
                    if(iter.hasNext()) {
                        defaultTextDecoration = iter.next();
                    }
                    var textDecorationDetailValue = Objects.requireNonNull(defaultTextDecoration).getLastDetailForUpdate().getTextDecorationDetailValue().clone();

                    textDecorationDetailValue.setIsDefault(Boolean.TRUE);
                    updateTextDecorationFromValue(textDecorationDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(textDecoration.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteTextDecoration(TextDecoration textDecoration, BasePK deletedBy) {
        deleteTextDecoration(textDecoration, true, deletedBy);
    }

    private void deleteTextDecorations(List<TextDecoration> textDecorations, boolean checkDefault, BasePK deletedBy) {
        textDecorations.forEach((textDecoration) -> deleteTextDecoration(textDecoration, checkDefault, deletedBy));
    }

    public void deleteTextDecorations(List<TextDecoration> textDecorations, BasePK deletedBy) {
        deleteTextDecorations(textDecorations, true, deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Text Decoration Descriptions
    // --------------------------------------------------------------------------------

    public TextDecorationDescription createTextDecorationDescription(TextDecoration textDecoration, Language language, String description, BasePK createdBy) {
        var textDecorationDescription = TextDecorationDescriptionFactory.getInstance().create(textDecoration, language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(textDecoration.getPrimaryKey(), EventTypes.MODIFY, textDecorationDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return textDecorationDescription;
    }

    private static final Map<EntityPermission, String> getTextDecorationDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM textdecorationdescriptions " +
                "WHERE txtdcrtnd_txtdcrtn_textdecorationid = ? AND txtdcrtnd_lang_languageid = ? AND txtdcrtnd_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM textdecorationdescriptions " +
                "WHERE txtdcrtnd_txtdcrtn_textdecorationid = ? AND txtdcrtnd_lang_languageid = ? AND txtdcrtnd_thrutime = ? " +
                "FOR UPDATE");
        getTextDecorationDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private TextDecorationDescription getTextDecorationDescription(TextDecoration textDecoration, Language language, EntityPermission entityPermission) {
        return TextDecorationDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getTextDecorationDescriptionQueries,
                textDecoration, language, Session.MAX_TIME);
    }

    public TextDecorationDescription getTextDecorationDescription(TextDecoration textDecoration, Language language) {
        return getTextDecorationDescription(textDecoration, language, EntityPermission.READ_ONLY);
    }

    public TextDecorationDescription getTextDecorationDescriptionForUpdate(TextDecoration textDecoration, Language language) {
        return getTextDecorationDescription(textDecoration, language, EntityPermission.READ_WRITE);
    }

    public TextDecorationDescriptionValue getTextDecorationDescriptionValue(TextDecorationDescription textDecorationDescription) {
        return textDecorationDescription == null? null: textDecorationDescription.getTextDecorationDescriptionValue().clone();
    }

    public TextDecorationDescriptionValue getTextDecorationDescriptionValueForUpdate(TextDecoration textDecoration, Language language) {
        return getTextDecorationDescriptionValue(getTextDecorationDescriptionForUpdate(textDecoration, language));
    }

    private static final Map<EntityPermission, String> getTextDecorationDescriptionsByTextDecorationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM textdecorationdescriptions, languages " +
                "WHERE txtdcrtnd_txtdcrtn_textdecorationid = ? AND txtdcrtnd_thrutime = ? AND txtdcrtnd_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM textdecorationdescriptions " +
                "WHERE txtdcrtnd_txtdcrtn_textdecorationid = ? AND txtdcrtnd_thrutime = ? " +
                "FOR UPDATE");
        getTextDecorationDescriptionsByTextDecorationQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<TextDecorationDescription> getTextDecorationDescriptionsByTextDecoration(TextDecoration textDecoration, EntityPermission entityPermission) {
        return TextDecorationDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getTextDecorationDescriptionsByTextDecorationQueries,
                textDecoration, Session.MAX_TIME);
    }

    public List<TextDecorationDescription> getTextDecorationDescriptionsByTextDecoration(TextDecoration textDecoration) {
        return getTextDecorationDescriptionsByTextDecoration(textDecoration, EntityPermission.READ_ONLY);
    }

    public List<TextDecorationDescription> getTextDecorationDescriptionsByTextDecorationForUpdate(TextDecoration textDecoration) {
        return getTextDecorationDescriptionsByTextDecoration(textDecoration, EntityPermission.READ_WRITE);
    }

    public String getBestTextDecorationDescription(TextDecoration textDecoration, Language language) {
        String description;
        var textDecorationDescription = getTextDecorationDescription(textDecoration, language);

        if(textDecorationDescription == null && !language.getIsDefault()) {
            textDecorationDescription = getTextDecorationDescription(textDecoration, getPartyControl().getDefaultLanguage());
        }

        if(textDecorationDescription == null) {
            description = textDecoration.getLastDetail().getTextDecorationName();
        } else {
            description = textDecorationDescription.getDescription();
        }

        return description;
    }

    public TextDecorationDescriptionTransfer getTextDecorationDescriptionTransfer(UserVisit userVisit, TextDecorationDescription textDecorationDescription) {
        return getCoreTransferCaches(userVisit).getTextDecorationDescriptionTransferCache().getTextDecorationDescriptionTransfer(textDecorationDescription);
    }

    public List<TextDecorationDescriptionTransfer> getTextDecorationDescriptionTransfersByTextDecoration(UserVisit userVisit, TextDecoration textDecoration) {
        var textDecorationDescriptions = getTextDecorationDescriptionsByTextDecoration(textDecoration);
        List<TextDecorationDescriptionTransfer> textDecorationDescriptionTransfers = new ArrayList<>(textDecorationDescriptions.size());
        var textDecorationDescriptionTransferCache = getCoreTransferCaches(userVisit).getTextDecorationDescriptionTransferCache();

        textDecorationDescriptions.forEach((textDecorationDescription) ->
                textDecorationDescriptionTransfers.add(textDecorationDescriptionTransferCache.getTextDecorationDescriptionTransfer(textDecorationDescription))
        );

        return textDecorationDescriptionTransfers;
    }

    public void updateTextDecorationDescriptionFromValue(TextDecorationDescriptionValue textDecorationDescriptionValue, BasePK updatedBy) {
        if(textDecorationDescriptionValue.hasBeenModified()) {
            var textDecorationDescription = TextDecorationDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    textDecorationDescriptionValue.getPrimaryKey());

            textDecorationDescription.setThruTime(session.START_TIME_LONG);
            textDecorationDescription.store();

            var textDecoration = textDecorationDescription.getTextDecoration();
            var language = textDecorationDescription.getLanguage();
            var description = textDecorationDescriptionValue.getDescription();

            textDecorationDescription = TextDecorationDescriptionFactory.getInstance().create(textDecoration, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(textDecoration.getPrimaryKey(), EventTypes.MODIFY, textDecorationDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteTextDecorationDescription(TextDecorationDescription textDecorationDescription, BasePK deletedBy) {
        textDecorationDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(textDecorationDescription.getTextDecorationPK(), EventTypes.MODIFY, textDecorationDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteTextDecorationDescriptionsByTextDecoration(TextDecoration textDecoration, BasePK deletedBy) {
        var textDecorationDescriptions = getTextDecorationDescriptionsByTextDecorationForUpdate(textDecoration);

        textDecorationDescriptions.forEach((textDecorationDescription) -> 
                deleteTextDecorationDescription(textDecorationDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Text Transformations
    // --------------------------------------------------------------------------------

    public TextTransformation createTextTransformation(String textTransformationName, Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultTextTransformation = getDefaultTextTransformation();
        var defaultFound = defaultTextTransformation != null;

        if(defaultFound && isDefault) {
            var defaultTextTransformationDetailValue = getDefaultTextTransformationDetailValueForUpdate();

            defaultTextTransformationDetailValue.setIsDefault(Boolean.FALSE);
            updateTextTransformationFromValue(defaultTextTransformationDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var textTransformation = TextTransformationFactory.getInstance().create();
        var textTransformationDetail = TextTransformationDetailFactory.getInstance().create(textTransformation, textTransformationName, isDefault, sortOrder, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);

        // Convert to R/W
        textTransformation = TextTransformationFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, textTransformation.getPrimaryKey());
        textTransformation.setActiveDetail(textTransformationDetail);
        textTransformation.setLastDetail(textTransformationDetail);
        textTransformation.store();

        sendEvent(textTransformation.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return textTransformation;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.TextTransformation */
    public TextTransformation getTextTransformationByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new TextTransformationPK(entityInstance.getEntityUniqueId());

        return TextTransformationFactory.getInstance().getEntityFromPK(entityPermission, pk);
    }

    public TextTransformation getTextTransformationByEntityInstance(EntityInstance entityInstance) {
        return getTextTransformationByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public TextTransformation getTextTransformationByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getTextTransformationByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public long countTextTransformations() {
        return session.queryForLong("""
                SELECT COUNT(*)
                FROM texttransformations, texttransformationdetails
                WHERE txttrns_activedetailid = txttrnsdt_texttransformationdetailid
                """);
    }

    private static final Map<EntityPermission, String> getTextTransformationByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM texttransformations, texttransformationdetails " +
                "WHERE txttrns_activedetailid = txttrnsdt_texttransformationdetailid " +
                "AND txttrnsdt_texttransformationname = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM texttransformations, texttransformationdetails " +
                "WHERE txttrns_activedetailid = txttrnsdt_texttransformationdetailid " +
                "AND txttrnsdt_texttransformationname = ? " +
                "FOR UPDATE");
        getTextTransformationByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    private TextTransformation getTextTransformationByName(String textTransformationName, EntityPermission entityPermission) {
        return TextTransformationFactory.getInstance().getEntityFromQuery(entityPermission, getTextTransformationByNameQueries, textTransformationName);
    }

    public TextTransformation getTextTransformationByName(String textTransformationName) {
        return getTextTransformationByName(textTransformationName, EntityPermission.READ_ONLY);
    }

    public TextTransformation getTextTransformationByNameForUpdate(String textTransformationName) {
        return getTextTransformationByName(textTransformationName, EntityPermission.READ_WRITE);
    }

    public TextTransformationDetailValue getTextTransformationDetailValueForUpdate(TextTransformation textTransformation) {
        return textTransformation == null? null: textTransformation.getLastDetailForUpdate().getTextTransformationDetailValue().clone();
    }

    public TextTransformationDetailValue getTextTransformationDetailValueByNameForUpdate(String textTransformationName) {
        return getTextTransformationDetailValueForUpdate(getTextTransformationByNameForUpdate(textTransformationName));
    }

    private static final Map<EntityPermission, String> getDefaultTextTransformationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM texttransformations, texttransformationdetails " +
                "WHERE txttrns_activedetailid = txttrnsdt_texttransformationdetailid " +
                "AND txttrnsdt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM texttransformations, texttransformationdetails " +
                "WHERE txttrns_activedetailid = txttrnsdt_texttransformationdetailid " +
                "AND txttrnsdt_isdefault = 1 " +
                "FOR UPDATE");
        getDefaultTextTransformationQueries = Collections.unmodifiableMap(queryMap);
    }

    private TextTransformation getDefaultTextTransformation(EntityPermission entityPermission) {
        return TextTransformationFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultTextTransformationQueries);
    }

    public TextTransformation getDefaultTextTransformation() {
        return getDefaultTextTransformation(EntityPermission.READ_ONLY);
    }

    public TextTransformation getDefaultTextTransformationForUpdate() {
        return getDefaultTextTransformation(EntityPermission.READ_WRITE);
    }

    public TextTransformationDetailValue getDefaultTextTransformationDetailValueForUpdate() {
        return getDefaultTextTransformationForUpdate().getLastDetailForUpdate().getTextTransformationDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getTextTransformationsQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM texttransformations, texttransformationdetails " +
                "WHERE txttrns_activedetailid = txttrnsdt_texttransformationdetailid " +
                "ORDER BY txttrnsdt_sortorder, txttrnsdt_texttransformationname " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM texttransformations, texttransformationdetails " +
                "WHERE txttrns_activedetailid = txttrnsdt_texttransformationdetailid " +
                "FOR UPDATE");
        getTextTransformationsQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<TextTransformation> getTextTransformations(EntityPermission entityPermission) {
        return TextTransformationFactory.getInstance().getEntitiesFromQuery(entityPermission, getTextTransformationsQueries);
    }

    public List<TextTransformation> getTextTransformations() {
        return getTextTransformations(EntityPermission.READ_ONLY);
    }

    public List<TextTransformation> getTextTransformationsForUpdate() {
        return getTextTransformations(EntityPermission.READ_WRITE);
    }

    public TextTransformationTransfer getTextTransformationTransfer(UserVisit userVisit, TextTransformation textTransformation) {
        return getCoreTransferCaches(userVisit).getTextTransformationTransferCache().getTextTransformationTransfer(textTransformation);
    }

    public List<TextTransformationTransfer> getTextTransformationTransfers(UserVisit userVisit, Collection<TextTransformation> entities) {
        List<TextTransformationTransfer> transfers = new ArrayList<>(entities.size());
        var transferCache = getCoreTransferCaches(userVisit).getTextTransformationTransferCache();
        
        entities.forEach((entity) ->
                transfers.add(transferCache.getTextTransformationTransfer(entity))
        );
        
        return transfers;
    }
    
    public List<TextTransformationTransfer> getTextTransformationTransfers(UserVisit userVisit) {
        return getTextTransformationTransfers(userVisit, getTextTransformations());
    }

    public TextTransformationChoicesBean getTextTransformationChoices(String defaultTextTransformationChoice, Language language, boolean allowNullChoice) {
        var textTransformations = getTextTransformations();
        var size = textTransformations.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultTextTransformationChoice == null) {
                defaultValue = "";
            }
        }

        for(var textTransformation : textTransformations) {
            var textTransformationDetail = textTransformation.getLastDetail();

            var label = getBestTextTransformationDescription(textTransformation, language);
            var value = textTransformationDetail.getTextTransformationName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultTextTransformationChoice != null && defaultTextTransformationChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && textTransformationDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new TextTransformationChoicesBean(labels, values, defaultValue);
    }

    private void updateTextTransformationFromValue(TextTransformationDetailValue textTransformationDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(textTransformationDetailValue.hasBeenModified()) {
            var textTransformation = TextTransformationFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     textTransformationDetailValue.getTextTransformationPK());
            var textTransformationDetail = textTransformation.getActiveDetailForUpdate();

            textTransformationDetail.setThruTime(session.START_TIME_LONG);
            textTransformationDetail.store();

            var textTransformationPK = textTransformationDetail.getTextTransformationPK(); // Not updated
            var textTransformationName = textTransformationDetailValue.getTextTransformationName();
            var isDefault = textTransformationDetailValue.getIsDefault();
            var sortOrder = textTransformationDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultTextTransformation = getDefaultTextTransformation();
                var defaultFound = defaultTextTransformation != null && !defaultTextTransformation.equals(textTransformation);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultTextTransformationDetailValue = getDefaultTextTransformationDetailValueForUpdate();

                    defaultTextTransformationDetailValue.setIsDefault(Boolean.FALSE);
                    updateTextTransformationFromValue(defaultTextTransformationDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            textTransformationDetail = TextTransformationDetailFactory.getInstance().create(textTransformationPK, textTransformationName, isDefault, sortOrder, session.START_TIME_LONG,
                    Session.MAX_TIME_LONG);

            textTransformation.setActiveDetail(textTransformationDetail);
            textTransformation.setLastDetail(textTransformationDetail);

            sendEvent(textTransformationPK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateTextTransformationFromValue(TextTransformationDetailValue textTransformationDetailValue, BasePK updatedBy) {
        updateTextTransformationFromValue(textTransformationDetailValue, true, updatedBy);
    }

    private void deleteTextTransformation(TextTransformation textTransformation, boolean checkDefault, BasePK deletedBy) {
        var textTransformationDetail = textTransformation.getLastDetailForUpdate();

        deleteAppearanceTextTransformationsByTextTransformation(textTransformation, deletedBy);
        deleteTextTransformationDescriptionsByTextTransformation(textTransformation, deletedBy);

        textTransformationDetail.setThruTime(session.START_TIME_LONG);
        textTransformation.setActiveDetail(null);
        textTransformation.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultTextTransformation = getDefaultTextTransformation();

            if(defaultTextTransformation == null) {
                var textTransformations = getTextTransformationsForUpdate();

                if(!textTransformations.isEmpty()) {
                    var iter = textTransformations.iterator();
                    if(iter.hasNext()) {
                        defaultTextTransformation = iter.next();
                    }
                    var textTransformationDetailValue = Objects.requireNonNull(defaultTextTransformation).getLastDetailForUpdate().getTextTransformationDetailValue().clone();

                    textTransformationDetailValue.setIsDefault(Boolean.TRUE);
                    updateTextTransformationFromValue(textTransformationDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(textTransformation.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteTextTransformation(TextTransformation textTransformation, BasePK deletedBy) {
        deleteTextTransformation(textTransformation, true, deletedBy);
    }

    private void deleteTextTransformations(List<TextTransformation> textTransformations, boolean checkDefault, BasePK deletedBy) {
        textTransformations.forEach((textTransformation) -> deleteTextTransformation(textTransformation, checkDefault, deletedBy));
    }

    public void deleteTextTransformations(List<TextTransformation> textTransformations, BasePK deletedBy) {
        deleteTextTransformations(textTransformations, true, deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Text Transformation Descriptions
    // --------------------------------------------------------------------------------

    public TextTransformationDescription createTextTransformationDescription(TextTransformation textTransformation, Language language, String description, BasePK createdBy) {
        var textTransformationDescription = TextTransformationDescriptionFactory.getInstance().create(textTransformation, language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(textTransformation.getPrimaryKey(), EventTypes.MODIFY, textTransformationDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return textTransformationDescription;
    }

    private static final Map<EntityPermission, String> getTextTransformationDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM texttransformationdescriptions " +
                "WHERE txttrnsd_txttrns_texttransformationid = ? AND txttrnsd_lang_languageid = ? AND txttrnsd_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM texttransformationdescriptions " +
                "WHERE txttrnsd_txttrns_texttransformationid = ? AND txttrnsd_lang_languageid = ? AND txttrnsd_thrutime = ? " +
                "FOR UPDATE");
        getTextTransformationDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private TextTransformationDescription getTextTransformationDescription(TextTransformation textTransformation, Language language, EntityPermission entityPermission) {
        return TextTransformationDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getTextTransformationDescriptionQueries,
                textTransformation, language, Session.MAX_TIME);
    }

    public TextTransformationDescription getTextTransformationDescription(TextTransformation textTransformation, Language language) {
        return getTextTransformationDescription(textTransformation, language, EntityPermission.READ_ONLY);
    }

    public TextTransformationDescription getTextTransformationDescriptionForUpdate(TextTransformation textTransformation, Language language) {
        return getTextTransformationDescription(textTransformation, language, EntityPermission.READ_WRITE);
    }

    public TextTransformationDescriptionValue getTextTransformationDescriptionValue(TextTransformationDescription textTransformationDescription) {
        return textTransformationDescription == null? null: textTransformationDescription.getTextTransformationDescriptionValue().clone();
    }

    public TextTransformationDescriptionValue getTextTransformationDescriptionValueForUpdate(TextTransformation textTransformation, Language language) {
        return getTextTransformationDescriptionValue(getTextTransformationDescriptionForUpdate(textTransformation, language));
    }

    private static final Map<EntityPermission, String> getTextTransformationDescriptionsByTextTransformationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM texttransformationdescriptions, languages " +
                "WHERE txttrnsd_txttrns_texttransformationid = ? AND txttrnsd_thrutime = ? AND txttrnsd_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM texttransformationdescriptions " +
                "WHERE txttrnsd_txttrns_texttransformationid = ? AND txttrnsd_thrutime = ? " +
                "FOR UPDATE");
        getTextTransformationDescriptionsByTextTransformationQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<TextTransformationDescription> getTextTransformationDescriptionsByTextTransformation(TextTransformation textTransformation, EntityPermission entityPermission) {
        return TextTransformationDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getTextTransformationDescriptionsByTextTransformationQueries,
                textTransformation, Session.MAX_TIME);
    }

    public List<TextTransformationDescription> getTextTransformationDescriptionsByTextTransformation(TextTransformation textTransformation) {
        return getTextTransformationDescriptionsByTextTransformation(textTransformation, EntityPermission.READ_ONLY);
    }

    public List<TextTransformationDescription> getTextTransformationDescriptionsByTextTransformationForUpdate(TextTransformation textTransformation) {
        return getTextTransformationDescriptionsByTextTransformation(textTransformation, EntityPermission.READ_WRITE);
    }

    public String getBestTextTransformationDescription(TextTransformation textTransformation, Language language) {
        String description;
        var textTransformationDescription = getTextTransformationDescription(textTransformation, language);

        if(textTransformationDescription == null && !language.getIsDefault()) {
            textTransformationDescription = getTextTransformationDescription(textTransformation, getPartyControl().getDefaultLanguage());
        }

        if(textTransformationDescription == null) {
            description = textTransformation.getLastDetail().getTextTransformationName();
        } else {
            description = textTransformationDescription.getDescription();
        }

        return description;
    }

    public TextTransformationDescriptionTransfer getTextTransformationDescriptionTransfer(UserVisit userVisit, TextTransformationDescription textTransformationDescription) {
        return getCoreTransferCaches(userVisit).getTextTransformationDescriptionTransferCache().getTextTransformationDescriptionTransfer(textTransformationDescription);
    }

    public List<TextTransformationDescriptionTransfer> getTextTransformationDescriptionTransfersByTextTransformation(UserVisit userVisit, TextTransformation textTransformation) {
        var textTransformationDescriptions = getTextTransformationDescriptionsByTextTransformation(textTransformation);
        List<TextTransformationDescriptionTransfer> textTransformationDescriptionTransfers = new ArrayList<>(textTransformationDescriptions.size());
        var textTransformationDescriptionTransferCache = getCoreTransferCaches(userVisit).getTextTransformationDescriptionTransferCache();

        textTransformationDescriptions.forEach((textTransformationDescription) ->
                textTransformationDescriptionTransfers.add(textTransformationDescriptionTransferCache.getTextTransformationDescriptionTransfer(textTransformationDescription))
        );

        return textTransformationDescriptionTransfers;
    }

    public void updateTextTransformationDescriptionFromValue(TextTransformationDescriptionValue textTransformationDescriptionValue, BasePK updatedBy) {
        if(textTransformationDescriptionValue.hasBeenModified()) {
            var textTransformationDescription = TextTransformationDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    textTransformationDescriptionValue.getPrimaryKey());

            textTransformationDescription.setThruTime(session.START_TIME_LONG);
            textTransformationDescription.store();

            var textTransformation = textTransformationDescription.getTextTransformation();
            var language = textTransformationDescription.getLanguage();
            var description = textTransformationDescriptionValue.getDescription();

            textTransformationDescription = TextTransformationDescriptionFactory.getInstance().create(textTransformation, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(textTransformation.getPrimaryKey(), EventTypes.MODIFY, textTransformationDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteTextTransformationDescription(TextTransformationDescription textTransformationDescription, BasePK deletedBy) {
        textTransformationDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(textTransformationDescription.getTextTransformationPK(), EventTypes.MODIFY, textTransformationDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteTextTransformationDescriptionsByTextTransformation(TextTransformation textTransformation, BasePK deletedBy) {
        var textTransformationDescriptions = getTextTransformationDescriptionsByTextTransformationForUpdate(textTransformation);

        textTransformationDescriptions.forEach((textTransformationDescription) -> 
                deleteTextTransformationDescription(textTransformationDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Appearances
    // --------------------------------------------------------------------------------

    public Appearance createAppearance(String appearanceName, Color textColor, Color backgroundColor, FontStyle fontStyle, FontWeight fontWeight,
            Boolean isDefault, Integer sortOrder, BasePK createdBy) {
        var defaultAppearance = getDefaultAppearance();
        var defaultFound = defaultAppearance != null;

        if(defaultFound && isDefault) {
            var defaultAppearanceDetailValue = getDefaultAppearanceDetailValueForUpdate();

            defaultAppearanceDetailValue.setIsDefault(Boolean.FALSE);
            updateAppearanceFromValue(defaultAppearanceDetailValue, false, createdBy);
        } else if(!defaultFound) {
            isDefault = Boolean.TRUE;
        }

        var appearance = AppearanceFactory.getInstance().create();
        var appearanceDetail = AppearanceDetailFactory.getInstance().create(appearance, appearanceName, textColor, backgroundColor, fontStyle,
                fontWeight, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);

        // Convert to R/W
        appearance = AppearanceFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE, appearance.getPrimaryKey());
        appearance.setActiveDetail(appearanceDetail);
        appearance.setLastDetail(appearanceDetail);
        appearance.store();

        sendEvent(appearance.getPrimaryKey(), EventTypes.CREATE, null, null, createdBy);

        return appearance;
    }

    /** Assume that the entityInstance passed to this function is a ECHO_THREE.Appearance */
    public Appearance getAppearanceByEntityInstance(EntityInstance entityInstance, EntityPermission entityPermission) {
        var pk = new AppearancePK(entityInstance.getEntityUniqueId());
        var appearance = AppearanceFactory.getInstance().getEntityFromPK(entityPermission, pk);

        return appearance;
    }

    public Appearance getAppearanceByEntityInstance(EntityInstance entityInstance) {
        return getAppearanceByEntityInstance(entityInstance, EntityPermission.READ_ONLY);
    }

    public Appearance getAppearanceByEntityInstanceForUpdate(EntityInstance entityInstance) {
        return getAppearanceByEntityInstance(entityInstance, EntityPermission.READ_WRITE);
    }

    public long countAppearances() {
        return session.queryForLong("""
                SELECT COUNT(*)
                FROM appearances, appearancedetails
                WHERE apprnc_activedetailid = apprncdt_appearancedetailid
                """);
    }

    private static final Map<EntityPermission, String> getAppearanceByNameQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid " +
                "AND apprncdt_appearancename = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid " +
                "AND apprncdt_appearancename = ? " +
                "FOR UPDATE");
        getAppearanceByNameQueries = Collections.unmodifiableMap(queryMap);
    }

    public Appearance getAppearanceByName(String appearanceName, EntityPermission entityPermission) {
        return AppearanceFactory.getInstance().getEntityFromQuery(entityPermission, getAppearanceByNameQueries, appearanceName);
    }

    public Appearance getAppearanceByName(String appearanceName) {
        return getAppearanceByName(appearanceName, EntityPermission.READ_ONLY);
    }

    public Appearance getAppearanceByNameForUpdate(String appearanceName) {
        return getAppearanceByName(appearanceName, EntityPermission.READ_WRITE);
    }

    public AppearanceDetailValue getAppearanceDetailValueForUpdate(Appearance appearance) {
        return appearance == null? null: appearance.getLastDetailForUpdate().getAppearanceDetailValue().clone();
    }

    public AppearanceDetailValue getAppearanceDetailValueByNameForUpdate(String appearanceName) {
        return getAppearanceDetailValueForUpdate(getAppearanceByNameForUpdate(appearanceName));
    }

    private static final Map<EntityPermission, String> getDefaultAppearanceQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid " +
                "AND apprncdt_isdefault = 1");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid " +
                "AND apprncdt_isdefault = 1 " +
                "FOR UPDATE");
        getDefaultAppearanceQueries = Collections.unmodifiableMap(queryMap);
    }

    private Appearance getDefaultAppearance(EntityPermission entityPermission) {
        return AppearanceFactory.getInstance().getEntityFromQuery(entityPermission, getDefaultAppearanceQueries);
    }

    public Appearance getDefaultAppearance() {
        return getDefaultAppearance(EntityPermission.READ_ONLY);
    }

    public Appearance getDefaultAppearanceForUpdate() {
        return getDefaultAppearance(EntityPermission.READ_WRITE);
    }

    public AppearanceDetailValue getDefaultAppearanceDetailValueForUpdate() {
        return getDefaultAppearanceForUpdate().getLastDetailForUpdate().getAppearanceDetailValue().clone();
    }

    private static final Map<EntityPermission, String> getAppearancesQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid " +
                "ORDER BY apprncdt_sortorder, apprncdt_appearancename " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid " +
                "FOR UPDATE");
        getAppearancesQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Appearance> getAppearances(EntityPermission entityPermission) {
        return AppearanceFactory.getInstance().getEntitiesFromQuery(entityPermission, getAppearancesQueries);
    }

    public List<Appearance> getAppearances() {
        return getAppearances(EntityPermission.READ_ONLY);
    }

    public List<Appearance> getAppearancesForUpdate() {
        return getAppearances(EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getAppearancesByTextColorQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid AND apprncdt_textcolorid = ? " +
                "ORDER BY apprncdt_sortorder, apprncdt_appearancename " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid AND apprncdt_textcolorid = ? " +
                "FOR UPDATE");
        getAppearancesByTextColorQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Appearance> getAppearancesByTextColor(Color textColor, EntityPermission entityPermission) {
        return AppearanceFactory.getInstance().getEntitiesFromQuery(entityPermission, getAppearancesByTextColorQueries,
                textColor);
    }

    public List<Appearance> getAppearancesByTextColor(Color textColor) {
        return getAppearancesByTextColor(textColor, EntityPermission.READ_ONLY);
    }

    public List<Appearance> getAppearancesByTextColorForUpdate(Color textColor) {
        return getAppearancesByTextColor(textColor, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getAppearancesByBackgroundColorQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid AND apprncdt_backgroundcolorid = ? " +
                "ORDER BY apprncdt_sortorder, apprncdt_appearancename " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid AND apprncdt_backgroundcolorid = ? " +
                "FOR UPDATE");
        getAppearancesByBackgroundColorQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Appearance> getAppearancesByBackgroundColor(Color backgroundColor, EntityPermission entityPermission) {
        return AppearanceFactory.getInstance().getEntitiesFromQuery(entityPermission, getAppearancesByBackgroundColorQueries,
                backgroundColor);
    }

    public List<Appearance> getAppearancesByBackgroundColor(Color backgroundColor) {
        return getAppearancesByBackgroundColor(backgroundColor, EntityPermission.READ_ONLY);
    }

    public List<Appearance> getAppearancesByBackgroundColorForUpdate(Color backgroundColor) {
        return getAppearancesByBackgroundColor(backgroundColor, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getAppearancesByFontStyleQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid AND apprncdt_fntstyl_fontstyleid = ? " +
                "ORDER BY apprncdt_sortorder, apprncdt_appearancename " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid AND apprncdt_fntstyl_fontstyleid = ? " +
                "FOR UPDATE");
        getAppearancesByFontStyleQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Appearance> getAppearancesByFontStyle(FontStyle fontStyle, EntityPermission entityPermission) {
        return AppearanceFactory.getInstance().getEntitiesFromQuery(entityPermission, getAppearancesByFontStyleQueries,
                fontStyle);
    }

    public List<Appearance> getAppearancesByFontStyle(FontStyle fontStyle) {
        return getAppearancesByFontStyle(fontStyle, EntityPermission.READ_ONLY);
    }

    public List<Appearance> getAppearancesByFontStyleForUpdate(FontStyle fontStyle) {
        return getAppearancesByFontStyle(fontStyle, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getAppearancesByFontWeightQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid AND apprncdt_fntwght_fontweightid = ? " +
                "ORDER BY apprncdt_sortorder, apprncdt_appearancename " +
                "_LIMIT_");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM appearances, appearancedetails " +
                "WHERE apprnc_activedetailid = apprncdt_appearancedetailid AND apprncdt_fntwght_fontweightid = ? " +
                "FOR UPDATE");
        getAppearancesByFontWeightQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<Appearance> getAppearancesByFontWeight(FontWeight fontWeight, EntityPermission entityPermission) {
        return AppearanceFactory.getInstance().getEntitiesFromQuery(entityPermission, getAppearancesByFontWeightQueries,
                fontWeight);
    }

    public List<Appearance> getAppearancesByFontWeight(FontWeight fontWeight) {
        return getAppearancesByFontWeight(fontWeight, EntityPermission.READ_ONLY);
    }

    public List<Appearance> getAppearancesByFontWeightForUpdate(FontWeight fontWeight) {
        return getAppearancesByFontWeight(fontWeight, EntityPermission.READ_WRITE);
    }

    public AppearanceTransfer getAppearanceTransfer(UserVisit userVisit, Appearance appearance) {
        return getCoreTransferCaches(userVisit).getAppearanceTransferCache().getAppearanceTransfer(appearance);
    }

    public List<AppearanceTransfer> getAppearanceTransfers(UserVisit userVisit, Collection<Appearance> appearances) {
        List<AppearanceTransfer> appearanceTransfers = new ArrayList<>(appearances.size());
        var appearanceTransferCache = getCoreTransferCaches(userVisit).getAppearanceTransferCache();

        appearances.forEach((appearance) ->
                appearanceTransfers.add(appearanceTransferCache.getAppearanceTransfer(appearance))
        );

        return appearanceTransfers;
    }

    public List<AppearanceTransfer> getAppearanceTransfers(UserVisit userVisit) {
        return getAppearanceTransfers(userVisit, getAppearances());
    }

    public AppearanceChoicesBean getAppearanceChoices(String defaultAppearanceChoice, Language language, boolean allowNullChoice) {
        var appearances = getAppearances();
        var size = appearances.size();
        var labels = new ArrayList<String>(size);
        var values = new ArrayList<String>(size);
        String defaultValue = null;

        if(allowNullChoice) {
            labels.add("");
            values.add("");

            if(defaultAppearanceChoice == null) {
                defaultValue = "";
            }
        }

        for(var appearance : appearances) {
            var appearanceDetail = appearance.getLastDetail();

            var label = getBestAppearanceDescription(appearance, language);
            var value = appearanceDetail.getAppearanceName();

            labels.add(label == null? value: label);
            values.add(value);

            var usingDefaultChoice = defaultAppearanceChoice != null && defaultAppearanceChoice.equals(value);
            if(usingDefaultChoice || (defaultValue == null && appearanceDetail.getIsDefault())) {
                defaultValue = value;
            }
        }

        return new AppearanceChoicesBean(labels, values, defaultValue);
    }

    private void updateAppearanceFromValue(AppearanceDetailValue appearanceDetailValue, boolean checkDefault, BasePK updatedBy) {
        if(appearanceDetailValue.hasBeenModified()) {
            var appearance = AppearanceFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                     appearanceDetailValue.getAppearancePK());
            var appearanceDetail = appearance.getActiveDetailForUpdate();

            appearanceDetail.setThruTime(session.START_TIME_LONG);
            appearanceDetail.store();

            var appearancePK = appearanceDetail.getAppearancePK(); // Not updated
            var appearanceName = appearanceDetailValue.getAppearanceName();
            var textColorPK = appearanceDetailValue.getTextColorPK();
            var backgroundColorPK = appearanceDetailValue.getBackgroundColorPK();
            var fontStylePK = appearanceDetailValue.getFontStylePK();
            var fontWeightPK = appearanceDetailValue.getFontWeightPK();
            var isDefault = appearanceDetailValue.getIsDefault();
            var sortOrder = appearanceDetailValue.getSortOrder();

            if(checkDefault) {
                var defaultAppearance = getDefaultAppearance();
                var defaultFound = defaultAppearance != null && !defaultAppearance.equals(appearance);

                if(isDefault && defaultFound) {
                    // If I'm the default, and a default already existed...
                    var defaultAppearanceDetailValue = getDefaultAppearanceDetailValueForUpdate();

                    defaultAppearanceDetailValue.setIsDefault(Boolean.FALSE);
                    updateAppearanceFromValue(defaultAppearanceDetailValue, false, updatedBy);
                } else if(!isDefault && !defaultFound) {
                    // If I'm not the default, and no other default exists...
                    isDefault = Boolean.TRUE;
                }
            }

            appearanceDetail = AppearanceDetailFactory.getInstance().create(appearancePK, appearanceName, textColorPK, backgroundColorPK, fontStylePK,
                    fontWeightPK, isDefault, sortOrder, session.START_TIME_LONG, Session.MAX_TIME_LONG);

            appearance.setActiveDetail(appearanceDetail);
            appearance.setLastDetail(appearanceDetail);

            sendEvent(appearancePK, EventTypes.MODIFY, null, null, updatedBy);
        }
    }

    public void updateAppearanceFromValue(AppearanceDetailValue appearanceDetailValue, BasePK updatedBy) {
        updateAppearanceFromValue(appearanceDetailValue, true, updatedBy);
    }

    private void deleteAppearance(Appearance appearance, boolean checkDefault, BasePK deletedBy) {
        var appearanceDetail = appearance.getLastDetailForUpdate();

        deleteAppearanceTextDecorationsByAppearance(appearance, deletedBy);
        deleteAppearanceTextTransformationsByAppearance(appearance, deletedBy);
        deleteAppearanceDescriptionsByAppearance(appearance, deletedBy);
        deleteEntityAppearancesByAppearance(appearance, deletedBy);

        appearanceDetail.setThruTime(session.START_TIME_LONG);
        appearance.setActiveDetail(null);
        appearance.store();

        if(checkDefault) {
            // Check for default, and pick one if necessary
            var defaultAppearance = getDefaultAppearance();

            if(defaultAppearance == null) {
                var appearances = getAppearancesForUpdate();

                if(!appearances.isEmpty()) {
                    var iter = appearances.iterator();
                    if(iter.hasNext()) {
                        defaultAppearance = iter.next();
                    }
                    var appearanceDetailValue = Objects.requireNonNull(defaultAppearance).getLastDetailForUpdate().getAppearanceDetailValue().clone();

                    appearanceDetailValue.setIsDefault(Boolean.TRUE);
                    updateAppearanceFromValue(appearanceDetailValue, false, deletedBy);
                }
            }
        }

        sendEvent(appearance.getPrimaryKey(), EventTypes.DELETE, null, null, deletedBy);
    }

    public void deleteAppearance(Appearance appearance, BasePK deletedBy) {
        deleteAppearance(appearance, true, deletedBy);
    }

    private void deleteAppearances(List<Appearance> appearances, boolean checkDefault, BasePK deletedBy) {
        appearances.forEach((appearance) -> deleteAppearance(appearance, checkDefault, deletedBy));
    }

    public void deleteAppearances(List<Appearance> appearances, BasePK deletedBy) {
        deleteAppearances(appearances, true, deletedBy);
    }

    public void deleteAppearancesByTextColor(Color textColor, BasePK deletedBy) {
        deleteAppearances(getAppearancesByTextColorForUpdate(textColor), deletedBy);
    }
    
    public void deleteAppearancesByBackgroundColor(Color backgroundColor, BasePK deletedBy) {
        deleteAppearances(getAppearancesByBackgroundColorForUpdate(backgroundColor), deletedBy);
    }
    
    public void deleteAppearancesByColor(Color color, BasePK deletedBy) {
        deleteAppearancesByTextColor(color, deletedBy);
        deleteAppearancesByBackgroundColor(color, deletedBy);
    }
    
    public void deleteAppearancesByFontStyle(FontStyle fontStyle, BasePK deletedBy) {
        deleteAppearances(getAppearancesByFontStyleForUpdate(fontStyle), deletedBy);
    }
    
    public void deleteAppearancesByFontWeight(FontWeight fontWeight, BasePK deletedBy) {
        deleteAppearances(getAppearancesByFontWeightForUpdate(fontWeight), deletedBy);
    }
    
    // --------------------------------------------------------------------------------
    //   Appearance Descriptions
    // --------------------------------------------------------------------------------

    public AppearanceDescription createAppearanceDescription(Appearance appearance, Language language, String description, BasePK createdBy) {
        var appearanceDescription = AppearanceDescriptionFactory.getInstance().create(appearance, language, description,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(appearance.getPrimaryKey(), EventTypes.MODIFY, appearanceDescription.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return appearanceDescription;
    }

    private static final Map<EntityPermission, String> getAppearanceDescriptionQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM appearancedescriptions " +
                "WHERE apprncd_apprnc_appearanceid = ? AND apprncd_lang_languageid = ? AND apprncd_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM appearancedescriptions " +
                "WHERE apprncd_apprnc_appearanceid = ? AND apprncd_lang_languageid = ? AND apprncd_thrutime = ? " +
                "FOR UPDATE");
        getAppearanceDescriptionQueries = Collections.unmodifiableMap(queryMap);
    }

    private AppearanceDescription getAppearanceDescription(Appearance appearance, Language language, EntityPermission entityPermission) {
        return AppearanceDescriptionFactory.getInstance().getEntityFromQuery(entityPermission, getAppearanceDescriptionQueries,
                appearance, language, Session.MAX_TIME);
    }

    public AppearanceDescription getAppearanceDescription(Appearance appearance, Language language) {
        return getAppearanceDescription(appearance, language, EntityPermission.READ_ONLY);
    }

    public AppearanceDescription getAppearanceDescriptionForUpdate(Appearance appearance, Language language) {
        return getAppearanceDescription(appearance, language, EntityPermission.READ_WRITE);
    }

    public AppearanceDescriptionValue getAppearanceDescriptionValue(AppearanceDescription appearanceDescription) {
        return appearanceDescription == null? null: appearanceDescription.getAppearanceDescriptionValue().clone();
    }

    public AppearanceDescriptionValue getAppearanceDescriptionValueForUpdate(Appearance appearance, Language language) {
        return getAppearanceDescriptionValue(getAppearanceDescriptionForUpdate(appearance, language));
    }

    private static final Map<EntityPermission, String> getAppearanceDescriptionsByAppearanceQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM appearancedescriptions, languages " +
                "WHERE apprncd_apprnc_appearanceid = ? AND apprncd_thrutime = ? AND apprncd_lang_languageid = lang_languageid " +
                "ORDER BY lang_sortorder, lang_languageisoname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM appearancedescriptions " +
                "WHERE apprncd_apprnc_appearanceid = ? AND apprncd_thrutime = ? " +
                "FOR UPDATE");
        getAppearanceDescriptionsByAppearanceQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<AppearanceDescription> getAppearanceDescriptionsByAppearance(Appearance appearance, EntityPermission entityPermission) {
        return AppearanceDescriptionFactory.getInstance().getEntitiesFromQuery(entityPermission, getAppearanceDescriptionsByAppearanceQueries,
                appearance, Session.MAX_TIME);
    }

    public List<AppearanceDescription> getAppearanceDescriptionsByAppearance(Appearance appearance) {
        return getAppearanceDescriptionsByAppearance(appearance, EntityPermission.READ_ONLY);
    }

    public List<AppearanceDescription> getAppearanceDescriptionsByAppearanceForUpdate(Appearance appearance) {
        return getAppearanceDescriptionsByAppearance(appearance, EntityPermission.READ_WRITE);
    }

    public String getBestAppearanceDescription(Appearance appearance, Language language) {
        String description;
        var appearanceDescription = getAppearanceDescription(appearance, language);

        if(appearanceDescription == null && !language.getIsDefault()) {
            appearanceDescription = getAppearanceDescription(appearance, getPartyControl().getDefaultLanguage());
        }

        if(appearanceDescription == null) {
            description = appearance.getLastDetail().getAppearanceName();
        } else {
            description = appearanceDescription.getDescription();
        }

        return description;
    }

    public AppearanceDescriptionTransfer getAppearanceDescriptionTransfer(UserVisit userVisit, AppearanceDescription appearanceDescription) {
        return getCoreTransferCaches(userVisit).getAppearanceDescriptionTransferCache().getAppearanceDescriptionTransfer(appearanceDescription);
    }

    public List<AppearanceDescriptionTransfer> getAppearanceDescriptionTransfersByAppearance(UserVisit userVisit, Appearance appearance) {
        var appearanceDescriptions = getAppearanceDescriptionsByAppearance(appearance);
        List<AppearanceDescriptionTransfer> appearanceDescriptionTransfers = new ArrayList<>(appearanceDescriptions.size());
        var appearanceDescriptionTransferCache = getCoreTransferCaches(userVisit).getAppearanceDescriptionTransferCache();

        appearanceDescriptions.forEach((appearanceDescription) ->
                appearanceDescriptionTransfers.add(appearanceDescriptionTransferCache.getAppearanceDescriptionTransfer(appearanceDescription))
        );

        return appearanceDescriptionTransfers;
    }

    public void updateAppearanceDescriptionFromValue(AppearanceDescriptionValue appearanceDescriptionValue, BasePK updatedBy) {
        if(appearanceDescriptionValue.hasBeenModified()) {
            var appearanceDescription = AppearanceDescriptionFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    appearanceDescriptionValue.getPrimaryKey());

            appearanceDescription.setThruTime(session.START_TIME_LONG);
            appearanceDescription.store();

            var appearance = appearanceDescription.getAppearance();
            var language = appearanceDescription.getLanguage();
            var description = appearanceDescriptionValue.getDescription();

            appearanceDescription = AppearanceDescriptionFactory.getInstance().create(appearance, language, description,
                    session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(appearance.getPrimaryKey(), EventTypes.MODIFY, appearanceDescription.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteAppearanceDescription(AppearanceDescription appearanceDescription, BasePK deletedBy) {
        appearanceDescription.setThruTime(session.START_TIME_LONG);

        sendEvent(appearanceDescription.getAppearancePK(), EventTypes.MODIFY, appearanceDescription.getPrimaryKey(), EventTypes.DELETE, deletedBy);

    }

    public void deleteAppearanceDescriptionsByAppearance(Appearance appearance, BasePK deletedBy) {
        var appearanceDescriptions = getAppearanceDescriptionsByAppearanceForUpdate(appearance);

        appearanceDescriptions.forEach((appearanceDescription) -> 
                deleteAppearanceDescription(appearanceDescription, deletedBy)
        );
    }

    // --------------------------------------------------------------------------------
    //   Appearance Text Decorations
    // --------------------------------------------------------------------------------

    public AppearanceTextDecoration createAppearanceTextDecoration(Appearance appearance, TextDecoration textDecoration, BasePK createdBy) {
        var appearanceTextDecoration = AppearanceTextDecorationFactory.getInstance().create(appearance, textDecoration,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(appearance.getPrimaryKey(), EventTypes.MODIFY, appearanceTextDecoration.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return appearanceTextDecoration;
    }

    private static final Map<EntityPermission, String> getAppearanceTextDecorationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM appearancetextdecorations "
                + "WHERE apprntxtdcrtn_apprnc_appearanceid = ? AND apprntxtdcrtn_txtdcrtn_textdecorationid = ? AND apprntxtdcrtn_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM appearancetextdecorations "
                + "WHERE apprntxtdcrtn_apprnc_appearanceid = ? AND apprntxtdcrtn_txtdcrtn_textdecorationid = ? AND apprntxtdcrtn_thrutime = ? "
                + "FOR UPDATE");
        getAppearanceTextDecorationQueries = Collections.unmodifiableMap(queryMap);
    }

    private AppearanceTextDecoration getAppearanceTextDecoration(Appearance appearance, TextDecoration textDecoration, EntityPermission entityPermission) {
        return AppearanceTextDecorationFactory.getInstance().getEntityFromQuery(entityPermission, getAppearanceTextDecorationQueries,
                appearance, textDecoration, Session.MAX_TIME);
    }

    public AppearanceTextDecoration getAppearanceTextDecoration(Appearance appearance, TextDecoration textDecoration) {
        return getAppearanceTextDecoration(appearance, textDecoration, EntityPermission.READ_ONLY);
    }

    public AppearanceTextDecoration getAppearanceTextDecorationForUpdate(Appearance appearance, TextDecoration textDecoration) {
        return getAppearanceTextDecoration(appearance, textDecoration, EntityPermission.READ_WRITE);
    }

    public AppearanceTextDecorationValue getAppearanceTextDecorationValue(AppearanceTextDecoration appearanceTextDecoration) {
        return appearanceTextDecoration == null? null: appearanceTextDecoration.getAppearanceTextDecorationValue().clone();
    }

    public AppearanceTextDecorationValue getAppearanceTextDecorationValueForUpdate(Appearance appearance, TextDecoration textDecoration) {
        return getAppearanceTextDecorationValue(getAppearanceTextDecorationForUpdate(appearance, textDecoration));
    }

    private static final Map<EntityPermission, String> getAppearanceTextDecorationsByAppearanceQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM appearancetextdecorations, textdecorations, textdecorationdetails "
                + "WHERE apprntxtdcrtn_apprnc_appearanceid = ? AND apprntxtdcrtn_thrutime = ? "
                + "AND apprntxtdcrtn_txtdcrtn_textdecorationid = txtdcrtn_textdecorationid AND txtdcrtn_lastdetailid = txtdcrtndt_textdecorationdetailid "
                + "ORDER BY txtdcrtndt_sortorder, txtdcrtndt_textdecorationname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM appearancetextdecorations "
                + "WHERE apprntxtdcrtn_apprnc_appearanceid = ? AND apprntxtdcrtn_thrutime = ? "
                + "FOR UPDATE");
        getAppearanceTextDecorationsByAppearanceQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<AppearanceTextDecoration> getAppearanceTextDecorationsByAppearance(Appearance appearance, EntityPermission entityPermission) {
        return AppearanceTextDecorationFactory.getInstance().getEntitiesFromQuery(entityPermission, getAppearanceTextDecorationsByAppearanceQueries,
                appearance, Session.MAX_TIME);
    }

    public List<AppearanceTextDecoration> getAppearanceTextDecorationsByAppearance(Appearance appearance) {
        return getAppearanceTextDecorationsByAppearance(appearance, EntityPermission.READ_ONLY);
    }

    public List<AppearanceTextDecoration> getAppearanceTextDecorationsByAppearanceForUpdate(Appearance appearance) {
        return getAppearanceTextDecorationsByAppearance(appearance, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getAppearanceTextDecorationsByTextDecorationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM appearancetextdecorations, appearances, appearancedetails "
                + "WHERE apprntxtdcrtn_txtdcrtn_textdecorationid = ? AND apprntxtdcrtn_thrutime = ? "
                + "AND apprntxttrns_apprnc_appearanceid = apprnc_appearanceid AND apprnc_lastdetailid = apprncdt_appearancedetailid "
                + "ORDER BY apprncdt_sortorder, apprncdt_appearancename");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM appearancetextdecorations "
                + "WHERE apprncd_apprnc_appearanceid = ? AND apprntxtdcrtn_thrutime = ? "
                + "FOR UPDATE");
        getAppearanceTextDecorationsByTextDecorationQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<AppearanceTextDecoration> getAppearanceTextDecorationsByTextDecoration(TextDecoration textDecoration, EntityPermission entityPermission) {
        return AppearanceTextDecorationFactory.getInstance().getEntitiesFromQuery(entityPermission, getAppearanceTextDecorationsByTextDecorationQueries,
                textDecoration, Session.MAX_TIME);
    }

    public List<AppearanceTextDecoration> getAppearanceTextDecorationsByTextDecoration(TextDecoration textDecoration) {
        return getAppearanceTextDecorationsByTextDecoration(textDecoration, EntityPermission.READ_ONLY);
    }

    public List<AppearanceTextDecoration> getAppearanceTextDecorationsByTextDecorationForUpdate(TextDecoration textDecoration) {
        return getAppearanceTextDecorationsByTextDecoration(textDecoration, EntityPermission.READ_WRITE);
    }

    public AppearanceTextDecorationTransfer getAppearanceTextDecorationTransfer(UserVisit userVisit, AppearanceTextDecoration appearanceTextDecoration) {
        return getCoreTransferCaches(userVisit).getAppearanceTextDecorationTransferCache().getAppearanceTextDecorationTransfer(appearanceTextDecoration);
    }

    public List<AppearanceTextDecorationTransfer> getAppearanceTextDecorationTransfers(UserVisit userVisit, Collection<AppearanceTextDecoration> appearanceTextDecorations) {
        List<AppearanceTextDecorationTransfer> appearanceTextDecorationTransfers = new ArrayList<>(appearanceTextDecorations.size());
        var appearanceTextDecorationTransferCache = getCoreTransferCaches(userVisit).getAppearanceTextDecorationTransferCache();

        appearanceTextDecorations.forEach((appearanceTextDecoration) ->
                appearanceTextDecorationTransfers.add(appearanceTextDecorationTransferCache.getAppearanceTextDecorationTransfer(appearanceTextDecoration))
        );

        return appearanceTextDecorationTransfers;
    }

    public List<AppearanceTextDecorationTransfer> getAppearanceTextDecorationTransfersByAppearance(UserVisit userVisit, Appearance appearance) {
        return getAppearanceTextDecorationTransfers(userVisit, getAppearanceTextDecorationsByAppearance(appearance));
    }

    public List<AppearanceTextDecorationTransfer> getAppearanceTextDecorationTransfersByTextDecoration(UserVisit userVisit, TextDecoration textDecoration) {
        return getAppearanceTextDecorationTransfers(userVisit, getAppearanceTextDecorationsByTextDecoration(textDecoration));
    }

    public void deleteAppearanceTextDecoration(AppearanceTextDecoration appearanceTextDecoration, BasePK deletedBy) {
        appearanceTextDecoration.setThruTime(session.START_TIME_LONG);

        sendEvent(appearanceTextDecoration.getAppearancePK(), EventTypes.MODIFY, appearanceTextDecoration.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deleteAppearanceTextDecorationsByAppearance(List<AppearanceTextDecoration> appearanceTextDecorations, BasePK deletedBy) {
        appearanceTextDecorations.forEach((appearanceTextDecoration) -> 
                deleteAppearanceTextDecoration(appearanceTextDecoration, deletedBy)
        );
    }

    public void deleteAppearanceTextDecorationsByAppearance(Appearance appearance, BasePK deletedBy) {
        deleteAppearanceTextDecorationsByAppearance(getAppearanceTextDecorationsByAppearanceForUpdate(appearance), deletedBy);
    }

    public void deleteAppearanceTextDecorationsByTextDecoration(TextDecoration textDecoration, BasePK deletedBy) {
        deleteAppearanceTextDecorationsByAppearance(getAppearanceTextDecorationsByTextDecorationForUpdate(textDecoration), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Appearance Text Transformations
    // --------------------------------------------------------------------------------

    public AppearanceTextTransformation createAppearanceTextTransformation(Appearance appearance, TextTransformation textTransformation, BasePK createdBy) {
        var appearanceTextTransformation = AppearanceTextTransformationFactory.getInstance().create(appearance, textTransformation,
                session.START_TIME_LONG, Session.MAX_TIME_LONG);

        sendEvent(appearance.getPrimaryKey(), EventTypes.MODIFY, appearanceTextTransformation.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return appearanceTextTransformation;
    }

    private static final Map<EntityPermission, String> getAppearanceTextTransformationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM appearancetexttransformations "
                + "WHERE apprntxttrns_apprnc_appearanceid = ? AND apprntxttrns_txttrns_texttransformationid = ? AND apprntxttrns_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM appearancetexttransformations "
                + "WHERE apprntxttrns_apprnc_appearanceid = ? AND apprntxttrns_txttrns_texttransformationid = ? AND apprntxttrns_thrutime = ? "
                + "FOR UPDATE");
        getAppearanceTextTransformationQueries = Collections.unmodifiableMap(queryMap);
    }

    private AppearanceTextTransformation getAppearanceTextTransformation(Appearance appearance, TextTransformation textTransformation, EntityPermission entityPermission) {
        return AppearanceTextTransformationFactory.getInstance().getEntityFromQuery(entityPermission, getAppearanceTextTransformationQueries,
                appearance, textTransformation, Session.MAX_TIME);
    }

    public AppearanceTextTransformation getAppearanceTextTransformation(Appearance appearance, TextTransformation textTransformation) {
        return getAppearanceTextTransformation(appearance, textTransformation, EntityPermission.READ_ONLY);
    }

    public AppearanceTextTransformation getAppearanceTextTransformationForUpdate(Appearance appearance, TextTransformation textTransformation) {
        return getAppearanceTextTransformation(appearance, textTransformation, EntityPermission.READ_WRITE);
    }

    public AppearanceTextTransformationValue getAppearanceTextTransformationValue(AppearanceTextTransformation appearanceTextTransformation) {
        return appearanceTextTransformation == null? null: appearanceTextTransformation.getAppearanceTextTransformationValue().clone();
    }

    public AppearanceTextTransformationValue getAppearanceTextTransformationValueForUpdate(Appearance appearance, TextTransformation textTransformation) {
        return getAppearanceTextTransformationValue(getAppearanceTextTransformationForUpdate(appearance, textTransformation));
    }

    private static final Map<EntityPermission, String> getAppearanceTextTransformationsByAppearanceQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM appearancetexttransformations, texttransformations, texttransformationdetails "
                + "WHERE apprntxttrns_apprnc_appearanceid = ? AND apprntxttrns_thrutime = ? "
                + "AND apprntxttrns_txttrns_texttransformationid = txttrns_texttransformationid AND txttrns_lastdetailid = txttrnsdt_texttransformationdetailid "
                + "ORDER BY txttrnsdt_sortorder, txttrnsdt_texttransformationname");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM appearancetexttransformations "
                + "WHERE apprntxttrns_apprnc_appearanceid = ? AND apprntxttrns_thrutime = ? "
                + "FOR UPDATE");
        getAppearanceTextTransformationsByAppearanceQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<AppearanceTextTransformation> getAppearanceTextTransformationsByAppearance(Appearance appearance, EntityPermission entityPermission) {
        return AppearanceTextTransformationFactory.getInstance().getEntitiesFromQuery(entityPermission, getAppearanceTextTransformationsByAppearanceQueries,
                appearance, Session.MAX_TIME);
    }

    public List<AppearanceTextTransformation> getAppearanceTextTransformationsByAppearance(Appearance appearance) {
        return getAppearanceTextTransformationsByAppearance(appearance, EntityPermission.READ_ONLY);
    }

    public List<AppearanceTextTransformation> getAppearanceTextTransformationsByAppearanceForUpdate(Appearance appearance) {
        return getAppearanceTextTransformationsByAppearance(appearance, EntityPermission.READ_WRITE);
    }

    private static final Map<EntityPermission, String> getAppearanceTextTransformationsByTextTransformationQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM appearancetexttransformations, appearances, appearancedetails "
                + "WHERE apprntxttrns_txttrns_texttransformationid = ? AND apprntxttrns_thrutime = ? "
                + "AND apprntxttrns_apprnc_appearanceid = apprnc_appearanceid AND apprnc_lastdetailid = apprncdt_appearancedetailid "
                + "ORDER BY apprncdt_sortorder, apprncdt_appearancename");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM apprntxttrns_txttrns_texttransformationid "
                + "WHERE apprncd_apprnc_appearanceid = ? AND apprntxttrns_thrutime = ? "
                + "FOR UPDATE");
        getAppearanceTextTransformationsByTextTransformationQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<AppearanceTextTransformation> getAppearanceTextTransformationsByTextTransformation(TextTransformation textTransformation, EntityPermission entityPermission) {
        return AppearanceTextTransformationFactory.getInstance().getEntitiesFromQuery(entityPermission, getAppearanceTextTransformationsByTextTransformationQueries,
                textTransformation, Session.MAX_TIME);
    }

    public List<AppearanceTextTransformation> getAppearanceTextTransformationsByTextTransformation(TextTransformation textTransformation) {
        return getAppearanceTextTransformationsByTextTransformation(textTransformation, EntityPermission.READ_ONLY);
    }

    public List<AppearanceTextTransformation> getAppearanceTextTransformationsByTextTransformationForUpdate(TextTransformation textTransformation) {
        return getAppearanceTextTransformationsByTextTransformation(textTransformation, EntityPermission.READ_WRITE);
    }

    public AppearanceTextTransformationTransfer getAppearanceTextTransformationTransfer(UserVisit userVisit, AppearanceTextTransformation appearanceTextTransformation) {
        return getCoreTransferCaches(userVisit).getAppearanceTextTransformationTransferCache().getAppearanceTextTransformationTransfer(appearanceTextTransformation);
    }

    public List<AppearanceTextTransformationTransfer> getAppearanceTextTransformationTransfers(UserVisit userVisit, Collection<AppearanceTextTransformation> appearanceTextTransformations) {
        List<AppearanceTextTransformationTransfer> appearanceTextTransformationTransfers = new ArrayList<>(appearanceTextTransformations.size());
        var appearanceTextTransformationTransferCache = getCoreTransferCaches(userVisit).getAppearanceTextTransformationTransferCache();

        appearanceTextTransformations.forEach((appearanceTextTransformation) ->
                appearanceTextTransformationTransfers.add(appearanceTextTransformationTransferCache.getAppearanceTextTransformationTransfer(appearanceTextTransformation))
        );

        return appearanceTextTransformationTransfers;
    }

    public List<AppearanceTextTransformationTransfer> getAppearanceTextTransformationTransfersByAppearance(UserVisit userVisit, Appearance appearance) {
        return getAppearanceTextTransformationTransfers(userVisit, getAppearanceTextTransformationsByAppearance(appearance));
    }

    public List<AppearanceTextTransformationTransfer> getAppearanceTextTransformationTransfersByTextTransformation(UserVisit userVisit, TextTransformation textTransformation) {
        return getAppearanceTextTransformationTransfers(userVisit, getAppearanceTextTransformationsByTextTransformation(textTransformation));
    }

    public void deleteAppearanceTextTransformation(AppearanceTextTransformation appearanceTextTransformation, BasePK deletedBy) {
        appearanceTextTransformation.setThruTime(session.START_TIME_LONG);

        sendEvent(appearanceTextTransformation.getAppearancePK(), EventTypes.MODIFY, appearanceTextTransformation.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deleteAppearanceTextTransformationsByAppearance(List<AppearanceTextTransformation> appearanceTextTransformations, BasePK deletedBy) {
        appearanceTextTransformations.forEach((appearanceTextTransformation) -> 
                deleteAppearanceTextTransformation(appearanceTextTransformation, deletedBy)
        );
    }

    public void deleteAppearanceTextTransformationsByAppearance(Appearance appearance, BasePK deletedBy) {
        deleteAppearanceTextTransformationsByAppearance(getAppearanceTextTransformationsByAppearanceForUpdate(appearance), deletedBy);
    }

    public void deleteAppearanceTextTransformationsByTextTransformation(TextTransformation textTransformation, BasePK deletedBy) {
        deleteAppearanceTextTransformationsByAppearance(getAppearanceTextTransformationsByTextTransformationForUpdate(textTransformation), deletedBy);
    }

    // --------------------------------------------------------------------------------
    //   Entity Appearances
    // --------------------------------------------------------------------------------

    public EntityAppearance createEntityAppearance(EntityInstance entityInstance, Appearance appearance, BasePK createdBy) {
        var entityAppearance = EntityAppearanceFactory.getInstance().create(entityInstance, appearance, session.START_TIME_LONG,
                Session.MAX_TIME_LONG);

        sendEvent(entityInstance, EventTypes.MODIFY, entityAppearance.getPrimaryKey(), EventTypes.CREATE, createdBy);

        return entityAppearance;
    }

    private static final Map<EntityPermission, String> getEntityAppearanceQueries;

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ " +
                "FROM entityappearances " +
                "WHERE eniapprnc_eni_entityinstanceid = ? AND eniapprnc_thrutime = ?");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ " +
                "FROM entityappearances " +
                "WHERE eniapprnc_eni_entityinstanceid = ? AND eniapprnc_thrutime = ? " +
                "FOR UPDATE");
        getEntityAppearanceQueries = Collections.unmodifiableMap(queryMap);
    }

    private EntityAppearance getEntityAppearance(EntityInstance entityInstance, EntityPermission entityPermission) {
        return EntityAppearanceFactory.getInstance().getEntityFromQuery(entityPermission, getEntityAppearanceQueries,
                entityInstance, Session.MAX_TIME);
    }

    public EntityAppearance getEntityAppearance(EntityInstance entityInstance) {
        return getEntityAppearance(entityInstance, EntityPermission.READ_ONLY);
    }

    public EntityAppearance getEntityAppearanceForUpdate(EntityInstance entityInstance) {
        return getEntityAppearance(entityInstance, EntityPermission.READ_WRITE);
    }

    public EntityAppearanceValue getEntityAppearanceValue(EntityAppearance entityAppearance) {
        return entityAppearance == null? null: entityAppearance.getEntityAppearanceValue().clone();
    }

    public EntityAppearanceValue getEntityAppearanceValueForUpdate(EntityInstance entityInstance) {
        return getEntityAppearanceValue(getEntityAppearanceForUpdate(entityInstance));
    }

    private static final Map<EntityPermission, String> getEntityAppearancesByAppearanceQueries;

    public List<EntityAppearance> getEntityAppearancesByEntityInstanceForUpdate(EntityInstance entityInstance) {
        List<EntityAppearance> entityAppearances;

        try {
            var ps = EntityAppearanceFactory.getInstance().prepareStatement(
                    "SELECT _ALL_ " +
                    "FROM entityappearances " +
                    "WHERE eniapprnc_eni_entityinstanceid = ? AND eniapprnc_thrutime = ? " +
                    "FOR UPDATE");

            ps.setLong(1, entityInstance.getPrimaryKey().getEntityId());
            ps.setLong(2, Session.MAX_TIME);

            entityAppearances = EntityAppearanceFactory.getInstance().getEntitiesFromQuery(EntityPermission.READ_WRITE, ps);
        } catch (SQLException se) {
            throw new PersistenceDatabaseException(se);
        }

        return entityAppearances;
    }

    static {
        Map<EntityPermission, String> queryMap = new HashMap<>(2);

        queryMap.put(EntityPermission.READ_ONLY,
                "SELECT _ALL_ "
                + "FROM entityappearances, entityinstances, entitytypes, entitytypedetails, componentvendors, componentvendordetails "
                + "WHERE eniapprnc_apprnc_appearanceid = ? AND eniapprnc_thrutime = ? "
                + "AND eniapprnc_eni_entityinstanceid = eni_entityinstanceid "
                + "AND eni_ent_entitytypeid = ent_entitytypeid AND ent_lastdetailid = entdt_entitytypedetailid "
                + "AND entdt_cvnd_componentvendorid = cvnd_componentvendorid AND cvnd_lastdetailid = cvndd_componentvendordetailid "
                + "ORDER BY cvndd_componentvendorname, entdt_sortorder, entdt_entitytypename, eni_entityuniqueid");
        queryMap.put(EntityPermission.READ_WRITE,
                "SELECT _ALL_ "
                + "FROM entityappearances "
                + "WHERE eniapprnc_apprnc_appearanceid = ? AND eniapprnc_thrutime = ? "
                + "FOR UPDATE");
        getEntityAppearancesByAppearanceQueries = Collections.unmodifiableMap(queryMap);
    }

    private List<EntityAppearance> getEntityAppearancesByAppearance(Appearance appearance, EntityPermission entityPermission) {
        return EntityAppearanceFactory.getInstance().getEntitiesFromQuery(entityPermission, getEntityAppearancesByAppearanceQueries,
                appearance, Session.MAX_TIME);
    }

    public List<EntityAppearance> getEntityAppearancesByAppearance(Appearance appearance) {
        return getEntityAppearancesByAppearance(appearance, EntityPermission.READ_ONLY);
    }

    public List<EntityAppearance> getEntityAppearancesByAppearanceForUpdate(Appearance appearance) {
        return getEntityAppearancesByAppearance(appearance, EntityPermission.READ_WRITE);
    }

    public EntityAppearanceTransfer getEntityAppearanceTransfer(UserVisit userVisit, EntityAppearance entityAppearance) {
        return getCoreTransferCaches(userVisit).getEntityAppearanceTransferCache().getEntityAppearanceTransfer(entityAppearance);
    }

    public List<EntityAppearanceTransfer> getEntityAppearanceTransfersByAppearance(UserVisit userVisit, Appearance appearance) {
        var entityAppearances = getEntityAppearancesByAppearance(appearance);
        List<EntityAppearanceTransfer> entityAppearanceTransfers = new ArrayList<>(entityAppearances.size());
        var entityAppearanceTransferCache = getCoreTransferCaches(userVisit).getEntityAppearanceTransferCache();

        entityAppearances.forEach((entityAppearance) ->
                entityAppearanceTransfers.add(entityAppearanceTransferCache.getEntityAppearanceTransfer(entityAppearance))
        );

        return entityAppearanceTransfers;
    }

    public void updateEntityAppearanceFromValue(EntityAppearanceValue entityAppearanceValue, BasePK updatedBy) {
        if(entityAppearanceValue.hasBeenModified()) {
            var entityAppearance = EntityAppearanceFactory.getInstance().getEntityFromPK(EntityPermission.READ_WRITE,
                    entityAppearanceValue.getPrimaryKey());

            entityAppearance.setThruTime(session.START_TIME_LONG);
            entityAppearance.store();

            var entityInstance = entityAppearance.getEntityInstance(); // Not updated.
            var appearancePK = entityAppearanceValue.getAppearancePK();

            entityAppearance = EntityAppearanceFactory.getInstance().create(entityInstance.getPrimaryKey(), appearancePK, session.START_TIME_LONG, Session.MAX_TIME_LONG);

            sendEvent(entityInstance, EventTypes.MODIFY, entityAppearance.getPrimaryKey(), EventTypes.MODIFY, updatedBy);
        }
    }

    public void deleteEntityAppearance(EntityAppearance entityAppearance, BasePK deletedBy) {
        entityAppearance.setThruTime(session.START_TIME_LONG);

        sendEvent(entityAppearance.getEntityInstance(), EventTypes.MODIFY, entityAppearance.getPrimaryKey(), EventTypes.DELETE, deletedBy);
    }

    public void deleteEntityAppearancesByEntityInstance(EntityInstance entityInstance, BasePK deletedBy) {
        var entityAppearances = getEntityAppearancesByEntityInstanceForUpdate(entityInstance);

        entityAppearances.forEach((entityAppearance) ->
                deleteEntityAppearance(entityAppearance, deletedBy)
        );
    }

    public void deleteEntityAppearancesByAppearance(Appearance appearance, BasePK deletedBy) {
        var entityAppearances = getEntityAppearancesByAppearanceForUpdate(appearance);

        entityAppearances.forEach((entityAppearance) ->
                deleteEntityAppearance(entityAppearance, deletedBy)
        );
    }

}
